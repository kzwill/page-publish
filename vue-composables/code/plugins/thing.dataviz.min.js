/*! For license information please see thing.dataviz.min.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("THING"),require("@uino/thing-t3d")):"function"==typeof define&&define.amd?define("THING",["THING"],e):"object"==typeof exports?exports.THING=e(require("THING"),require("@uino/thing-t3d")):(t.THING=t.THING||{},t.THING.DATAVIZ=e(t.THING,t.THING.T3D))}(self,((t,e)=>(()=>{"use strict";var i={"./src/common/Factory.js":(t,e,i)=>{i.r(e),i.d(e,{Factory:()=>h});var a=i("./src/uNodes/Heatmap/UHeatmapLayerNode.js"),r=i("./src/uNodes/Heatmap/UIDWLayerNode.js"),n=i("./src/uNodes/Streamlines/UStreamlines.js"),s=i("./src/uNodes/WindLayer/UWindLayerNode.js"),o=i("./src/uNodes/volumerendering/UVolumerenderNode.js"),l=i("./src/uNodes/geologicalmodel/UGeologicalmodelNode.js");class h{static className="Factory";constructor(){}createObject(t,e){switch(t){case"HeatmapLayerNode":return new a.UHeatmapLayerNode(e);case"IDWLayerNode":return new r.UIDWLayerNode(e);case"VolumerenderNode":return new o.UVolumerenderNode(e);case"GeologicalmodelNode":return new l.UGeologicalmodelNode(e);case"UWindLayerNode":return new s.UWindLayerNode(e);case"StreamlinesNode":return new n.UStreamlines(e);default:return null}}}},"./src/common/Utils.js":(t,e,i)=>{i.r(e),i.d(e,{Utils:()=>n});var a=i("@uino/thing"),r=i("@uino/thing-t3d");class n extends a.Utils{static className="Utils";static _processGeojson(t,e){var i=JSON.stringify(t);if("LINEHEIGHT"===e.toUpperCase())0===i.indexOf("[")&&0!==i.indexOf("[[")&&(t=[t]);else if("POLYGON"===e.toUpperCase()||"BOUNDARYPOLYGON"===e.toUpperCase()){if(0===i.indexOf("[")&&0!==i.indexOf("[[")&&(t=[[[t]]]),0===i.indexOf("[[")&&0!==i.indexOf("[[[")&&(t=[[t]]),0===i.indexOf("[[[")&&0!==i.indexOf("[[[[")&&(t=[t]),"POLYGON"===e.toUpperCase()){const e=[];t.forEach((function(t){THING.EARTH.Utils.hasHole(t)?e.push(t):t.forEach((function(t){e.push([t])}))})),t=e}}else"LINE"===e.toUpperCase()&&0===i.indexOf("[[")&&0!==i.indexOf("[[[")&&(t=[t]);return t}static convertToTwoDimensionalArray(t,e){const i=[],a=Math.ceil(t.length/e);for(let r=0;r<a;r++){const a=t.slice(r*e,(r+1)*e);i.push(a)}return i}static restoreArray(t,e,i,a){const r=[];for(let n=0;n<e;n++){const e=[];for(let r=0;r<i;r++){const s=[];for(let e=0;e<a;e++){const o=n*i*a+r*a+e;s.push(t[o])}e.push(s)}r.push(e)}return r}static _plotting(t){let e,i=document.createElement("canvas");if(i.name="debugPlotting",i.width=t.width,i.height=t.height,i.style.position="absolute",i.style.left=i.style.top="0px",t.data.length!==t.width*t.height*4){const i=new Uint8ClampedArray(t.width*t.height*4);for(let e=0;e<t.data.length;e++)i[4*e]=255,i[4*e+1]=255,i[4*e+2]=255,i[4*e+3]=t.data[e];e=new ImageData(i,t.width,t.height)}else e=new ImageData(t.data,t.width,t.height);i.getContext("2d").putImageData(e,0,0),a.Utils.getCurrentApp().container.parentElement.appendChild(i)}static getMin(t){let e=t.length,i=1/0;for(;e--;)i=t[e]<i?t[e]:i;return i}static getMax(t){let e=t.length,i=-1/0;for(;e--;)i=t[e]>i?t[e]:i;return i}static parseData(t){let e=[...new Set(t.map((t=>t[0])))],i=[...new Set(t.map((t=>t[1])))],a=[...new Set(t.map((t=>t[2])))];return{minX:Math.min(...e),maxX:Math.max(...e),minY:Math.min(...i),maxY:Math.max(...i),minZ:Math.min(...a),maxZ:Math.max(...a)}}static getValue(t,e,i,a,r){let n=t+r*(e-t)/(a-i);return Math.abs(n)<1e-6&&(n=0),n}static uInt16ToNumber(t,e){let i=(t>>8&255)+(255&t)/255;return this.getValue(e.min,e.max,0,255,i)}static _parseFieldDataHeaders(t){let e=t.substring(t.indexOf("isGrid")+7,t.indexOf(",",t.indexOf("isGrid")));e="true"===e;const i=+t.substring(t.indexOf("dimension")+10,t.indexOf(",",t.indexOf("dimension"))),a=+t.substring(t.indexOf("minX")+5,t.indexOf(",",t.indexOf("minX"))),r=+t.substring(t.indexOf("minY")+5,t.indexOf(",",t.indexOf("minY"))),n=+t.substring(t.indexOf("minZ")+5,t.indexOf(",",t.indexOf("minZ"))),s=+t.substring(t.indexOf("maxX")+5,t.indexOf(",",t.indexOf("maxX"))),o=+t.substring(t.indexOf("maxY")+5,t.indexOf(",",t.indexOf("maxY"))),l=+t.substring(t.indexOf("maxZ")+5,t.indexOf(",",t.indexOf("maxZ"))),h=+t.substring(t.indexOf("dimX")+5,t.indexOf(",",t.indexOf("dimX"))),u=+t.substring(t.indexOf("dimY")+5,t.indexOf(",",t.indexOf("dimY"))),d=+t.substring(t.indexOf("dimZ")+5,t.indexOf(",",t.indexOf("dimZ")));let m=t.substring(t.indexOf("min=")+4,t.indexOf(",",t.indexOf("min="))),c=t.substring(t.indexOf("max=")+4);m.indexOf("|")&&(m=m.split("|"),m=Array.from(m,(t=>parseFloat(t)))),c.indexOf("|")&&(c=c.split("|"),c=Array.from(c,(t=>parseFloat(t))));const p=[];for(let t=0;t<m.length;t++)p.push({min:m[t],max:c[t]});const _={isGrid:e,dimension:i,minX:a,minY:r,maxX:s,maxY:o,dimX:h,dimY:u,minmax:p};return 3===i&&(_.minZ=n,_.maxZ=l,_.dimZ=d),_}static readFieldDataBuffer(t){let e={};var i=new Uint8Array(t),a=new DataView(t),r=0,n=a.getInt32(r,!0);r+=4,console.log("version",n);var s=a.getInt32(r,!0);r+=4,console.log("head length",s);var o=i.subarray(r,r+s);r+=s;const l=(new TextDecoder).decode(o);console.log("head str",l),e.headers=this._parseFieldDataHeaders(l),e.data=[];const h=e.headers.minmax;let u=0;for(;r<t.byteLength;){const t=a.getInt32(r,!0);r+=4;const i=[];for(var d=0;d<t;d++){const t=a.getInt32(r,!0);r+=4,i.push(t)}const n=a.getInt32(r,!0);r+=4;let s=n;e.headers.isGrid||(s*=i.length);const o=new Float32Array(s);for(let t=0;t<n;t++)for(let n=0;n<i.length;n++){let s=t;if(e.headers.isGrid||(u=n,s=t*i.length+n),2===i[n]){const t=a.getUint16(r,!0);r+=2;const e=this.uInt16ToNumber(t,h[u]);o[s]=e}else if(4===i[n]){const t=a.getFloat32(r,!0);r+=4,o[s]=t}}console.log(u),e.headers.isGrid&&u++,e.data.push(o)}return e.headers.isGrid||(e.data=e.data[0],e.data=this.convertToTwoDimensionalArray(e.data,e.headers.dimension+1)),e}static processFieldDataBufferData(t){const e={};let i=t.headers;return i.isGrid?(e.u=t.data[0],e.v=t.data[1],e.w=t.data[2]):e.data=t.data,e.minX=i.minX,e.minY=i.minY,e.maxX=i.maxX,e.maxY=i.maxY,e.dimX=i.dimX,e.dimY=i.dimY,3===i.dimension&&(e.minZ=i.minZ,e.maxZ=i.maxZ,e.dimZ=i.dimZ),e}static processFieldDataString(t){const e={},i=t.split("\n"),a=i[0].replace("\r",""),r=a.substring(a.indexOf("isGrid")+7,a.indexOf(",",a.indexOf("isGrid"))),n=+a.substring(a.indexOf("dimension")+10,a.indexOf(",",a.indexOf("dimension"))),s=+a.substring(a.indexOf("minX")+5,a.indexOf(",",a.indexOf("minX"))),o=+a.substring(a.indexOf("minY")+5,a.indexOf(",",a.indexOf("minY"))),l=+a.substring(a.indexOf("minZ")+5,a.indexOf(",",a.indexOf("minZ"))),h=+a.substring(a.indexOf("maxX")+5,a.indexOf(",",a.indexOf("maxX"))),u=+a.substring(a.indexOf("maxY")+5,a.indexOf(",",a.indexOf("maxY"))),d=+a.substring(a.indexOf("maxZ")+5,a.indexOf(",",a.indexOf("maxZ"))),m=+a.substring(a.indexOf("dimX")+5,a.indexOf(",",a.indexOf("dimX"))),c=+a.substring(a.indexOf("dimY")+5,a.indexOf(",",a.indexOf("dimY"))),p=+a.substring(a.indexOf("dimZ")+5,a.indexOf(",",a.indexOf("dimZ")));if("true"===r){let t=i[1].replace("\r","").split(","),a=i[2].replace("\r","").split(",");if(t=Array.from(t,(t=>parseFloat(t))),a=Array.from(a,(t=>parseFloat(t))),e.u=t,e.v=a,3===n){let t=i[3].replace("\r","").split(",");t=Array.from(t,(t=>parseFloat(t))),e.w=t}}else{const t=[];for(let e=1;e<i.length-1;e++){let a=i[e].replace("\r","").split(",");a=Array.from(a,(t=>parseFloat(t))),t.push(a)}e.data=t}return e.minX=s,e.minY=o,e.maxX=h,e.maxY=u,e.dimX=m,e.dimY=c,3===n&&(e.minZ=l,e.maxZ=d,e.dimZ=p),e}static getGradientTexture(t){var e=document.createElement("canvas");e.width=256,e.height=1;var i=(e=e.getContext("2d")).createLinearGradient(0,0,256,0);for(var a in t)i.addColorStop(+a,t[a]);e.fillStyle=i,e.fillRect(0,0,256,1);var n=new r.Texture2D;return n.image=e.canvas,n.version++,n}static _generateHalfTexture(){if(!this._halfTexture){const t=new Uint8Array(512);for(let e=0;e<128;e++)t[4*e+0]=255,t[4*e+1]=e<64?0:255,t[4*e+2]=255,t[4*e+3]=255;this._halfTexture=new THING.T3D.Texture2D,this._halfTexture.image={data:t,width:128,height:1},this._halfTexture.needsUpdate=!0}return this._halfTexture}static parseValue(t,e){return null==t?e:t}static isNumeric(t){return!isNaN(parseFloat(t))&&isFinite(t)}static indexOfClosest(t,e){for(var i=0,a=Math.abs(t-e[0]),r=0;r<e.length;r++){var n=Math.abs(t-e[r]);n<a&&(a=n,i=r)}return i}static getSize(t){for(var e,i,a,r=[];e=t.map((t=>Array.isArray(t)?t.length:0)),i=Math.max(...e),a=e.indexOf(i),r.push(t.length),i>0;)t=t[a];return r}}},"./src/const.js":(t,e,i)=>{i.r(e),i.d(e,{HeatmapRenderType:()=>n,StreamlineRenderType:()=>r,VERSION:()=>a});const a="1.0.1",r={Streamline:"Streamline",Line:"Line"},n={Plane:"2d",Mesh:"3d"}},"./src/objects/EarthHeatmap.js":(t,e,i)=>{i.r(e),i.d(e,{EarthHeatmap:()=>n});var a=i("@uino/thing"),r=i("./src/objects/Heatmap.js");class n extends r.Heatmap{static className="EarthHeatmap";constructor(t={}){t.isLonlat=!0,t.offsetHeight=a.Utils.parseValue(t.offsetHeight,0),super(t)}get offsetHeight(){return this._params.offsetHeight}set offsetHeight(t){this._params.offsetHeight=t,this.updateMapViewExtent()}}},"./src/objects/EarthIDWmap.js":(t,e,i)=>{i.r(e),i.d(e,{EarthIDWmap:()=>r});var a=i("./src/objects/IDWmap.js");class r extends a.IDWmap{static className="EarthIDWmap";constructor(t={}){t.isLonlat=!0,super(t)}}},"./src/objects/EarthVectorField.js":(t,e,i)=>{i.r(e),i.d(e,{EarthVectorField:()=>r});var a=i("./src/objects/VectorField.js");class r extends a.VectorField{static className="EarthVectorField";constructor(t={}){t.isLonlat=!0,super(t)}get offsetHeight(){return this._offsetHeight}}},"./src/objects/EarthVolumeRendering.js":(t,e,i)=>{i.r(e),i.d(e,{EarthVolumeRendering:()=>r});var a=i("./src/objects/VolumeRendering.js");class r extends a.VolumeRendering{static className="EarthVolumeRendering";constructor(t={}){t.isLonlat=!0,super(t)}}},"./src/objects/GeologicalmodelLayer.js":(t,e,i)=>{i.r(e),i.d(e,{GeologicalmodelLayer:()=>n});var a=i("@uino/thing"),r=i("./src/common/Utils.js");class n extends a.Object3D{static className="GeologicalmodelLayer";constructor(t={}){super(t),this._data=t.data,this._params=t,this._init(t)}async _init(t){let e=t.data;const i=r.Utils.parseData(e[0]),n=i.maxX-i.minX,s=i.maxY-i.minY;let o=n>s?n:s,l=[];for(let t=0;t<e.length;t++)l[t]=e[t];let h=e.length-1;l[e.length]=[];for(let t=0;t<l[h].length;t++)l[e.length][t]=[],l[e.length][t][0]=l[h][t][0],l[e.length][t][1]=l[h][t][1],l[e.length][t][2]=l[h][t][2]-l[h][t][3];let u=l[0];const d={pointlist:[],segmentlist:[],numberofholes:0,numberofpoints:u.length,numberofsegments:u.length};for(let t=0;t<u.length;t++)d.pointlist.push(u[t][0]),d.pointlist.push(u[t][1]),0===t?d.segmentlist.push([u.length-1,0]):d.segmentlist.push([t-1,t]);if(t.triangulationWasmUrl){await a.Utils.loadFileAsync(t.triangulationWasmUrl);let e=getTriangleWasmModule();await e.init(),this._flatten(d);const r=e.makeIO(d),n=e.makeIO();let s={quality:20,area:a.Utils.parseValue(t.defaultGridSize,o),ccdt:!1,convexHull:!1,holes:!1,quiet:!1,varea:.01,vqual:100};e.triangulate(s,r,n),t.output=n,t.geologicallayers=l,t.worldMatrix=this.matrix,t.extent=i;const h=a.Utils.createObject("GeologicalmodelNode",{external:{uScene:this.node._uScene,param:t}});this._node=h,this.body.setNode(h),this._params.imageUrls&&this._params.imageUrls.length>0&&this.setdiffuseMap(this._params.imageUrls),this.colors=this._params.colors}}get clippingPlane(){return this._node._clippingPlane}set clippingPlane(t){this._node._clippingPlane=t,this._setClipPlane(t),this.colors=this.colors,this.imageUrls=this.imageUrls}setVisibleByIndex(t,e,i=!0){this.node.setVisibleByIndex(t,e,i)}setTopBlockVisibleByIndex(t,e){this.node.setTopBlockVisibleByIndex(t,e)}setBottomBlockVisibleByIndex(t,e){this.node.setBottomBlockVisibleByIndex(t,e)}setSideBlockVisibleByIndex(t,e){this.node.setSideBlockVisibleByIndex(t,e)}setdiffuseMap(t){this._node.setdiffuseMap(t)}setdiffuse(t){this._node.setdiffuse(t)}set imageUrls(t){this._params.imageUrls=t,Array.isArray(this._params.imageUrls)&&this._params.imageUrls.length>0&&this._node.setdiffuseMap(t)}get imageUrls(){return this._params.imageUrls}set colors(t){if(this._params.colors=t,Array.isArray(this._params.colors)&&this._params.colors.length>0){const t=[];this._params.colors.forEach((e=>{t.push(a.Utils.parseColor(e))})),this.setdiffuse(t)}}get colors(){return this._params.colors}_setClipPlane(t){this._node._updataClipPlane(t)}_flatten(t){let e;for(e in t)Array.isArray(t[e])&&(t[e]=t[e].flat())}get data(){return this._data}onDestroy(){super.onDestroy()}}},"./src/objects/Heatmap.js":(t,e,i)=>{i.r(e),i.d(e,{Heatmap:()=>o});var a=i("@uino/thing"),r=i("./src/common/Utils.js"),n=i("./src/objects/Mosaic.js"),s=i("./src/const.js");class o extends a.Object3D{static className="Heatmap";constructor(t={}){super(t),this._isLonlat=a.Utils.parseValue(t.isLonlat,!1),this.init(t)}init(t){const e=(t=t||this._params).geometry;delete t.geometry;let i=a.Utils.parseValue(t.updateExtent,!0),o=t.data;delete t.data,this._params=a.Utils.cloneObject(t,!1);const l=a.Utils.cloneObject(t,!1);e&&(l.geometry=e,this._params.geometry=e),this._renderType=a.Utils.parseValue(t.renderType,s.HeatmapRenderType.Plane),t.renderType===s.HeatmapRenderType.Mesh?l.type="3Dheatmap":(t.renderType===s.HeatmapRenderType.Plane&&(l.type="heatmap"),t.mosaic&&(t.mosaic.object=this,this._mosaic=new n.Mosaic(t.mosaic),t.mosaic.enable&&(l.type="mosaic",l.mosaicSize=this._mosaic.size))),l.alpha=l.transparent,delete l.renderType,delete l.width,delete l.height,l.alpha=a.Utils.parseValue(l.alpha,!1),l.radius=a.Utils.parseValue(l.radius,5),l.segmentCount=a.Utils.parseValue(l.segmentCount,512),l.renderer=this.app.view._renderer;const h=e=>{let n;if(e){if(l.data=e,this._params.data=e,i&&(this._drawExtent=r.Utils.parseData(this.data),this._dataExtent=a.Utils.copyObject(this._drawExtent),t.extent&&(this._drawExtent.minX=t.extent.minX,this._drawExtent.minY=t.extent.minY,this._drawExtent.maxX=t.extent.maxX,this._drawExtent.maxY=t.extent.maxY)),!this._isLonlat&&t.mask)if(t.mask.points){let e=[...new Set(t.mask.points.map((t=>t[0])))],i=[...new Set(t.mask.points.map((t=>t[1])))],a=Math.min(...e),r=Math.max(...e),n=Math.min(...i),s=Math.max(...i);this._drawExtent.minX=a,this._drawExtent.minY=n,this._drawExtent.maxX=r,this._drawExtent.maxY=s}else if(this._isLonlat){const e=THING.EARTH.Utils.getPolygonExtent(t.mask);this._drawExtent.minX=e.minX,this._drawExtent.minY=e.minY,this._drawExtent.maxX=e.maxX,this._drawExtent.maxY=e.maxY}if(this._drawExtent.minX===this._drawExtent.maxX)return void a.Utils.warn("since the minimumX and maximumX values are the same, please checkout data or extent.");if(this._drawExtent.minY===this._drawExtent.maxY)return void a.Utils.warn("since the minimumY and maximumY values are the same, please checkout data or extent.");a.Utils.isNull(t.minValue)&&(l.minValue=this._dataExtent.minZ),a.Utils.isNull(t.maxValue)&&(l.maxValue=this._dataExtent.maxZ);const n=this._drawExtent.maxX-this._drawExtent.minX,s=this._drawExtent.maxY-this._drawExtent.minY;l.width=n,l.height=s,l.extent={minX:this._drawExtent.minX,maxX:this._drawExtent.maxX,minY:this._drawExtent.minY,maxY:this._drawExtent.maxY}}if(this._isLonlat){i&&(this._drawExtent=this._getMapViewExtent());const t=this._processLonlatData(this._drawExtent,this.data,this.offsetHeight);l.geometry=t.geometry,l.width=t.width,l.height=t.height,l.data=t.data,n=t.transform}const s=a.Utils.createObject("HeatmapLayerNode",{external:{uScene:this.node._uScene,param:l}});this._node=s,this.body.setNode(s),this._needRefresh=!0,this._isLonlat&&n&&(this.matrixWorld=n.matrix,this.updateMatrixWorld()),this.onLoadComplete()};if(t.url){const e=t=>{a.Utils.error(t)};t.url.endsWith("bin")?a.Utils.loadBinaryFile(t.url,(t=>{let e=r.Utils.readFieldDataBuffer(t.data);e=r.Utils.processFieldDataBufferData(e),h(e)}),null,(t=>{e(t)})):t.url.endsWith("json")?a.Utils.loadJSONFile(t.url,(t=>{h(t.data)}),null,(t=>{e(t)})):a.Utils.loadTextFile(t.url,(t=>{const e=THING.Utils.processFieldDataString(t.data);h(e)}),null,(t=>{e(t)}))}else h(o);o=null}_onLoadResource(){}_getMapViewExtent(){if(this._params.extent)return this._params.extent;let t=a.Utils.getCurrentApp().map.getCurrentExtent(),e={minX:t.minX,maxX:t.maxX,minY:t.minY,maxY:t.maxY};if(this._dataExtent){if(e.maxX<this._dataExtent.minX||e.minX>this._dataExtent.maxX||e.minY>this._dataExtent.maxY||e.maxY<this._dataExtent.minY)return t;let i=this._dataExtent.maxX-this._dataExtent.minX,a=this._dataExtent.maxY-this._dataExtent.minY;e.maxX>this._dataExtent.maxX+1*i&&(e.maxX=this._dataExtent.maxX+1*i),e.minX<this._dataExtent.minX-1*i&&(e.minX=this._dataExtent.minX-1*i),e.maxY>this._dataExtent.maxY+1*a&&(e.maxY=this._dataExtent.maxY+1*a),e.minY<this._dataExtent.minY-1*a&&(e.minY=this._dataExtent.minY-1*a)}return this._params.extent&&(e.minX<this._params.extent.minX&&(e.minX=this._params.extent.minX),e.minY<this._params.extent.minY&&(e.minY=this._params.extent.minY),e.maxX>this._params.extent.maxX&&(e.maxX=this._params.extent.maxX),e.maxY>this._params.extent.maxY&&(e.maxY=this._params.extent.maxY)),e}_processLonlatData(t,e,i){const a=this._createVertexData(t,i),r=a.vertexData[0],n=a.transform,s=[t.maxX,t.maxY],o=[t.minX,t.minY],l=[t.maxX,t.minY],h=THING.EARTH.Utils.getSphericalDistance(l,o),u=2048,d=u*THING.EARTH.Utils.getSphericalDistance(s,l)/h,m=u/(t.maxX-t.minX),c=d/(t.maxY-t.minY),p=(t.maxX+t.minX)/2,_=(t.maxY+t.minY)/2,f=[];return e.forEach((e=>{if(e[0]>=t.minX&&e[0]<=t.maxX&&e[1]>=t.minY&&e[1]<=t.maxY){let t=e[0]-p,i=e[1]-_;t*=m,i*=c,f.push([t,i,e[2]])}})),{width:u,height:d,transform:n,data:f,geometry:r}}_getGranularity(t,e=2){return a.MathUtils.max(t.maxX-t.minX,t.maxY-t.minY)/e*a.MathUtils.PI/180}_createVertexData(t,e){const i=(t.maxX+t.minX)/2,n=(t.maxY+t.minY)/2;let o;o=THING.EARTH.Utils.getEarthMode()===THING.EARTH.SceneMode.EarthView?new THING.EARTH.Transform({position:THING.EARTH.Utils.convertLonlatToWorld([i,n],e)}):new THING.EARTH.Transform2D({position:THING.EARTH.Utils.convertLonlatToWorld([i,n],e)});const l=a.Utils.getCurrentApp().map._combineEngine._earthInstance;let h;if(this._params.mask){const i=r.Utils._processGeojson(this._params.mask,"POLYGON"),n=THING.EARTH.Utils.getPolygonExtent(i),s=(t.maxX-t.minX)/(n.maxX-n.minX),l=(t.maxY-t.minY)/(n.maxY-n.minY),u=THING.MathUtils.max(512,512)/THING.MathUtils.min(s,l),d=this._getGranularity(n,u);h=a.Utils.getCurrentApp().map._combineEngine._earthInstance.createPolygonGeometryData(i,o,e,null,0,t,!1,null,!1,!1,!1,d),h=h.vertexData}else h=this.renderType===s.HeatmapRenderType.Plane?l.createRectangleGeometry(t,!1,e,o,0):l.createCustomRectangleGeometry(t,!1,e,o,0,null,512,512);return{vertexData:h,transform:o}}updateMapViewExtent(){this._drawExtent=this._getMapViewExtent();const t=this._processLonlatData(this._drawExtent,this.data,this.offsetHeight);this._node._updateGeometry(t.geometry),this.matrix=t.transform.matrix,this.updateMatrixWorld(),this.node._updateWidthHeightAndData(t)}addData(t){this._params.data.push(t),this.data=this._params.data}setData(t){this.data=t}randomData(){let t=[];for(let e=0;e<Math.round(this._node._params.areaWidth*this._node._params.areaHeight)/100;e++)t.push([(Math.random()-.5)*this._node._params.areaWidth,(Math.random()-.5)*this._node._params.areaHeight,Math.pow(Math.random(),3)*(this._node._params.maxValue-this._node._params.minValue)+this._node._params.minValue]);this.setData(t)}getGrayTexture(){if(!(this._node.getGrayTexture instanceof Function))return null;this._node.getGrayTexture()}get transparent(){return this._params.transparent}set transparent(t){this._params.transparent=t,this._node.transparent=t}get extrudeHeight(){return this._params.extrudeHeight}set extrudeHeight(t){t!==this._params.extrudeHeight&&(this._params.extrudeHeight=t,this._node.extrudeHeight=t)}get radius(){return this._params.radius}set radius(t){this._params.radius=t,this._node.radius=this._params.radius}get gradient(){return this._params.gradient}set gradient(t){this._params.gradient=t,this._node.gradient=this._params.gradient}get mosaic(){return this._mosaic}set mosaic(t){t?(t.object=this,this._mosaic=new n.Mosaic(t),this.updateMosaic()):(this._mosaic=t,this.updateMosaic())}updateMosaic(){this._mosaic?this._params.mosaic=this._mosaic.toJSON():this._params.mosaic=void 0,this.renderType===s.HeatmapRenderType.Plane&&(this._params.updateExtent=!1,this.init(this._params))}get minValue(){return this._params.minValue}set minValue(t){this._params.minValue=t,this._node.minValue=this._params.minValue,this._needRefresh&&this._node.refresh()}get mask(){return this._params.mask}set mask(t){this._params.mask=t,this._params.updateExtent=!this._isLonlat,this.init(this._params)}get maxValue(){return this._params.maxValue}set maxValue(t){this._params.maxValue=t,this._node.maxValue=this._params.maxValue,this._needRefresh&&this._node.refresh()}get renderType(){return this._renderType}set renderType(t){this._renderType=t,this._params.renderType=t,this._params.updateExtent=!1,this.init(this._params)}get data(){return this._params.data}set data(t){this._params.data=t,this.init(this._params)}updateSubBuffer(t,e){this._node.updateSubBuffer(t,e)}onDestroy(){super.onDestroy()}}},"./src/objects/IDWmap.js":(t,e,i)=>{i.r(e),i.d(e,{IDWmap:()=>n});var a=i("@uino/thing"),r=i("./src/common/Utils.js");class n extends a.Object3D{static className="IDWmap";constructor(t={}){super(t),this._isLonlat=r.Utils.parseValue(t.isLonlat,!1),this.init(t)}init(t){const e=t.geometry;delete t.geometry,this._params=r.Utils.cloneObject(t,!1);const i=r.Utils.cloneObject(t,!1);e&&(i.geometry=e,this._params.geometry=e),i.renderer=this.app.view._renderer,i.radius=this._radius=r.Utils.parseValue(t.radius,10),this._mask=t.mask,this._factor=1;const n=e=>{i.data=e,this._params.data=e;const n=r.Utils.parseData(this._params.data);if(t.mask)if(t.mask.points){let e=[...new Set(t.mask.points.map((t=>t[0])))],i=[...new Set(t.mask.points.map((t=>t[1])))],r=a.Math.min(...e),s=a.Math.max(...e),o=a.Math.min(...i),l=a.Math.max(...i);n.minX=r,n.minY=o,n.maxX=s,n.maxY=l}else if(this._isLonlat){const e=THING.EARTH.Utils.getPolygonExtent(t.mask);n.minX=e.minX,n.minY=e.minY,n.maxX=e.maxX,n.maxY=e.maxY}if(t.extent&&(n.minX=t.extent.minX,n.minY=t.extent.minY,n.maxX=t.extent.maxX,n.maxY=t.extent.maxY),n.minX===n.maxX)return void r.Utils.warn("since the minimumX and maximumX values are the same, please checkout data or extent.");if(n.minY===n.maxY)return void r.Utils.warn("since the minimumY and maximumY values are the same, please checkout data or extent.");let s;if(r.Utils.isNull(t.minValue)&&(i.minValue=n.minZ),r.Utils.isNull(t.maxValue)&&(i.maxValue=n.maxZ),i.extent={minX:n.minX,maxX:n.maxX,minY:n.minY,maxY:n.maxY},t.isLonlat){const t=this._processLonlatData(n,this.data);i.geometry=t.geometry,i.data=t.data,i.width=t.width,i.height=t.height,this._factor=t.factor,r.Utils.isNull(this._radius)||(i.radius=this._radius*this._factor),i.originPoint=[0,0],i.range=[i.width,i.height],s=t.transform}else{const t=n.maxX-n.minX,e=n.maxY-n.minY;i.width=t,i.height=e,i.range=[t,e]}const o=r.Utils.createObject("IDWLayerNode",{external:{uScene:this.node._uScene,param:i}});this._node=o,this.body.setNode(o),this._isLonlat&&s&&(this.matrix=s.matrix),this.onLoadComplete()};if(t.url){const e=t=>{r.Utils.error(t)};t.url.endsWith("bin")?r.Utils.loadBinaryFile(t.url,(t=>{let e=ExtendUtils.readFieldDataBuffer(t.data);e=ExtendUtils.processFieldDataBufferData(e),n(e)}),null,(t=>{e(t)})):t.url.endsWith("json")?r.Utils.loadJSONFile(t.url,(t=>{n(t.data)}),null,(t=>{e(t)})):r.Utils.loadTextFile(t.url,(t=>{const e=THING.Utils.processFieldDataString(t.data);n(e)}),null,(t=>{e(t)}))}else n(t.data)}_onLoadResource(){}_processLonlatData(t,e){const i=this._createVertexData(t),a=i.vertexData,r=i.transform,n=[t.maxX,t.maxY],s=[t.minX,t.minY],o=[t.maxX,t.minY],l=THING.EARTH.Utils.getSphericalDistance(o,s),h=2048,u=h*THING.EARTH.Utils.getSphericalDistance(n,o)/l,d=h/(t.maxX-t.minX),m=u/(t.maxY-t.minY),c=(t.minX+t.maxX)/2,p=(t.minY+t.maxY)/2,_=[];return e.forEach((e=>{if(e[0]>=t.minX&&e[0]<=t.maxX&&e[1]>=t.minY&&e[1]<=t.maxY){let t=e[0]-c,i=e[1]-p;t*=d,i*=m,_.push([t,i,e[2]])}})),{width:h,height:u,transform:r,data:_,geometry:a,factor:m}}_createVertexData(t){const e=[(t.minX+t.maxX)/2,(t.minY+t.maxY)/2];let i,a;if(i="3D"===THING.EARTH.Utils.getEarthMode()?new THING.EARTH.Transform({position:THING.EARTH.Utils.convertLonlatToWorld(e,0)}):new THING.EARTH.Transform2D({position:THING.EARTH.Utils.convertLonlatToWorld(e,0)}),this._mask){const e=r.Utils._processGeojson(this._mask,"POLYGON");a=r.Utils.getCurrentApp().map._combineEngine._earthInstance.createPolygonGeometryData(e,i,0,null,0,t,!1,null,!1),a=a.vertexData}else a=r.Utils.getCurrentApp().map._combineEngine._earthInstance.createRectangleGeometry(t,!1,0,i,0,null);return a=THING.EARTH.Utils._mergePolygonVertexData(a),this._geoVertexData=a.top,{vertexData:this._geoVertexData,transform:i}}setData(t){this._node.updateData(t)}get data(){return this._params.data}set data(t){this._params.data=t,this.setData(t)}get mask(){return this._mask}set mask(t){this._params.mask=t,this.init(this._params)}set exponent(t){this._params.exponent=t,this._node.exponent=t}get exponent(){return this._params.exponent}set radius(t){this._params.radius=this._radius=t,this._node.radius=t*this._factor}get radius(){return this._radius}set isoline(t){this._params.isoline=this._node.isolineCheck=t}get isoline(){return this._params.isoline}set auxiliaryLine(t){this._params.auxiliaryLine=this._node.auxiliaryLine=t}get auxiliaryLine(){return this._params.auxiliaryLine}set minValue(t){this._node.minValue=t}get minValue(){return this._node.minValue}set maxValue(t){this._node.maxValue=t}get maxValue(){return this._node.maxValue}get gradient(){return this._node.gradient}set gradient(t){this._params.gradient=this._node.gradient=t}setIsoline(t,e){idwMaterial.uniforms.contourSpacingValue=t,idwMaterial.uniforms.lineThickness=e,this._node.drawTexture()}onUpdate(){this._node._mesh.material.diffuseMap=this._node.renderTarget.texture,this._node._mesh.material.needsUpdate=!0}onResize(t,e){super.onResize(t,e)}onDestroy(){super.onDestroy()}}},"./src/objects/Mosaic.js":(t,e,i)=>{i.r(e),i.d(e,{Mosaic:()=>r});var a=i("@uino/thing");class r{static className="Mosaic";constructor(t){this._enable=a.Utils.parseValue(t.enable,!0),this._size=a.Utils.parseValue(t.size,[1,1]),"number"==typeof this._size&&(this._size=[this._size,this._size]),this._object=t.object}toJSON(){return{enable:this._enable,size:this._size}}get enable(){return this._enable}set enable(t){this._enable=t,this._object.updateMosaic?this._object.updateMosaic(this._enable,this._size):a.Utils.warn("please implement function updateMosaic to update mosaic effect")}get size(){return this._size}set size(t){this._size=t,this._object.node.mosaicSize=t}}},"./src/objects/Streamline.js":(t,e,i)=>{i.r(e),i.d(e,{Streamline:()=>s});var a=i("@uino/thing"),r=i("./src/const.js"),n=i("./src/common/Utils.js");class s extends a.Object3D{static className="Streamline";constructor(t={}){super(t);const e=e=>{this._data=e,e.u.length>1&&!Array.isArray(e.u[0])&&e.dimX&&e.dimY&&e.dimZ&&(this._data.u=n.Utils.restoreArray(e.u,e.dimX,e.dimY,e.dimZ),this._data.v=n.Utils.restoreArray(e.v,e.dimX,e.dimY,e.dimZ),this._data.w=n.Utils.restoreArray(e.w,e.dimX,e.dimY,e.dimZ)),n.Utils.isNull(e.minX)||n.Utils.isNull(e.maxX)||n.Utils.isNull(e.minY)||n.Utils.isNull(e.maxY)||n.Utils.isNull(e.minZ)||n.Utils.isNull(e.maxZ)||(t.extent=this._extent={minX:e.minX,maxX:e.maxX,minY:e.minY,maxY:e.maxY,minZ:e.minZ,maxZ:e.maxZ}),t.extent&&(this._extent=t.extent),this._deltaX=(this._extent.maxX-this._extent.minX)/(e.u.length-1),this._deltaY=(this._extent.maxY-this._extent.minY)/(e.u[0].length-1),this._deltaZ=(this._extent.maxZ-this._extent.minZ)/(e.u[0][0].length-1),this._numLines=a.Utils.parseValue(t.numLines,5e3),this._gradient=a.Utils.parseValue(t.gradient,{0:"rgb(0,0,255)",.33:"rgb(0,255,0)",.66:"rgb(255,255,0)",1:"rgb(0,0,255)"}),this._speed=a.Utils.parseValue(t.speed,1),this._maxAge=a.Utils.parseValue(t.maxAge,100),this._renderType=a.Utils.parseValue(t.renderType,r.StreamlineRenderType.Streamline),this._useDataColor=a.Utils.parseValue(t.useDataColor,!0),this._imageUrl=t.imageUrl,this.init(t),this.app.addBeforeRenderCallback(this._onBeforeRenderCallback=()=>{this.onUpdate()}),this.onLoadComplete()};if(t.url){const i=t=>{a.Utils.error(t)};t.url.endsWith("bin")?a.Utils.loadBinaryFile(t.url,(t=>{let i=n.Utils.readFieldDataBuffer(t.data);i=n.Utils.processFieldDataBufferData(i),e(i)}),null,(t=>{i(t)})):t.url.endsWith("json")?a.Utils.loadJSONFile(t.url,(t=>{e(t.data)}),null,(t=>{i(t)})):a.Utils.loadTextFile(t.url,(t=>{const i=THING.Utils.processFieldDataString(t.data);e(i)}),null,(t=>{i(t)}))}else e(t.data)}_onLoadResource(){}onUpdate(){this.node.animate()}_getGridValue(t,e,i){const a=[];for(let r=0;r<(e-t)/i;r++)a.push(t+i*r);return a}init(t){let e,i,r,n,s,o;e=t.extent.minX,i=t.extent.minY,s=t.extent.minZ,r=t.extent.maxX,n=t.extent.maxY,o=t.extent.maxZ;let l=this._getGridValue(e,r,this._deltaX),h=this._getGridValue(i,n,this._deltaY),u=this._getGridValue(s,o,this._deltaZ);this._gridData={x:l,y:h,z:u},a.Utils.isNull(t.minValue)||a.Utils.isNull(t.maxValue)||(this._minValue=t.minValue,this._maxValue=t.maxValue),this._extent={minX:e,minY:i,minZ:s,maxX:r,maxY:n,maxZ:o};const d=THING.Utils.createObject("StreamlinesNode",{external:{uScene:this.node._uScene,param:{bounds:this._extent,min:this._minValue,max:this._maxValue,data:this._data,numLines:this._numLines,speed:this._speed,maxAge:this._maxAge,gradient:this._gradient,renderType:this._renderType,imageUrl:this._imageUrl,useDataColor:this._useDataColor}}});this._minValue=d.min,this._maxValue=d.max,this._scalarData=d.velocity,this.body.setNode(d)}playLineGrow(t){this.stopPlayLineGrow(),(t=a.Utils.parseValue(t,{})).speed=a.Utils.parseValue(t.speed,2),t.repeatX=a.Utils.parseValue(t.repeatX,1);const e=this.node._node.children[0].material[0];e.uniforms.useAlphaMap=!0;const i=this.node._generateHalfTexture();i.wrapS=i.wrapT=THING.T3D.TEXTURE_WRAP.REPEAT,e.uniforms.alphaMap=i,e.uniforms.alphaMapRepeat=.5,e.uniforms.alphaMapOffset=.5,e.needsUpdate=!0;let r=0,n=t.speed;this.on("update",(()=>{if(r+=n/500,t.loopType)t.loopType===a.LoopType.PingPong?t.speed>0?r>.5?(r=.5,n*=-1):r<0&&(r=0,n*=-1):r<-.5?(r=-.5,n*=-1):r>0&&(r=0,n*=-1):r>1&&(r=0);else if(r>.5||r<-.5)return e.uniforms.alphaMapOffset=.5,this.off("update",null,"streamlineGrow"),void this.app.trigger("StreamlineGrowEnd",{object:this});e.uniforms.alphaMapOffset=-r}),"streamlineGrow")}stopPlayLineGrow(){this.off("update",null,"streamlineGrow")}_clone3DArray(t){return t.map((function(t){return t.map((function(t){return t.slice()}))}))}get renderType(){return this._renderType}get maxAge(){return this._maxAge}get gradient(){return this._gradient}set gradient(t){JSON.stringify(t)!==JSON.stringify(this._gradient)&&(this.node.gradient=t,this._gradient=t)}get numLines(){return this._numLines}get data(){return this._data}get scalarData(){return this._scalarData}get minValue(){return this._minValue}get maxValue(){return this._maxValue}get extent(){return this._extent}get useDataColor(){return this._useDataColor}set useDataColor(t){this.node.useDataColor=t}get speed(){return this._speed}set speed(t){this.node.speed=t,this._speed=t}get imageUrl(){return this._imageUrl}set imageUrl(t){this.node.imageUrl=t,this._imageUrl=t}get gridData(){return this._gridData}onDestroy(){this.app.removeBeforeRenderCallback(this._onBeforeRenderCallback),super.onDestroy()}}},"./src/objects/VectorField.js":(t,e,i)=>{i.r(e),i.d(e,{VectorField:()=>n});var a=i("@uino/thing"),r=i("./src/common/Utils.js");class n extends a.Object3D{static className="VectorField";constructor(t={}){super(t);var e=this.app.view._renderer;this._isLonlat=a.Utils.parseValue(t.isLonlat,!1),this._extent=t.extent,this._numParticles=a.Utils.parseValue(t.numParticles,1e4),this._speed=a.Utils.parseValue(t.speed,1),this._inverseY=a.Utils.parseValue(t.inverseY,!1),this._inverseX=a.Utils.parseValue(t.inverseX,!1),this._offsetHeight=a.Utils.parseValue(t.offsetHeight,0),this._fadeOpacity=a.Utils.parseValue(t.fadeOpacity,.996);const i=i=>{let r;this._data=i,this._extent||(this._extent={minX:this._data.minX,maxX:this._data.maxX,minY:this._data.minY,maxY:this._data.maxY}),this._width=this._extent.maxX-this._extent.minX,this._height=this._extent.maxY-this._extent.minY,r=this._isLonlat?this._createVertexData(this._extent):new THING.T3D.PlaneGeometry(this._width,this._height);const n=a.Utils.createObject("UWindLayerNode",{external:{fadeOpacity:this._fadeOpacity,extent:this._extent,uScene:this.node._uScene,geometry:r,vertexData:t.vertexData,renderer:e,speedFactor:this._speed,circleMapUrl:t.circleMapUrl,pointSize:void 0===t.pointSize?3:t.pointSize,gradient:void 0===t.gradient?{0:"rgb(255,255,255)",1:"rgb(255,255,255)"}:t.gradient,numParticles:this._numParticles}});this._node=n,this.body.setNode(n),this._data&&this.setData(this._data),this.on("update",(()=>{this._data&&this.onUpdate()}),"updateVectorField"),this.onLoadComplete()};if(t.url){const e=t=>{a.Utils.error(t)};t.url.endsWith("bin")?a.Utils.loadBinaryFile(t.url,(t=>{let e=r.Utils.readFieldDataBuffer(t.data);e=r.Utils.processFieldDataBufferData(e),i(e)}),null,(t=>{e(t)})):t.url.endsWith("json")?a.Utils.loadJSONFile(t.url,(t=>{i(t.data)}),null,(t=>{e(t)})):a.Utils.loadTextFile(t.url,(t=>{const e=THING.Utils.processFieldDataString(t.data);i(e)}),null,(t=>{e(t)}))}else i(t.data)}_onLoadResource(){}_createVertexData(t){return new THING.EARTH.GeoPolygon({coordinates:[[[t.minX,t.minY],[t.minX,t.maxY],[t.maxX,t.maxY],[t.maxX,t.minY],[t.minX,t.minY]]],useLocalPosition:!1,parent:null,useMercatorUV:!1,offsetHeight:this.offsetHeight}).children[0].node._node.geometry}get extent(){return this._extent}get numParticles(){return this._numParticles}set numParticles(t){this._numParticles=t,this._node.numParticles=t}get fadeOpacity(){return this._node.fadeOpacity}set fadeOpacity(t){this._node.fadeOpacity=t}get speed(){return this._speed}set speed(t){this._speed=this._node.speedFactor=t}get dropRate(){return this._node.dropRate}set dropRate(t){this._node.dropRate=t}get dropRateBump(){return this._node.dropRateBump}set dropRateBump(t){this._node.dropRateBump=t}get rttResolution(){return this._node.rttResolution}set rttResolution(t){this._node.rttResolution=t}set pointSize(t){t<0&&a.Utils.warn("pointSize can not less than zero"),this._node.pointSize=t}get pointSize(){return this._node.pointSize}set gradient(t){this._node.gradient=t}get gradient(){return this._node.gradient}getRenderTexture(){return this._node.renderTarget2.texture}onUpdate(){this._node.draw(),this._node._mesh.material.diffuseMap=this._node.renderTarget2.texture,this._node._mesh.material.needsUpdate=!0,this._node._mesh.material.transparent=!0}setData(t){this._data=t;const e=this._parseData(t);this._node.setWind(e)}_parseData(t){const e=t.u,i=t.v;e.minimum=i.minimum=1/0,e.maximum=i.maximum=-1/0;const a=t.dimX,r=t.dimY;for(let t=0;t<r;t++)for(let r=0;r<a;r++){const n=t*a+(r+a/2)%a;e[n]<e.minimum&&(e.minimum=e[n]),e[n]>e.maximum&&(e.maximum=e[n]),i[n]<i.minimum&&(i.minimum=i[n]),i[n]>i.maximum&&(i.maximum=i[n])}const n=new Uint8Array(a*r*4);let s=1,o=1;this._inverseX&&(s=-s),this._inverseY&&(o=-o);for(let t=0;t<r;t++)for(let r=0;r<a;r++){const l=4*(t*a+r),h=t*a+(r+a/2)%a;n[l+0]=s*Math.floor(255*(e[h]-e.minimum)/(e.maximum-e.minimum)),n[l+1]=o*Math.floor(255*(i[h]-i.minimum)/(i.maximum-i.minimum)),n[l+2]=0,n[l+3]=255}return{data:n,width:a,height:r,uMin:e.minimum,uMax:e.maximum,vMin:i.minimum,vMax:i.maximum}}destroy(){this.off("update",null,"updateVectorField"),super.destroy()}dispose(){this._node.dispose()}copy(t){this._node.copy(t)}}},"./src/objects/VolumeRendering.js":(t,e,i)=>{i.r(e),i.d(e,{VolumeRendering:()=>l});var a=i("@uino/thing"),r=i("./src/common/Utils.js"),n=[],s=[],o=[];class l extends a.Object3D{static className="VolumeRendering";constructor(t={}){super(t);var e=this.app.view._renderer;t.renderer=e,t.camera=this.app.camera;let i=t.textureResolution;this._flipY=a.Utils.parseBoolean(t.flipY,!0),this._needsToFillingBlankData=a.Utils.parseBoolean(t.needsToFillingBlankData,!0);const n=e=>{if(t.textureUrl)this._textureUrl=t.textureUrl,i=a.Utils.parseValue(t.textureResolution,[128,128,16]),this._zsliceNum=i[2],this._textureSize=[i[0],i[1]],t.cubeTexUrl=this._textureUrl,t.extent=a.Utils.parseValue(t.extent,{minX:-1,maxX:1,minY:-1,maxY:1,minZ:-1,maxZ:1});else if(e){let n,s,o,l,h,u,d,m,c,p,_;if(e.data?this._data=e.data:this._data=e,t.gridData?(d=t.gridData.x,m=t.gridData.y,c=t.gridData.z):(d=[...new Set(this._data.map((t=>t[0])))],m=[...new Set(this._data.map((t=>t[1])))],c=[...new Set(this._data.map((t=>t[2])))]),t.extent?(n=t.extent.minX,s=t.extent.minY,h=t.extent.minZ,o=t.extent.maxX,l=t.extent.maxY,u=t.extent.maxZ):(n=r.Utils.getMin(d),o=r.Utils.getMax(d),s=r.Utils.getMin(m),l=r.Utils.getMax(m),h=r.Utils.getMin(c),u=r.Utils.getMax(c)),a.Utils.isNull(t.minValue)||a.Utils.isNull(t.maxValue)){const t=[...new Set(this._data.map((t=>t[3])))];p=r.Utils.getMin(t),_=r.Utils.getMax(t)}else p=t.minValue,_=t.maxValue;if(i&&Array.isArray(i)&&3===i.length)this._zsliceNum=i[2],this._textureSize=i[0];else{let t=this._nextPowerOfTwo(Math.min(d.length,m.length));this._textureSize=a.Utils.parseValue(this._textureSize,Math.min(128,t));let e=this._nextPowerOfTwoAndPerfectSquareNumber(c.length);this._zsliceNum=a.Utils.parseValue(this._zsliceNum,Math.min(16,e))}d.length<this._textureSize&&(o=(o-n)*this._textureSize/d.length+n),m.length<this._textureSize&&(l=(l-s)*this._textureSize/m.length+s);const f=this._convert3DTexture(this._data,this._textureSize,this._textureSize,this._zsliceNum,p,_,d,m,c,this._flipY,h,u,n,s,o,l);t.cubeTexData=f,t.extent={minX:n,minY:s,minZ:h,maxX:o,maxY:l,maxZ:u}}let n;if(this._extent=t.extent,t.textureSize=this._textureSize,t.zsliceNum=this._zsliceNum,t.isLonlat){const e=this._createVertexData(this._extent);t.vertexData=e.vertexData,n=e.transform}t.uniformBox=!t.isLonlat,t.minPos=[t.extent.minX,t.extent.minY,t.extent.minZ],t.maxPos=[t.extent.maxX,t.extent.maxY,t.extent.maxZ],this._textureResolution=[this._textureSize,this._textureSize,this._zsliceNum];const s=a.Utils.createObject("VolumerenderNode",{external:{uScene:this.node._uScene,param:t}});this._node=s,this.body.setNode(s),n&&(this.matrix=n.matrix),this.app.addBeforeRenderCallback(this._onBeforeRenderCallback=()=>{this.onUpdate()}),this.onLoadComplete()};if(t.url){const e=t=>{a.Utils.error(t)};t.url.endsWith("bin")?a.Utils.loadBinaryFile(t.url,(t=>{let e=r.Utils.readFieldDataBuffer(t.data);e=r.Utils.processFieldDataBufferData(e),n(e)}),null,(t=>{e(t)})):t.url.endsWith("json")?a.Utils.loadJSONFile(t.url,(t=>{n(t.data)}),null,(t=>{e(t)})):a.Utils.loadTextFile(t.url,(t=>{const e=THING.Utils.processFieldDataString(t.data);n(e)}),null,(t=>{e(t)}))}else n(t.data)}_onLoadResource(){}_convert3DTexture(t,e,i,a,r,n,s,o,l,h,u,d,m,c,p,_){let f=Math.sqrt(a),x=Math.sqrt(a),g=e*f,y=i*x,v=new Array(l.length),w=new Array(l.length);if(l.length<=a){for(let e=0;e<l.length;e++)v[e]=t.filter((t=>t[2]===l[e]));w=this._interpolateHorizontalData(v,e,i,x,f,s.length,o.length,l.length,h,r,n,m,c,p,_)}else{let l=(d-u)/a;for(let e=0;e<a;e++)v[e]=t.filter((t=>t[2]>u+e*l-1e-6&&t[2]<=u+(e+1)*l+1e-6));w=this._interpolateHorizontalData(v,e,i,x,f,s.length,o.length,a,h,r,n,m,c,p,_)}return{width:g,height:y,data:w}}_interpolateHorizontalData(t,e,i,a,r,n,s,o,l,h,u,d,m,c,p){let _=e*r,f=new Uint8ClampedArray(_*(i*a)),x=(c-d)/e,g=(p-m)/i;for(let c=0;c<o;c++){let o={};for(let n=0;n<t[c].length;n++){const s=t[c][n],p=Math.ceil((s[0]-d)/x),y=Math.ceil((s[1]-m)/g);let v;v=l?i-y-1:y;let w=p+c%a*e+(v+parseInt(c/r)*i)*_;void 0===o[p+"_"+y]?o[p+"_"+y]=s[3]:o[p+"_"+y]=(s[3]+o[p+"_"+y])/2;const b=255*(o[p+"_"+y]-h)/(u-h);f[w]=b}this._needsToFillingBlankData&&this._fillinBlankData(o,e,i,f,l,r,a,c,_,h,u,n,s)}return f}_fillinBlankData(t,e,i,r,n,s,o,l,h,u,d,m,c){for(let p=0;p<m;p++)for(let _=0;_<c;_++){let f=p+"_"+_;if(!t.hasOwnProperty(f)){let f=p-1+"_"+_,x=p+1+"_"+_,g=p+"_"+(_+1),y=p+"_"+(_-1),v=0,w=0;if(!a.Utils.isNull(t[f])&&p-1>=0&&v++,!a.Utils.isNull(t[x])&&p+1<=m&&v++,!a.Utils.isNull(t[g])&&_-1>=0&&w++,!a.Utils.isNull(t[y])&&_+1<=c&&w++,v>1||w>1){const m=(a.Utils.parseValue(t[f],0)+a.Utils.parseValue(t[x],0)+a.Utils.parseValue(t[g],0)+a.Utils.parseValue(t[y],0))/(w+v);let c;c=n?i-_-1:_;r[p+l%o*e+(c+parseInt(l/s)*i)*h]=255*(m-u)/(d-u)}}}}_nextPowerOfTwo(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}_nextPowerOfTwoAndPerfectSquareNumber(t){return t<=4?4:t<=16?16:t<=64?64:t<=256?256:t<=1024?1024:t}_createVertexData(t){const e=[(t.minX+t.maxX)/2,(t.minY+t.maxY)/2];let i;i="3D"===THING.EARTH.Utils.getEarthMode()?new THING.EARTH.Transform({position:THING.EARTH.Utils.convertLonlatToWorld(e,0)}):new THING.EARTH.Transform2D({position:THING.EARTH.Utils.convertLonlatToWorld(e,0)});const a=[];a[0]=[[[t.minX,t.minY],[t.maxX,t.minY],[t.maxX,t.maxY],[t.minX,t.maxY],[t.minX,t.minY]]];const r=t.maxZ-t.minZ,n={minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY},s=this.app.map._combineEngine._earthInstance.createPolygonGeometryData(a,i,0,null,r,n,!0,null,!0,!1,!0);return this._geoVertexData=s.vertexData[0],{vertexData:this._geoVertexData,transform:i}}get needsToFillingBlankData(){return this._needsToFillingBlankData}get clippingPlane(){return this._node._clippingPlane}set clippingPlane(t){this._node._clippingPlane=t,this._node._updataClipPlane(t)}get textureUrl(){return this._textureUrl}set textureUrl(t){this._textureUrl=t,this.node.cubeTex=t}get textureResolution(){return this._textureResolution}get extent(){return this._extent}get gradient(){return this._node.gradient}set gradient(t){this._node.gradient=t}get alphaCorrection(){return this._node.alphaCorrection}set alphaCorrection(t){this._node.alphaCorrection=t}get data(){return this._data}set data(t){this._data=t}onUpdate(){const t=THING.Math.mat4.fromValues(this.app.camera.matrix[0],this.app.camera.matrix[1],this.app.camera.matrix[2],this.app.camera.matrix[3],this.app.camera.matrix[4],this.app.camera.matrix[5],this.app.camera.matrix[6],this.app.camera.matrix[7],this.app.camera.matrix[8],this.app.camera.matrix[9],this.app.camera.matrix[10],this.app.camera.matrix[11],this.app.camera.matrix[12],this.app.camera.matrix[13],this.app.camera.matrix[14],this.app.camera.matrix[15]);THING.Math.mat4.getTranslation(n,t),THING.Math.mat4.getRotation(s,t),THING.Math.mat4.getScaling(o,t),this._node.rttcamera.position.set(n[0],n[1],n[2]),this._node.rttcamera.quaternion.set(s[0],s[1],s[2],s[3]),this._node.rttcamera.scale.set(o[0],o[1],o[2]),this._node.rttcamera.setPerspective(this.app.camera.fov*Math.PI/180,this.app.camera.aspect,this.app.camera.near,this.app.camera.far);const e=THING.Math.mat4.fromValues(this._body.matrixWorld[0],this._body.matrixWorld[1],this._body.matrixWorld[2],this._body.matrixWorld[3],this._body.matrixWorld[4],this._body.matrixWorld[5],this._body.matrixWorld[6],this._body.matrixWorld[7],this._body.matrixWorld[8],this._body.matrixWorld[9],this._body.matrixWorld[10],this._body.matrixWorld[11],this._body.matrixWorld[12],this._body.matrixWorld[13],this._body.matrixWorld[14],this._body.matrixWorld[15]);THING.Math.mat4.getTranslation(n,e),THING.Math.mat4.getRotation(s,e),THING.Math.mat4.getScaling(o,e),this._node._rttbox.position.set(n[0],n[1],n[2]),this._node._rttbox.quaternion.set(s[0],s[1],s[2],s[3]),this._node._rttbox.scale.set(o[0],o[1],o[2]),this._node.drawRttTexture(),this._node._mesh.material.uniforms.rtTexture=this._node.renderTarget.texture,this._node._mesh.material.needsUpdate=!0}onDestroy(){this.app.removeBeforeRenderCallback(this._onBeforeRenderCallback),super.onDestroy()}}},"./src/uNodes/Heatmap/Earcut.js":(t,e,i)=>{i.r(e),i.d(e,{Earcut:()=>a});const a={triangulate:function(t,e,i){i=i||2;const a=e&&e.length,o=a?e[0]*i:t.length;let l=r(t,0,o,i,!0);const h=[];if(!l||l.next===l.prev)return h;let u,c,p,f,x,g,y;if(a&&(l=function(t,e,i,a){const s=[];let o,l,h,u,c;for(o=0,l=e.length;o<l;o++)h=e[o]*a,u=o<l-1?e[o+1]*a:t.length,c=r(t,h,u,a,!1),c===c.next&&(c.steiner=!0),s.push(_(c));for(s.sort(d),o=0;o<s.length;o++)m(s[o],i),i=n(i,i.next);return i}(t,e,l,i)),t.length>80*i){u=p=t[0],c=f=t[1];for(let e=i;e<o;e+=i)x=t[e],g=t[e+1],x<u&&(u=x),g<c&&(c=g),x>p&&(p=x),g>f&&(f=g);y=Math.max(p-u,f-c),y=0!==y?1/y:0}return s(l,h,i,u,c,y),h}};function r(t,e,i,a,r){let n,s;if(r===function(t,e,i,a){let r=0;for(let n=e,s=i-a;n<i;n+=a)r+=(t[s]-t[n])*(t[n+1]+t[s+1]),s=n;return r}(t,e,i,a)>0)for(n=e;n<i;n+=a)s=S(n,t[n],t[n+1],s);else for(n=i-a;n>=e;n-=a)s=S(n,t[n],t[n+1],s);return s&&y(s,s.next)&&(U(s),s=s.next),s}function n(t,e){if(!t)return t;e||(e=t);let i,a=t;do{if(i=!1,a.steiner||!y(a,a.next)&&0!==g(a.prev,a,a.next))a=a.next;else{if(U(a),a=e=a.prev,a===a.next)break;i=!0}}while(i||a!==e);return e}function s(t,e,i,a,r,d,m){if(!t)return;!m&&d&&function(t,e,i,a){let r=t;do{null===r.z&&(r.z=p(r.x,r.y,e,i,a)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){let e,i,a,r,n,s,o,l,h=1;do{for(i=t,t=null,n=null,s=0;i;){for(s++,a=i,o=0,e=0;e<h&&(o++,a=a.nextZ,a);e++);for(l=h;o>0||l>0&&a;)0!==o&&(0===l||!a||i.z<=a.z)?(r=i,i=i.nextZ,o--):(r=a,a=a.nextZ,l--),n?n.nextZ=r:t=r,r.prevZ=n,n=r;i=a}n.nextZ=null,h*=2}while(s>1)}(r)}(t,a,r,d);let c,_,f=t;for(;t.prev!==t.next;)if(c=t.prev,_=t.next,d?l(t,a,r,d):o(t))e.push(c.i/i),e.push(t.i/i),e.push(_.i/i),U(t),t=_.next,f=_.next;else if((t=_)===f){m?1===m?s(t=h(n(t),e,i),e,i,a,r,d,2):2===m&&u(t,e,i,a,r,d):s(n(t),e,i,a,r,d,1);break}}function o(t){const e=t.prev,i=t,a=t.next;if(g(e,i,a)>=0)return!1;let r=t.next.next;for(;r!==t.prev;){if(f(e.x,e.y,i.x,i.y,a.x,a.y,r.x,r.y)&&g(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function l(t,e,i,a){const r=t.prev,n=t,s=t.next;if(g(r,n,s)>=0)return!1;const o=r.x<n.x?r.x<s.x?r.x:s.x:n.x<s.x?n.x:s.x,l=r.y<n.y?r.y<s.y?r.y:s.y:n.y<s.y?n.y:s.y,h=r.x>n.x?r.x>s.x?r.x:s.x:n.x>s.x?n.x:s.x,u=r.y>n.y?r.y>s.y?r.y:s.y:n.y>s.y?n.y:s.y,d=p(o,l,e,i,a),m=p(h,u,e,i,a);let c=t.prevZ,_=t.nextZ;for(;c&&c.z>=d&&_&&_.z<=m;){if(c!==t.prev&&c!==t.next&&f(r.x,r.y,n.x,n.y,s.x,s.y,c.x,c.y)&&g(c.prev,c,c.next)>=0)return!1;if(c=c.prevZ,_!==t.prev&&_!==t.next&&f(r.x,r.y,n.x,n.y,s.x,s.y,_.x,_.y)&&g(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(;c&&c.z>=d;){if(c!==t.prev&&c!==t.next&&f(r.x,r.y,n.x,n.y,s.x,s.y,c.x,c.y)&&g(c.prev,c,c.next)>=0)return!1;c=c.prevZ}for(;_&&_.z<=m;){if(_!==t.prev&&_!==t.next&&f(r.x,r.y,n.x,n.y,s.x,s.y,_.x,_.y)&&g(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function h(t,e,i){let a=t;do{const r=a.prev,n=a.next.next;!y(r,n)&&v(r,a,a.next,n)&&T(r,n)&&T(n,r)&&(e.push(r.i/i),e.push(a.i/i),e.push(n.i/i),U(a),U(a.next),a=t=n),a=a.next}while(a!==t);return n(a)}function u(t,e,i,a,r,o){let l=t;do{let t=l.next.next;for(;t!==l.prev;){if(l.i!==t.i&&x(l,t)){let h=A(l,t);return l=n(l,l.next),h=n(h,h.next),s(l,e,i,a,r,o),void s(h,e,i,a,r,o)}t=t.next}l=l.next}while(l!==t)}function d(t,e){return t.x-e.x}function m(t,e){if(e=function(t,e){let i=e;const a=t.x,r=t.y;let n,s=-1/0;do{if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const t=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=a&&t>s){if(s=t,t===a){if(r===i.y)return i;if(r===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!n)return null;if(a===s)return n;const o=n,l=n.x,h=n.y;let u,d=1/0;i=n;do{a>=i.x&&i.x>=l&&a!==i.x&&f(r<h?a:s,r,l,h,r<h?s:a,r,i.x,i.y)&&(u=Math.abs(r-i.y)/(a-i.x),T(i,t)&&(u<d||u===d&&(i.x>n.x||i.x===n.x&&c(n,i)))&&(n=i,d=u)),i=i.next}while(i!==o);return n}(t,e),e){const i=A(e,t);n(e,e.next),n(i,i.next)}}function c(t,e){return g(t.prev,t,e.prev)<0&&g(e.next,t,t.next)<0}function p(t,e,i,a,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-a)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function _(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function f(t,e,i,a,r,n,s,o){return(r-s)*(e-o)-(t-s)*(n-o)>=0&&(t-s)*(a-o)-(i-s)*(e-o)>=0&&(i-s)*(n-o)-(r-s)*(a-o)>=0}function x(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&v(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(T(t,e)&&T(e,t)&&function(t,e){let i=t,a=!1;const r=(t.x+e.x)/2,n=(t.y+e.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(a=!a),i=i.next}while(i!==t);return a}(t,e)&&(g(t.prev,t,e.prev)||g(t,e.prev,e))||y(t,e)&&g(t.prev,t,t.next)>0&&g(e.prev,e,e.next)>0)}function g(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function y(t,e){return t.x===e.x&&t.y===e.y}function v(t,e,i,a){const r=b(g(t,e,i)),n=b(g(t,e,a)),s=b(g(i,a,t)),o=b(g(i,a,e));return r!==n&&s!==o||(!(0!==r||!w(t,i,e))||(!(0!==n||!w(t,a,e))||(!(0!==s||!w(i,t,a))||!(0!==o||!w(i,e,a)))))}function w(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function b(t){return t>0?1:t<0?-1:0}function T(t,e){return g(t.prev,t,t.next)<0?g(t,e,t.next)>=0&&g(t,t.prev,e)>=0:g(t,e,t.prev)<0||g(t,t.next,e)<0}function A(t,e){const i=new M(t.i,t.x,t.y),a=new M(e.i,e.x,e.y),r=t.next,n=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,a.next=i,i.prev=a,n.next=a,a.prev=n,a}function S(t,e,i,a){const r=new M(t,e,i);return a?(r.next=a.next,r.prev=a,a.next.prev=r,a.next=r):(r.prev=r,r.next=r),r}function U(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function M(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}},"./src/uNodes/Heatmap/GeometryBuilderUtils.js":(t,e,i)=>{i.r(e),i.d(e,{GeometryBuilderUtils:()=>a});var a={convertShapeDataToEarcut:function(t,e,i){var a=t.contour,o=t.holes;if(r(a)||(a=a.reverse()),o)for(var l=0,h=o.length;l<h;l++){var u=o[l];r(u)&&(o[l]=u.reverse())}if(e=e||[],i=i||[],n(a),s(e,a),o){var d=a.length;o.forEach(n);for(l=0;l<o.length;l++)i.push(d),d+=o[l].length,s(e,o[l])}}};function r(t){return function(t){for(var e=t.length,i=0,a=e-1,r=0;r<e;a=r++)i+=t[a][0]*t[r][1]-t[r][0]*t[a][1];return.5*i}(t)<0}function n(t){var e=t.length;e>2&&function(t,e){if(t.length!==e.length)return!1;for(var i=0,a=t.length;i<a;i++)if(t[i]!==e[i])return!1;return!0}(t[e-1],t[0])&&t.pop()}function s(t,e){for(var i=0;i<e.length;i++)t.push(e[i][0]),t.push(e[i][1])}},"./src/uNodes/Heatmap/Heatmap2DMaterial.js":(t,e,i)=>{i.r(e),i.d(e,{Heatmap2DMaterial:()=>n});var a=i("@uino/thing-t3d");const r={uniforms:{transparentCheck:!1,grayTexture:null,colormap:null},vertexShader:"#include <common_vert>\n\tattribute vec2 a_Uv;\n\tvarying vec2 vUv;\n\t#include <logdepthbuf_pars_vert>\n\tvoid main(){\n\t\tvUv = a_Uv;\n\t\tgl_Position = u_Projection * u_View * u_Model * vec4(a_Position,1.0);\n\t\t#include <logdepthbuf_vert>\n\t}",fragmentShader:"precision highp float;\n\tuniform bool transparentCheck;\n\tuniform float u_Opacity;\n\tuniform sampler2D grayTexture;\n\tuniform sampler2D colormap;\n\tvarying vec2 vUv;\n\t#include <logdepthbuf_pars_frag>\n\t#include <fog_pars_frag>\n\tvec4 colorize(vec4 originColor,sampler2D colormap){float f1 =originColor.a;vec4 color2 = texture2D( colormap, vec2( f1,0.5) );vec3 tarcolor2 =color2.rgb;return vec4(tarcolor2,1.0);}\n\tvoid main(){\n\t\t#include <logdepthbuf_frag>\n\t\tvec4 color1 = texture2D( grayTexture, vUv);\n\t\tvec4 colorized = colorize(color1,colormap);\n\t\tfloat opacity = u_Opacity;\n\t\tif(transparentCheck){\n\t\t\topacity =  u_Opacity * color1.a *2.0;\n\t\t}\n\t\tgl_FragColor = vec4 (colorized.rgb,opacity);\n\t\t#include <fog_frag>\n\t}"};class n extends a.ShaderMaterial{static className="Heatmap2DMaterial";constructor(t){super({type:"2DheatmapMaterial",defines:{},uniforms:r.uniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.transparent=!0,this.side=a.DRAW_SIDE.DOUBLE,this.depthTest=!0,this._wireframe=t}set wireframe(t){t!==this._wireframe&&(this._wireframe=t,this.drawMode=t?a.DRAW_MODE.LINES:a.DRAW_MODE.TRIANGLES)}get wireframe(){return this._wireframe}}},"./src/uNodes/Heatmap/Heatmap3DMaterial.js":(t,e,i)=>{i.r(e),i.d(e,{Heatmap3DMaterial:()=>n});var a=i("@uino/thing-t3d");const r={uniforms:{tDiffuse:null,colormap:null,transparentCheck:null,extrudeHeight:1},vertexShader:"\n\t\t#include <common_vert>\n\t\t#include <logdepthbuf_pars_vert>\n\t\tattribute vec2 a_Uv;\n\t\tvarying vec2 vUV;\n\t\tvarying vec3 vNormal;\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform float max;\n\t\tuniform float min;\n\t\tuniform float extrudeHeight;\n\t\tvoid main() {\n\t\t\tvUV = a_Uv;\n\t\t\tmat4 normalMatrix = inverse(u_View * u_Model);\n\t\t\tnormalMatrix = transpose(normalMatrix);\n\t\t\tvec4 nor = normalMatrix * vec4(a_Normal, 1.0);\n\t\t\tvNormal = normalize( nor.xyz );\n\t\t\tfloat dv = texture2D( tDiffuse, vUV ).w;\n\t\t\tfloat df = extrudeHeight*dv;\n\t\t\tvec3 newPosition = vec3(a_Position.x,a_Position.y +df,a_Position.z);\n\t\t\tgl_Position =  u_Projection *  u_View * u_Model * vec4( newPosition, 1.0 );\n\t\t\t#include <logdepthbuf_vert>\n        }\n    ",fragmentShader:"\n\t\t#include <fog_pars_frag>\n\t\t#include <logdepthbuf_pars_frag>\n\n\t\tuniform sampler2D colormap;\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform float u_Opacity;\n\t\t// uniform vec3 color;\n\t\tuniform bool transparentCheck;\n\t\tvarying vec3 vNormal;\n\n\t\tvarying vec2 vUV;\n\t\tvec4 colorize(vec4 originColor,sampler2D colormap){float f1 =originColor.a;vec4 color2 = texture2D( colormap, vec2( f1,0.5) );vec3 tarcolor2 =color2.rgb;return vec4(tarcolor2,1.0);}\n\t\tvoid main(void) {\n\t\t\tvec4 color1 = texture2D( tDiffuse, vUV);\n\t\t\tvec4 colorized = colorize(color1,colormap);\n\t\t\tfloat opacity = u_Opacity;\n\t\t\tif(transparentCheck){\n\t\t\t\topacity =  u_Opacity * color1.a *2.0;\n\t\t\t}\n\t\t\tgl_FragColor = vec4 (colorized.rgb,opacity);\n\t\t\t#include <logdepthbuf_frag>\n\t\t\t#include <fog_frag>\n        }\n    "};class n extends a.ShaderMaterial{static className="Heatmap3DMaterial";constructor(t){super({type:"3DheatmapMaterial",defines:{},uniforms:r.uniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.transparent=!0,this.side=a.DRAW_SIDE.DOUBLE,this.depthTest=!0,this.color=[1,1,1],this._wireframe=t}set wireframe(t){t!==this._wireframe&&(this._wireframe=t,this.drawMode=t?a.DRAW_MODE.LINES:a.DRAW_MODE.TRIANGLES)}get wireframe(){return this._wireframe}}},"./src/uNodes/Heatmap/HeatmapGrayMaterial.js":(t,e,i)=>{i.r(e),i.d(e,{HeatmapGrayMaterial:()=>n});var a=i("@uino/thing-t3d");const r={uniforms:{radius:1,u_maxClick:1,u_minClick:1,u_sigma:.15},vertexShader:"#include <common_vert>\n\tattribute float strength;\n\tvarying float vStrength;\n\tuniform float radius;\n\tuniform float u_maxClick;\n\tuniform float u_minClick;\t\n\tvoid main(){\n\t\tgl_PointSize = radius *2. ;\n\t\tvStrength = strength;\t\t\n\t\tvec4 transformed = vec4(a_Position, 1.0);\n\t\tgl_Position = u_Projection * u_View * u_Model * transformed;\n\t}",fragmentShader:"precision highp float;\n\tvarying float vStrength;\n\tuniform float radius;\n\tuniform float u_maxClick;\n\tuniform float u_minClick;\n\tuniform float u_sigma;\n\tvoid main(){\n\t\tfloat dx = gl_PointCoord.x -0.5;\n\t\tfloat dy = 1.-gl_PointCoord.y -0.5;\n\t\tfloat SigmaSquare = u_sigma *u_sigma;//\n\t\t// SigmaSquare =0.025;\n\t\tfloat pxAlpha=0.0;\n\t\tif(u_maxClick>= vStrength && vStrength> u_minClick){\n\t\t\tpxAlpha = (vStrength-u_minClick)/(u_maxClick-u_minClick);\n\t\t}\n\t\tif(vStrength>= u_maxClick){\n\t\t\tpxAlpha = 1.0;\n\t\t}\n\t\tif(vStrength <0.1){\n\t\t\tpxAlpha = 0.1;\n\t\t}\n\t\t// float R = (dx*dx + dy*dy );  R<radius *radius? -6.* pow(R,5.)+15.*pow(R,4.)-10.*pow(R,3.):0.;//  \n\t\tfloat gaussianKernel = exp(-(dx*dx + dy*dy )/(2.*SigmaSquare ));\n\t\tgl_FragColor = vec4(0., 0.,0., pxAlpha* gaussianKernel );//\n\t}"};class n extends a.ShaderMaterial{static className="HeatmapGrayMaterial";constructor(){super({type:"HeatmapGrayMaterial",defines:{},uniforms:r.uniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.transparent=!0,this.drawMode=a.DRAW_MODE.POINTS,this.depthTest=!0,this.depthWrite=!1}}},"./src/uNodes/Heatmap/PointMosaicMaterial.js":(t,e,i)=>{i.r(e),i.d(e,{PointMosaicMaterial:()=>n});var a=i("@uino/thing-t3d");const r={uniforms:{color:[1,1,1],tDiffuse:null,texSize:[640,640],mosaicSize:[16,16],transparentCheck:!1,colormap:null},vertexShader:"\n\t\t#include <common_vert>\n\t\t#include <logdepthbuf_pars_vert> \n\t\tattribute vec2 a_Uv;\n\t\tvarying vec2 vUV;\n\t\tvoid main() {\n\t\t\tvUV = a_Uv;\n\t\t\tgl_Position = u_Projection * u_View * u_Model * vec4(a_Position,1.0);;\n\t\t\t#include <logdepthbuf_vert>\n\t\t}\n    ",fragmentShader:"\n\t\tuniform\tfloat u_Opacity;\n\t\t#include <logdepthbuf_pars_frag>\n\t\t#include <fog_pars_frag>\n\t\tvec4 colorize(vec4 originColor,sampler2D colormap){float f1 =originColor.a;vec4 color2 = texture2D( colormap, vec2( f1,0.5) );vec3 tarcolor2 =color2.rgb;return vec4(tarcolor2,1.0);}\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec2 texSize;\n\t\tuniform vec2 mosaicSize;\n\t\tuniform sampler2D colormap;\n\t\tuniform bool transparentCheck;\n\n\t\tuniform vec3 color;\n\t\tvarying vec2 vUV;\n\n\t\tvoid main(void) {\n\t\t\tvec4 originColor = texture2D(tDiffuse, vUV);\n\t\t\tfloat grayTextureAlhpa = originColor.a;\n\t\t\toriginColor = colorize(originColor,colormap);\n\t\t\t#include <logdepthbuf_frag>\n\t\t\tvec2 xy = vec2(vUV.x * texSize.x, vUV.y * texSize.y);\n\t\t\t\n\t\t\tvec2 xyMosaic = vec2(floor(xy.x / mosaicSize.x) * mosaicSize.x, floor(xy.y / mosaicSize.y) * mosaicSize.y )+ 0.5*mosaicSize;\n\t\t\n\t\t\tvec2 delXY = xyMosaic - xy;\n\t\t\tfloat delL = length(delXY);\n\t\t\t\n\t\t\tvec2 uvMosaic = vec2(xyMosaic.x / texSize.x, xyMosaic.y / texSize.y);\n\n\t\t\tfloat percent = smoothstep(0., 1., 1. - delL * 2.4 / mosaicSize.x) * 0.7 + 0.3;\n\n\t\t\tvec4 centerColor = texture2D(tDiffuse, uvMosaic);\n\t\t\tfloat mosaicOpacity = u_Opacity;\n\t\t\tif (transparentCheck) {\n\t\t\t\tmosaicOpacity = u_Opacity * grayTextureAlhpa * 1.2;//1.2transparentCheckfalse\n\t\t\t}\n\t\t\tcenterColor =  colorize(centerColor,colormap);\n\t\t\tif (mosaicOpacity < 0.0001) discard;\n\t\t\tvec4 resultColor = vec4(mix(originColor.rgb, centerColor.rgb, percent)*color,  percent * mosaicOpacity);\n\t\t\tgl_FragColor = resultColor;\n\t\t\t#include <fog_frag>\n\t\t}\n    "};class n extends a.ShaderMaterial{static className="PointMosaicMaterial";constructor(){super({type:"PointMosaic heatmap",defines:{},uniforms:r.uniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.transparent=!0,this.side=a.DRAW_SIDE.DOUBLE,this.depthTest=!0,this.color=[1,1,1],this._wireframe=!1}set wireframe(t){t!==this._wireframe&&(this._wireframe=t,this.drawMode=t?a.DRAW_MODE.LINES:a.DRAW_MODE.TRIANGLES)}get wireframe(){return this._wireframe}}},"./src/uNodes/Heatmap/PolygonBuilder.js":(t,e,i)=>{i.r(e),i.d(e,{PolygonBuilder:()=>n});var a=i("./src/uNodes/Heatmap/Earcut.js"),r=i("./src/uNodes/Heatmap/GeometryBuilderUtils.js"),n={getGeometryData:function(t){var e=[],i=[];r.GeometryBuilderUtils.convertShapeDataToEarcut(t,e,i);var n=a.Earcut.triangulate(e,i),s=[],o=[],l=[];for(let t=0,i=e.length;t<i;t+=2)s.push(e[t],0,e[t+1]),o.push(0,1,0),l.push(e[t],1-e[t+1]);return{positions:s,normals:o,uvs:l,indices:n}}}},"./src/uNodes/Heatmap/UHeatmapLayerNode.js":(t,e,i)=>{i.r(e),i.d(e,{UHeatmapLayerNode:()=>h});var a=i("@uino/thing-t3d"),r=i("./src/uNodes/Heatmap/PolygonBuilder.js"),n=i("./src/uNodes/Heatmap/Heatmap3DMaterial.js"),s=i("./src/uNodes/Heatmap/PointMosaicMaterial.js"),o=i("./src/uNodes/Heatmap/Heatmap2DMaterial.js"),l=i("./src/uNodes/Heatmap/HeatmapGrayMaterial.js");class h extends a.UNode{static className="UHeatmapLayerNode";constructor(t={}){super(t.external.uScene),this._colorRamp=null,this._renderer=null,this._params={},this._mesh=null,this._2DMaterial=null,this._3DMaterial=null,this._mosaicMaterial=null,this._pointGeometry=null,this._scaleRatio=1,this._renderer=t.external.param.renderer,this._initParameter(t.external.param),this._beforeSetup(),this._createNode(t.external.param),this._draw(),this.$markChildrenMatrixAutoUpdate(!1)}_beforeSetup(){var t=this._params.gradient,e=this._createCanvas();e.width=256,e.height=1,this._gradCtx=e.getContext("2d"),this._gradTexture=null,this._originalGrad=t,this._colorRamp=this._gradient(t);let{width:i,height:r}=this._setScaleRatio(this._params.areaWidth,this._params.areaHeight);this.scene1=new a.Scene,this.renderTarget1=new a.RenderTarget2D(i,r),this.renderTarget1.texture.minFilter=a.TEXTURE_FILTER.LINEAR,this.renderTarget1.texture.magFilter=a.TEXTURE_FILTER.LINEAR,this.renderTarget1.texture.encoding=a.TEXEL_ENCODING_TYPE.GAMMA,this.renderTarget1.texture.generateMipmaps=!1;var n=new a.Camera;n.position.set(0,0,10),n.updateMatrix(),n.lookAt(new a.Vector3(0,0,0),new a.Vector3(0,1,0)),n.setOrtho(i/-2,i/2,r/-2,r/2,.01,1e3),this.camera=n}_setScaleRatio(t,e){return t<=e&&t<512?(this._scaleRatio=512/t,e=512*e/t,t=512):e<t&&e<512&&(this._scaleRatio=512/e,t=512*t/e,e=512),{width:t,height:e}}_createPolygonGeometry(t){const e=new a.Geometry;t.index&&(e.index=new a.Attribute(new a.Buffer(t.index,1)));var i=new a.Buffer(t.position instanceof Float32Array?t.position:new Float32Array(t.position),3);i.usage=a.BUFFER_USAGE.DYNAMIC_DRAW,e.addAttribute("a_Position",new a.Attribute(i,3));var r=new a.Buffer(t.uv instanceof Float32Array?t.uv:new Float32Array(t.uv),2);r.usage=a.BUFFER_USAGE.DYNAMIC_DRAW,e.addAttribute("a_Uv",new a.Attribute(r,2));var n=new a.Buffer(t.uv instanceof Float32Array?t.uv:new Float32Array(t.uv),2);if(n.usage=a.BUFFER_USAGE.DYNAMIC_DRAW,e.addAttribute("a_Uv2",new a.Attribute(n,2)),t.normal){var s=new a.Buffer(t.normal instanceof Float32Array?t.normal:new Float32Array(t.normal),3);s.usage=a.BUFFER_USAGE.DYNAMIC_DRAW,e.addAttribute("a_Normal",new a.Attribute(s,3))}else a.GeometryUtils.computeNormals(e);return e}_createNode(t){var e=this._params.areaWidth,i=this._params.areaHeight;let n,s;if(void 0!==t.geometry)n=this._createPolygonGeometry(t.geometry);else if(t.mask||t.clipShape){const s=t.mask||t.clipShape,o=s.points||s.shape,l=r.PolygonBuilder.getGeometryData({contour:o,holes:s.holes});n=new a.Geometry;let h=l.uvs;for(let t=0;t<h.length/2;t++){let a=l.positions[3*t+0],r=l.positions[3*t+2];h[2*t+0]=(a+e/2)/e,h[2*t+1]=(r+i/2)/i}n.addAttribute("a_Position",new a.Attribute(new a.Buffer(new Float32Array(l.positions),3))),n.addAttribute("a_Normal",new a.Attribute(new a.Buffer(new Float32Array(l.normals),3))),n.addAttribute("a_Uv",new a.Attribute(new a.Buffer(new Float32Array(h),2))),n.setIndex(new a.Attribute(new a.Buffer(l.positions.length/3>65536?new Uint32Array(l.indices):new Uint16Array(l.indices),1)))}else if(n=new a.PlaneGeometry(e,i,this._params.mapSize,this._params.mapSize),this._params.extent){const t=(this._params.extent.maxX+this._params.extent.minX)/2,e=(this._params.extent.maxY+this._params.extent.minY)/2;for(let i=0;i<n.attributes.a_Position.buffer.count;i++)n.attributes.a_Position.buffer.array[3*i]+=t,n.attributes.a_Position.buffer.array[3*i+2]+=e,n.attributes.a_Uv.buffer.array[2*i+1]=1-n.attributes.a_Uv.buffer.array[2*i+1]}s="mosaic"===t.type?this._createPointMosaicMaterial():"3Dheatmap"===t.type?this._3DMaterial=this._createHeat3DMaterial():this._2DMaterial=this._createHeatMaterial(),this._geometry=n,this._mesh||(this._mesh=new a.Mesh(this._geometry,s),this._mesh.geometry.computeBoundingSphere(),this._mesh.geometry.computeBoundingBox(),this._mesh.userData.skipEnvMap=!0,this._mesh.matrixAutoUpdate=!0,this._mesh.material.needsUpdate=!0,this._mesh.userData.skipOutline=!0,this._node.add(this._mesh))}_updateGeometry(t){if("3Dheatmap"!==this._params.type||this._params.mask){const e=this._createPolygonGeometry(t);this._geometry=e,this._mesh.geometry=e}else this.updateSubBuffer("position",t.position),this.updateSubBuffer("normal",t.normal)}_initParameter(t){this._params.extent=t.extent,this._params.areaWidth=THING.Utils.parseValue(t.width,10),this._params.areaHeight=THING.Utils.parseValue(t.height,10),this._params.mapSize=THING.Utils.parseValue(t.mapSize,256),this._params.alpha=!!t.alpha;var e=THING.Utils.parseValue(t.gradient,{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"});this._params.isLonlat=!!t.geometry,this._params.gradient=e,this._params.minValue=void 0!==t.minValue?t.minValue:10,this._params.maxValue=void 0!==t.maxValue?t.maxValue:50,this._params.radius=THING.Utils.parseValue(t.radius,5),this._params.data=THING.Utils.parseValue(t.data,[]),this._params.mosaicSize=THING.Utils.parseValue(t.mosaicSize,[1,1]),"number"==typeof this._params.mosaicSize&&(this._params.mosaicSize=[this._params.mosaicSize,this._params.mosaicSize]),this._params.extrudeHeight=THING.Utils.parseValue(t.extrudeHeight,1),this._params.type=THING.Utils.parseValue(t.type,"heatmap"),this._params.sigma=THING.Utils.parseValue(t.sigma,.158),this._params.mask=t.mask,this._params.extent=t.extent}_updateWidthHeightAndData(t){this._params.areaWidth=t.width,this._params.areaHeight=t.height,this.renderTarget1.resize(t.width,t.height),this.camera.setOrtho(this._params.areaWidth/-2,this._params.areaWidth/2,this._params.areaHeight/-2,this._params.areaHeight/2,.01,1e3),this._params.data=t.data,this._draw()}_draw(){let t=this._params;this._createRTTMesh();const e=this._params.extent.maxX-this._params.extent.minX,i=this._params.extent.maxY-this._params.extent.minY;"mosaic"===t.type?this._mesh.material.uniforms.mosaicSize?(this._mesh.material.uniforms.texSize=[e,i],this._mesh.material.uniforms.mosaicSize=this._params.mosaicSize):(this._setMaterial(t),this._mesh.material.uniforms.texSize=[e,i],this._mesh.material.uniforms.mosaicSize=this._params.mosaicSize):"3Dheatmap"===t.type?this._mesh.material.uniforms.extrudeHeight?(this._mesh.material.uniforms.tDiffuse=this.renderTarget1.texture,this._mesh.material.uniforms.extrudeHeight=this._params.extrudeHeight,this._mesh.material.needsUpdate=!0):(this._setMaterial(t),this._mesh.material.uniforms.extrudeHeight=this._params.extrudeHeight):((this._mesh.material.uniforms.extrudeHeight||this._mesh.material.uniforms.mosaicSize)&&this._setMaterial(t),this._mesh.material.uniforms.grayTexture=this.renderTarget1.texture,this._mesh.material.needsUpdate=!0),this._mesh.material.uniforms.transparentCheck=this._params.alpha,this._mesh.material.uniforms.colormap=this._colorRamp,this.scene1.updateMatrix(),this.scene1.updateRenderStates(this.camera),this.scene1.updateRenderQueue(this.camera),this._update()}_createRTTMesh(){let t=this._params.data;if(t&&t.length){if(THING.Utils.isNull(this._pointGeometry)){const i=new a.Geometry,r=[];for(let e=0;e<t.length;e++)this._params.isLonlat?(r.push(t[e][0]),r.push(t[e][1]),r.push(0),r.push(t[e][2])):(r.push((t[e][0]-(this._params.extent.maxX+this._params.extent.minX)/2)*this._scaleRatio),r.push((t[e][1]-(this._params.extent.maxY+this._params.extent.minY)/2)*this._scaleRatio),r.push(0),r.push(t[e][2]));var e=new a.Buffer(new Float32Array(r),4);e.usage=a.BUFFER_USAGE.DYNAMIC_DRAW;const n=new a.Attribute(e,3,0);i.addAttribute("a_Position",n);const s=new a.Attribute(e,1,3);i.addAttribute("strength",s),this._pointGeometry=i}else this._updatePointGeo(t);if(THING.Utils.isNull(this._pointMaterial)&&(this._pointMaterial=this._createGrayMaterial()),0===this.scene1.children.length){const t=new a.Mesh(this._pointGeometry,this._pointMaterial);this.scene1.add(t),this.scene1.add(this.camera)}else this.scene1.children[0].geometry=this._pointGeometry,this.scene1.children[0].material.needsUpdate=!0,this.scene1.children[0].material.uniforms.radius=this._params.radius*this._scaleRatio,this.scene1.children[0].material.uniforms.u_minClick=this._params.minValue,this.scene1.children[0].material.uniforms.u_maxClick=this._params.maxValue}}_setMaterial(t){let e;"mosaic"===t.type?(this._mosaicMaterial||(this._mosaicMaterial=new s.PointMosaicMaterial),this._mosaicMaterial.uniforms.tDiffuse=this.renderTarget1.texture,e=this._mosaicMaterial):"3Dheatmap"===t.type?(this._3DMaterial||(this._3DMaterial=new n.Heatmap3DMaterial),this._3DMaterial.uniforms.tDiffuse=this.renderTarget1.texture,this._3DMaterial.uniforms.transparentCheck=this._params.alpha,this._3DMaterial.uniforms.extrudeHeight=this._params.extrudeHeight,e=this._3DMaterial):(this._2DMaterial.uniforms.grayTexture=this.renderTarget1.texture,e=this._2DMaterial),e.uniforms.colormap=this._colorRamp,this._mesh.material=e,this._mesh.material.needsUpdate=!0}_createPointMosaicMaterial(){const t=new s.PointMosaicMaterial;return t.uniforms.tDiffuse=this.renderTarget1.texture,t.uniforms.colormap=this._colorRamp,t.uniforms.transparentCheck=this._params.alpha,t}_createGrayMaterial(){const t=new l.HeatmapGrayMaterial;return t.uniforms.radius=this._params.radius*this._scaleRatio,t.uniforms.u_maxClick=this._params.maxValue,t.uniforms.u_minClick=this._params.minValue,t.uniforms.u_sigma=this._params.sigma,t}_createHeatMaterial(){let t={transparentCheck:this._params.alpha,grayTexture:this.renderTarget1.texture,colormap:this._colorRamp},e=new o.Heatmap2DMaterial;for(let i in t)e.uniforms[i]=t[i];return e}_createHeat3DMaterial(){let t=new n.Heatmap3DMaterial;return t.uniforms.tDiffuse=this.renderTarget1.texture,t.uniforms.extrudeHeight=this._params.extrudeHeight,t.uniforms.transparentCheck=this._params.alpha,t.uniforms.colormap=this._colorRamp,t}_getGradientCode(t){var e="grad:(";for(var i in t)e+=i+":"+t[i]+",";return e+=")"}_gradient(t){if(this._getGradientCode(this._originalGrad)===this._getGradientCode(t)&&!THING.Utils.isNull(this._gradTexture))return this._gradTexture;var e=this._gradCtx.createLinearGradient(0,0,256,0);for(var i in t)e.addColorStop(+i,t[i]);this._gradCtx.fillStyle=e,this._gradCtx.fillRect(0,0,256,1);var r=new a.Texture2D;return r.image=this._gradCtx.canvas,r.version++,this._gradTexture=r,r}_createCanvas(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}addData(t){this._params.data.push(t);const e=this._params.data;this.setData(e)}setData(t){this._params.data=t,this._params.extent.maxX=-1/0,this._params.extent.minX=1/0,this._params.extent.maxY=-1/0,this._params.extent.minY=1/0;for(let e=0;e<t.length;e++)t[e][0]>this._params.extent.maxX&&(this._params.extent.maxX=t[e][0]),t[e][0]<this._params.extent.minX&&(this._params.extent.minX=t[e][0]),t[e][1]>this._params.extent.maxY&&(this._params.extent.maxY=t[e][1]),t[e][1]<this._params.extent.minY&&(this._params.extent.minY=t[e][1]);this._params.areaWidth=this._params.extent.maxX-this._params.extent.minX,this._params.areaHeight=this._params.extent.maxY-this._params.extent.minY;let{width:e,height:i}=this._setScaleRatio(this._params.areaWidth,this._params.areaHeight);this.renderTarget1.resize(e,i),this.camera.setOrtho(e/-2,e/2,i/-2,i/2,.01,1e3),this._draw()}setAlpha(t){this._params.alpha=t,this._draw()}get transparent(){return this._params.alpha}set transparent(t){this._params.alpha=t,"mosaic"!==this._params.type?this._mesh.material&&this._mesh.material.uniforms&&(this._mesh.material.uniforms.transparentCheck=t):this._draw()}get radius(){return this._params.radius}set radius(t){this._params.radius=t,this.scene1.children.length>0&&(this.scene1.children[0].material.uniforms.radius=t*this._scaleRatio),this._draw()}get gradient(){return this._params.gradient}set gradient(t){this._params.gradient=t,this._colorRamp=this._gradient(t),this._originalGrad=t,this._draw()}get extrudeHeight(){return this._params.extrudeHeight}set extrudeHeight(t){this._params.extrudeHeight=t,"3Dheatmap"===this.type&&(this._mesh.material.uniforms.extrudeHeight=t)}get mosaicSize(){return this._params.mosaicSize}set mosaicSize(t){this._params.mosaicSize=t,this._mesh.material.uniforms.mosaicSize=this._params.mosaicSize}get type(){return this._params.type}set type(t){this._params.type!==t&&(this._params.type=t,this._setMaterial(this._params),this._mesh.material.needsUpdate=!1)}get minValue(){return this._params.minValue}set minValue(t){this._params.minValue=t}get maxValue(){return this._params.maxValue}set maxValue(t){this._params.maxValue=t}get data(){return this._params.data}set data(t){this._params.data=t}_update(){var t=this._renderer;t.setRenderTarget(this.renderTarget1),t.setClearColor(0,0,0,0),t.clear(!0,!0,!0),t.renderScene(this.scene1,this.camera)}getGrayTexture(){return this.renderTarget1.texture}refresh(){this._draw()}updateSubBuffer(t,e){switch(t){case"position":this._geometry.attributes.a_Position.buffer.array=e,this._geometry.attributes.a_Position.buffer.version++;break;case"normal":this._geometry.attributes.a_Normal.buffer.array=e,this._geometry.attributes.a_Normal.buffer.version++;break;case"uv":this._geometry.attributes.a_Uv.buffer.array=e,this._geometry.attributes.a_Uv.buffer.version++,this._geometry.attributes.a_Uv2.buffer.array=e,this._geometry.attributes.a_Uv2.buffer.version++;break;case"index":this._geometry.index.buffer.array=e,this._geometry.index.buffer.version++}}_updatePointGeo(t){const e=t,i=[],r=[];for(let t=0;t<e.length;t++)this._params.isLonlat?(i.push(e[t][0]),i.push(e[t][1]),i.push(0),r.push(e[t][2])):(i.push((e[t][0]-(this._params.extent.maxX+this._params.extent.minX)/2)*this._scaleRatio),i.push((e[t][1]-(this._params.extent.maxY+this._params.extent.minY)/2)*this._scaleRatio),i.push(0),r.push(e[t][2]));this._pointGeometry.attributes.a_Position.buffer=new a.Buffer(new Float32Array(i),3),this._pointGeometry.attributes.strength.buffer=new a.Buffer(new Float32Array(r),1),this._pointGeometry.attributes.a_Position.buffer.version++,this._pointGeometry.attributes.strength.buffer.version++,this._pointGeometry.version++}dispose(){this.renderTarget1.dispose(),this._colorRamp.dispose(),this._gradTexture.dispose(),this._mesh.geometry.dispose(),this._mesh.material.dispose(),this._mesh.geometry.attributes.a_Position.buffer.array=null,this._mesh.geometry.attributes.a_Uv.buffer.array=null,this._mesh.geometry.attributes.a_Normal.buffer.array=null,this._mesh.geometry.index.buffer.array=null,this._mesh.material.dispose(),super.dispose()}copy(t){return super.copy(t),this}}},"./src/uNodes/Heatmap/UIDWLayerNode.js":(t,e,i)=>{i.r(e),i.d(e,{UIDWLayerNode:()=>s});var a=i("@uino/thing-t3d"),r=i("./src/uNodes/Heatmap/PolygonBuilder.js"),n=new a.ShaderMaterial({defines:{},vertexShader:"    #include <common_vert>\n    precision mediump float;\n    attribute vec2 a_Uv;\n    varying vec2 v_Uv;\n    \n    void main() {\n        v_Uv = a_Uv;\n        vec4 position =vec4( a_Position.xyz, 1);\n        gl_Position = u_ProjectionView * u_Model * position;\n    }\n    ",fragmentShader:"    #include <common_frag>\n    precision mediump float;\n\tuniform float idw_distanceThreshold;\n\tuniform float idw_exponent;\n\tuniform float idw_linearFadeFactor;\n\tuniform float idw_minValue;\n\tuniform float idw_maxValue;\n\tuniform vec2 dataResolution;\n\tuniform vec2 originPoint;\n\tuniform float pointTextureSize;\n\tuniform sampler2D pointTexture;\n\tuniform sampler2D colorRampTexture;\n\tuniform int pointsNum;\n\tuniform bool isolineCheck;\n\tuniform float contourSpacingValue;\n\tuniform float lineThickness;\n\tuniform bool auxiliaryLine;\n\tvarying vec2 v_Uv;\n\n\tfloat isoline(float val, float lg, float ref, float pas, float thickness) {\n\t\t// thickness the thickness of the line;\n\t\t// pas   the Contour spacing value\n\t\t// ref   offset value,set to 0; \n\t\tfloat v = abs(mod(val - ref + pas * .5, pas) - pas * .5) / lg - .1 * thickness;\n\t\treturn smoothstep(.2, .8, v);\n\t}\n\tstruct Accumulator\n\t{\n\t\tfloat m_sumOfWeightedValues;\n\t\tfloat m_sumOfWeights;\n\t};\n\tfloat GetWeightedAverage(Accumulator acc)\n\t{\n\t\treturn acc.m_sumOfWeightedValues / acc.m_sumOfWeights;\n\t}\n\t\t\n\tvoid main() {\n\t\tfloat exactThreshold = 0.01; // if we are very close to a point then avoid a divide by zero and set to exact weight of the point\n\n\t\tAccumulator acc = Accumulator(0.0f,0.0f);\n\n\t\tvec2 st = (2.*v_Uv-1.)*0.5;\n\t\tvec2 fragCoord = st * dataResolution.xy;\n\t\tfloat interpolatedValue = 0.;\n\t\t\n\t\tfor (int i = 0; i < pointsNum; ++i) \n\t\t{\n\t\t\tfloat i_float = float(i);\n\t\t\tfloat j = i_float * 1.0;\n\t\t\tfloat x = mod( j, float( pointTextureSize ) );\n\t\t\tfloat y = floor( j / float( pointTextureSize ) );\n\n\t\t\tfloat dx = 1.0 / float( pointTextureSize );\n\t\t\tfloat dy = 1.0 / float( pointTextureSize );\n\n\t\t\ty = dy * ( y + 0.5 );\n\n\t\t\tvec4 pointSampler = texture2D( pointTexture, vec2( dx * ( x + 0.5 ), y ) );\n\n\t\t\tfloat dist = max(exactThreshold, length(fragCoord.xy  - pointSampler.xz));  \n\t\t\tif (dist < idw_distanceThreshold) \n\t\t\t{\n\n\t\t\t\tfloat weight = 1.0f / pow(dist, idw_exponent);\n\t\t\t\tweight *= (1.0f - idw_linearFadeFactor * (dist / idw_distanceThreshold));\n\n\t\t\t\tacc.m_sumOfWeights += weight;\n\t\t\t\tacc.m_sumOfWeightedValues += weight * pointSampler.w;\n\t\t\t}\n\t\t}\n\n\t\tinterpolatedValue = GetWeightedAverage(acc);\n\t\t// interpolatedValue = clamp(interpolatedValue, 0.0, 1.0);\n\n\t\tfloat lg = 2.*length(vec2(dFdx(interpolatedValue), dFdy(interpolatedValue)));\n\t\tfloat k1 = isoline(interpolatedValue, lg, .0, contourSpacingValue, lineThickness);\n\t\tfloat k2 = isoline(interpolatedValue, lg, .0, contourSpacingValue*0.1, .1*lineThickness);\n\t\t\n\t\t//normailize the interpolatedValue\n\t\tinterpolatedValue = (interpolatedValue- idw_minValue) /(idw_maxValue -idw_minValue+0.0000001);\n\t\t// color map the value\n\t\tvec3 col = texture2D( colorRampTexture, vec2( interpolatedValue, 0.5)).rgb;\n\t\t\n\t\t// apply isoline to color\n\t\tif(isolineCheck && lg>0.005){\n\t\t\tcol *= (.3+(k1*.7));\n\t\t\tif( auxiliaryLine ){ col *= (.7+(k2*.3)); }\n\t\t}\n\t\tgl_FragColor = vec4(col, u_Opacity);\n\t}\n\t\n\t",uniforms:{idw_exponent:2,idw_distanceThreshold:1,idw_linearFadeFactor:0,idw_minValue:1,idw_maxValue:10,pointTexture:null,colorRampTexture:null,pointTextureSize:1,pointsNum:1,isolineCheck:!1,dataResolution:[1,1],originPoint:[0,0],contourSpacingValue:10,lineThickness:1,auxiliaryLine:!0}});class s extends a.UNode{static className="UIDWLayerNode";constructor(t={}){super(t.external.uScene),this._mesh=null,this._exponent=THING.Utils.parseValue(t.external.param.exponent,2),this._radius=THING.Utils.parseValue(t.external.param.radius,100),this._minValue=THING.Utils.parseValue(t.external.param.minValue,0),this._maxValue=THING.Utils.parseValue(t.external.param.maxValue,1),this._width=THING.Utils.parseValue(t.external.param.width,10),this._height=THING.Utils.parseValue(t.external.param.height,10),this._isolineCheck=THING.Utils.parseValue(t.external.param.isoline,!1),this._auxiliaryLine=THING.Utils.parseValue(t.external.param.auxiliaryLine,!0),this._range=THING.Utils.parseValue(t.external.param.range,null),this._originPoint=THING.Utils.parseValue(t.external.param.originPoint,null);const e=THING.Utils.parseValue(t.external.param.data,[]);this._grad=THING.Utils.parseValue(t.external.param.gradient,{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"});var i=this._createCanvas();i.width=256,i.height=1,this._gradCtx=i.getContext("2d"),this._originalGrad=this._grad,this._gradTexture=this._gradient(this._grad),n.uniforms.colorRampTexture=this._gradTexture,n.uniforms.idw_exponent=this._exponent,n.uniforms.idw_minValue=this._minValue,n.uniforms.idw_maxValue=this._maxValue,n.uniforms.idw_distanceThreshold=this._radius,n.uniforms.isolineCheck=this._isolineCheck,n.uniforms.auxiliaryLine=this._auxiliaryLine,this.rttscene=new a.Scene,this.rttcamera=new a.Camera,this.rttcamera.position.set(0,1,0),this.rttcamera.lookAt(new a.Vector3(0,0,0),new a.Vector3(0,0,-1)),this.rttcamera.setOrtho(-1,1,-1,1,.01,1e3),this.rttscene.add(this.rttcamera);const r=new a.PlaneGeometry(2,2);if(this._rttplane=new a.Mesh(r,n),this.rttscene.add(this._rttplane),this.renderer=t.external.param.renderer,this.backRenderTarget=this.renderer.backRenderTarget,this.resize(),e.length>0){const t=new a.Texture2D;t.type=a.PIXEL_TYPE.FLOAT,t.magFilter=a.TEXTURE_FILTER.NEAREST,t.minFilter=a.TEXTURE_FILTER.NEAREST,t.generateMipmaps=!1,t.internalformat=a.PIXEL_FORMAT.RGBA32F,t.format=a.PIXEL_FORMAT.RGBA,t.flipY=!1,this._pointTexture=t,this.setData(e)}this.drawTexture(),this._createNode(t.external.param)}set exponent(t){this._exponent=t,n.uniforms.idw_exponent=this._exponent,this.drawTexture()}get exponent(){return this._exponent}set radius(t){this._radius=t,n.uniforms.idw_distanceThreshold=this._radius,this.drawTexture()}get radius(){return this._radius}set isolineCheck(t){this._isolineCheck=t,n.uniforms.isolineCheck=this._isolineCheck,this.drawTexture()}get isolineCheck(){return this._isolineCheck}set auxiliaryLine(t){this._auxiliaryLine=t,n.uniforms.auxiliaryLine=this._auxiliaryLine,this.drawTexture()}get auxiliaryLine(){return this._auxiliaryLine}set minValue(t){this._minValue=t,n.uniforms.idw_minValue=this._minValue,this.drawTexture()}get minValue(){return this._minValue}set maxValue(t){this._maxValue=t,n.uniforms.idw_maxValue=this._maxValue,this.drawTexture()}get maxValue(){return this._maxValue}get gradient(){return this._grad}set gradient(t){this._originalGrad=this._grad,n.uniforms.colorRampTexture=null,"object"==typeof t&&null!==t&&Object.keys(t).length>0&&(this._gradTexture=this._gradient(t),n.uniforms.colorRampTexture=this._gradTexture),this._grad=t,this.drawTexture()}_createNode(t){let e;if(void 0!==t.geometry){var i=t.geometry;const r=new a.Geometry;i.index&&(r.index=new a.Attribute(new a.Buffer(i.index,1)));var n=new a.Buffer(new Float32Array(i.position),3);n.usage=a.BUFFER_USAGE.DYNAMIC_DRAW,r.addAttribute("a_Position",new a.Attribute(n,3));var s=new a.Buffer(new Float32Array(i.uv),2);s.usage=a.BUFFER_USAGE.DYNAMIC_DRAW,r.addAttribute("a_Uv",new a.Attribute(s,2));var o=new a.Buffer(new Float32Array(i.uv),2);if(o.usage=a.BUFFER_USAGE.DYNAMIC_DRAW,r.addAttribute("a_Uv2",new a.Attribute(o,2)),i.normal){var l=new a.Buffer(new Float32Array(i.normal),3);l.usage=a.BUFFER_USAGE.DYNAMIC_DRAW,r.addAttribute("a_Normal",new a.Attribute(l,3))}e=r}else if(t.vertexData){const i=t.vertexData;e=new a.Geometry,i.index&&e.setIndex(new a.Attribute(new a.Buffer(new Float16Array(i.index),1))),e.addAttribute("a_Position",new a.Attribute(new a.Buffer(new Float32Array(i.position),3))),i.normals&&e.addAttribute("a_Normal",new a.Attribute(new a.Buffer(new Float32Array(i.normals),3))),e.addAttribute("a_Uv",new a.Attribute(new a.Buffer(new Float32Array(i.uv),2)))}else if(t.mask||t.clipShape){const i=t.mask||t.clipShape,n=i.points||i.shape,s=r.PolygonBuilder.getGeometryData({contour:n,holes:i.holes});e=new a.Geometry;let o=s.uvs;for(let t=0;t<o.length/2;t++){let e=s.positions[3*t+0],i=s.positions[3*t+2];o[2*t+0]=(e+this._width/2)/this._width,o[2*t+1]=(i+this._height/2)/this._height}e.addAttribute("a_Position",new a.Attribute(new a.Buffer(new Float32Array(s.positions),3))),e.addAttribute("a_Normal",new a.Attribute(new a.Buffer(new Float32Array(s.normals),3))),e.addAttribute("a_Uv",new a.Attribute(new a.Buffer(new Float32Array(o),2))),e.setIndex(new a.Attribute(new a.Buffer(s.positions.length/3>65536?new Uint32Array(s.indices):new Uint16Array(s.indices),1)))}else{e=new a.PlaneGeometry(this._width,this._height);const i=(t.extent.maxX+t.extent.minX)/2,r=(t.extent.maxY+t.extent.minY)/2;for(let t=0;t<e.attributes.a_Position.buffer.count;t++)e.attributes.a_Position.buffer.array[3*t]+=i,e.attributes.a_Position.buffer.array[3*t+2]+=r,e.attributes.a_Uv.buffer.array[2*t]=(e.attributes.a_Position.buffer.array[3*t]+this._width/2)/this._width,e.attributes.a_Uv.buffer.array[2*t+1]=(e.attributes.a_Position.buffer.array[3*t+2]+this._height/2)/this._height}e.computeBoundingBox(),e.computeBoundingSphere();const h=new a.ExtendBasicMaterial;h.side=a.DRAW_SIDE.DOUBLE,h.transparent=!0,h.diffuseMap=this.renderTarget.texture,this._mesh||(this._mesh=new a.Mesh(e,h),this._node.add(this._mesh),this.$markChildrenMatrixAutoUpdate(!1))}drawTexture(){this.rttscene.add(this.rttcamera),this.rttscene.updateMatrix(),this.rttscene.updateRenderStates(this.rttcamera),this.rttscene.updateRenderQueue(this.rttcamera),this.renderer.setRenderTarget(this.renderTarget),this.renderer.setClearColor(0,0,0,0),this.renderer.clear(!0,!0,!0),this.renderer.renderScene(this.rttscene,this.rttcamera)}draw(){}setData(t){let e=Math.sqrt(t.length);e=this._nextPowerOfTwo(Math.ceil(e)),e=Math.max(4,e);const i=new Float32Array(e*e*4),a=[],r=[],n=[];for(let e=0;e<t.length;e++)a.push(t[e][0]),r.push(t[e][1]),n.push(t[e][2]);let s=[Math.min.apply(Math,a),Math.min.apply(Math,r)];var o=this._range?this._range[0]:Math.max.apply(Math,a)-s[0],l=this._range?this._range[1]:Math.max.apply(Math,r)-s[1];this._originPoint=this._originPoint?this._originPoint:[.5*(Math.max.apply(Math,a)+s[0]),.5*(Math.max.apply(Math,r)+s[1])];for(let e=0;e<t.length;e++)i[4*e]=t[e][0],i[4*e+1]=0,i[4*e+2]=t[e][1],i[4*e+3]=t[e][2];this._pointTexture.image={data:i,width:e,height:e},this._pointTexture.version++,this._rttplane.material.uniforms.pointTextureSize=e,this._rttplane.material.uniforms.pointsNum=t.length,this._rttplane.material.uniforms.pointTexture=this._pointTexture,this._rttplane.material.uniforms.dataResolution=[o,l],this._rttplane.material.uniforms.originPoint=this._originPoint}updateData(t){this.setData(t),this.drawTexture()}setIsoline(t,e){n.uniforms.contourSpacingValue=t,n.uniforms.lineThickness=e,this.drawTexture()}resize(){const t=this.renderer.capabilities;let e,i;t.version>1?t.getExtension("EXT_color_buffer_float")&&t.getExtension("OES_texture_float_linear")?(e=a.PIXEL_TYPE.FLOAT,i=a.PIXEL_FORMAT.RGBA32F):(e=a.PIXEL_TYPE.HALF_FLOAT,i=a.PIXEL_FORMAT.RGBA16F):t.getExtension("OES_texture_float")&&t.getExtension("OES_texture_float_linear")?(e=a.PIXEL_TYPE.FLOAT,i=a.PIXEL_FORMAT.RGBA32F):t.getExtension("OES_texture_half_float")&&t.getExtension("OES_texture_half_float_linear")?(e=a.PIXEL_TYPE.HALF_FLOAT,i=a.PIXEL_FORMAT.RGBA16F):(e=a.PIXEL_TYPE.UNSIGNED_BYTE,i=null,console.warn("Half float texture is not supported!")),this.renderTarget=new a.RenderTarget2D(1024,1024),this.renderTarget.texture.magFilter=a.TEXTURE_FILTER.LINEAR,this.renderTarget.texture.minFilter=a.TEXTURE_FILTER.LINEAR,this.renderTarget.texture.type=e,this.renderTarget.texture.format=a.PIXEL_FORMAT.RGBA,this.renderTarget.texture.internalformat=i,this.renderTarget.texture.generateMipmaps=!1}dispose(){this.renderTarget.dispose(),this._gradTexture.dispose(),this._pointTexture.dispose(),this._rttplane.material.dispose(),this._rttplane.geometry.dispose(),this._grad=null,this._originalGrad=null,this._gradCtx=null,this._mesh&&(this._mesh.material.dispose(),this._mesh.geometry.dispose()),super.dispose()}copy(t){return super.copy(t),this}_getGradientCode(t){var e="grad:(";for(var i in t)e+=i+":"+t[i]+",";return e+=")"}_gradient(t){if(this._getGradientCode(this._originalGrad)===this._getGradientCode(t)&&!THING.Utils.isNull(this._gradTexture))return this._gradTexture;var e=this._gradCtx.createLinearGradient(0,0,256,0);for(var i in t)e.addColorStop(+i,t[i]);this._gradCtx.fillStyle=e,this._gradCtx.fillRect(0,0,256,1);var r=new a.Texture2D;return r.image=this._gradCtx.canvas,r.version++,this._gradTexture=r,r}_createCanvas(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}_nextPowerOfTwo(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}}},"./src/uNodes/Streamlines/UStreamlines.js":(t,e,i)=>{i.r(e),i.d(e,{UStreamlines:()=>n});var a=i("@uino/thing-t3d"),r=i("./src/common/Utils.js");a.Geometry.prototype.merge=function(t,e){if(!t)return void console.error("Geometry.merge(): geometry is undefined or null");void 0===e&&(e=0,console.warn("Geometry.merge(): Overwriting original geometry, starting at offset=0. Use GeometryUtils.mergeGeometries() for lossless merge."));const i=this.attributes;for(const a in i){if(void 0===t.attributes[a])continue;const r=i[a].buffer.array,n=t.attributes[a],s=n.buffer.array,o=n.size*e,l=Math.min(s.length,r.length-o);for(let t=0,e=o;t<l;t++,e++)r[e]=s[t]}return this};class n extends a.UNode{static className="UStreamlines";constructor(t={}){super(t.external.uScene);const e=t.external.param;this._verifyInputs(e.data,e.bounds);const i=e.data;this.data=i,this.bounds=this._computeBounds(i,e.bounds),this.numLines=r.Utils.parseValue(e.numLines,1e4),this.maxAge=r.Utils.parseValue(e.maxAge,100),this.fadeOutPercentage=r.Utils.parseValue(e.fadeOutPercentage,.1),this.individualColors=r.Utils.parseValue(e.individualColors,100),this._renderType=r.Utils.parseValue(e.renderType,"Streamline"),this._useDataColor=r.Utils.parseValue(e.useDataColor,!0),this._imageUrl=e.imageUrl,this._speed=r.Utils.parseValue(e.speed,1);const n=Math.sqrt(this.bounds.xLen*this.bounds.xLen+this.bounds.yLen*this.bounds.yLen+this.bounds.zLen*this.bounds.zLen);this._lineMinSize=.1*n,this._textureSize=void 0===e.textureSize?n:e.textureSize,this._textureWrap=void 0===e.textureWrap?a.TEXTURE_WRAP.CLAMP_TO_EDGE:e.textureWrap,e.velocityData?this.velocity=e.velocityData:this._computeVelocity(i),this.min=void 0!==e.min?e.min:r.Utils.getMin(this.velocity.flat(3)),this.max=void 0!==e.max?e.max:r.Utils.getMax(this.velocity.flat(3)),this.noData=e.nodata,this._updateImageData(e.gradient),this.fadeOut=Math.round(this.maxAge*this.fadeOutPercentage),this._getValidCells(),this._addLines()}_updateImageData(t){this._gradient=r.Utils.parseValue(t,{0:"#0000ff",.33:"#00ff00",.66:"#ffff00",1:"#ff0000"}),this._gradientTexture=r.Utils.getGradientTexture(this._gradient);const e=this._gradientTexture.image.getContext("2d").getImageData(0,0,this._gradientTexture.image.width,this._gradientTexture.image.height).data;this._imageData=e}get gradient(){return this._gradient}set gradient(t){if(JSON.stringify(t)!==JSON.stringify(this._gradient)){if(this._updateImageData(t),"Line"===this.renderType){const t=this._node.children[0].geometry,r=t.attributes.a_Position.buffer.array,n=t.attributes.color.buffer.array;for(let t=0;t<r.length/3;t++){const s={x:r[3*t],y:r[3*t+1],z:r[3*t+2]};if(0!==s.x&&0!==s.y&&0!==s.z){const r=Math.round((s.x-this.bounds.minX)/this.bounds.xSize),o=Math.round((s.y-this.bounds.minY)/this.bounds.ySize),l=Math.round((s.z-this.bounds.minZ)/this.bounds.zSize);if(r>-1&&r<this.bounds.xLen&&o>-1&&o<this.bounds.yLen&&l>-1&&l<this.bounds.zLen&&null!==this.data.u[r][o][l]){var e=this.data.u[r][o][l],i=this.data.v[r][o][l],a=this.data.w[r][o][l];s.u=e,s.v=i,s.w=a;const h=this._getColor(s);n[4*t]=h[0],n[4*t+1]=h[1],n[4*t+2]=h[2],n[4*t+3]=h[3]}}}t.attributes.color.buffer.version++}this._gradient=t}}get renderType(){return this._renderType}get useDataColor(){return this._useDataColor}set useDataColor(t){this._node.children[0].material[0].uniforms.useDataColor=t,this._useDataColor=t}get speed(){return this._speed}set speed(t){this._speed=t}get imageUrl(){return this._imageUrl}set imageUrl(t){this._node.children.forEach((e=>{const i=this._textureLoader.load(t);i.wrapS=i.wrapT=a.TEXTURE_WRAP.REPEAT,e.material[0].uniforms.map=i})),this._imageUrl=t}get textureWrap(){return this._textureWrap}get textureSize(){return this._textureSize}_computeVelocity(t){let e=this._clone3DArray(t.u);for(let i=0;i<t.u.length;i++)for(let a=0;a<t.u[0].length;a++)for(let r=0;r<t.u[0][0].length;r++)e[i][a][r]=(t.u[i][a][r]**2+t.v[i][a][r]**2+t.w[i][a][r]**2)**.5;this.velocity=e}_clone3DArray(t){return t.map((function(t){return t.map((function(t){return t.slice()}))}))}_verifyInputs(t,e){if(!("u"in t)||!("v"in t)||!("w"in t))throw new Error("Invalid data object. Must contain keys: u, v, w.");if(3!==r.Utils.getSize(t.u).length)throw new Error("Invalid data object. Velocity array must have three dimensions, input has "+r.Utils.getSize(t.u).length+" dimensions.");if(r.Utils.getSize(t.u).toString()!==r.Utils.getSize(t.v).toString()||r.Utils.getSize(t.v).toString()!==r.Utils.getSize(t.w).toString())throw new Error("Invalid data object. Dimensions must be consistent across velocity components");if(this.yarr=!1,this.xarr=!1,this.zarr=!1,"y"in t){if(this.yarr=!0,1!==r.Utils.getSize(t.y).length||t.y.length!==r.Utils.getSize(t.u)[0])throw new Error("Invalid data object. Provided y-axis array must be 1 dimensions and of equal length to the first dimension of the velocity arrays.")}else if(!("minY"in e)||!r.Utils.isNumeric(e.minY))throw new Error("Invalid data object. If y-axis array not provided then minY and maxY must be provided in bounds object.");if("x"in t){if(this.xarr=!0,1!==r.Utils.getSize(t.x).length||t.x.length!==r.Utils.getSize(t.u)[1])throw new Error("Invalid data object. Provided x-axis array must be 1 dimensions and of equal length to the second dimension of the velocity arrays.")}else if(!("minX"in e)||!r.Utils.isNumeric(e.minX))throw new Error("Invalid data object. If x-axis array not provided then minX and maxX must be provided in bounds object.");if("z"in t){if(this.zarr=!0,1!==r.Utils.getSize(t.z).length||t.z.length!==r.Utils.getSize(t.u)[2])throw new Error("Invalid data object. Provided z-axis array must be 1 dimensions and of equal length to the third dimension of the velocity arrays.")}else if(!("minZ"in e)||!r.Utils.isNumeric(e.minZ))throw new Error("Invalid data object. If z-axis array not provided then minZ and maxX must be provided in bounds object.")}_computeBounds(t,e){return this.yarr||(e.yLen=t.u[0].length,e.minY=parseFloat(e.minY),e.maxY=parseFloat(e.maxY),e.ySize=(e.maxY-e.minY)/e.yLen),this.xarr||(e.xLen=t.u.length,e.minX=parseFloat(e.minX),e.maxX=parseFloat(e.maxX),e.xSize=(e.maxX-e.minX)/e.xLen),this.zarr||(e.zLen=t.u[0][0].length,e.minZ=parseFloat(e.minZ),e.maxZ=parseFloat(e.maxZ),e.zSize=(e.maxZ-e.minZ)/e.zLen),e}_getValidCells(){this.validCells=[];for(let t=0;t<this.bounds.xLen;t++)for(let e=0;e<this.bounds.yLen;e++)if(Array.isArray(this.data.u[t][e]))for(let i=0;i<this.bounds.zLen;i++)r.Utils.isNumeric(this.data.u[t][e][i])&&this.data.u[t][e][i]!==this.noData&&this.validCells.push([t,e,i])}_getColor(t){const e=Math.sqrt(t.u**2+t.v**2+t.w**2);let i=Math.round((e-this.min)/(this.max-this.min)*255);return[this._imageData[4*i]/255,this._imageData[4*i+1]/255,this._imageData[4*i+2]/255,this._imageData[4*i+3]/255]}_generateHalfTexture(){return r.Utils._generateHalfTexture()}_addLines(){var t="\n      attribute vec3 a_Position;\n      attribute vec2 a_Uv;\n      attribute vec2 a_Uv2;\n      attribute vec4 color;\n      varying vec4 vColor;\n      varying vec2 vUv;\n      varying vec2 vUv2;\n      uniform mat4 u_ProjectionView;\n      uniform mat4 u_Model;\n\n      void main()    {\n\n        vColor = color;\n        vUv = a_Uv;\n        vUv2 = a_Uv2;\n        vec4 position = vec4(a_Position.xyz, 1.0);\n        gl_Position = u_ProjectionView * u_Model * position;\n      }\n    ",e="\n      varying vec4 vColor;\n      uniform bool useDataColor;\n      uniform bool useMap;\n      uniform sampler2D map;\n      uniform float u_Opacity;\n      uniform float offset;\n      uniform float alphaMapRepeat;\n      uniform float alphaMapOffset;\n      varying vec2 vUv;\n      varying vec2 vUv2;\n      uniform bool useAlphaMap;\n      uniform sampler2D alphaMap;\n\n      void main()    {\n        vec4 color = vec4(1.0,1.0,1.0,1.0);\n        if(useDataColor){\n          color = vec4(vColor);\n        }\n        if(useMap){\n          color *= texture2D( map, vUv + vec2(offset,0));\n        }\n        if(useAlphaMap){\n          color.a *= texture2D(alphaMap, vUv2 * vec2(alphaMapRepeat,1.0) + vec2(alphaMapOffset,0.0)).g;\n        }\n        float alpha = u_Opacity * color.a;\n        gl_FragColor = vec4(color.rgb,alpha);\n      }\n    ";if("Streamline"===this.renderType){let i=new a.Geometry,r=new Float32Array(new Array(4*this.maxAge).fill(1));i.addAttribute("color",new a.Attribute(new a.Buffer(r,4)));let n=new Float32Array(3*this.maxAge);i.addAttribute("a_Position",new a.Attribute(new a.Buffer(n,3))),i.groups.push({start:0,count:0,materialIndex:0});let s=new a.ShaderMaterial({vertexShader:t,fragmentShader:e});s.transparent=!0,s.uniforms.useDataColor=this._useDataColor,s.drawMode=a.DRAW_MODE.LINE_STRIP,s.needsUpdate=!0;for(let t=0;t<this.numLines;t++){let t=new a.Mesh(i.clone(),[s]);t.frustumCulled=!1,t.age=0,t.maxAge=Math.round((this.maxAge-this.fadeOut)*Math.random())+this.fadeOut,this._node.add(t)}this._initialPositions()}else if("Line"===this.renderType){this._textureLoader||(this._textureLoader=new a.Texture2DLoader);const r=this._textureLoader.load(this._imageUrl);r.wrapS=r.wrapT=a.TEXTURE_WRAP.REPEAT;let n=new a.ShaderMaterial({vertexShader:t,fragmentShader:e});n.uniforms.useMap=!!this._imageUrl,n.uniforms.useDataColor=this._useDataColor,n.transparent=!0,n.uniforms.map=r,n.uniforms.offset=0,n.drawMode=a.DRAW_MODE.LINES,n.needsUpdate=!0;const s=new a.Geometry,o=[];let l=0,h=0,u=0;const d=this.validCells.length-1;for(let t=0;t<this.numLines;t++){let t=new a.Geometry;const e=[];let r=0,n=new Float32Array(600),s=new Float32Array(400),m=new Float32Array(400),c=new Float32Array(800),p=this.validCells[Math.round(d*Math.random())];n[0]=this.xarr?this.data.u[p[0]]:this.bounds.minX+this.bounds.xSize*p[0]+(this.bounds.xSize*Math.random()-this.bounds.xSize),n[1]=this.yarr?this.data.v[p[1]]:this.bounds.minY+this.bounds.ySize*p[1]+(this.bounds.ySize*Math.random()-this.bounds.ySize),n[2]=this.zarr?this.data.w[p[2]]:this.bounds.minZ+this.bounds.zSize*p[2]+(this.bounds.zSize*Math.random()-this.bounds.zSize);for(let a=0;a<n.length/3-1;a++){var i=this._nextPosition(n[3*a],n[3*a+1],n[3*a+2]);if(!i){t.groups.push({start:0,count:a,materialIndex:0});break}{n[3*(a+1)+0]=i.x,n[3*(a+1)+1]=i.y,n[3*(a+1)+2]=i.z;const t=((i.x-n[3*a])**2+(i.y-n[3*a+1])**2+(i.z-n[3*a+2])**2)**.5;let s=0;e.length>=1&&(s=e[e.length-1]),e.push(s+t),r+=t;const o=this._getColor(i);c[4*(a+1)+0]=o[0],c[4*(a+1)+1]=o[1],c[4*(a+1)+2]=o[2],c[4*(a+1)+3]=o[3]}}if(s[0]=Math.random(),m[0]=0,m[1]=s[1]=.5,r>0)for(let t=0;t<s.length/2-1&&!(t>e.length-1);t++)m[2*(t+1)]=m[0]+e[t]/r,m[2*(t+1)+1]=.5,this._textureWrap===a.TEXTURE_WRAP.REPEAT?(s[2*(t+1)]=s[0]+e[t]/this._textureSize,s[2*(t+1)+1]=.5):(s[2*(t+1)]=s[0]+e[t]/r,s[2*(t+1)+1]=.5);t.addAttribute("a_Position",new a.Attribute(new a.Buffer(n,3))),t.addAttribute("color",new a.Attribute(new a.Buffer(c,4))),t.addAttribute("a_Uv",new a.Attribute(new a.Buffer(s,2))),t.addAttribute("a_Uv2",new a.Attribute(new a.Buffer(m,2))),0===t.groups.length&&t.groups.push({start:0,count:200,materialIndex:0}),t.computeBoundingSphere(),t.boundingSphere.radius>this._lineMinSize&&(l+=n.length,h+=s.length,u+=c.length,o.push(t))}s.addAttribute("a_Position",new a.Attribute(new a.Buffer(new Float32Array(l),3))),s.addAttribute("color",new a.Attribute(new a.Buffer(new Float32Array(u),4))),s.addAttribute("a_Uv",new a.Attribute(new a.Buffer(new Float32Array(h),2))),s.addAttribute("a_Uv2",new a.Attribute(new a.Buffer(new Float32Array(h),2)));let m=0,c=[];o.forEach((t=>{s.merge(t,m);let e=t.groups[0].count;for(let t=0;t<e-1;t++)c.push(t+m),c.push(t+1+m);m+=t.attributes.a_Position.buffer.count})),s.setIndex(c),s.groups.push({start:0,count:1/0,materialIndex:0});let p=new a.Mesh(s,[n]);p.frustumCulled=!1,this._node.add(p)}}_initialPositions(){for(var t=this.validCells.length-1,e=0;e<this._node.children.length;e++){let i=this._node.children[e],a=this.validCells[Math.round(t*Math.random())],r=i.geometry.attributes.a_Position.buffer.array;r[0]=this.xarr?this.data.u[a[0]]:this.bounds.minX+this.bounds.xSize*a[0]+(this.bounds.xSize*Math.random()-this.bounds.xSize),r[1]=this.yarr?this.data.v[a[1]]:this.bounds.minY+this.bounds.ySize*a[1]+(this.bounds.ySize*Math.random()-this.bounds.ySize),r[2]=this.zarr?this.data.w[a[2]]:this.bounds.minZ+this.bounds.zSize*a[2]+(this.bounds.zSize*Math.random()-this.bounds.zSize),r[3]=r[0],r[4]=r[1],r[5]=r[2],i.geometry.attributes.a_Position.needsUpdate=!0}}_nextPosition(t,e,i){var a=this.xarr?r.Utils.indexOfClosest(t,this.data.u):Math.round((t-this.bounds.minX)/this.bounds.xSize),n=this.yarr?r.Utils.indexOfClosest(e,this.data.v):Math.round((e-this.bounds.minY)/this.bounds.ySize),s=this.zarr?r.Utils.indexOfClosest(i,this.data.w):Math.round((i-this.bounds.minZ)/this.bounds.zSize);if(a>-1&&a<this.bounds.xLen&&n>-1&&n<this.bounds.yLen&&s>-1&&s<this.bounds.zLen&&null!==this.data.u[a][n][s]){var o=this.data.u[a][n][s],l=this.data.v[a][n][s],h=this.data.w[a][n][s],u=this.velocity[a][n][s];let r=this.speed;return"Line"===this.renderType&&(r*=100),{x:t+o*r,y:e+l*r,z:i+h*r,u:o,v:l,w:h,m:u}}return!1}animate(){if("Streamline"===this.renderType)for(var t=this.validCells.length-1,e=0;e<this._node.children.length;e++){let a=this._node.children[e],r=a.geometry.attributes.a_Position.buffer.array,n=a.geometry.attributes.color.buffer.array;if(a.age<a.maxAge-this.fadeOut){a.age++;var i=this._nextPosition(r[3*(a.age-1)],r[3*(a.age-1)+1],r[3*(a.age-1)+2]);if(i){r[3*a.age]=i.x,r[3*a.age+1]=i.y,r[3*a.age+2]=i.z;let t=this._getColor(i);n[4*a.age-4]=t[0],n[4*a.age-3]=t[1],n[4*a.age-2]=t[2];for(let t=1;t<a.age;t++)n[4*t-1]=Math.exp(1-1/(t/a.age)**2);a.geometry.attributes.color.buffer.version++,a.geometry.groups[0].start=0,a.geometry.groups[0].count=a.age,a.geometry.attributes.a_Position.buffer.version++}else a.age=a.maxAge-this.fadeOut}else if(a.age<a.maxAge){a.age++;for(let t=1;t<a.age;t++)n[4*t-1]=Math.min(1*(a.maxAge-a.age)/this.fadeOut,n[4*t-1]);a.geometry.attributes.color.buffer.version++}else{a.age=0,a.maxAge=Math.round((this.maxAge-this.fadeOut)*Math.random())+this.fadeOut;let e=this.validCells[Math.round(t*Math.random())];r[0]=this.xarr?this.data.u[e[0]]:this.bounds.minX+this.bounds.xSize*e[0]+(this.bounds.xSize*Math.random()-this.bounds.xSize),r[1]=this.yarr?this.data.v[e[1]]:this.bounds.minY+this.bounds.ySize*e[1]*2+(this.bounds.ySize*Math.random()-this.bounds.ySize),r[2]=this.zarr?this.data.w[e[2]]:this.bounds.minZ+this.bounds.zSize*e[2]+(this.bounds.zSize*Math.random()-this.bounds.zSize),r[3]=r[0],r[4]=r[1],r[5]=r[2];for(let t=0;t<4*this.maxAge;t++)n[t]=1;a.geometry.groups[0].start=0,a.geometry.groups[0].count=a.age,a.geometry.attributes.color.buffer.version++,a.geometry.attributes.a_Position.buffer.version++}}else if("Line"===this.renderType)for(e=0;e<this._node.children.length;e++){let t=this._node.children[e];void 0===t.offset&&(t.offset=0),t.material[0].map?t.material[0].map.offset.set(t.offset,0):t.material[0].uniforms.map&&(t.material[0].uniforms.offset=t.offset,t.offset-=.002*this.speed)}}setMaxAge(t){this.maxAge=t}setNumLines(t){this._node.remove(...this._node.children),this.numLines=t,this._addLines()}clearStreamlines(){this._node.remove(...this._node.children)}}},"./src/uNodes/WindLayer/UWindLayerNode.js":(t,e,i)=>{i.r(e),i.d(e,{UWindLayerNode:()=>h});var a=i("@uino/thing-t3d");const r=new a.Texture2DLoader;var n=new a.ShaderMaterial({name:"ScreenMaterial",defines:{},vertexShader:"    #include <common_vert>\n    precision mediump float;\n    attribute vec2 a_Uv;\n    varying vec2 v_uv;\n    \n    void main() {\n        v_uv = a_Uv;\n        vec4 position =vec4( a_Position.xyz, 1);\n        gl_Position = u_ProjectionView * u_Model * position;\n    }\n    \n    ",fragmentShader:"    #include <common_frag>\n    precision mediump float;\n    \n    uniform sampler2D u_screen;\n    uniform float u_opacity;\n    varying vec2 v_uv;\n    \n    void main() {\n        vec4 color = texture2D(u_screen,  vec2(v_uv.x,1.-v_uv.y));\n        // a hack to guarantee opacity fade out even with a value close to 1.0\n        gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n        // if(gl_FragColor.a ==0.) gl_FragColor.a =0.1;\n    }\n    ",uniforms:{u_screen:null,u_opacity:0}}),s=new a.ShaderMaterial({name:"pointMaterial",defines:{},vertexShader:"    #include <common_vert>\n    precision mediump float;\n    \n    attribute float a_index;\n    \n    uniform sampler2D u_particles;\n    uniform float u_particles_res;\n\t\tuniform float pointSize;\n    \n    varying vec2 v_particle_pos;\n    \n    void main() {\n        vec4 color = texture2D(u_particles, vec2(\n            fract(a_index / u_particles_res),\n            floor(a_index / u_particles_res) / u_particles_res));\n    \n        // decode current particle position from the pixel's RGBA value\n        v_particle_pos = vec2(\n            color.r / 255.0 + color.b,\n            color.g / 255.0 + color.a);\n    \n        gl_PointSize = pointSize;\n\t\t\t\tif(pointSize==0.0){\n\t\t\t\t\tgl_Position *= 0.0; //0\n\t\t\t\t}\n\t\t\t\telse{\n        \tgl_Position = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n\t\t\t\t}\n    }\n    \n    ",fragmentShader:"    #include <common_frag>\n    precision mediump float;\n    \n    uniform sampler2D u_wind;\n    uniform vec2 u_wind_min;\n    uniform vec2 u_wind_max;\n    uniform sampler2D u_color_ramp;\n    uniform sampler2D u_circle;\n    \n    varying vec2 v_particle_pos;\n    \n    void main() {\n        vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, v_particle_pos).rg);\n\t\t\t\tfloat velocityLength = length(velocity);\n        float speed_t = velocityLength / length(u_wind_max);\n    \n        // color ramp is encoded in a 16x16 texture\n        vec2 ramp_pos = vec2(\n            fract(16.0 * speed_t),\n            floor(16.0 * speed_t) / 16.0);\n    \n        gl_FragColor = texture2D(u_color_ramp, ramp_pos);\n    \n        float  alpha = texture2D(u_circle, vec2(gl_PointCoord.x, 1.0 - gl_PointCoord.y)).a;\n        gl_FragColor.a *= alpha * velocityLength;\n    }\n    \n    ",uniforms:{u_wind:null,u_particles:null,u_color_ramp:null,u_circle:null,pointSize:5,u_particles_res:0,u_wind_min:[0,0],u_wind_max:[0,0]}}),o=new a.ShaderMaterial({name:"updateMaterial",defines:{},vertexShader:"    #include <common_vert>\n    precision mediump float;\n    attribute vec2 a_Uv;\n    varying vec2 v_uv;\n    \n    void main() {\n        v_uv = a_Uv;\n        vec4 position =vec4( a_Position.xyz, 1);\n        gl_Position = u_ProjectionView * u_Model * position;\n    }\n    ",fragmentShader:"    #include <common_frag>\n    precision highp float;\n    \n    uniform sampler2D u_particles;\n    uniform sampler2D u_wind;\n    uniform vec2 u_wind_res;\n    uniform vec2 u_wind_min;\n    uniform vec2 u_wind_max;\n    uniform float u_rand_seed;\n    uniform float u_speed_factor;\n    uniform float u_drop_rate;\n    uniform float u_drop_rate_bump;\n\t\tuniform vec2 u_extentY;\n    \n    varying vec2 v_uv;\n    \n    // pseudo-random generator\n    const vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n    float rand2(const vec2 co) {\n        float t = dot(rand_constants.xy, co);\n        return fract(sin(t) * (rand_constants.z + t));\n    }\n    \n    // wind speed lookup; use manual bilinear filtering based on 4 adjacent pixels for smooth interpolation\n    vec2 lookup_wind(const vec2 uv) {\n        // return texture2D(u_wind, uv).rg; // lower-res hardware filtering\n        vec2 px = 1.0 / u_wind_res;\n        vec2 vc = (floor(uv * u_wind_res)) * px;\n        vec2 f = fract(uv * u_wind_res);\n        vec2 tl = texture2D(u_wind, vc).rg;\n        vec2 tr = texture2D(u_wind, vc + vec2(px.x, 0)).rg;\n        vec2 bl = texture2D(u_wind, vc + vec2(0, px.y)).rg;\n        vec2 br = texture2D(u_wind, vc + px).rg;\n        return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n    }\n    \n    void main() {\n        vec4 color = texture2D(u_particles, v_uv);\n        vec2 pos = vec2(\n            color.r / 255.0 + color.b,\n            color.g / 255.0 + color.a); // decode particle position from pixel RGBA\n    \n        vec2 velocity = mix(u_wind_min, u_wind_max, lookup_wind(pos));\n        float speed_t = length(velocity) / length(u_wind_max);\n    \n        // take EPSG:4236 distortion into account for calculating where the particle moved\n        float distortion = cos(radians(pos.y * (u_extentY.y-u_extentY.x) - 0.5*(u_extentY.y-u_extentY.x)));\n        vec2 offset = vec2(velocity.x / distortion, velocity.y) * 0.0001 * u_speed_factor;\n    \n        // update particle position, wrapping around the date line\n        pos = fract(1.0 + pos + offset);\n    \n        // a random seed to use for the particle drop\n        vec2 seed = (pos + v_uv) * u_rand_seed;\n    \n        // drop rate is a chance a particle will restart at random position, to avoid degeneration\n        float drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n        float drop = step(1.0 - drop_rate, rand2(seed));\n    \n        vec2 random_pos = vec2(\n            rand2(seed + 1.3),\n            rand2(seed + 2.1));\n        pos = mix(pos, random_pos, drop);\n    \n        // encode the new particle position back into RGBA\n        gl_FragColor = vec4(\n            fract(pos * 255.0),\n            floor(pos * 255.0) / 255.0);\n    }\n    \n    ",uniforms:{u_wind:null,u_particles:null,u_rand_seed:Math.random(),u_wind_res:[0,0],u_wind_min:[0,0],u_wind_max:[0,0],u_speed_factor:0,u_drop_rate:0,u_drop_rate_bump:0,u_extentY:[0,0]}});function l(t){const e=document.createElement("canvas"),i=e.getContext("2d");e.width=256,e.height=1;const a=i.createLinearGradient(0,0,256,0);for(const e in t)a.addColorStop(+e,t[e]);return i.fillStyle=a,i.fillRect(0,0,256,1),new Uint8Array(i.getImageData(0,0,256,1).data)}class h extends a.UNode{static className="UWindLayerNode";constructor(t={}){super(t.external.uScene),this._fadeOpacity=void 0===t.external.fadeOpacity?.996:t.external.fadeOpacity,this._speedFactor=void 0===t.external.speedFactor?1:t.external.speedFactor,this._dropRate=.01,this._dropRateBump=.01,this._rttResolution=4096,this._pointSize=t.external.pointSize,this._extent=t.external.extent,this.blendscene=new a.Scene,this.blendcamera=new a.Camera,this.blendcamera.setOrtho(-1,1,-1,1,.01,1e3),this.blendcamera.position.set(0,10,0),this.blendcamera.lookAt(new a.Vector3(0,0,0),new a.Vector3(0,0,-1)),this.blendscene.add(this.blendcamera);let e=new a.PlaneGeometry(2,2);this.mesh=new a.Mesh(e,new a.ExtendBasicMaterial),this.blendscene.add(this.mesh);var i=new a.ExtendBasicMaterial;i.diffuse.setRGB(0,0,0),i.transparent=!0,i.opacity=.1,i.blending=a.BLEND_TYPE.CUSTOM,i.blendSrc=a.BLEND_FACTOR.SRC_ALPHA,i.blendDst=a.BLEND_FACTOR.ONE_MINUS_SRC_ALPHA;const r=new a.Mesh(new a.PlaneGeometry(2,2),i);this.blendscene.add(r),this.rttmesh=null,this.rttscene=new a.Scene,this.rttcamera=new a.Camera,this.rttcamera.position.set(0,10,0),this.rttcamera.lookAt(new a.Vector3(0,0,0),new a.Vector3(0,0,-1)),this.rttscene.add(this.rttcamera),this.setcircleMap(t.external.circleMapUrl),this.particscene=new a.Scene,this.parcticcamera=new a.Camera,this.parcticcamera.position.set(0,20,0),this.parcticcamera.lookAt(new a.Vector3(0,0,0),new a.Vector3(0,0,-1)),this.parcticcamera.setOrtho(-1,1,-1,1,.01,100),this.particscene.add(this.parcticcamera),this.renderer=t.external.renderer,this.POINTS=null,this._grad=t.external.gradient;var n=this._createCanvas();n.width=256,n.height=1,this._gradCtx=n.getContext("2d"),this._gradTexture=null,this._originalGrad=this._grad,this.colorRampTexture=this._gradient(this._grad),this.resize(),this._createNode(t),this.numParticles=void 0===t.external.numParticles||null===t.external.numParticles?1e4:t.external.numParticles}set numParticles(t){const e=this.particleStateResolution=Math.ceil(Math.sqrt(t));this._numParticles=e*e;const i=new Uint8Array(4*this._numParticles);for(let t=0;t<i.length;t++)i[t]=Math.floor(256*Math.random());this.particleStateRT0=new a.RenderTarget2D(e,e),this.particleStateRT0.texture.image={data:i,width:e,height:e},this.particleStateRT0.texture.minFilter=a.TEXTURE_FILTER.NEAREST,this.particleStateRT0.texture.magFilter=a.TEXTURE_FILTER.NEAREST,this.particleStateRT0.texture.type=a.PIXEL_TYPE.UNSIGNED_BYTE,this.particleStateRT0.texture.format=a.PIXEL_FORMAT.RGBA,this.particleStateRT0.texture.internalformat=null,this.particleStateRT0.texture.generateMipmaps=!1,this.particleStateRT1=new a.RenderTarget2D(e,e),this.particleStateRT1.texture.image={data:i,width:e,height:e},this.particleStateRT1.texture.minFilter=a.TEXTURE_FILTER.NEAREST,this.particleStateRT1.texture.magFilter=a.TEXTURE_FILTER.NEAREST,this.particleStateRT1.texture.type=a.PIXEL_TYPE.UNSIGNED_BYTE,this.particleStateRT1.texture.format=a.PIXEL_FORMAT.RGBA,this.particleStateRT1.texture.internalformat=null,this.particleStateRT1.texture.generateMipmaps=!1;const r=new Float32Array(this._numParticles);for(let t=0;t<this._numParticles;t++)r[t]=t;this.particleIndexBuffer=new a.Buffer(r,1)}get numParticles(){return this._numParticles}get fadeOpacity(){return this._fadeOpacity}set fadeOpacity(t){this._fadeOpacity=t}get speedFactor(){return this._speedFactor}set speedFactor(t){this._speedFactor=t}get dropRate(){return this._dropRate}set dropRate(t){this._dropRate=t}get dropRateBump(){return this._dropRateBump}set dropRateBump(t){this._dropRateBump=t}set rttResolution(t){this._rttResolution=t,this.resize()}get rttResolution(){return this._rttResolution}set pointSize(t){this._pointSize=t}get pointSize(){return this._pointSize}set opacity(t){this._opacity=t}get opacity(){return this._opacity}get gradient(){return this._grad}set gradient(t){this._originalGrad=this._grad,this.colorRampTexture=this._gradient(t),this._grad=t}_createNode(t){var e;if(t.external.geometry)e=t.external.geometry;else{var i=t.external.vertexData;(e=new a.Geometry).addAttribute("a_Position",new a.Attribute(new a.Buffer(new Float32Array(i.positions),3))),e.addAttribute("a_Normal",new a.Attribute(new a.Buffer(new Float32Array(i.normals),3))),e.addAttribute("a_Uv",new a.Attribute(new a.Buffer(new Float32Array(i.uv),2))),e.setIndex(new a.Attribute(new a.Buffer(i.positions.length/3>65536?new Uint32Array(i.indices):new Uint16Array(i.indices),1)))}const r=new a.ExtendBasicMaterial;this._mesh||(this._mesh=new a.Mesh(e,r),this._node.add(this._mesh),this.$markChildrenMatrixAutoUpdate(!1))}setcircleMap(t){let e;if(t)e=r.load(t);else{const t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sHDRYtFjgycv0AAAAdaVRYdENvbW1lbnQAAAAAAENyZWF0ZWQgd2l0aCBHSU1QZC5lBwAABlNJREFUWMPll8uPHUcVxn9fdfd9zcy1PePYjj32YJkQDA5BipBAAqQIsQD+B1hlj8QCsOwBO0aILRJr/gZ2sIoILBAOcgSBxGAzNs68PO/7mn5U1WHRPQqRYo8HkRUlXfW93eqq36nz1XfOhf/nUV6G9ONcYL8PhYEBxwRu8MGzRxchfOZjAAjA+Ay4NsQWuBa4AJMKRtOgEfQGUJ6FcOF/BDA+CToF7W4dbZZDuQnpRXAJmCAD4gSsgGJQf5dA/82CG6dgdh7CPmgM4RLEk5BMAYIwAHYgeQjxC/U7ioAH5RDGwCboBUiOLJxPQvY50Kcg/A3sMugT4F4AdxlsHtwMOAfKIPszxFdAHaANZOAEtCBZPWIK7p6HcBluXvlhKgm+TWpmSIICz0O4+Z1feJYHxJ4RQ7PVl+rIGYDtgSU1YLAjpuDq1atpkiRpjLEDpGbWbq4kSeLNrDCz3DmXL37pludNKN+Bzp8g/BK0CbYMrINtAXtHALh+/XoqqRNCmJI0B8xIascY2wCSCmAMDM1sz8zGSZLk19593edvw9SvM2y3Ij4A7oO9X0Mkz7p4CKEDzAFnJC1IOg/MA6cknQSeA/pAJskBQVL47cmvxq//8c3Id19E7YKkVUFVo1rxDBpYXFxMQwgd59ycpHPAgpk9b2YnJXVr3RMlRTMbAbNAv9kdYoxeBT5kL6NouP4SzBWoD9p+BoAQQgocM7MzZrYg6ZKkeWAG6ACJpGBmE0nTZtYHus1975wrrr32A38rcT6ka9BeRVMFtYoOScHi4mJqZj1Jp4EFSZeAi8A5SReSJFlI0/RskiRzwJSZAbjmY2ZWNWD7b/ye+OqXN6KqVRjuY+u1Vxy2A2kz8WyT59OSTkg6n6bp+SzLprvdbpJlmZVlmY9Go+Pe+3sxxmBmBTAEHjvntiXlFvZQrIglyIPFZ/OBjnNu2sxONDAzaZqearVa/VarlfR6Paanpwkh9CTN7+3tjWOMI0nTTZp6Ztb23qfOP/JxPIFBLUJVhwDEGFMza5tZD2ibWSYpy7Ks2+v1XLfbZWZmhn6/j5kpz/POeDyeCyG8H2PMGo10JaWtVgu3u0ZcD7AG7IKNDwFoXM41gkrMLEoiTVM3NTWlfr9Pv9+n3W5TliVZlsk5125Sl9SGSyIplYR/6NEysAK2W9eRQwGccxEIDYwBeYyxcs5Zp9NRq9Wqa0RZUhSFxRgrMwvNySglBcCbGXoPbBPcNsRBrZCnAqRpSlVVhXNuImkMFMCkLMutwWAwnWVZq6oqnHPs7OwwGAyKsiy3gZzabvLmJHhJxKU693Fc23AcHS5C75zLJY3MbChpYmYT7/2DwWCQFUXxXKfTaccYyfM8L4piJca43Kh/BOxJ2m5OhNdj8AVoAtkQysEzAEgam9kmsC7p+EFey7L03vuNyWQyDbgQwgDYALaAXTN73PzelZRfe+uWt6LuC2xQi7C/VBvGE8fNmze9cy53zm1JWgX+ZWbrZrYjaS3GeC+E8K73/q/APWDtALaWGisxxr2qqnK3AbYBPICpO5AtfWA0Tx2SfFPl1swsacRZmdlsc8ycJBqh7QPbZrYCPDCztRjj6MbvfuZjAd13Ptrpnrz/l8C/ccP/9NUf5cCWmRFjLCTtA7OSOgdzmJkHBjHGbUkrzrmNEMJelmW+dQfc/hMCfGr7dQX8aUjm4ScLdVU0s46kY5JmgN5/BOGBiZkNzWwvSZKRc85//zc3PI+gt3xEgPASmIPqLHAOkgvAS/Dj21dTSR3nXAq0Y4xIwjkXQgi+EW5+bXjLH3Q/+TKc+OcRAEZfg/aF+mG1DW6uroHuZXCfbhNnr/D6z7+VSiKEcABQNy/fuOHjHYjvAatg66D3oXP/ydXuw5F/BfznBa/0CL2M5O4I+4vHCrASrAoQB1z93opPkxcxSzDbxKo/kExuowegEhQAgyRCMn56uf3wOAf6bIf4xSto6nns1G3i0jIaAttgux6mVnDuLYLtgFooPsZVf4fhkLDRdL8F2ATCBFw8AkBwQMvhOtOEdBYd79RuMYS4Buk0uGxMDHexzirC1f9QRkNsOaAVsJ3a7Tio+ztHAHC7EJf2sftv42b/AXfX0RbECOkWWAo+gM7t42ZyDGFlxHbqTtet1r0/ozp6RpB+E/jVRwP8G3R7eXmZvRtYAAAAAElFTkSuQmCC";e=r.load(t)}e.wrapS=e.wrapT=a.TEXTURE_WRAP.CLAMP_TO_EDGE,e.anisotropy=16,e.version++,this._circleT=e}drawToSrceen(t){n.uniforms.u_screen=this.renderTarget.texture,n.uniforms.u_opacity=3*t,this.mesh.material=n,this.mesh.material.needsUpdate=!0,n.blending=a.BLEND_TYPE.CUSTOM,n.blendSrc=a.BLEND_FACTOR.SRC_ALPHA,n.blendDst=a.BLEND_FACTOR.ONE_MINUS_SRC_ALPHA,this.blendscene.updateMatrix(),this.blendscene.updateRenderStates(this.blendcamera),this.blendscene.updateRenderQueue(this.blendcamera),this.renderer.setRenderTarget(this.renderTarget2),this.renderer.renderScene(this.blendscene,this.blendcamera)}drawParticles(){if(s.uniforms.u_wind=this.windTexture,s.uniforms.u_particles=this.particleStateRT1.texture,s.uniforms.u_color_ramp=this.colorRampTexture,s.uniforms.u_circle=this._circleT,s.uniforms.pointSize=this.pointSize,s.uniforms.u_particles_res=this.particleStateResolution,s.uniforms.u_wind_min=[this.windData.uMin,this.windData.vMin],s.uniforms.u_wind_max=[this.windData.uMax,this.windData.vMax],s.drawMode=a.DRAW_MODE.POINTS,s.depthWrite=!1,s.depthTest=!1,this.POINTS)this.POINTS.material=s;else{const t=new a.Geometry,e=new a.Attribute(this.particleIndexBuffer);t.addAttribute("a_index",e),t.addAttribute("a_Position",new a.Attribute(new a.Buffer(new Float32Array(3*this._numParticles),3))),t.computeBoundingBox(),t.computeBoundingSphere(),this.POINTS=new a.Mesh(t,s),this.POINTS.frustumCulled=!1,this.particscene.add(this.POINTS)}this.particscene.updateMatrix(),this.particscene.updateRenderStates(this.parcticcamera),this.particscene.updateRenderQueue(this.parcticcamera),this.renderer.setRenderTarget(this.renderTarget),this.renderer.setClearColor(0,0,0,0),this.renderer.clear(!0,!0,!0),this.renderer.renderScene(this.particscene,this.parcticcamera)}updateParticles(){if(o.uniforms.u_wind=this.windTexture,o.uniforms.u_particles=this.particleStateRT1.texture,o.uniforms.u_wind_res=[this.windData.width,this.windData.height],o.uniforms.u_wind_min=[this.windData.uMin,this.windData.vMin],o.uniforms.u_wind_max=[this.windData.uMax,this.windData.vMax],o.uniforms.u_speed_factor=.25*this.speedFactor,o.uniforms.u_drop_rate=this.dropRate,o.uniforms.u_drop_rate_bump=this.dropRateBump,o.uniforms.u_extentY=[this._extent.minY,this._extent.maxY],this.rttmesh)this.rttmesh.frustumCulled=!1,this.rttmesh.material=o,this.rttmesh.material.needsUpdate=!0;else{var t=new a.PlaneGeometry(2,2);this.rttmesh=new a.Mesh(t,o),this.rttmesh.frustumCulled=!1,this.rttcamera.setOrtho(-1,1,-1,1,.01,100),this.rttscene.add(this.rttmesh)}this.rttscene.updateMatrix(),this.rttscene.updateRenderStates(this.rttcamera),this.rttscene.updateRenderQueue(this.rttcamera),this.renderer.setRenderTarget(this.particleStateRT0),this.renderer.setClearColor(0,0,0,0),this.renderer.clear(!0,!0,!0),this.renderer.renderScene(this.rttscene,this.rttcamera);const e=this.particleStateRT1;this.particleStateRT1=this.particleStateRT0,this.particleStateRT0=e}draw(){this.drawParticles(),this.updateParticles(),this.drawToSrceen(this._fadeOpacity)}setWind(t){this.windData=t,t.data?(this.windTexture=new a.Texture2D,this.windTexture.image={data:t.data,width:t.width,height:t.height},this.windTexture.type=a.PIXEL_TYPE.UNSIGNED_BYTE,this.windTexture.format=a.PIXEL_FORMAT.RGBA,this.windTexture.internalformat=null,this.windTexture.generateMipmaps=!1):t.imgUrl&&(this.windTexture=a.Texture2D.fromSrc(t.imgUrl),this.windTexture.wrapS=this.windTexture.wrapT=a.TEXTURE_WRAP.REPEAT,this.windTexture.generateMipmaps=!1,this.windTexture.flipY=!1),this.windTexture.magFilter=a.TEXTURE_FILTER.LINEAR,this.windTexture.minFilter=a.TEXTURE_FILTER.LINEAR,this.windTexture.anisotropy=16,this.windTexture.version++}setColorRamp(t){this.colorRampTexture=new a.Texture2D,this.colorRampTexture.image={data:l(t),width:16,height:16},this.colorRampTexture.magFilter=a.TEXTURE_FILTER.LINEAR,this.colorRampTexture.minFilter=a.TEXTURE_FILTER.LINEAR,this.colorRampTexture.generateMipmaps=!1,this.colorRampTexture.version++}resize(){this.renderTarget=new a.RenderTarget2D(this.rttResolution,this.rttResolution),this.renderTarget.texture.magFilter=a.TEXTURE_FILTER.LINEAR,this.renderTarget.texture.minFilter=a.TEXTURE_FILTER.LINEAR,this.renderTarget.texture.generateMipmaps=!1,this.renderTarget.texture.version++,this.renderTarget2=new a.RenderTarget2D(this.rttResolution,this.rttResolution),this.renderTarget2.texture.magFilter=a.TEXTURE_FILTER.LINEAR,this.renderTarget2.texture.minFilter=a.TEXTURE_FILTER.LINEAR,this.renderTarget2.texture.wrapS=this.renderTarget2.texture.wrapT=a.TEXTURE_WRAP.REPEAT,this.renderTarget2.texture.generateMipmaps=!1,this.renderTarget2.texture.version++}_getGradientCode(t){var e="grad:(";for(var i in t)e+=i+":"+t[i]+",";return e+=")"}_gradient(t){if(this._getGradientCode(this._originalGrad)===this._getGradientCode(t)&&!THING.Utils.isNull(this._gradTexture))return this._gradTexture;var e=this._gradCtx.createLinearGradient(0,0,256,0);for(var i in t)e.addColorStop(+i,t[i]);this._gradCtx.fillStyle=e,this._gradCtx.fillRect(0,0,256,1);var r=new a.Texture2D;return r.image=this._gradCtx.canvas,r.version++,this._gradTexture=r,r}_createCanvas(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}}},"./src/uNodes/geologicalmodel/UGeologicalmodelNode.js":(t,e,i)=>{i.r(e),i.d(e,{UGeologicalmodelNode:()=>l});var a=i("@uino/thing-t3d"),r=i("./src/uNodes/Heatmap/Earcut.js"),n=i("./src/uNodes/geologicalmodel/kriging.js");a.Plane.prototype.intersectLine=function(t,e){void 0===e&&(console.warn("t3d.Plane: .intersectLine() target is now required"),e=new a.Vector3);var i=e.subVectors(t.end,t.start),r=this.normal.dot(i);if(0===r)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;var n=-(t.start.dot(this.normal)+this.constant)/r;return n<0||n>1?null:e.copy(i).multiplyScalar(n).add(t.start)},a.Buffer.prototype.setXYZ=function(t,e,i,a){return t*=this.stride,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=a,this},a.Vector3.prototype.fromBufferAttribute=function(t,e){return this.x=t.array[e*this.stride],this.y=t.array[e*this.stride+1],this.z=t.array[e*this.stride+2],this};var s=new Map;let o=new a.Plane(new a.Vector3(0,0,1),500);class l extends a.UNode{static className="UGeologicalmodelNode";constructor(t={}){if(super(t.external.uScene),this._poGroup=new a.Group,this._worldMatrix=t.external.param.worldMatrix?(new a.Matrix4).fromArray(t.external.param.worldMatrix):new a.Matrix4,this._extent=t.external.param.extent,t.external.param.clippingPlane){let e=new a.Vector3(t.external.param.clippingPlane.normal[0],t.external.param.clippingPlane.normal[1],t.external.param.clippingPlane.normal[2]).normalize(),i=t.external.param.clippingPlane.constant;this._clippingPlane={normal:e,constant:i},this._clipPlane=new a.Plane(e.clone(),i)}this._imageRepeat=t.external.param.imageRepeat||[1,1],this._volumeBlockGeo=[],this._clipMesh=[],this._init(t.external.param),this.$markChildrenMatrixAutoUpdate(!1)}_init(t){const e=new a.Geometry,i=new a.Attribute(new a.Buffer(new Float32Array(3e5),3),!1);e.addAttribute("a_Position",i),this.outlineLines=new a.Mesh(e,new a.LineMaterial),this.outlineLines.frustumCulled=!1,this._addcylinderGeometry(t),this._clipfaceGeometrys=[],this._geologicallayers=new Array(t.geologicallayers.length),this._interpolatedData=new Array(t.geologicallayers.length);for(let e=0;e<t.geologicallayers.length;e++)this._geologicallayers[e]=t.geologicallayers[e];let r=t.output;var n=new Int32Array,s=new Int32Array;let o=new Float32Array(1.5*r.pointlist.length);for(let t=0;t<r.pointlist.length/2;t++)o[3*t]=r.pointlist[2*t],o[3*t+2]=r.pointlist[2*t+1];n=r.trianglelist,s=r.segmentlist;for(let e=0;e<t.geologicallayers.length;e++)this._interpolatedData[e]=this._interpolateHorizontalData(this._geologicallayers[e],o);let l=s.length/2,h=new Int32Array(s.length),u=new Int32Array(l),d=new Int32Array(l);for(let t=0;t<l;t++)u[t]=s[2*t],d[t]=s[2*t+1];h[0]=s[0],h[1]=s[1];for(let t=1;t<=l;t++){let e=u.indexOf(h[2*t-1]);h[2*t]=u[e],h[2*t+1]=d[e]}this._blockGroup=new a.Group;for(let e=0;e<t.geologicallayers.length-1;e++){let i=16777215;t.colors&&(i=t.colors[e]),this._volumeBlockGeo[e]=this._createVolumeBlock(this._interpolatedData[e],this._interpolatedData[e+1],n,h,i)}t.clippingPlane&&this._updataClipPlane(t.clippingPlane),this._node.add(this._blockGroup),this._node.add(this._poGroup)}_addcylinderGeometry(t){let e=new a.Group;e.groupType="cylinderGroup",this._cylinderGroup=e;let i=t.data;for(var r=0;r<i.length;r++){const t=new a.ExtendPBRMaterial;for(let n=0;n<i[0].length;n++){void 0===this.cylinderCount&&(this.cylinderCount=i[0].length);const s=new a.CylinderGeometry(1,1,i[r][n][3],20);let o=new a.Mesh(s,t);o.position.set(i[r][n][0],i[r][n][2]-i[r][n][3]/2,i[r][n][1]),e.add(o)}}this._node.add(e)}_updataClipPlane(t){if(t){const e=this.outlineLines.geometry.attributes.a_Position.buffer;e.array.fill(0);let i=new a.Vector3(t.normal[0],t.normal[1],t.normal[2]).normalize();this._clippingPlane={normal:i,constant:t.constant},o.normal=i,o.constant=t.constant,this._clipPlane.normal=i.clone(),this._clipPlane.constant=t.constant,this._clipPlane.applyMatrix4(this._worldMatrix);for(let t=0;t<this._blockGroup.children.length;t++)this._blockGroup.children[t].material.clippingPlanes=[this._clipPlane];for(let t=0;t<this._geologicallayers.length-1;t++){let i=this._lineTriangleIntersect(this._volumeBlockGeo[t],o,e);if(i>0){let r=this._orderLinesegments(e,i);if(this._clipfaceGeometrys[t]&&this._clipfaceGeometrys[t].dispose(),this._clipfaceGeometrys[t]=new a.Geometry,this._triangulation(r,this._clipfaceGeometrys[t]),this._poGroup.children[t])this._poGroup.children[t].visible=!0,this._clipfaceGeometrys[t].removeAttribute("a_Normal"),a.GeometryUtils.computeNormals(this._clipfaceGeometrys[t]),this._clipfaceGeometrys[t].version++,this._poGroup.children[t].geometry=this._clipfaceGeometrys[t],this._poGroup.children[t].material.needsUpdate=!0;else{let e=new a.Mesh(this._clipfaceGeometrys[t],new a.ExtendPBRMaterial);e.material.side=a.DRAW_SIDE.FRONT,this._poGroup.add(e),this._poGroup.groupType="poGroup"}}else this._poGroup.children[t]&&this._poGroup.children[t].geometry&&(this._poGroup.children[t].visible=!1)}this._poGroup.updateWorldMatrix(!0,!0)}else{this._poGroup.visible=!1;for(let t=0;t<this._blockGroup.children.length;t++)this._blockGroup.children[t].material.clippingPlanes=null}}_interpolateHorizontalData(t,e){const i=this._extent.maxX-this._extent.minX,a=this._extent.maxY-this._extent.minY;let r=i>a?i:a;r/=10;let s=[],o=[],l=[];for(let e=0;e<t.length;e++)s.push(t[e][0]),o.push(t[e][1]),l.push(t[e][2]);let h=n.kriging.train(l,s,o,"spherical",0,100,r);for(let t=0;t<e.length/3;t++){let i=e[3*t],a=e[3*t+2],r=n.kriging.predict(i,a,h);e[3*t+1]=r}return e.slice(0)}_initUV(t){let e=[],i=0,a=t.length;for(let r=0;r<a;r+=3){let n=t[(r+3)%a]-t[r],s=t[(r+3)%a+1]-t[r+1],o=t[(r+3)%a+2]-t[r+2],l=Math.sqrt(n*n+s*s+o*o);e.push(i),i+=l}return e.push(i),e}_createVolumeBlock(t,e,i,r,n){let s=r.length/2,o=s+1,l=new Uint32Array(2*i.length+6*o),h=t.length/3,u=new Float32Array(2*t.length+6*o);for(var d=0;d<t.length;d++)u[d]=t[d],u[d+t.length]=e[d];let m=2*t.length,c=m,p=[];for(let e=0;e<s;e++){let i=r[2*e];u[m++]=t[3*i],u[m++]=t[3*i+1],u[m++]=t[3*i+2],p[3*e]=t[3*i],p[3*e+1]=t[3*i+1],p[3*e+2]=t[3*i+2]}m=2*t.length+3*s,u[m++]=u[c],u[m++]=u[c+1],u[m++]=u[c+2];let _=m;m=2*t.length+3*o;for(let t=0;t<s;t++){let i=r[2*t];u[m++]=e[3*i],u[m++]=e[3*i+1],u[m++]=e[3*i+2]}m=2*t.length+6*s+3,u[m++]=u[_],u[m++]=u[_+1],u[m++]=u[_+2];let f=1/0,x=1/0;for(let e=0;e<t.length/3;e++)f>t[3*e]&&(f=t[3*e]),x>t[3*e+2]&&(x=t[3*e+2]);let g=2*t.length/3,y=new Float32Array(2*u.length/3);for(let t=0;t<h;t++)y[2*t]=u[3*t]-f,y[2*t+1]=u[3*t+2]-x,y[2*t+g]=u[3*t]-f,y[2*t+1+g]=u[3*t+2]-x;let v=this._initUV(p),w=2*h*2;for(let i=0;i<s;i++){let a=r[2*i];y[2*i+w]=v[i],y[2*i+1+w]=t[3*a+1]-e[3*a+1]}y[2*s+w]=v[s],y[2*s+1+w]=t[3*r[0]+1]-e[3*r[0]+1],w=2*h*2+2*o;for(let t=0;t<s;t++)y[2*t+w]=v[t],y[2*t+1+w]=0;y[2*s+w]=v[s],y[2*s+1+w]=0;for(let t=0;t<i.length;t++)l[t]=i[t],l[t+i.length]=t%3==1?i[t+1]+h:t%3==2?i[t-1]+h:i[t]+h;let b=2*i.length;for(let t=0;t<o;t++){let e=t+2*h,i=(t+1)%o+2*h,a=e+o,r=i+o;l[b++]=e,l[b++]=a,l[b++]=i,l[b++]=i,l[b++]=a,l[b++]=r}const T=u.slice(),A=y.slice(),S=l.slice();let U=new a.Geometry;const M=T.subarray(0,t.length),R=A.subarray(0,t.length/3*2),D=S.subarray(0,i.length);U.addAttribute("a_Position",new a.Attribute(new a.Buffer(M,3))),U.addAttribute("a_Uv",new a.Attribute(new a.Buffer(R,2))),U.setIndex(new a.Attribute(new a.Buffer(D,1))),U.computeBoundingSphere(),U.computeBoundingBox(),a.GeometryUtils.computeNormals(U);let E=new a.Geometry;const P=T.subarray(t.length,2*t.length),N=A.subarray(t.length/3*2,t.length/3*4),G=S.subarray(0,i.length);E.addAttribute("a_Position",new a.Attribute(new a.Buffer(P,3))),E.addAttribute("a_Uv",new a.Attribute(new a.Buffer(N,2))),E.setIndex(new a.Attribute(new a.Buffer(G,1))),E.computeBoundingSphere(),E.computeBoundingBox(),a.GeometryUtils.computeNormals(E);let C=new a.Geometry;const z=T.subarray(2*t.length),V=A.subarray(t.length/3*4),I=S.subarray(2*i.length);I.forEach(((e,i)=>{I[i]=e-t.length/3*2})),C.addAttribute("a_Position",new a.Attribute(new a.Buffer(z,3))),C.addAttribute("a_Uv",new a.Attribute(new a.Buffer(V,2))),C.setIndex(new a.Attribute(new a.Buffer(I,1))),C.computeBoundingSphere(),C.computeBoundingBox(),a.GeometryUtils.computeNormals(C);const L=new a.ExtendPBRMaterial;this._clipPlane&&(L.clippingPlanes=[this._clipPlane]),L.side=a.DRAW_SIDE.DOUBLE;const O=new a.Mesh(U,L),X=new a.Mesh(E,L),Y=new a.Mesh(C,L);this._blockGroup.add(O),this._blockGroup.add(X),this._blockGroup.add(Y),this._blockGroup.groupType="blockGroup";let B=new a.Geometry;return B.addAttribute("a_Position",new a.Attribute(new a.Buffer(u,3))),B.addAttribute("a_Uv",new a.Attribute(new a.Buffer(y,2))),B.setIndex(new a.Attribute(new a.Buffer(l,1))),B.computeBoundingSphere(),B.computeBoundingBox(),a.GeometryUtils.computeNormals(B),B}_lineTriangleIntersect(t,e,i){let r=0;const n=new a.Vector3,s=new a.Geometry,o=t.attributes.a_Position.buffer.array;for(let l=0;l<t.index.buffer.count;l+=3){let h=o[3*t.index.buffer.array[l]],u=o[3*t.index.buffer.array[l]+1],d=o[3*t.index.buffer.array[l]+2],m=o[3*t.index.buffer.array[l+1]],c=o[3*t.index.buffer.array[l+1]+1],p=o[3*t.index.buffer.array[l+1]+2],_=o[3*t.index.buffer.array[l+2]],f=o[3*t.index.buffer.array[l+2]+1],x=o[3*t.index.buffer.array[l+2]+2],g=0;if(s.start=new a.Vector3(h,u,d),s.end=new a.Vector3(m,c,p),e.intersectLine(s,n)&&(i.setXYZ(r,n.x,n.y,n.z),r++,g++),s.start=new a.Vector3(m,c,p),s.end=new a.Vector3(_,f,x),e.intersectLine(s,n)&&(i.setXYZ(r,n.x,n.y,n.z),g++,r++),s.start=new a.Vector3(_,f,x),s.end=new a.Vector3(h,u,d),e.intersectLine(s,n)&&(i.setXYZ(r,n.x,n.y,n.z),g++,r++),3===g){const t=new a.Vector3,e=new a.Vector3,n=new a.Vector3;t.fromBufferAttribute(i,r-3),e.fromBufferAttribute(i,r-2),n.fromBufferAttribute(i,r-1),n.equals(t)||n.equals(e)?(g--,r--):t.equals(e)&&(i.setXYZ(r-2,n),g--,r--)}2!==g&&(r-=g)}return r}_orderLinesegments(t,e){let i=[];for(let a=0;a<e;a++)i[a]=[t.array[3*a],t.array[3*a+1],t.array[3*a+2]];let a=i.length/2,r=[],n=[],s=[];for(let t=0;t<a;t++)n[t]=i[2*t],s[t]=i[2*t+1];r[0]=i[0],r[1]=i[1];let o=i[1];for(;!this._checkSamePoint(o,i[0]);)for(let t=1;t<a&&2!==i.length;t++){if(this._checkSamePoint(i[2*t],o)){o=i[2*t+1],r.push(i[2*t]),r.push(o),i.splice(2*t,2);break}if(this._checkSamePoint(i[2*t+1],o)){o=i[2*t],r.push(i[2*t+1]),r.push(o),i.splice(2*t,2);break}}let l=[];for(let t=0;t<r.length/2;t++)l[t]=r[2*t];return l}_triangulation(t,e){let i=[],n=1/0,s=1/0,o=-1/0,l=-1/0;for(let e=0;e<t.length;e++)i[2*e]=t[e][0],i[2*e+1]=t[e][1],t[e][0]>o&&(o=t[e][0]),t[e][0]<n&&(n=t[e][0]),t[e][1]>l&&(l=t[e][1]),t[e][1]<s&&(s=t[e][1]);let h=r.Earcut.triangulate(i),u=new Float32Array(t.flat()),d=new Float32Array(2*u.length/3);for(let t=0;t<u.length/3;t++)d[2*t]=u[3*t]-n,d[2*t+1]=u[3*t+1]-s;let m=new Uint32Array(h);e.addAttribute("a_Position",new a.Attribute(new a.Buffer(u,3))),e.addAttribute("a_Uv",new a.Attribute(new a.Buffer(d,2))),e.setIndex(new a.Attribute(new a.Buffer(m,1))),e.computeBoundingBox(),e.computeBoundingSphere(),a.GeometryUtils.computeNormals(e)}_checkSamePoint(t,e){return t&&e||console.log(t[0]),!!(t[0]===e[0]&t[1]===e[1]&t[2]===e[2])}_getImageTexture(t,e){let i=s.get("_blockdiffuseMap_"+e);if(!i){i=(new a.Texture2DLoader).load(t[e]),i.wrapS=i.wrapT=a.WEBGL_TEXTURE_WRAP.REPEAT,s.set("_blockdiffuseMap_"+e,i)}return i}setdiffuseMap(t){if(this._cylinderGroup){for(let e=0;e<this._cylinderGroup.children.length;e++){let i=this._cylinderGroup.children[e],a=this._getImageTexture(t,Math.floor(e/this.cylinderCount));i.material.diffuseMap=a,i.material.diffuseMap.version++,i.material.needsUpdate=!0}if(this._poGroup)for(let e=0;e<this._poGroup.children.length;e++){let i=this._poGroup.children[e],a=this._getImageTexture(t,e);i.material.diffuseMap=a,i.material.diffuseMapTransform.setUvTransform(0,0,this._imageRepeat[0],this._imageRepeat[1],0,0,0),i.material.diffuseMap.version++,i.material.needsUpdate=!0}if(this._blockGroup)for(let e=0;e<this._blockGroup.children.length;e++){let i=this._blockGroup.children[e],a=this._getImageTexture(t,Math.floor(e/3));i.material.diffuseMap=a,i.material.diffuseMapTransform.setUvTransform(0,0,this._imageRepeat[0],this._imageRepeat[1],0,0,0),i.material.diffuseMap.version++,i.material.needsUpdate=!0}}}setVisibleByIndex(t,e,i=!0){if(i&&this._cylinderGroup)for(let i=0;i<this.cylinderCount;i++){this._cylinderGroup.children[e*this.cylinderCount+i].visible=t}if(this._poGroup&&this._poGroup.children[e]&&(this._poGroup.children[e].visible=t),this._blockGroup)for(let i=0;i<3;i++){this._blockGroup.children[3*e+i].visible=t}}setBottomBlockVisibleByIndex(t,e){if(this._blockGroup){this._blockGroup.children[3*e+1].visible=t}}setTopBlockVisibleByIndex(t,e){if(this._blockGroup){this._blockGroup.children[3*e+0].visible=t}}setSideBlockVisibleByIndex(t,e){if(this._blockGroup){this._blockGroup.children[3*e+2].visible=t}}setdiffuse(t){if(this._cylinderGroup)for(let e=0;e<this._cylinderGroup.children.length;e++){let i=this._cylinderGroup.children[e];i.material.diffuse=(new a.Color3).fromArray(t[Math.floor(e/this.cylinderCount)]),i.material.needsUpdate=!0,i.material.version++}if(this._poGroup)for(let e=0;e<this._poGroup.children.length;e++){let i=this._poGroup.children[e];i.material.diffuse=(new a.Color3).fromArray(t[e]),i.material.needsUpdate=!0,i.material.version++}if(this._blockGroup)for(let e=0;e<this._blockGroup.children.length;e++){let i=this._blockGroup.children[e];i.material.diffuse=(new a.Color3).fromArray(t[Math.floor(e/3)]),i.material.needsUpdate=!0,i.material.version++}}dispose(){if(this.outlineLines.material.dispose(),this.outlineLines.geometry.dispose(),this._cylinderGroup)for(let t=0;t<this._cylinderGroup.children.length;t++){let e=this._cylinderGroup.children[t];e.material.dispose(),e.geometry.dispose()}if(this._poGroup)for(let t=0;t<this._poGroup.children.length;t++){let e=this._poGroup.children[t];e.material.dispose(),e.geometry.dispose()}if(this._blockGroup)for(let t=0;t<this._blockGroup.children.length;t++){let e=this._blockGroup.children[t];e.material.dispose(),e.geometry.dispose()}for(let t=0;t<this._clipMesh.length;t++)this._clipMesh[t].material.dispose(),this._clipMesh[t].geometry.dispose()}}},"./src/uNodes/geologicalmodel/kriging.js":(t,e,i)=>{function a(t,e){return Array(...new Array(e)).map(Number.prototype.valueOf,t[0])}function r(t,e,i){let a,r,n=!1;for(a=0,r=t.length-1;a<t.length;r=a++)t[a][1]>i!=t[r][1]>i&&e<(t[r][0]-t[a][0])*(i-t[a][1])/(t[r][1]-t[a][1])+t[a][0]&&(n=!n);return n}function n(t,e){let i;const r=a([0],e*e);for(i=0;i<e;i++)r[i*e+i]=t;return r}function s(t,e,i,a){let r,n;const s=Array(i*a);for(r=0;r<i;r++)for(n=0;n<a;n++)s[r*a+n]=t[r*a+n]+e[r*a+n];return s}function o(t,e,i,a,r){let n,s,o;const l=Array(i*r);for(n=0;n<i;n++)for(s=0;s<r;s++)for(l[n*r+s]=0,o=0;o<a;o++)l[n*r+s]+=t[n*a+o]*e[o*r+s];return l}function l(t,e){let i,a,r;const n=Array(e);for(i=0;i<e;i++)n[i]=t[i*e+i];for(i=0;i<e;i++){for(a=0;a<i;a++)n[i]-=t[i*e+a]*t[i*e+a];if(n[i]<=0)return!1;for(n[i]=Math.sqrt(n[i]),a=i+1;a<e;a++){for(r=0;r<i;r++)t[a*e+i]-=t[a*e+r]*t[i*e+r];t[a*e+i]/=n[i]}}for(i=0;i<e;i++)t[i*e+i]=n[i];return!0}function h(t,e){let i,a,r,n;for(i=0;i<e;i++)for(t[i*e+i]=1/t[i*e+i],a=i+1;a<e;a++){for(n=0,r=i;r<a;r++)n-=t[a*e+r]*t[r*e+i];t[a*e+i]=n/t[a*e+a]}for(i=0;i<e;i++)for(a=i+1;a<e;a++)t[i*e+a]=0;for(i=0;i<e;i++){for(t[i*e+i]*=t[i*e+i],r=i+1;r<e;r++)t[i*e+i]+=t[r*e+i]*t[r*e+i];for(a=i+1;a<e;a++)for(r=a;r<e;r++)t[i*e+a]+=t[r*e+i]*t[r*e+a]}for(i=0;i<e;i++)for(a=0;a<i;a++)t[i*e+a]=t[a*e+i]}function u(t,e){const i=e,a=Array(e*e),r=Array(e),n=Array(e),s=Array(e);let o,l,h,u,d,m,c,p,_,f,x;for(o=0;o<e;o++)for(u=0;u<e;u++)a[o*e+u]=o===u?1:0;for(u=0;u<e;u++)s[u]=0;for(o=0;o<e;o++){for(p=0,u=0;u<e;u++)if(1!==s[u])for(d=0;d<e;d++)0===s[d]&&Math.abs(t[u*e+d])>=p&&(p=Math.abs(t[u*e+d]),h=u,l=d);if(++s[l],h!==l){for(m=0;m<e;m++)x=t[h*e+m],t[h*e+m]=t[l*e+m],t[l*e+m]=x;for(m=0;m<i;m++)x=a[h*e+m],a[h*e+m]=a[l*e+m],a[l*e+m]=x}if(n[o]=h,r[o]=l,0===t[l*e+l])return!1;for(f=1/t[l*e+l],t[l*e+l]=1,m=0;m<e;m++)t[l*e+m]*=f;for(m=0;m<i;m++)a[l*e+m]*=f;for(c=0;c<e;c++)if(c!==l){for(_=t[c*e+l],t[c*e+l]=0,m=0;m<e;m++)t[c*e+m]-=t[l*e+m]*_;for(m=0;m<i;m++)a[c*e+m]-=a[l*e+m]*_}}for(m=e-1;m>=0;m--)if(n[m]!==r[m])for(d=0;d<e;d++)x=t[d*e+n[m]],t[d*e+n[m]]=t[d*e+r[m]],t[d*e+r[m]]=x;return!0}function d(t,e,i,a,r){return e+(a-e)/i*(1-Math.exp(-1/r*Math.pow(t/i,2)))}function m(t,e,i,a,r){return e+(a-e)/i*(1-Math.exp(-1/r*(t/i)))}function c(t,e,i,a,r){return t>i?e+(a-e)/i:e+(a-e)/i*(t/i*1.5-.5*Math.pow(t/i,3))}i.r(e),i.d(e,{kriging:()=>p});const p=function(){const t={};return t.train=function(t,e,i,r,p,_,f){const x={t,x:e,y:i,nugget:0,range:0,sill:0,A:1/3,n:0};switch(r){case"gaussian":x.model=d;break;case"exponential":x.model=m;break;case"spherical":x.model=c}let g,y,v,w,b=t.length;const T=Array((b*b-b)/2);for(g=0,v=0;g<b;g++)for(y=0;y<g;y++,v++)T[v]=Array(2),T[v][0]=Math.pow(Math.pow(e[g]-e[y],2)+Math.pow(i[g]-i[y],2),.5),T[v][1]=Math.abs(t[g]-t[y]);T.sort(((t,e)=>t[0]-e[0])),x.range=T[(b*b-b)/2-1][0];const A=(b*b-b)/2>30?30:(b*b-b)/2,S=x.range/A,U=a([0],A),M=a([0],A);if(A<30)for(w=0;w<A;w++)U[w]=T[w][0],M[w]=T[w][1];else{for(g=0,y=0,v=0,w=0;g<A&&y<(b*b-b)/2;g++,v=0){for(;T[y][0]<=(g+1)*S&&(U[w]+=T[y][0],M[w]+=T[y][1],y++,v++,!(y>=(b*b-b)/2)););v>0&&(U[w]/=v,M[w]/=v,w++)}if(w<2)return x}b=w,x.range=f;const R=a([1],2*b),D=Array(b),E=x.A;for(g=0;g<b;g++){switch(r){case"gaussian":R[2*g+1]=1-Math.exp(-1/E*Math.pow(U[g]/x.range,2));break;case"exponential":R[2*g+1]=1-Math.exp(-1/E*U[g]/x.range);break;case"spherical":R[2*g+1]=U[g]/x.range*1.5-.5*Math.pow(U[g]/x.range,3)}D[g]=M[g]}const P=function(t,e,i){let a,r;const n=Array(i*e);for(a=0;a<e;a++)for(r=0;r<i;r++)n[r*e+a]=t[a*i+r];return n}(R,b,2);let N=o(P,R,2,b,2);N=s(N,n(1/_,2),2,2);const G=N.slice(0);l(N,2)?h(N,2):(u(G,2),N=G);const C=o(o(N,P,2,2,b),D,2,b,1);x.nugget=C[0],x.sill=C[1]*x.range+x.nugget,x.n=e.length,b=e.length;var z=Array(b*b);for(g=0;g<b;g++){for(y=0;y<g;y++)z[g*b+y]=x.model(Math.pow(Math.pow(e[g]-e[y],2)+Math.pow(i[g]-i[y],2),.5),x.nugget,x.range,x.sill,x.A),z[y*b+g]=z[g*b+y];z[g*b+g]=x.model(0,x.nugget,x.range,x.sill,x.A)}let V=s(z,n(p,b),b,b);const I=V.slice(0);l(V,b)?h(V,b):(u(I,b),V=I);z=V.slice(0);const L=o(V,t,b,b,1);return x.K=z,x.M=L,x},t.predict=function(t,e,i){let a;const r=Array(i.n);for(a=0;a<i.n;a++)r[a]=i.model(Math.pow(Math.pow(t-i.x[a],2)+Math.pow(e-i.y[a],2),.5),i.nugget,i.range,i.sill,i.A);return o(r,i.M,1,i.n,1)[0]},t.variance=function(t,e,i){let a;const r=Array(i.n);for(a=0;a<i.n;a++)r[a]=i.model(Math.pow(Math.pow(t-i.x[a],2)+Math.pow(e-i.y[a],2),.5),i.nugget,i.range,i.sill,i.A);return i.model(0,i.nugget,i.range,i.sill,i.A)+o(o(r,i.K,1,i.n,i.n),r,1,i.n,1)[0]},t.grid=function(e,i,a){let n,s,o;const l=e.length;if(0===l)return;const h=[e[0][0][0],e[0][0][0]],u=[e[0][0][1],e[0][0][1]];for(n=0;n<l;n++)for(s=0;s<e[n].length;s++)e[n][s][0]<h[0]&&(h[0]=e[n][s][0]),e[n][s][0]>h[1]&&(h[1]=e[n][s][0]),e[n][s][1]<u[0]&&(u[0]=e[n][s][1]),e[n][s][1]>u[1]&&(u[1]=e[n][s][1]);let d,m;const c=Array(2),p=Array(2),_=Array(2),f=Array(2),x=Math.ceil((h[1]-h[0])/a),g=Math.ceil((u[1]-u[0])/a),y=Array(x+1);for(n=0;n<=x;n++)y[n]=Array(g+1);for(n=0;n<l;n++){for(_[0]=e[n][0][0],_[1]=_[0],f[0]=e[n][0][1],f[1]=f[0],s=1;s<e[n].length;s++)e[n][s][0]<_[0]&&(_[0]=e[n][s][0]),e[n][s][0]>_[1]&&(_[1]=e[n][s][0]),e[n][s][1]<f[0]&&(f[0]=e[n][s][1]),e[n][s][1]>f[1]&&(f[1]=e[n][s][1]);for(c[0]=Math.floor((_[0]-(_[0]-h[0])%a-h[0])/a),c[1]=Math.ceil((_[1]-(_[1]-h[1])%a-h[0])/a),p[0]=Math.floor((f[0]-(f[0]-u[0])%a-u[0])/a),p[1]=Math.ceil((f[1]-(f[1]-u[1])%a-u[0])/a),s=c[0];s<=c[1];s++)for(o=p[0];o<=p[1];o++)d=h[0]+s*a,m=u[0]+o*a,r(e[n],d,m)&&(y[s][o]=t.predict(d,m,i))}return y.xlim=h,y.ylim=u,y.zlim=[Math.min(...i.t),Math.max(...i.t)],y.width=a,y},t.contour=function(t,e,i){},t.plot=function(t,e,i,a,r){console.time("plot");const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=[i[1]-i[0],a[1]-a[0],e.zlim[1]-e.zlim[0]];let o,l,h,u,d;const m=e.length,c=e[0].length,p=Math.ceil(e.width*t.width/(i[1]-i[0])),_=Math.ceil(e.width*t.height/(a[1]-a[0]));for(o=0;o<m;o++)for(l=0;l<c;l++)void 0!==e[o][l]&&(h=t.width*(o*e.width+e.xlim[0]-i[0])/s[0],u=t.height*(1-(l*e.width+e.ylim[0]-a[0])/s[1]),d=(e[o][l]-e.zlim[0])/s[2],d<0&&(d=0),d>1&&(d=1),n.fillStyle=r[Math.floor((r.length-1)*d)],n.fillRect(Math.round(h-p/2),Math.round(u-_/2),p,_))},t}()},"./src/uNodes/volumerendering/UVolumerenderNode.js":(t,e,i)=>{i.r(e),i.d(e,{UVolumerenderNode:()=>l});var a=i("@uino/thing-t3d");const r=new a.Texture2DLoader,n="\n\t\tconst vec3 oneOverRadii=vec3(1.5678896205707118e-7);\n\t\tconst vec3 oneOverRadiiSquared=vec3(2.4582778622933707e-14);\n\t\tconst float centerToleranceSquared=0.1;\n\t\t#define SIGN(x) ((x) < 0. ? -1. : 1.)\n\t\tfloat getAngleBetweenVectors(vec3 a,vec3 b){\n\t\t\treturn  degrees(acos(dot(a, b)));\n\t\t}\n\t\tvec3 webMercatorToCartographic(vec3 cartesian){\n\t\t\tfloat longitude = degrees(cartesian.x*oneOverRadii.x);\n\t\t\tfloat latitude =  -degrees(cartesian.z*oneOverRadii.z);\n\t\t\tfloat height = cartesian.y;\n\t\t\treturn vec3(longitude-u_minPos.x,latitude-u_minPos.y,height-u_minPos.z)/(u_maxPos-u_minPos);\n\t\t}\n\t\tvec3 cartesianToCartographic(vec3 cartesian){\n\t\t\treturn vec3(cartesian.x-u_minPos.x,cartesian.y-u_minPos.y,cartesian.z-u_minPos.z)/(u_maxPos-u_minPos);\n\t\t}\n";var s=new a.ShaderMaterial({defines:{},vertexShader:"\n\t\t#include <common_vert>\n\t\t#include <logdepthbuf_pars_vert>\n\t\tprecision highp float;\n\t\tattribute vec2 a_Uv;\n\t\tattribute vec3 a_Lonlat;\n\n\t\tuniform vec3 dimensions;\n\t\tuniform vec3 u_minPos;\n\t\tuniform vec3 u_maxPos;\n\t\tvarying vec3 v_lonlat;\n\t\tvarying vec3 v_pos;\n\t\tvarying vec3 worldSpaceCoords;\n\n\t\tvoid main() {\n\t\t\t//Set the world space coordinates of the back faces vertices as output.\n\n\t\t\tworldSpaceCoords =(a_Position-u_minPos)/(u_maxPos-u_minPos); //move it from [-0.5;0.5] to [0,1]\n\t\t\tv_pos = a_Position;\n\t\t\tv_lonlat = a_Lonlat;\n\t\t\tgl_Position = u_ProjectionView * u_Model * vec4(a_Position.xyz, 1.0);\n\t\t}\n\t",fragmentShader:`\n\t\t#include <common_frag>\n\t\tprecision highp float;\n\t\tvarying vec3 worldSpaceCoords;\n\t\tvarying vec3 v_lonlat;\n\t\tuniform bool uniformBox;\n\t\tuniform vec3 u_minPos;\n\t\tuniform vec3 u_maxPos;\n\t\t\n\t\t${n}\n\t\t\n\t\t#include <logdepthbuf_pars_frag>\n\t\tvoid main() {\n\t\t\t//The fragment's world space coordinates as fragment output.\n\t\t\tvec4 fragColor;\n\t\t\tif( uniformBox)\n\t\t\t{ \n\t\t\t\tfragColor = vec4( worldSpaceCoords.x , worldSpaceCoords.y, worldSpaceCoords.z, 1. ); \n\t\t\t} \n\t\t\telse\n\t\t\t{ \n\t\t\t\tfragColor = vec4(cartesianToCartographic(v_lonlat), 1. );\n\t\t\t}\n\t\t\tgl_FragColor = fragColor;\n\t\t}\n\t`,uniforms:{dimensions:[1,1,1],uniformBox:!1,u_minPos:[0,0,1e3],u_maxPos:[150,44.6,65e4]}}),o=new a.ShaderMaterial({defines:{},uniforms:{rtTexture:null,cubeTex:null,colorRampTexture:null,numSamples:887,alphaCorrection:1,dimensions:[1,1,1],zsliceNum:256,zslicex:16,zslicey:16,uniformBox:!1,u_minPos:[0,0,1e3],u_maxPos:[150,44.6,65e4],planeComponents:[0,1,0,0]},vertexShader:"\n\t\t#include <common_vert>\n\t\tprecision highp float;\n\t\tattribute vec2 a_Uv;\n\t\tattribute vec3 a_Lonlat;\n\n\t\tuniform vec3 u_minPos;\n\t\tuniform vec3 u_maxPos;\n\t\tvarying vec3 v_lonlat;\n\t\tvarying vec3 v_pos;\n\t\tvarying vec2 v_Uv;\n\t\tvarying vec3 worldSpaceCoords;\n\t\tvarying vec4 projectedCoords;\n\t\t\n\t\tuniform vec3 dimensions;\n\t\t#include <logdepthbuf_pars_vert>\n\n\t\tvoid main() {\n\t\t\tv_pos = a_Position;\n\t\t\tv_Uv = a_Uv;\n\t\t\tv_lonlat = a_Lonlat;\n\t\t\tworldSpaceCoords = (a_Position-u_minPos)/(u_maxPos-u_minPos); //move it from [-0.5;0.5] to [0,1]\n\n\t\t\tprojectedCoords =  u_ProjectionView * u_Model * vec4( a_Position, 1.0 );\n\t\t\tgl_Position = projectedCoords;\n\t\t\t#include <logdepthbuf_vert>\n\t\t}\n\t",fragmentShader:`\n\t\t#include <common_frag>\n\t\tprecision highp float;\n\t\tvarying vec3 worldSpaceCoords;\n\t\tvarying vec4 projectedCoords;\n\t\tvarying vec3 v_pos;\n\t\tvarying vec2 v_Uv;\n\t\tvarying vec3 v_lonlat;\n\t\tuniform sampler2D rtTexture, cubeTex, colorRampTexture;\n\t\tuniform int numSamples;\n\t\tuniform float alphaCorrection;\n\t\tuniform float zsliceNum;\n\t\tuniform float zslicex;\n\t\tuniform float zslicey;\n\t\tuniform vec3 u_minPos;\n\t\tuniform vec3 u_maxPos;\n\t\tuniform vec3 u_minPos1;\n\t\tuniform vec3 u_maxPos1;\n\t\tuniform bool uniformBox;\n\t\tuniform vec4 planeComponents;\n\t\t#include <logdepthbuf_pars_frag>\n\n\t\t// float decodeValue(vec3 cv) {\n\t\t// \tfloat a = (cv.r + cv.g + cv.b) / 3.;\n\t\t// \treturn a;\n\t\t// }\n\t\t//Acts like a texture3D using Z slices and trilinear filtering.\n\t\tvec4 sampleAs3DTexture( vec3 texCoord )\n\t\t{\n\t\t\tvec4 colorSlice1, colorSlice2;\n\t\t\tvec2 texCoordSlice1, texCoordSlice2;\n\n\t\t\t//The z coordinate determines which Z slice we have to look for.\n\t\t\t//Z slice number goes from 0 to zsliceNum-1..\n\t\t\tfloat zdepth = (zsliceNum-1.);\n\t\t\tfloat zSliceNumber1 = floor(texCoord.z  * zdepth);\n\n\t\t\t//As we use trilinear we go the next Z slice.\n\t\t\tfloat zSliceNumber2 = min( zSliceNumber1 + 1.0, zdepth); \n\n\t\t\t//The Z slices are stored in a matrix of 16x16 of Z slices.\n\t\t\t//The original UV coordinates have to be rescaled by the tile numbers in each row and column.\n\t\t\t// texCoord.xy /= 16.0;\n\t\t\ttexCoord.x /= zslicex;\n\t\t\ttexCoord.y /= zslicey;\n\n\t\t\ttexCoordSlice1 = texCoordSlice2 = texCoord.xy;\n\n\t\t\t//Add an offset to the original UV coordinates depending on the row and column number.\n\t\t\ttexCoordSlice1.x += (mod(zSliceNumber1, zslicex ) / zslicex);\n\t\t\ttexCoordSlice1.y += floor((zdepth - zSliceNumber1) / zslicey) / zslicey;\n\n\t\t\ttexCoordSlice2.x += (mod(zSliceNumber2, zslicex ) / zslicex);\n\t\t\ttexCoordSlice2.y += floor((zdepth - zSliceNumber2) / zslicey) / zslicey;\n\n\t\t\t//Get the opacity value from the 2D texture.\n\t\t\t//Bilinear filtering is done at each texture2D by default.\n\t\t\tcolorSlice1 = texture2D( cubeTex, texCoordSlice1 );\n\t\t\tcolorSlice2 = texture2D( cubeTex, texCoordSlice2 );\n\n\t\t\t//Based on the opacity obtained earlier, get the RGB color in the transfer function texture.\n\t\t\tcolorSlice1.rgb = texture2D( colorRampTexture, vec2( colorSlice1.a, 0.5)).rgb;\n\t\t\tcolorSlice2.rgb = texture2D( colorRampTexture,vec2( colorSlice1.a, 0.5)).rgb;\n\t\t\t// colorSlice1.rgb = texture2D( colorRampTexture, vec2( decodeValue(colorSlice1.rgb), 0.5) ).rgb;\n\t\t\t// colorSlice2.rgb = texture2D( colorRampTexture, vec2( decodeValue(colorSlice2.rgb), 0.5) ).rgb;\n\n\t\t\t//How distant is zSlice1 to ZSlice2. Used to interpolate between one Z slice and the other.\n\t\t\tfloat zDifference = mod(texCoord.z * zdepth, 1.0);\n\n\t\t\t//Finally interpolate between the two intermediate colors of each Z slice.\n\t\t\treturn mix(colorSlice1, colorSlice2, zDifference) ;\n\t\t}\n\n\t\t${n}\n\t\t\t\t\n\t\tvoid main() {\n\t\t\t#include <logdepthbuf_frag>\n\t\t\t//Transform the coordinates it from [-1;1] to [0;1]\n\t\t\tvec2 texc = vec2(((projectedCoords.x / projectedCoords.w) + 1.0 ) / 2.0,\n\t\t\t\t\t\t\t((projectedCoords.y / projectedCoords.w) + 1.0 ) / 2.0 );\n\n\t\t\t//The back position is the world space position stored in the texture.\n\t\t\tvec3 backPos = texture2D(rtTexture, texc).xyz;\n\n\t\t\t//The front position is the world space position of the second render pass.\n\t\t\tvec3 coord = cartesianToCartographic(v_lonlat);\n\t\t\tvec3 frontPos = uniformBox? worldSpaceCoords:coord;// \n\n\t\t\t//The direction from the front position to back position.\n\t\t\tvec3 dir = backPos - frontPos;\n\n\t\t\tfloat rayLength = length(dir);\n\n\t\t\t//Calculate how long to increment in each step.\n\t\t\tfloat stepSize = 1.0 / float(numSamples);\n\n\t\t\t//The increment in each direction for each step.\n\t\t\tvec3 deltaDirection = normalize(dir) * stepSize;\n\t\t\tfloat deltaDirectionLength = length(deltaDirection);\n\n\t\t\t//Start the ray casting from the front position.\n\t\t\tvec3 currentPosition = frontPos;\n\n\t\t\t//The color accumulator.\n\t\t\tvec4 accumulatedColor = vec4(0.0);\n\n\t\t\t//The alpha value accumulated so far.\n\t\t\tfloat accumulatedAlpha = 0.0;\n\n\t\t\t//How long has the ray travelled so far.\n\t\t\tfloat accumulatedLength = 0.0;\n\t\t\tfloat travel = length(dir);\n\n\t\t\t//If we have twice as many samples, we only need ~1/2 the alpha per sample.\n\t\t\t//Scaling by 256/10 just happens to give a good value for the alphaCorrection slider.\n\t\t\tfloat alphaScaleFactor = zsliceNum * 0.5 * stepSize;\n\n\t\t\tvec4 colorSample;\n\t\t\tfloat alphaSample;\n\t\t\tvec3 planeNormal = normalize(planeComponents.xyz);\n\n\t\t\t//Perform the ray marching iterations\n\t\t\tfor(int i = 0; i < numSamples; i++)\n\t\t\t{\n\t\t\t\tif (travel <= 0.0) break;\n\n\t\t\t\t//Get the voxel intensity value from the 3D texture.\n\t\t\t\tcolorSample = sampleAs3DTexture( currentPosition );\n\n\t\t\t\t//Allow the alpha correction customization.\n\t\t\t\talphaSample = colorSample.a * alphaCorrection;\n\n\t\t\t\t//Applying this effect to both the color and alpha accumulation results in more realistic transparency.\n\t\t\t\talphaSample *= (1.0 - accumulatedAlpha);\n\n\t\t\t\t//Scaling alpha by the number of steps makes the final color invariant to the step size.\n\t\t\t\talphaSample *= alphaScaleFactor;\n\n\t\t\t\t// add clipping plane: planeNormal  planeconstant =planeComponents.w;\n\t\t\t\tif((planeNormal.x*currentPosition.x+planeNormal.y*currentPosition.y+planeNormal.z*currentPosition.z-planeComponents.w)>0.){\n\t\t\t\t\t//Perform the composition.\n\t\t\t\t\taccumulatedColor += colorSample * alphaSample; \n\n\t\t\t\t\t//Store the alpha accumulated so far.\n\t\t\t\t\taccumulatedAlpha += alphaSample;\n\t\t\t\t}\n\n\n\t\t\t\t//Advance the ray.\n\t\t\t\tcurrentPosition += deltaDirection;\n\t\t\t\taccumulatedLength += deltaDirectionLength;\n\t\t\t\ttravel -= deltaDirectionLength;\n\n\t\t\t\t//If the length traversed is more than the ray length, or if the alpha accumulated reaches 1.0 then exit.\n\t\t\t\tif( accumulatedAlpha >= 1.0 )\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tgl_FragColor.rgb = accumulatedColor.rgb; \n\t\t\t// huyang \n\t\t\tif(backPos.x==0.0&&backPos.y==0.0&&backPos.z==0.0){\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t\tgl_FragColor.a = accumulatedAlpha * u_Opacity;\n\t\t\t// gl_FragColor.a = u_Opacity;\n\t\t}\n\t`});class l extends a.UNode{static className="UVolumerenderNode";constructor(t={}){super(t.external.uScene),this._mesh=null;const e=t.external.param;this._steps=THING.Utils.parseValue(e.steps,512),this._alphaCorrection=THING.Utils.parseValue(e.alphaCorrection,.5),this.dimensions=[e.extent.maxX-e.extent.minX,e.extent.maxY-e.extent.minY,e.extent.maxZ-e.extent.minZ],this._vertexData=e.vertexData,this._minPos=e.minPos,this._maxPos=e.maxPos,this._extent=e.extent,this._uniformBox=THING.Utils.parseValue(e.uniformBox,!0),this._zsliceNum=THING.Utils.parseValue(e.zsliceNum,256),e.clippingPlane&&this._updataClipPlane(e.clippingPlane),this._grad=THING.Utils.parseValue(e.gradient,{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"});var i=this._createCanvas();let n;if(i.width=256,i.height=1,this._gradCtx=i.getContext("2d"),this._originalGrad=this._grad,this._gradTexture=this._gradient(this._grad),o.uniforms.colorRampTexture=this._gradTexture,o.uniforms.zsliceNum=this._zsliceNum,o.uniforms.zslicex=Math.sqrt(this._zsliceNum),o.uniforms.zslicey=Math.sqrt(this._zsliceNum),o.uniforms.numSamples=Math.ceil(Math.sqrt(3)*this.steps),o.uniforms.alphaCorrection=this._alphaCorrection,this._clippingPlane&&(o.uniforms.planeComponents=[this._clippingPlane.normal[0],this._clippingPlane.normal[1],this._clippingPlane.normal[2],this.normalConstant]),e.cubeTexData){const t=e.cubeTexData;n=new a.Texture2D,n.image={data:t.data,width:t.width,height:t.height},n.format=a.PIXEL_FORMAT.ALPHA}else e.cubeTexUrl&&(n=r.load(e.cubeTexUrl));n&&(n.generateMipmaps=!1,n.minFilter=a.TEXTURE_FILTER.LINEAR,n.magFilter=a.TEXTURE_FILTER.LINEAR,this._cubeTex=n),this.rttscene=new a.Scene,this.rttcamera=new a.Camera;const l=e.camera;this.rttcamera.position.set(l.position[0],l.position[1],l.position[2]),this.rttcamera.lookAt(new a.Vector3(l.target[0],l.target[1],l.target[2]),new a.Vector3(l.up[0],l.up[1],l.up[2])),this.rttcamera.setPerspective(l.fov*Math.PI/180,l.aspect,l.near,l.far),this.rttscene.add(this.rttcamera),this._boxGeometry=this._createGeo(),s.uniforms.u_minPos=this._minPos,s.uniforms.u_maxPos=this._maxPos,s.uniforms.uniformBox=this._uniformBox,s.side=a.DRAW_SIDE.BACK,s.uniforms.dimensions=[this.dimensions[0],this.dimensions[1],this.dimensions[2]],this._rttbox=new a.Mesh(this._boxGeometry,s),this.rttscene.add(this._rttbox),this.renderer=e.renderer,this.backRenderTarget=this.renderer.backRenderTarget,this.createRenderTarget(),this.drawRttTexture(),this._createNode()}get gradient(){return this._grad}set gradient(t){this._originalGrad=this._grad,this._mesh.material.uniforms.colorRampTexture=null,"object"==typeof t&&null!==t&&Object.keys(t).length>0&&(this._gradTexture=this._gradient(t),this._mesh.material.uniforms.colorRampTexture=this._gradTexture),this._grad=t,this.drawRttTexture()}get steps(){return this._steps}set steps(t){this._steps=t,this._mesh.material.uniforms.numSamples=Math.ceil(1.7320508075688772*this._steps)}get alphaCorrection(){return this._alphaCorrection}set alphaCorrection(t){this._alphaCorrection=t,this._mesh.material.uniforms.alphaCorrection=this._alphaCorrection}get cubeTex(){return this._cubeTex}set cubeTex(t){"string"==typeof t?r.load(t,(t=>{t.generateMipmaps=!1,t.minFilter=a.TEXTURE_FILTER.LINEAR,t.magFilter=a.TEXTURE_FILTER.LINEAR,this._mesh.material.uniforms.cubeTex=t,this._cubeTex=t})):t instanceof Object&&(this._cubeTex.image={data:t.data,width:t.width,height:t.height},this._cubeTex.version++,this._mesh.material.uniforms.cubeTex=this._cubeTex)}_createGeo(){var t;if(this._vertexData){const e=this._vertexData;t=new a.Geometry,e.index&&t.setIndex(new a.Attribute(new a.Buffer(e.position.length/3>65536?new Uint32Array(e.index):new Uint16Array(e.index),1))),t.groups=this._vertexData.group,t.addAttribute("a_Position",new a.Attribute(new a.Buffer(new Float32Array(e.position),3))),t.addAttribute("a_Uv",new a.Attribute(new a.Buffer(new Float32Array(e.uv),2))),t.addAttribute("a_Lonlat",new a.Attribute(new a.Buffer(new Float32Array(e.lonlat),3)))}else{t=new a.BoxGeometry(this.dimensions[0],this.dimensions[1],this.dimensions[2]);const e=(this._extent.maxX+this._extent.minX)/2,i=(this._extent.maxY+this._extent.minY)/2,r=(this._extent.maxZ+this._extent.minZ)/2;for(let a=0;a<t.attributes.a_Position.buffer.count;a++)t.attributes.a_Position.buffer.array[3*a]+=e,t.attributes.a_Position.buffer.array[3*a+1]+=i,t.attributes.a_Position.buffer.array[3*a+2]+=r}return t.computeBoundingBox(),t.computeBoundingSphere(),t}_createNode(){this._minPos&&this._maxPos&&(o.uniforms.u_minPos=this._minPos,o.uniforms.u_maxPos=this._maxPos),o.uniforms.uniformBox=this._uniformBox,this._mesh?this._mesh.material.uniforms.rtTexture=this.renderTarget.texture:(o.uniforms.rtTexture=this.renderTarget.texture,o.uniforms.cubeTex=this._cubeTex,o.side=a.DRAW_SIDE.FRONT,o.uniforms.dimensions=[this.dimensions[0],this.dimensions[1],this.dimensions[2]],o.transparent=!0,o.depthWrite=!1,this._mesh=new a.Mesh(this._boxGeometry,o),this.$markChildrenMatrixAutoUpdate(!1),this._node.add(this._mesh))}drawRttTexture(){this.rttscene.updateMatrix(),this.rttscene.updateRenderStates(this.rttcamera),this.rttscene.updateRenderQueue(this.rttcamera),this.renderer.setRenderTarget(this.renderTarget),this.renderer.setClearColor(0,0,0,0),this.renderer.clear(!0,!0,!0),this.renderer.renderScene(this.rttscene,this.rttcamera)}createRenderTarget(){this.renderTarget=new a.RenderTarget2D(2048,2048),this.renderTarget.texture.magFilter=a.TEXTURE_FILTER.NEAREST,this.renderTarget.texture.minFilter=a.TEXTURE_FILTER.NEAREST,this.renderTarget.texture.wrapS=a.TEXTURE_WRAP.CLAMP_TO_EDGE,this.renderTarget.texture.wrapT=a.TEXTURE_WRAP.CLAMP_TO_EDGE,this.renderTarget.texture.format=a.PIXEL_FORMAT.RGBA,this.renderTarget.texture.generateMipmaps=!1}dispose(){this.renderTarget.dispose(),this._gradTexture.dispose(),this._rttbox.material.dispose(),this._rttbox.geometry.dispose(),this._grad=null,this._originalGrad=null,this._gradCtx=null,this._mesh&&(this._mesh.material.dispose(),this._mesh.geometry.dispose()),super.dispose()}copy(t){return super.copy(t),this}_getGradientCode(t){var e="grad:(";for(var i in t)e+=i+":"+t[i]+",";return e+=")"}_gradient(t){if(this._getGradientCode(this._originalGrad)===this._getGradientCode(t)&&!THING.Utils.isNull(this._gradTexture))return this._gradTexture;var e=this._gradCtx.createLinearGradient(0,0,256,0);for(var i in t)e.addColorStop(+i,t[i]);this._gradCtx.fillStyle=e,this._gradCtx.fillRect(0,0,256,1);var r=new a.Texture2D;return r.image=this._gradCtx.canvas,r.version++,this._gradTexture=r,r}_createCanvas(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}_updataClipPlane(t){let e=new a.Vector3(t.normal[0],t.normal[1],t.normal[2]).normalize(),i=t.constant;if(this.normalConstant=i,this._vertexData){let t=6378e3*Math.acos(Math.cos(this._maxPos[1])*Math.cos(this._maxPos[1])*Math.cos(this._maxPos[0]-this._minPos[0])+Math.sin(this._maxPos[1])*Math.sin(this._maxPos[1])),r=6378e3*Math.acos(Math.cos(this._maxPos[1]-this._minPos[1])),n=this._maxPos[2]-this._minPos[2],s=new a.Vector3(e.x/t,e.y/r,e.z/n).getLength();this.normalConstant=i*s}this._clippingPlane={normal:[e.x,e.y,e.z],constant:i},this._mesh&&(this._mesh.material.uniforms.planeComponents=[this._clippingPlane.normal[0],this._clippingPlane.normal[1],this._clippingPlane.normal[2],this.normalConstant],this._mesh.material.needsUpdate=!0)}}},"@uino/thing":e=>{e.exports=t},"@uino/thing-t3d":t=>{t.exports=e}},a={};function r(t){var e=a[t];if(void 0!==e)return e.exports;var n=a[t]={exports:{}};return i[t](n,n.exports,r),n.exports}r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return(()=>{r.r(n),r.d(n,{COMPILETIME:()=>x,VERSION:()=>c.VERSION});var t=r("./src/common/Utils.js"),e=r("./src/objects/Heatmap.js"),i=r("./src/objects/EarthHeatmap.js"),a=r("./src/objects/IDWmap.js"),s=r("./src/objects/EarthIDWmap.js"),o=r("./src/objects/VectorField.js"),l=r("./src/objects/EarthVectorField.js"),h=r("./src/objects/VolumeRendering.js"),u=r("./src/objects/Streamline.js"),d=r("./src/objects/EarthVolumeRendering.js"),m=r("./src/objects/GeologicalmodelLayer.js"),c=r("./src/const.js"),p=r("@uino/thing"),_=r("./src/common/Factory.js");const f={Heatmap:e.Heatmap,EarthHeatmap:i.EarthHeatmap,IDWmap:a.IDWmap,EarthIDWmap:s.EarthIDWmap,VectorField:o.VectorField,EarthVectorField:l.EarthVectorField,VolumeRendering:h.VolumeRendering,Streamline:u.Streamline,EarthVolumeRendering:d.EarthVolumeRendering,GeologicalmodelLayer:m.GeologicalmodelLayer,HeatmapRenderType:c.HeatmapRenderType,StreamlineRenderType:c.StreamlineRenderType,Utils:t.Utils};THING.EARTH&&(THING.EARTH.VectorField=l.EarthVectorField,THING.EARTH.IDWmap=s.EarthIDWmap,THING.EARTH.Heatmap=i.EarthHeatmap,THING.EARTH.VolumeRendering=d.EarthVolumeRendering),t.Utils.registerClasses(f,THING),t.Utils.addFactory(new _.Factory,"thing.dataviz.factory");const x=(new Date).toString();p.App.addCompleteCallback((t=>{t.on("__!!a$u^t@h*event@__",(e=>{if(!0===e.hasExpired||!e.plugins||e.plugins&&"0"===e.plugins.substr(2,1)){const e=p.StringEncoder.toText("147,136,32,42,117,54,39,76,214,237,120,180,47"),i=p.StringEncoder.toText("186,156,39"),a=p.StringEncoder.toText("183,133,36,48,115,33,42");t.camera.position=[0,10,0],t.camera.target=[0,0,0],new p.Label({fontText:e+" "+i+" "+a,fontSize:20,renderType:p.RenderType.Sprite,style:{color:[1,0,0]},scale:[.4,.4,.4]}),t.stop(),setTimeout((()=>{t.timer.update=()=>{}}),0)}})),t.trigger("__a)s*k&!!a$u^t@h*event@__")}),-3)})(),n})()));