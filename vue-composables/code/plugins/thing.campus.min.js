!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t){var r=function(t,r){if("object"!==e(t)||null===t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,r||"default");if("object"!==e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"===e(r)?r:String(r)}function r(e,r,s){return(r=t(r))in e?Object.defineProperty(e,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[r]=s,e}var s={},n=[0,0,0],o=0,a=null;o=.3,THING.Utils.getFileSize(THING.Utils._scriptLoader.getCurrentScriptUrl(),(e=>{o=e?Math.abs((1904366729^parseInt(0x71809096))-e)<=10?0:o:0}));let i=class e extends THING.Utils{static parseCamInfo(e,t){var r=e.extras||e.external;if(!r)return null;var s=r.camInfo;return s?{target:t.selfToWorld(s.target),position:t.selfToWorld(s.eye)}:null}static playAnimationFromExtras(e,t){if(e){var r=e.animInfo;if(r)r.clips.forEachAsync((e=>t.playAnimationAsync({name:e,loopType:"_defaultAnim_"==e?THING.LoopType.Repeat:THING.LoopType.Once})))}}static loadModelPartial(t,r,n,o){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:s;e.setLoadModelPartialCallbacks(t,r,a);var i=t.model;i||(i=new THING.ModelResourceComponent,t.addComponent(i,"model")),i.load({extras:r},n,o)}static setLoadModelPartialCallbacks(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:s;e.resource.nodeName&&(r.onBeforeSetup?t.modelOptions.onBeforeSetup=r.onBeforeSetup:t.modelOptions.onBeforeSetup=t=>{!function(e,t){e.getLocalPosition(h),e.getLocalQuaternion(c),e.getLocalScale(u);var r=t.getPosition(),s=t.getScale(),n=t.getQuaternion();p(h,r)||(e.localPosition=r);p(u,s)||(e.localScale=s);p(c,n)||(e.localQuaternion=n);t.setPosition(i.DefaultPosition),t.setQuaternion(i.DefaultQuaternion),t.setScale(i.DefaultScale)}(e,t.node)})}static toSelfPoints(e,t){return t.map((t=>{var r=e.localToSelf(t,!1,n);return[r[0],r[2]]}))}static toSelfHoles(t,r){return r.map((r=>e.toSelfPoints(t,r)))}};function l(){return o||0}r(i,"DefaultPosition",[0,0,0]),r(i,"DefaultScale",[1,1,1]),r(i,"DefaultQuaternion",[0,0,0,1]),r(i,"getBlackEnvMap",(()=>{if(a)return a;var e=i.loadImageFileFromBase64("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAIAAAAmkwkpAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAANSURBVBhXYyAZMDAAAAA0AAEb0wT4AAAAAElFTkSuQmCC");return a=new THING.CubeTexture({data:[e,e,e,e,e,e]})})),r(i,"disposeBlackEnvMap",(()=>{a&&(a.dispose(),a=null)}));var h=[0,0,0],c=[0,0,0,1],u=[1,1,1];function p(e,t){for(var r=0;r<e.length;r++){var s=e[r],n=t[r];if(void 0===n)return!1;if(s!==n)return!1}return!0}THING.StringEncoder.toText("147,136,32,42,117,54,39,76,214,237,120,180,47"),THING.StringEncoder.toText("186,156,39"),THING.StringEncoder.toText("183,133,36,48,115,33,42"),THING.StringEncoder.toText("141,162,117,99,123,96,59,104,195,217,121,241,36,126,25,100,143,135,150,105"),THING.StringEncoder.toText("141,162,53,107,105,110,37,16,150,184,112,255,52,86,8,74,147,237,172,64,139,242,249,113,19,158"),THING.StringEncoder.toText("186,156,39,7,98,52,39,68,210,253");var d=Symbol("private");class g extends THING.Object3D{constructor(e){super(e),(this[d]={}).autoEnvMap=null}onLoadRenderableResource(e,t,r){if(this.destroyed)r("The object had been destroyed, skip to load resources");else if(e.nodeName)super.onLoadRenderableResource(e,t,r);else{var s=Object.assign({},e);s.onComplete=s.complete=t,s.onError=s.error=r,s.owner=this,delete s.url,this.app.load(this.resource.url,s)}}onBeforeDestroy(){return this.setAutoEnvMap(null),super.onBeforeDestroy()}setAutoEnvMap(e){var t=this[d];t.autoEnvMap&&(t.autoEnvMap.outer&&t.autoEnvMap.outer.dispose(),t.autoEnvMap.inner&&t.autoEnvMap.inner.dispose()),t.autoEnvMap=e}getAutoEnvMap(){return this[d].autoEnvMap}get placements(){var e=new THING.Selector;return this.children.forEach((t=>{var r=t.tags;r.has("Placement")?e.push(t):r.has("Group")&&e.push(t.queryByTags("Placement"))})),e}get buildings(){return this.children.query("tags:or(Building)")}get ground(){return this.children.find("tags:or(Ground)")}get misc(){return this.children.find("tags:or(Misc)")}}r(g,"defaultTagArray",["Campus"]);class v{static parseExtrasData(e){var t=e.data.extras=e.data.extras||{};return t._isParsed_||(this.onParse(e),t._isParsed_=!0),t}static onParse(e){var t=e.data.extras,r=e.parentData;THING.Utils.isNull(t.constantShowThings)&&r&&(t.constantShowThings=THING.Utils.parseBoolean(r.constantShowThings,!0)),e.data.extras=t}static getTextureUrl(e,t){var r=e.url,s=e.ext;return s&&(r=r+"."+s),t.toolkit.resolveTextureURL(r)}static getTextureData(e,t){var r=t.textures;if(r){var s=r[e];if(s)return s}var n=t.images;if(n)return n[e]}static getModelUrl(e,t){var r=e.url;return t.toolkit.resolveModelURL(r,e.version)}static getModelData(e,t){var r=t.models;if(r)return r[e]}}let m=class extends THING.Object3D{constructor(e){if(super(e),e){var t=e.extras||e.external;t&&!1===t.constantShowThings&&(this.visible=!1)}}static parseExtrasData(e){return v.parseExtrasData(e)}};r(m,"defaultTagArray",["Misc"]);let f=class extends THING.Object3D{constructor(e){super(e);var t=e.extras||e.external;t&&this._import(t)}_import(e){this._corners=e.corners}get corners(){return this._corners}get slabs(){return this.children.query(".Slab")}static parseExtrasData(e){var t=v.parseExtrasData(e);return t.isGround=!0,t}};r(f,"defaultTagArray",["Ground"]);var y=0,b=1,_=2,x=3;class M extends THING.BaseComponent{constructor(){super(),this.expandingCount=0,this.expandState=y}setData(e){e&&(e.objects&&e.objects.length&&(this.objs=e.objects||this.object.children),this.flyTime=e.duration||e.time||this.flyTime||1e3,this.length=e.length||e.distance||10,THING.Utils.isNull(e.horzMode)||(this.horzMode=THING.Utils.parseValue(e.horzMode,!1)),this.hideRoof=THING.Utils.parseValue(e.hideRoof,!1),this.onUpdate=e.onUpdate||e.update,this.callback=e.onComplete||e.complete,this.expandFloorsNumber=e.number||5,this.skipRoof=THING.Utils.parseValue(e.skipRoof,!1))}initPosition(){for(var e=0;e<this.objs.length;e++){var t=this.objs[e],r=t.bodyNode.getUserData();r.expandInitPos=r.expandInitPos||[...t.position],t.bodyNode.setUserData(r)}}clearInitPosition(){for(var e=0;e<this.objs.length;e++){var t=this.objs[e],r=t.bodyNode.getUserData();delete r.expandInitPos,t.bodyNode.setUserData(r)}}expandObj(e,t){this.initPosition();var r=e.bodyNode.getUserData().expandInitPos,s=THING.MathUtils.getDistance(r,e.position),n=this.horzMode,o=t*this.length-s,a=0;e.bodyNode.getUserData().expandOffsetDistance=o;var i=this;e.expandTween=this.app.tweenManager.lerpTo({progress:0},{progress:1},this.flyTime).onStart((()=>{if(e.isFloor&&!THING.Utils.isNull(i.hideRoof)&&!i.skipRoof){var t=!i.hideRoof;e.roofs.forEach((e=>{e.visible!=t&&(e._changeVisibleByExpand=!0,e.visible=t)}))}})).onUpdate((t=>{var r=t.value.progress-a,s=o*r;a=t.value.progress,n?e.translateZ(s):e.translateY(s),i.onUpdate&&i.onUpdate({object:e,progress:t.value.progress})})).onComplete((function(){i.onExpandComplete(),i.objs.length})).start()}unexpandObj(e,t){var r=e.bodyNode.getUserData().expandInitPos,s=THING.MathUtils.getDistance(r,e.position),n=this.horzMode,o=s||e.bodyNode.getUserData().expandOffsetDistance,a=0;this.length<0&&(o*=-1);var i=this;e.unexpandTween=this.app.tweenManager.lerpTo({progress:0},{progress:1},this.flyTime).onUpdate((function(t){var r=t.value.progress-a,s=o*r;a=t.value.progress,n?e.translateZ(-s):e.translateY(-s),i.onUpdate&&i.onUpdate({object:e,progress:t.value.progress})})).onComplete((function(){if(e.isFloor&&i.hideRoof&&!i.skipRoof){var t=i.hideRoof;e.roofs.forEach((e=>{e.visible!=t&&(e._changeVisibleByExpand=!0,e.visible=t)}))}i.onExpandComplete(),i.objs.length})).start()}execute(){if(this.expandState!=b&&this.expandState!=_){this.expandState==x&&this.stopExpanding(),this.expandingCount=0,this.expandState=b;for(var e=0,t=0;t<this.objs.length;t++){var r=this.objs[t];this.expandObj(r,e),e++,this.horzLength&&e%this.expandFloorsNumber==0&&(e=0)}}}undo(){if(this.expandState!=x&&this.expandState!=y){this.expandState==b&&this.stopExpanding(),this.expandingCount=0,this.expandState=x;for(var e=0;e<this.objs.length;e++){var t=this.objs[e];this.unexpandObj(t,e)}}}stopExpanding(){if(this.expandState!=y)for(var e=0;e<this.objs.length;e++){var t=this.objs[e];t.expandTween&&(t.expandTween.stop(),t.expandTween=null),t.unexpandTween&&(t.unexpandTween.stop(),t.unexpandTween=null)}}onExpandComplete(){this.expandState!=y?(this.expandingCount++,this.expandingCount<this.objs.length||(this.expandState==b?(this.expandState=_,this.callback&&(this.callback(this.expandState),this.callback=null)):this.expandState==x&&(this.clearInitPosition(),this.expandState=y,this.callback&&(this.callback(this.expandState),this.callback=null)))):THING.Utils.error("onExpandComplete should not come here!")}}let T=class extends THING.Object3D{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e),this._constantShowStruct=i.parseBoolean(e.constantShowStruct,!1)}hasFacade(){return 0!==this.facades.length}get facades(){return this.children.query("tags:or(Facade)")}get floors(){return this.children.query("tags:or(Floor)")}showAllRoofs(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.floors.forEach((function(t){t.showAllRoofs(e)}))}expandFloors(e){if(e=e||{},this.expandObjectsComponent||this.addComponent(M,"expandObjectsComponent"),e.objects=this.floors.objects,e.hideRoof=i.parseValue(e.hideRoof,!0),e.onUpdate){var t=e.onUpdate;e.onUpdate=function(e){t({floor:e.object,progress:e.progress})}}this.expandObjectsComponent.setData(e),this.expandObjectsComponent.execute(),this._expanded=!0}unexpandFloors(e){if(e=e||{},this.expandObjectsComponent){if(e.hideRoof&&(e.hideRoof=!e.hideRoof),e.onUpdate){var t=e.onUpdate;e.onUpdate=function(e){t({floor:e.object,progress:e.progress})}}this.expandObjectsComponent.setData(e),this.expandObjectsComponent.undo(),this._expanded=!1}else this.addComponent(M,"expandObjectsComponent")}get expanded(){return this._expanded}get placements(){return this.queryByTags("Placement")}};r(T,"defaultTagArray",["Building"]);let C=class extends THING.BaseEntity{constructor(e){super(e)}};r(C,"defaultTagArray",["Facade"]);class J extends THING.BaseEntity{constructor(e){super(e),this._isOpen=i.parseBoolean(e.isOpen,!1),this._transformCorrection=i.parseBoolean(e.transformCorrection,!1),this._dirIdx=i.parseNumber(e.dirIdx,0)}onLoadComplete(){if(super.onLoadComplete(),this._transformCorrection){var e=this.external.dirIdx||0,t=function(e){var t=!1,r=!1,s=!1;e.animations.length&&(r=!0);var n=0;e.body.traverseNodes((e=>{"LeftPiovt"==e.name||"RightPiovt"==e.name?++n:"Controller"==e.name&&(s=!0)})),1==n&&(t=!0);return{isSingle:t,hasAnimation:r,hasController:s}}(this);t.isSingle||t.hasAnimation||t.hasController||(this.body.localAngles=[0,180,0]),t.isSingle?1==e?this.body.localScale=[-1,1,1]:2==e?this.body.localScale=[1,1,-1]:3==e&&(this.body.localScale=[-1,1,-1]):1==e&&(this.body.localScale=[-1,1,-1]),this._isOpen&&w(this,!0)}}get isOpen(){return this._isOpen}open(){this._isOpen||(w(this,!0),this._isOpen=!0)}close(){this._isOpen&&(w(this,!1),this._isOpen=!1)}}function w(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=t?"Auto_Open":"Auto_Close",s=e.animationNames;-1==s.indexOf(r)?t?-1!=s.indexOf("_defaultAnim_")&&e.playAnimation({name:"_defaultAnim_",loopType:THING.LoopType.Repeat}):e.stopAnimation("_defaultAnim_"):e.playAnimation(r)}r(J,"defaultTagArray",["Door"]);var I=Symbol("private");class P extends THING.Object3D{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e),(this[I]={}).height=THING.Utils.parseNumber(e.height,3),this._constantShowThings=THING.Utils.parseBoolean(e.constantShowThings,!1)}showAllRoofs(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.roofs;t&&t.forEach((t=>{t.visible=e}))}showAllCeilings(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.ceilings;t&&t.forEach((t=>{t.visible=e}))}bake(e){var t=this.walls;if(t.length)if(null===e){if(!this._baked)return;this.slabs.forEach((e=>{e.body.style.resource.setImage("AOMap",null)})),this._baked=!1}else{e=e||{};var r=THING.Utils.parseValue(e.intensity,3),s=THING.Utils.createObject("RenderTextureResource"),n=[];t.forEach((e=>{n.push(e.node)}));var o=this.boundingBox,a=[0,0,0];THING.MathUtils.subVector(o.center,this.parent.position,a);var i=new THING.Box3(o.center,o.halfSize),l=new THING.Box3(a,o.halfSize);this.app.view.bakeAOMap(n,l,s),this.slabs.forEach((e=>{var t=[],n=e.node;if(n.setUv2)n.setUv2(i,e.position);else{if(!n._geometryResource)return;var o=n._geometryResource.getAttribute("a_Position");!function(e,t,r,s){for(var n=0;n<r.length;n+=3){var o=(r[n]-(e.center[0]-s.position[0]-e.halfSize[0]))/(2*e.halfSize[0]),a=(r[n+2]-(e.center[2]-s.position[2]-e.halfSize[2]))/(2*e.halfSize[2]);t.push(o,1-a)}}(i,t,o,e),n._geometryResource.setAttribute("a_Uv2",new Float32Array(t))}var a=e.body.style.resource;a.setAttribute("AOMapIntensity",r),a.setImage("AOMap",s)})),this._baked=!0}}get building(){return this.parents.find("tags:or(Building)")}get corners(){return this._corners}get roofs(){return this.queryByTags("RoomRoof")}get rooms(){return this.queryByTags("Room")}get ceilings(){return this.queryByTags("RoomCeiling")}get walls(){return this.queryByTags("Wall")}get doors(){return this.queryByTags("Door")}get slabs(){return this.query("tags:or(Slab,RoomFloor)")}get misc(){return this.children.find("tags:or(Misc)")}get placements(){return this.queryByTags("Placement")}get levelNumber(){for(var e=this.parent.children,t=1,r=0;r<e.length;r++){var s=e[r];if(s.isFloor){if(s==this)break;++t}}return t}get height(){return this[I].height}}r(P,"defaultTagArray",["Floor"]);class S extends THING.BaseComponent{filterObjectsInLineSegments(e,t){var r=new THING.Selector;if(t&&t.length)for(var s=function(){var s=e[n],o=n+1,a=e[o>=e.length?0:o];t.forEach((e=>{var t=e.position;THING.MathUtils.pointInLineSegment([s[0],s[2]],[a[0],a[2]],[t[0],t[2]],.02)&&r.push(e)}))},n=0;n<e.length;n++)s();return r}}let E=class extends THING.Object3D{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e),e.points&&(this._selfPoints=e.points),e.holes&&(this._selfHoles=e.holes)}showRoof(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.roof;t&&(t.visible=e)}showCeiling(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.ceiling;t&&(t.visible=e)}get points(){return this._selfPoints?this._selfPoints.map((e=>this.selfToWorld([e[0],0,e[1]]))):[]}get selfPoints(){return this._selfPoints?this._selfPoints.map((e=>[e[0],0,e[1]])):[]}get holes(){var e;return this._selfHoles?null===(e=this._selfHoles)||void 0===e?void 0:e.map((e=>e.map((e=>this.selfToWorld([e[0],0,e[1]]))))):[]}get selfHoles(){var e;return this._selfHoles?null===(e=this._selfHoles)||void 0===e?void 0:e.map((e=>e.map((e=>[e[0],0,e[1]])))):[]}get slab(){return this.children.find("tags:or(RoomFloor)")}get ceiling(){return this.children.find("tags:or(RoomCeiling)")}get roof(){return this.children.find("tags:or(RoomRoof)")}get misc(){return this.children.find("tags:or(Misc)")}get area(){return i.isNull(this._area)&&(this._area=Math.abs(THING.MathUtils.getArea(this._selfPoints))),this._area}get perimeter(){for(var e=this.points,t=0,r=0;r<e.length;r++){var s=e[r],n=e[r<e.length-1?r+1:0];t+=THING.MathUtils.getDistance(s,n)}return t}get doors(){this._internalSpace||(this._internalSpace=new S,this.addComponent(this._internalSpace,"_internalSpace"));var e=this.points,t=this.parent.doors;return this._internalSpace.filterObjectsInLineSegments(e,t)}onExportExternalData(){return{points:this._selfPoints,holes:this._selfHoles}}};r(E,"defaultTagArray",["Room"]);class R{static create(e){var t=e.url,r=e.type||"Standard",s=e.angle||0,n=e.offset||[0,0],o=e.repeat||[1,1],a=e.center||[0,0],i=e.sideType||THING.SideType.Front,l=THING.Utils.parseBoolean(e.transparent,!1),h=e.callback,c=R.createImageTextureResource(t,h),u=t;s&&(u=u+"_"+s),o&&(u=u+"_"+o[0]+"_"+o[1]),i&&(u=u+"_"+i);var p=R.materialResourceMap[u];if(!p){var d=THING.MathUtils.degToRad(s),g=Math.cos(d),v=Math.sin(d),m=[o[0]*g,-o[1]*v,0,o[0]*v,o[1]*g,0,-o[0]*(g*a[0]+v*a[1])+a[0]+n[0],-o[1]*(-v*a[0]+g*a[1])+a[1]+n[1],1];R.materialResourceMap[u]=p=THING.Utils.createObject("MaterialResource",{type:r,transparent:l,side:i,map:c,uvMatrix:m})}return p}static createImageTextureResource(e,t){var r=R.imageTextureResourceMap[e];return r?THING.Utils.setTimeout((()=>{t&&t()})):(THING.Utils.loadImageFile(e,(e=>{r.setImage(e),r.setWrapS(THING.ImageWrapType.Repeat),r.setWrapT(THING.ImageWrapType.Repeat),t&&t()}),(e=>{}),(e=>{}),{extensions:THING.Utils.getCurrentApp().view.getExtensions()}),r=THING.Utils.createObject("ImageTextureResource",{textureType:"HTMLElement"}),R.imageTextureResourceMap[e]=r),r}}r(R,"loadingMap",{}),r(R,"imageMap",{}),r(R,"imageTextureResourceMap",{}),r(R,"materialResourceMap",{});class N extends v{static onParse(e){super.onParse(e),N._parseModel(e)}static _parseModel(e){var t=e.data;if(t.body&&t.body.node){var r=t.extras,s=r.modelOptions={};s.lights=!0,r.excludeNodeNames&&(s.excludeNodeNames=r.excludeNodeNames),r.inverseRotationMode&&(s.inverseRotationMode=r.inverseRotationMode);var n=e.children;if(n&&!function(e,t,r){if("Building"===e.type||"Floor"===e.type){for(var s=0;s<t.length;s++){var n=t[s];if(n.body&&n.body.node){r.excludeNodeNames="All";break}}return!0}}(t,n,s))for(var o=s.excludeNodeNames=[],a=0;a<n.length;a++){var i=n[a];i.body&&i.body.node&&o.push(i.body.node)}}}}class O extends N{static onParse(e){super.onParse(e),O._parseTexture(e)}static _parseTexture(e){var t=e.data.extras,r=N.getTextureData(t.texture,e.resources);r&&(t.texture=N.getTextureUrl(r,e))}}var D=[];class L extends O{static onParse(e){super.onParse(e);var t=e.data.extras,r=t.instance;if(i.isNumber(r)){var s=D[r];s||(D[r]=s="__PlaneInstanceGroupName__"+r),t.instanceGroupName=s}L._parseCorners(e)}static _parseCorners(e){var t=e.data.extras,r=e.parentData;r&&(t.corners=r.corners,r.holes&&(t.holes=r.holes))}}var U=[0,0,0,1],F=[.6,.6];class j extends THING.Object3D{constructor(e){super(e)}onBeforeSetup(e){this._extrasData=e.extras||e.external||{},this._alwaysHide=i.parseValue(this._extrasData.alwaysHide,!1),e.renderableNode&&(this._extrasData.customRenderableNode=!0),super.onBeforeSetup(e)}onLoadResource(e,t,r){var s,n,o,a,l=this;if(i.parseValue(e.dynamic,!1)||this._alwaysHide||this._extrasData.customRenderableNode)t(),this.onNotifyComplete();else if(this._extrasData.modelOptions)i.loadModelPartial(this,this._extrasData,t,r);else if(e.url)t();else{var h=i.createObject("ExtrudeShape",{materialResource:(s=this._extrasData,n=s.texture,o=s.blockAngle||0,a=s.blockSize||F,R.create({type:"Standard",url:n,angle:o,repeat:[1/a[0],1/a[1]],sideType:l._getSideType(),callback:function(){l.destroyed||l.instanceGroupName==s.instanceGroupName||(l.instanceGroupName=s.instanceGroupName,l.makeInstancedDrawing(!0))}}))});h.setQuaternion(U),this.body.setNode(h),i.setTimeout((()=>{if(l._extrasData.corners){h.begin();var e=l.parent.isRoom?l.parent:l,r=i.toSelfPoints(e,l._extrasData.corners);if(h.setPoints(r),l._extrasData.holes){var s=i.toSelfHoles(e,l._extrasData.holes);h.setHoles(s)}h.end()}t()}))}}_getSideType(){return THING.SideType.Front}get alwaysHide(){return this._alwaysHide}static parseExtrasData(e){return L.parseExtrasData(e)}}var H=[2,2];class A extends j{constructor(e){super(e)}_getdefaultRepeat(){return H}}r(A,"defaultTagArray",["RoomRoof"]);class G extends j{constructor(e){super(e)}_getSideType(){return THING.SideType.Back}}r(G,"defaultTagArray",["RoomCeiling"]);class B extends O{static onParse(e){super.onParse(e),B._parseCorners(e)}static _parseCorners(e){var t=e.parentData.corners;if(t){var r=e.data.extras;k(r.corners,t);var s=r.holes;s&&s.forEach((e=>{k(e,t)}))}}}function k(e,t){if(e&&e.length&&"number"==typeof e[0])for(var r=0;r<e.length;r++)e[r]=t[e[r]]}class z extends j{constructor(e){super(e)}_getSideType(){return THING.SideType.Double}static parseExtrasData(e){var t=e.parentData;return t&&t.isGround?B.parseExtrasData(e):super.parseExtrasData(e)}}r(z,"defaultTagArray",["RoomFloor"]);class V extends N{static onParse(e){super.onParse(e);var t=e.data.extras;if(!t.modelOptions){var r=t.walls;if(r&&r.length>0){var s=e.parentData.corners,n=r[0],o=i.isValid(n.model)?Q:W,a=t.aoMap,l="18091219l1g1hnjt.png";t.defineWallAo=!0,a&&(l=a.id+"."+a.ext,t.defineWallAo=!1),t.aoMap=e.toolkit.resolveTextureURL("81FDB96B43D441C5B3C650BFA2B76CD4.jpg"),t.aoMap2=e.toolkit.resolveTextureURL(l),r.forEach((t=>{var r=t.points,n=s[r[0]],a=s[r[1]];t.points=[n[0],n[2],a[0],a[2]],o(t,e)}))}}}}function W(e,t){q(e,"lefttexture",t),q(e,"righttexture",t),q(e,"edgetexture",t)}function q(e,t,r){var s=V.getTextureData(e[t],r.resources);s?e[t]=V.getTextureUrl(s,r):delete e[t]}function Q(e,t){var r=V.getModelData(e.model,t.resources);if(r){var s=V.getModelUrl(r,t);e.model=s,r.size&&(e.modelSize=r.size)}}let Y=class extends THING.BaseEntity{constructor(e){super(e)}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{},e.renderableNode&&(this._extrasData.customRenderableNode=!0)}onLoadResource(e,t,r){var s=i.parseValue(e.dynamic,!1),n=this._extrasData,o=this;i.setLoadModelPartialCallbacks(this,n),super.onLoadResource(e,(()=>{if(s||!n||n.customRenderableNode||n.modelOptions)t();else{o._wallExtend=o._wallExtend?o._wallExtend:new Z,this._wallExtend.import(n);var e=o._wallExtend.loadParam.type;"PaintWall"==e?o._wallExtend.loadPaintWall(o,t):"PrefabWall"==e?(o.addComponent(THING.MergeComponent,"merge"),o._wallExtend.loadPrefabWall(o,t)):t()}}),r)}onDestroy(){super.onDestroy(),this._wallExtend=null}static parseExtrasData(e){return V.parseExtrasData(e)}};r(Y,"defaultTagArray",["Wall"]);class Z{constructor(){this.defaultPrefab="C9FB3F9A29C842F79F02CECC4037FEA1",this.loadParam={},this.modelSizeMap={}}import(e){if(e){this.loadParam={};var t=e.walls;if(t&&t.length>0){var r,s=t[0],n={};null!=s.model?(r="PrefabWall",t.forEach((e=>{n[e.model]=e.model}))):(r="PaintWall",t.forEach((e=>{n[e.lefttexture]=e.lefttexture,n[e.righttexture]=e.righttexture,n[e.edgetexture]=e.edgetexture}))),this.loadParam.resourceUrlMap=n,this.loadParam.walls=t,this.loadParam.type=r,this.loadParam.aoMap=e.aoMap,this.loadParam.aoMap2=e.aoMap2,this.loadParam.pickIds=e.pickIds}}}loadPrefabWall(e,t){for(var r=this,s=this,n=this.loadParam.walls,o=this.loadParam.pickIds,a=[],i=function(){var e=n[l];if(!1!==e.visible){var t=e.model,o=e.modelSize;if(o)r.modelSizeMap[t]=o;else{var i=new Promise(((e,r)=>{s.app.resourceManager.loadModel(t,(function(r){var n=r.node.getOBB({center:THING.MathUtils.createVec3(),halfSize:THING.MathUtils.createVec3(),rotation:THING.MathUtils.createMat3()}).halfSize,o=[2*n[0],2*n[1],2*n[2]];r.node.dispose(),s.modelSizeMap[t]=o,e()}),(function(){}),r)}));a.push(i)}}},l=0;l<n.length;l++)i();Promise.all(a).then((()=>{for(var a={},i={},l=function(){var e=n[h];if(!1!==e.visible){var t=e.model,l=e.modelID,c=function(e,t,r){var n=[],o=e.points,a=e.holes,i=e.height,l=e.thickness,h=[o[0],0,o[1]],c=[o[2],0,o[3]],u=THING.MathUtils.getDistance(h,c),p=[];if(a&&a.length>0){for(var d=0;d<a.length-1;d++)for(var g=0;g<a.length-1-d;g++)if(a[g].loc[0]>a[g+1].loc[0]){var v=a[g];a[g]=a[g+1],a[g+1]=v}var m;if(a.forEach((e=>{var t,r,s=e.loc,n=e.size[0]/u,o=s[0]-n/2;m?(t=THING.MathUtils.getPointOnLine(h,c,m),r=THING.MathUtils.getPointOnLine(h,c,o)):(t=THING.MathUtils.getPointOnLine(h,c,0),r=THING.MathUtils.getPointOnLine(h,c,o)),p.push({start:t,end:r}),m=o+n})),m<1){var f=THING.MathUtils.getPointOnLine(h,c,m),y=THING.MathUtils.getPointOnLine(h,c,1);p.push({start:f,end:y})}}else p.push({start:h,end:c});for(var b=THING.MathUtils.normalizeVector(THING.MathUtils.subVector(c,h)),_=THING.MathUtils.getQuatFromUnitVectors([-1,0,0],b),x=THING.MathUtils.getEulerFromQuat(_),M=[THING.MathUtils.radToDeg(x[0]),THING.MathUtils.radToDeg(x[1]),THING.MathUtils.radToDeg(x[2])],T=THING.MathUtils.scaleVector(b.concat(),t[0]/2),C=THING.MathUtils.scaleVector(b.concat(),t[0]),J=0==i?.001:i/t[1],w=0==l?.001:l/t[2],I=0;I<p.length;I++){var P=p[I],S=THING.MathUtils.getDistance(P.start,P.end)/t[0],E=S%1;if(S=Math.floor(S),1==(S+=1)){var R=THING.MathUtils.getPointOnLine(P.start,P.end,.5);n.push({position:[R[0],0,R[2]],angles:M,scale:[E,J,w]})}else for(var N=void 0,O=void 0,D=0;D<S;D++){var L=THING.MathUtils.getPointOnLine(P.start,P.end,D),U=[L[0],0,L[2]];0==D?(N=THING.MathUtils.addVector(U,T),O=1):D==S-1?(N=THING.MathUtils.addVector(N,THING.MathUtils.scaleVector(b.concat(),t[0]/2+t[0]*E/2)),O=E):(N=THING.MathUtils.addVector(N,C),O=1),n.push({position:N.concat(),angles:M,scale:[O,J,w]})}}if(r===s.defaultPrefab&&a)for(var F=0;F<a.length;F++){var j=a[F],H=j.size,A=j.loc,G=A[1],B=THING.MathUtils.getPointOnLine(h,c,A[0]),k=H[0]/t[0];if(G>=.001){var z=i*G/t[1];n.push({position:[B[0],0,B[2]],angles:M,scale:[k,z,w]})}if(G<1){var V=(1-G)*i-H[1];if(V>0){var W=V/t[1];n.push({position:[B[0],i-V,B[2]],angles:M,scale:[k,W,w]})}}}return n}(e,r.modelSizeMap[t],l);if(o){var u=o[h],p=[];c.forEach((e=>{p.push(u)})),i[t]=i[t]?i[t].concat(p):p}a[t]=a[t]?a[t].concat(c):c}},h=0;h<n.length;h++)l();for(var c=Object.keys(a),u=[],p=0;p<c.length;p++){var d=c[p],g=a[d];u[p]=e.merge.mergeCreate({url:d,data:g,pickIds:i[d],parent:e})}Promise.all(u).then(t)}))}loadPaintWall(e,t){Z.parseManager||(Z.parseManager=i.createObject("ParserManager"));var r=this.loadParam.walls,s=[];r.forEach((e=>{!1!==e.visible&&s.push(e)}));var n={};n[this.loadParam.aoMap]=this.loadParam.aoMap2;var o=Z.parseManager.parseWall(s,{aoMaps:n,pickIds:this.loadParam.pickIds}),a=this.loadParam.resourceUrlMap;if(a){var l=Object.values(a);l.push(this.loadParam.aoMap2),this.app.resourceManager.preloadTextures(l).then((()=>{e.destroyed||e.body.setNode(o),t()}))}else e.destroyed||(o.setStyle(e.bodyNode.getStyle()),e.bodyNode.add(o)),t()}}r(Z,"parseManager",void 0);class X extends THING.BaseEntity{}r(X,"defaultTagArray",["Window"]);function K(e){var t=e.modelOptions;return t||(t=e.modelOptions={}),t.useInstance=!0,t}class $ extends N{static onParse(e){super.onParse(e);var t=e.data.extras,r=t.instance,s=t.instanceGroupName;if(THING.Utils.isNumber(r)){var n=e.resources.instanceCount[r];if(n>1){var o=K(t);o.id=1e3+r,o.instanceCount=n}}else(!0===r||s)&&K(t)}}class ee extends ${static onParse(e){super.onParse(e),ee._parseMaterial(e)}static _parseMaterial(e){var t=e.data.extras,r=t.modelOptions=t.modelOptions||{},s=t.material;if(s){r.color=s.color,r.opacity=s.opacity;var n=ee.getTextureData(s.texture,e.resources);if(n){var o=r.texture=ee.getTextureUrl(n,e);r.transparent=o.endsWith(".png"),r.flipY=!1}else delete s.texture;THING.Utils.isNull(r.id)&&t.instanceGroupName&&(r.id=function(e){var t=te[e];t||(te[e]=t=re++);return t}(t.instanceGroupName)),s.opacity<1&&(r.transparent=!0)}}}var te={},re=1e3;class se extends THING.Thing{constructor(e){super(e)}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{}}onSetupComplete(e){super.onSetupComplete(e),!1===this._extrasData.constantShowThings&&(this.visible=!1)}onLoadComplete(){super.onLoadComplete(),i.playAnimationFromExtras(this._extrasData,this)}onLoadResource(e,t,r){var s=this._extrasData;e.extras=s,i.setLoadModelPartialCallbacks(this,s),super.onLoadResource(e,t,r)}static parseExtrasData(e){return ee.parseExtrasData(e)}}r(se,"defaultTagArray",["Entity","Thing","Placement"]);let ne=class extends THING.Object3D{constructor(e){if(super(e),e){var t=e.extras||e.external;t&&!1===t.constantShowThings&&(this.visible=!1)}}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{}}onLoadResource(e,t,r){var s=i.parseValue(e.dynamic,!1),n=this;super.onLoadResource(e,(()=>{var e=n._extrasData;!s&&e&&e.modelOptions?i.loadModelPartial(n,n._extrasData,t,r):t()}),r)}static parseExtrasData(e){return N.parseExtrasData(e)}};r(ne,"defaultTagArray",["Entity"]);let oe=class extends THING.Object3D{constructor(e){super(e)}};r(oe,"defaultTagArray",["Dummy"]);class ae extends se{constructor(e){super(e)}}function ie(e,t,r,s,n,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(s,n)}function le(e){return function(){var t=this,r=arguments;return new Promise((function(s,n){var o=e.apply(t,r);function a(e){ie(o,s,n,a,i,"next",e)}function i(e){ie(o,s,n,a,i,"throw",e)}a(void 0)}))}}class he{static getIgnore(e,t){if(!e.level)return!1;var r=e.level.config;return!(!r||!0!==r[t])}static isGeneralObject(e){return!!e.has("Entity")||(!!e.has("Placement")||(!!e.has("Region")||(!!e.has("Line")||!!e.has("Geometry"))))}static traverseByIgnore(e,t,r){e.traverse((e=>{he.getIgnore(e,t)||r(e)}))}static traverseBranchByIgnore(e,t,r){if(!he.getIgnore(e,t)&&!THING.Utils.parseBoolean(r(e),!0))return;var s=e.children;if(s)for(var n=0,o=s.length;n<o;n++)this.traverseBranchByIgnore(s[n],t,r)}static compatibilityConstantShowStruct(e){return!!THING.Utils.isValid(e._constantShowStruct)&&e._constantShowStruct}static compatibilityConstantShowThings(e){return!!THING.Utils.isValid(e._constantShowThings)&&e._constantShowThings}static setFloorVisibleInCampusLevel(e,t,r){var s=he.compatibilityConstantShowThings(e),n=!t||r;e.setVisible(n,!1),e.children.forEach((e=>{he.traverseByIgnore(e,"ignoreVisible",(e=>{var t=e.tags;t.has("BuildingElement")?e.setVisible(n,!1):he.isGeneralObject(t)&&n?e.setVisible(s,!1):e.setVisible(!1,!1)}))}))}static setEnvMap(e,t){var r=t;if(e&&e.getAutoEnvMap){var s=e.getAutoEnvMap();if(s){var n=s[t];n&&n.waitForComplete().then((()=>{r===t&&(e.app.envMap=n)}),(e=>{THING.Utils.warn(e)}))}}}static getNearestObjectPosition(e){for(var t=e.target,r=e.boundingBox||t.boundingBox,s=e.radius||r.radius,n=e.camera,o=[],a=0;a<4;a++)o[a]=THING.MathUtils.getPositionByBoundingBoxAngles(t,45+90*a,45,r,s);for(var i,l,h,c,u,p,d=THING.MathUtils.getDistance(o[0],n.position),g=0,v=1;v<o.length;v++){var m=THING.MathUtils.getDistance(o[v],n.position);d>m&&(d=m,g=v)}if(60!==n.fov){var f=.5773502691896257*THING.MathUtils.getDistance(r.center,o[g])/Math.tan(.5*n.fov*Math.PI/180);return i=r.center,l=o[g],h=f,c=[l[0]-i[0],l[1]-i[1],l[2]-i[2]],u=Math.sqrt(c[0]**2+c[1]**2+c[2]**2),p=h/u,[i[0]+p*c[0],i[1]+p*c[1],i[2]+p*c[2]]}return o[g]}}function ce(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}var ue="default",pe=Symbol("private"),de=new Map;class ge{static setLevelControlClass(e,t,r){de.set(e,{condition:t,cls:r})}constructor(e){this.app=e;var t=this[pe]={};t.controlsMap=new Map,t.addControlProperty=(e,r,s)=>{var n={control:s,condition:r,tag:ue};t.controlsMap.set(e,n),Object.defineProperty(this,e,{get:()=>{var r=t.controlsMap.get(e);return r?r.control:null},set:r=>{var s=t.controlsMap.get(e);s&&this.addControl(s.condition,e,r)},configurable:!0})},de.forEach(((t,r)=>{e.level.levelControlManager.registerClass(t.cls,{condition:t.condition,name:r,tag:ue})})),e.level.levelControlManager.enableControls(ue);for(var r=e.level.levelControlManager.getControlsByTag(ue),s=0;s<r.length;s++){var n=r[s],o=n.options;t.addControlProperty(o.name,o.condition,n)}}setControlOption(e,t){this[pe].controlsMap.forEach((r=>{r.control[e]=t}))}addControl(e,t,s,n){s&&s.isDefaultLevelControl&&(this.removeControl(t),this.app.level.register(e,s,function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ce(Object(s),!0).forEach((function(t){r(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ce(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({tag:ue,priority:0},n)),this[pe].addControlProperty(t,e,s))}removeControl(e){var t=this[pe],r=t.controlsMap.get(e);r&&(this.app.level.unregister(r.control),t.controlsMap.delete(e),delete this[e])}}var ve=1;function me(){return"__CampusLevelControl__TagName__"+ ++ve}var fe=Symbol("private");class ye extends THING.BaseLevelControl{static register(){ge.setLevelControlClass(this.levelName,this.levelCondition,this)}constructor(e){super(e);var t=this[fe]={};t.enableFly=!0,t.enableSkipLevel=!0,t.enableOutlineColor=!0,t.enableMouseEvent=!0,t.enterLevelEventType=THING.EventType.DBLClick,t.leaveLevelEventType=THING.EventType.DBLClick,t.outlineColor=[1,.5019607843137255,0],t.preferCachedViewpoint=!1,t.isCameraFirst=!1,t.viewpointCache=new Map,t.events=[],t.tagName=me(),t.mouseEnterObject=null,t._isSkipLevel=!1,t.enableBrotherMouseEvent=!0,t.cacheViewpoint=e=>{var r=e.current;if(r){var s=e.next;if(s&&s.isChildOf(r)){var n=r.app.camera;t.viewpointCache.set(r.uuid,{position:n.position,target:n.target})}}},t.getViewpointFromLevel=e=>{if(e){var t=e.level;if(t)return t.viewpoint}},t.backLevel=()=>{var e=this.app,t=e.level.current.parent;t&&e.levelManager.change(t)},t.registerFlyToEvent=e=>{var r=me()+"_fly_tag_";return t.registerEvent(THING.EventType.MouseUp,(()=>{e.stopFlying()}),r),t.registerEvent(THING.EventType.MouseDown,(()=>{e.stopFlying()}),r),t.registerEvent(THING.EventType.Wheel,(()=>{e.stopFlying()}),r),()=>{t.unregisterEvent(THING.EventType.MouseUp,r),t.unregisterEvent(THING.EventType.MouseDown,r),t.unregisterEvent(THING.EventType.Wheel,r)}},t.processFlyParam=e=>{var r=e.current,s=r.app.camera,n=t.registerFlyToEvent(s),o={target:r,onStop:()=>{n()},onComplete:()=>{n()}},a=t.viewpointCache.get(r.uuid);if(!a||!t.preferCachedViewpoint){var i=t.getViewpointFromLevel(r);i&&(a=i)}return t.viewpointCache.delete(r.uuid),a&&(o.target=a.target,o.position=a.position),o},t.registerMouseEvent=()=>{t.registerEvent(THING.EventType.MouseEnter,(e=>{this.onMouseEnter(e)})),t.registerEvent(THING.EventType.MouseLeave,(e=>{this.onMouseLeave(e)})),t.registerEvent(t.enterLevelEventType,(e=>{if(0===e.button&&t.mouseEnterObject){var r=t.mouseEnterObject;this.onMouseLeave(),this.onEnterObjectLevel(r)}}),t.tagName+"_enter"),t.registerEvent(t.leaveLevelEventType,(e=>{2===e.button&&(t.mouseEnterObject&&this.onMouseLeave(),this.onBackToParentLevel())}),t.tagName+"_leave")},t.unregisterMouseEvent=()=>{t.unregisterEvent(THING.EventType.MouseEnter),t.unregisterEvent(THING.EventType.MouseLeave),t.unregisterEvent(t.enterLevelEventType,t.tagName+"_enter"),t.unregisterEvent(t.leaveLevelEventType,t.tagName+"_leave")},t.registerEvent=(e,r,s)=>{var n=s||t.tagName;this.app.on(e,r,n),t.events.push({name:e,tag:n})},t.unregisterEvent=(e,r)=>{if(e)for(var s=this.app,n=t.events,o=0;o<n.length;o++){var a=n[o];if(a.name===e)return void(r?r===a.tag&&(s.off(e,r),n._removeAt(o)):(s.off(e,a.tag),n._removeAt(o)))}},t.unregisterAllEvents=()=>{var e=this.app;t.events.forEach((t=>{e.off(t.name,t.tag)}))},t.setLevelChangeEventType=(e,r)=>{r!==t[e]&&(this.isRunning&&t.unregisterMouseEvent(),r===THING.EventType.DBLClick?t[e]=THING.EventType.DBLClick:t[e]=THING.EventType.Click,this.isRunning&&t.registerMouseEvent())}}onEnter(e){var t=()=>super.onEnter,r=this;return le((function*(){t().call(r,e);var s=r[fe];s.levelParam=e;var n=!1;e.options.jumping&&e.target!==e.current&&(n=!0),s.enableSkipLevel&&(s._isSkipLevel=r.onSkipLevel(e),s._isSkipLevel&&(n=!0)),n?r.onSetEffect(e):(s.isCameraFirst&&(yield r.onSetCamera(e)),yield r.onSetEffect(e),r.app.root.dynamicLoad.enable&&(yield r.app.root.dynamicLoad.waitForComplete()),r.isRunning&&(r.onRegisterEvent(e),s.isCameraFirst||(yield r.onSetCamera(e))))}))()}onLeave(e){var t=()=>super.onLeave,r=this;return le((function*(){t().call(r,e);var s=r[fe];if(yield r.onResetEffect(e),!s.enableSkipLevel||!s._isSkipLevel)return s.cacheViewpoint(e),r.onUnregisterEvent(e),Promise.resolve();s._isSkipLevel=!1}))()}onEnable(e){super.onEnable(e),this.onRegisterEvent(e)}onDisable(e){super.onDisable(e),this.onUnregisterEvent(e)}onRegisterEvent(e){var t=this[fe];t.enableMouseEvent&&t.registerMouseEvent()}onUnregisterEvent(e){this[fe].unregisterAllEvents()}onSetEffect(e){}onResetEffect(e){this.onMouseLeave()}filterObject(e){var t=this[fe];if(e.tags.has("IgnoreLevel"))return null;if(e.tags.has("Ground")||e.tags.has("Misc"))return null;var r=e.parents;if(r.find("tags:or(Misc,Ground)"))return null;var s=e.app.levelManager.current;if(e.isBrotherOf(s))return i(e);var n=r.indexOf(s);if(0===n)return i(e);if(n>0)return i(r[n-1]);var o=s.parent,a=r.indexOf(o);return a>0?i(r[a-1]):null;function i(e){return!t.enableBrotherMouseEvent&&e.isBrotherOf(s)?null:e}}getLevelParam(){return this.isRunning?this[fe].levelParam:null}onSetCamera(e){var t=this[fe],r=t.processFlyParam(e);return t.enableFly?this.onFlyTo(r):(this.app.camera.fit(r),null)}onFlyTo(e){return new Promise(((t,r)=>{var s=e.onComplete;e.onComplete=e.onStop=()=>{s&&s(),t()},this.app.camera.flyTo(e)}))}onSkipLevel(e){var t=e.prev,r=e.path;if(!t||!r)return!1;var s=r[r.length-1];return!(!s||!t.isBrotherOf(s))}onMouseEnter(e){var t=this[fe],r=e.object;if(r&&!he.getIgnore(r,"ignoreEvent")){var s=this.filterObject(r);if(s&&!he.getIgnore(s,"ignoreEvent"))return t.mouseEnterObject=s,t.enableOutlineColor&&(this.onSetOutlineColor(s,t.outlineColor),t.mouseEnterObject.on(THING.EventType.BeforeDestroy,(()=>{t.mouseEnterObject=null}),"__CampusLevelControl__Destroy__")),s}}onMouseLeave(e){var t=this[fe],r=t.mouseEnterObject;if(r)return t.enableOutlineColor&&this.onSetOutlineColor(r,null),r.off(THING.EventType.BeforeDestroy,"__CampusLevelControl__Destroy__"),t.mouseEnterObject=null,r}onEnterObjectLevel(e){e.app.level.change(e)}onBackToParentLevel(){this[fe].backLevel()}onSetOutlineColor(e,t){e&&he.traverseByIgnore(e,"ignoreStyle",(e=>{if(!t||e.visible){var r=e.body.style;r&&(t||r.outlineColor)&&this.shouldOutline(e)&&(r.outlineColor=t)}}))}shouldOutline(e){return!0}get enableFly(){return this[fe].enableFly}set enableFly(e){this[fe].enableFly=e}get enableSkipLevel(){return this[fe].enableSkipLevel}set enableSkipLevel(e){this[fe].enableSkipLevel=e}get enableOutlineColor(){return this[fe].enableOutlineColor}set enableOutlineColor(e){this[fe].enableOutlineColor=e}get enableMouseEvent(){return this[fe].enableMouseEvent}set enableMouseEvent(e){var t=this[fe];t.enableMouseEvent!==e&&(t.enableMouseEvent=e,this.isRunning&&(e?t.registerMouseEvent():t.unregisterMouseEvent()))}get outlineColor(){return this[fe].outlineColor}set outlineColor(e){this[fe].outlineColor=e}get enterLevelEventType(){return this[fe].enterLevelEventType}set enterLevelEventType(e){this[fe].setLevelChangeEventType("enterLevelEventType",e)}get leaveLevelEventType(){return this[fe].leaveLevelEventType}set leaveLevelEventType(e){this[fe].setLevelChangeEventType("leaveLevelEventType",e)}get preferCachedViewpoint(){return this[fe].preferCachedViewpoint}set preferCachedViewpoint(e){this[fe].preferCachedViewpoint=!!e}get isCameraFirst(){return this[fe].isCameraFirst}set isCameraFirst(e){this[fe].isCameraFirst=!!e}get enableBrotherMouseEvent(){return this[fe].enableBrotherMouseEvent}set enableBrotherMouseEvent(e){this[fe].enableBrotherMouseEvent=!!e}get isDefaultLevelControl(){return!0}}r(ye,"levelCondition",""),r(ye,"levelName","");class be extends ye{constructor(e){super(e)}onEnter(e){var t=e.current;return he.setEnvMap(t,"outer"),super.onEnter(e)}onSetEffect(e){var t=e.current;t&&this.showCampus(t)}onBackToParentLevel(){this.app.level.current.parent!==this.app.root&&super.onBackToParentLevel()}filterObject(e){if(e.tags.has("Ground")||e.tags.has("Misc"))return null;var t=e.parents,r=t.find("tags:or(Campus)");return r?r!=r.app.level.current||t.find("tags:or(Misc,Ground)")?null:super.filterObject(e):null}showCampus(e){e.children.forEach((e=>{if(e.tags.has("Building")){var t=e;t.setVisible(!0,!1);var r=t.find("tags:or(Facade,Roof)"),s=he.compatibilityConstantShowStruct(t);t.children.forEach((e=>{var t=e.tags;t.has("Floor")?he.setFloorVisibleInCampusLevel(e,r,s):t.has("Facade")||t.has("Roof")?he.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)})):he.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))}))}else he.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)}))}))}onFlyTo(e){var t=e.target;if(t&&t.isObject3D){var r=t.boundingBox;e.position=he.getNearestObjectPosition({target:t,boundingBox:r,radius:Math.min(r.radius,300),camera:this.app.camera}),e.target=r.center}return super.onFlyTo(e)}}r(be,"levelCondition","tags:or(Campus)"),r(be,"levelName","campus");var _e=Symbol("private");class xe extends ye{constructor(e){super(e);var t=this[_e]={};t.hideObjects=[],t.enableExpandFloors=!1,t.notCheckOutline=!1}onEnter(e){var t=()=>super.onEnter,r=this;return le((function*(){var s=r[_e],n=e.prev;n&&n.isCampus&&he.setEnvMap(n,"inner");var o=t().call(r,e),a=e.current;return s.enableExpandFloors&&a.expandFloors(),o}))()}onLeave(e){var t=this[_e];return super.onLeave(e),new Promise((r=>{var s=e.current;t.enableExpandFloors&&s.expanded?s.unexpandFloors({duration:1,onComplete:r}):r()}))}onSetEffect(e){var t=e.current;if(t){var r=this[_e];t.brothers.forEach((e=>{he.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))})),t.children.forEach((e=>{var t=e.tags;t.has("Floor")?(e.setVisible(!0,!1),he.traverseByIgnore(e,"ignoreVisible",(t=>{if(t!=e){var r=t.tags;r.has("BuildingElement")?t.setVisible(!(r.has("RoomRoof")||r.has("Roof")),!1):t.setVisible(!0,!1)}}))):t.has("Facade")||t.has("Roof")?he.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)})):he.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)}))})),t.parent.brothers.queryByTags("Campus").forEach((e=>{he.traverseByIgnore(e,"ignoreVisible",(e=>{e.isLight||e.isCamera||(r.hideObjects.push(e),e.setVisible(!1,!1))}))}))}}onResetEffect(e){var t=e.current,r=e.next;if(!r||t.parent==r){var s=this[_e];s.hideObjects.forEach((e=>{e.setVisible(!0,!1)})),s.hideObjects.length=0}}onSetOutlineColor(e,t){if(e){var r=this[_e],s=e.find("tags:or(Wall,BuildingElement)");r.notCheckOutline=!s,super.onSetOutlineColor(e,t)}}shouldOutline(e){if(this[_e].notCheckOutline)return!0;if(e){if(e.tags.has("Door")||e.tags.has("Window"))return!0;var t=e.tags;if(t.has("Wall"))return!0;if(t.has("Slab"))return!0;if(t.has("BuildingElement"))return!0}return!1}get enableExpandFloors(){return this[_e].enableExpandFloors}set enableExpandFloors(e){this[_e].enableExpandFloors=e}onFlyTo(e){var t=e.target;if(t&&t.isObject3D){var r=t.children.queryByTags("Floor"),s=new THING.Selector;if(r.forEach((e=>{e.children.forEach((e=>{e.tags&&e.tags.has("Wall")&&s.push(e)}))})),0===s.length)return e.target=t,super.onFlyTo(e);var n=s.getBoundingBox();e.position=he.getNearestObjectPosition({target:t,boundingBox:n,camera:this.app.camera}),e.target=n.center}return super.onFlyTo(e)}}r(xe,"levelCondition","tags:or(Building)"),r(xe,"levelName","building");class Me extends ye{constructor(e){super(e)}onSetEffect(e){var t=e.current;t&&(he.traverseByIgnore(t,"ignoreVisible",(e=>{e.tags.has("RoomRoof")||e.tags.has("Roof")?e.setVisible(!1,!1):e.setVisible(!0,!1)})),t.brothers.forEach((e=>{he.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))})))}filterObject(e){return e.tags.has("Wall")||e.tags.has("Slab")||e.tags.has("Roof")||e.tags.has("Ceiling")||e.parents.find("tags:or(Misc,Wall)")?null:super.filterObject(e)}onFlyTo(e){var t=e.target;if(t&&t.isObject3D){var r=t.boundingBox;e.position=he.getNearestObjectPosition({target:t,boundingBox:r,camera:this.app.camera}),e.target=r.center}return super.onFlyTo(e)}}r(Me,"levelCondition","tags:or(Floor)"),r(Me,"levelName","floor");var Te=Symbol("private");class Ce extends ye{constructor(e){super(e);var t=this[Te]={};t.transparentObjects=[],t.isObjectTransparent=!1}onSetEffect(e){var t=this[Te],r=e.current;if(r){var s=r.brothers;he.traverseByIgnore(r,"ignoreStyle",(e=>{var t=e.body.style;t&&(t.opacity=null,t.transparent=null)})),s.forEach((e=>{var r=e.children.queryByTags(t.isObjectTransparent?"RoomFloor||Placement||Entity||Line||Geometry||Region||Window||Door":"RoomFloor");r&&he.traverseByIgnore(r,"ignoreStyle",(e=>{var r=e.body.style;r&&(r.opacity=.25,r.transparent=!0),t.transparentObjects.push(e)}))}))}}onResetEffect(e){var t=this[Te];t.isObjectTransparent&&e.next.parent===e.current||(t.transparentObjects.forEach((e=>{var t=e.style;t&&(t.opacity=null,t.transparent=null)})),t.transparentObjects.length=0)}filterObject(e){var t=e.tags;return e.tags.has("Wall")||(t.has("RoomFloor")||t.has("RoomCeiling")||t.has("RoomRoof"))&&e.parent==e.app.level.current||e.parents.find("tags:or(Misc,Wall)")?null:super.filterObject(e)}onFlyTo(e){var t=e.target;if(t&&t.isObject3D){var r=t.boundingBox;e.position=he.getNearestObjectPosition({target:t,boundingBox:r,camera:this.app.camera}),e.target=r.center}return super.onFlyTo(e)}get isObjectTransparent(){return this[Te].isObjectTransparent}set isObjectTransparent(e){this[Te].isObjectTransparent=!!e}}r(Ce,"levelCondition","tags:or(Room)"),r(Ce,"levelName","room");var Je=Symbol("private");class we extends ye{constructor(e){super(e);var t=this[Je]={};t.isAllObjectsTransparent=!1,t.transparentObjects=[],t.filterBuildingElementOfIndoor=e=>{if(e.app.level.current.parents.find("tags:or(Floor)")){var t=e.tags;if(t.has("RoomFloor"))return!0;if(t.has("RoomCeiling"))return!0;if(t.has("RoomRoof"))return!0;if(t.has("Wall"))return!0}return!1}}onSetEffect(e){!0===this[Je].isAllObjectsTransparent?this._setEffect_transparentAll(e):this._setEffect_self(e)}_setEffect_self(e){var t=this[Je];t.transparentObjects.length=0;var r=e.current;if(r){var s=r.brothers;he.traverseByIgnore(r,"ignoreStyle",(e=>{var t=e.body.style;t&&(t.opacity=null,t.transparent=null)})),s.forEach((e=>{e.tags.has("Misc")||he.traverseByIgnore(e,"ignoreStyle",(e=>{if(he.isGeneralObject(e.tags)&&!e.destroyed){var r=e.body.style;r&&(r.opacity=.25,r.transparent=!0),t.transparentObjects.push(e)}}))}))}}_setEffect_transparentAll(e){var t=this[Je];t.transparentObjects.length=0;var r=e.current;if(r){var s=!1,n=r.parents.find("tags:or(Floor)");n||(n=r.parents.find("tags:or(Campus)"),s=!0),n?he.traverseBranchByIgnore(n,"ignoreStyle",(e=>{if(s&&(e.tags.has("Building")||e.tags.has("Floor")))return!1;if(e.tags.has("Misc")||e.tags.has("Ground"))return!1;if(e===r)return!1;if(he.isGeneralObject(e.tags)&&!e.destroyed){var n=e.body.style;n&&(n.opacity=.25,n.transparent=!0),t.transparentObjects.push(e)}return!0})):this._setEffect_self(e)}}onResetEffect(e){var t=this[Je];e.next&&e.current&&e.current.isChildOf(e.next)&&t.transparentObjects.forEach((e=>{he.traverseByIgnore(e,"ignoreStyle",(e=>{if(!e.destroyed){var t=e.body.style;t&&(t.opacity=null,t.transparent=null)}}))})),t.transparentObjects.length=0}filterObject(e){var t=this[Je];return e.parents.find("tags:or(Misc,Ground)")||t.filterBuildingElementOfIndoor(e)?null:super.filterObject(e)}get isAllObjectsTransparent(){return this[Je].isAllObjectsTransparent}set isAllObjectsTransparent(e){this[Je].isAllObjectsTransparent=!!e}}r(we,"levelCondition","tags:or(Placement,Group,Entity,Line,Geometry,Region,Window,Door)"),r(we,"levelName","placement");var Ie={EnableFly:"enableFly",EnableSkipLevel:"enableSkipLevel",EnableOutlineColor:"enableOutlineColor",EnableMouseEvent:"enableMouseEvent",OutlineColor:"outlineColor",EnterLevelEventType:"enterLevelEventType",LeaveLevelEventType:"leaveLevelEventType"},Pe=Symbol("private"),Se="ModelWall",Ee="TextureWall",Re=[0,0,0],Ne=[0,0,0],Oe=[0,0,0],De={};class Le extends THING.Component{constructor(e){super(e);var t=this[Pe]={};t.data=null,t.dataType=null,t.pickIds=null,t.setData=(e,r)=>{e&&(t.toolkit=r,t.data=e,t.dataType=e.type,t.pickIds=e.pickIds,t.walls=e.walls,t.materialExtendOptions={defineUsePickId:!!t.pickIds},e.type===Se&&t._parseModelWalls(e.walls))},t.getData=e=>{var r={type:t.dataType};if(t.pickIds&&(r.pickIds=t.pickIds),t.walls){var s=[];t.walls.forEach((e=>{s.push(Object.assign({},e))})),r.walls=s}return r},t.load=e=>t.dataType===Se?t._loadModelWall(e):t.dataType===Ee?t._loadTextureWall(e):Promise.resolve(),t._getParserManager=()=>(t._parserManager||(t._parserManager=i.createObject("ParserManager")),t._parserManager),t._loadTextureWall=e=>{var r=[],s=[];return t.walls.forEach((e=>{!1!==e.visible&&(e.height=i.parseNumber(e.height,3),e.thickness=i.parseNumber(e.thickness,.25),(e=Object.assign({},e)).leftMaterial=t._loadMaterialResource(e.leftMaterial,r),e.rightMaterial=t._loadMaterialResource(e.rightMaterial,r),e.edgeMaterial=t._loadMaterialResource(e.edgeMaterial,r),s.push(e))})),Promise.all(r).then((()=>{t._parseWall(e,s)}),(()=>{t._parseWall(e,s)}))},t._loadMaterialResource=(e,t)=>{if(!e)return null;var{material:r,promise:s}=this.app._materialResourceLoader.createMaterialResource(e);return t.push(s),r},t._parseWall=(e,r)=>{if(!e.destroyed){var s=t._getParserManager().parseWall(r,{pickIds:t.pickIds});e.body.setNode(s)}},t._parseModelWalls=e=>{e.forEach((e=>{var r=e.model;if("number"==typeof r&&(t.toolkit.getURIByIndex&&(e.model=t.toolkit.resolveURL(t.toolkit.getURIByIndex(r))),t.toolkit.getModelDataByIndex)){var s=t.toolkit.getModelDataByIndex(r);e.model=s.url}}))},t._loadModelWall=function(){var e=le((function*(e){for(var r=t.walls,s={},n={},o=function*(){var o=r[a],i=o.model;if(!1===o.visible||!i)return"continue";var l=De[i];l||(l=yield t._getModelSize(i,e)),De[i]=l;var h=t._generateModelWallTransfrom(o,l);if(t.pickIds){var c=t.pickIds[a],u=[];h.forEach((e=>{u.push(c)})),n[i]=n[i]?n[i].concat(u):u}s[i]=s[i]?s[i].concat(h):h},a=0;a<r.length;a++)yield*o();for(var i=Object.keys(s),l=[],h=0;h<i.length;h++){var c=i[h],u=s[c];l[h]=t._mergeCreate(c,u,n[c],e)}return Promise.all(l)}));return function(t){return e.apply(this,arguments)}}(),t._generateModelWallTransfrom=(e,r)=>{for(var s=[],n=e.points,o=[n[0],0,n[1]+l()],a=[n[2]+l(),0,n[3]],h=e.holes,c=e.height,u=e.thickness,p=t._generateLines(o,a,h),d=THING.MathUtils.normalizeVector(THING.MathUtils.subVector(a,o)),g=THING.MathUtils.getQuatFromUnitVectors([-1,0,0],d),v=THING.MathUtils.getEulerFromQuat(g),m=[THING.MathUtils.radToDeg(v[0]),THING.MathUtils.radToDeg(v[1]),THING.MathUtils.radToDeg(v[2])],f=THING.MathUtils.scaleVector(d.concat(),r[0]/2),y=THING.MathUtils.scaleVector(d.concat(),r[0]),b=0==c?.001:c/r[1],_=0==u?.001:u/r[2],x=0;x<p.length;x++){var M=p[x],T=THING.MathUtils.getDistance(M.start,M.end)/r[0],C=T%1;if(T=Math.floor(T),1==(T+=1)){var J=THING.MathUtils.getPointOnLine(M.start,M.end,.5),w=THING.MathUtils.createMat4([J[0],0,J[2]],m,[C,b,_]);s.push(w)}else for(var I=void 0,P=void 0,S=0;S<T;S++){var E=THING.MathUtils.getPointOnLine(M.start,M.end,S),R=[E[0],0,E[2]];0==S?(I=THING.MathUtils.addVector(R,f),P=1):S==T-1?(I=THING.MathUtils.addVector(I,THING.MathUtils.scaleVector(d.concat(),r[0]/2+r[0]*C/2)),P=C):(I=THING.MathUtils.addVector(I,y),P=1);var N=THING.MathUtils.createMat4([I[0],0,I[2]],m,[P,b,_]);s.push(N)}}if(i.parseBoolean(e.fillHole,!1)&&h)for(var O=0;O<h.length;O++){var D=h[O],L=D.size,U=D.loc,F=U[1],j=THING.MathUtils.getPointOnLine(o,a,U[0]),H=L[0]/r[0];if(F>=.001){var A=c*F/r[1],G=THING.MathUtils.createMat4([j[0],0,j[2]],m,[H,A,_]);s.push(G)}if(F<1){var B=(1-F)*c-L[1];if(B>0){var k=B/r[1],z=THING.MathUtils.createMat4([j[0],c-B,j[2]],m,[H,k,_]);s.push(z)}}}return s},t._generateLines=(e,t,r)=>{var s=[],n=THING.MathUtils.getDistance(e,t);if(r&&r.length>0){for(var o=0;o<r.length-1;o++)for(var a=0;a<r.length-1-o;a++)if(r[a].loc[0]>r[a+1].loc[0]){var i=r[a];r[a]=r[a+1],r[a+1]=i}var l=null;r.forEach((r=>{var o,a,i=r.loc,h=r.size[0]/n,c=i[0]-h/2;l?(o=THING.MathUtils.getPointOnLine(e,t,l),a=THING.MathUtils.getPointOnLine(e,t,c)):(o=THING.MathUtils.getPointOnLine(e,t,0),a=THING.MathUtils.getPointOnLine(e,t,c)),s.push({start:o,end:a}),l=c+h})),l<1&&s.push({start:THING.MathUtils.getPointOnLine(e,t,l),end:THING.MathUtils.getPointOnLine(e,t,1)})}else s.push({start:e,end:t});return s},t._mergeCreate=(e,t,r,s)=>{var n={matrices:t,lights:!0,pickIds:r};return new Promise((function(r,o){t&&t.length&&s.app.resourceManager.loadModel(e,(e=>{s.destroyed||(e.node.setStyle(s.bodyNode.getStyle()),s.bodyNode.add(e.node)),r()}),void 0,(e=>{o(e),console.error(e)}),n)}))},t._getModelSize=function(){var e=le((function*(e,t){return new Promise(((r,s)=>{t.app.resourceManager.loadModel(e,(function(e){var t=e.node.getOBB({center:Re,halfSize:Ne,rotation:Oe}).halfSize,s=[2*t[0],2*t[1],2*t[2]];e.node.dispose(),r(s)}),(function(){}),s)}))}));return function(t,r){return e.apply(this,arguments)}}()}onImport(e,t){e&&(super.onImport(e,t),this[Pe].setData(e,t))}onExport(e){return super.onExport(e),this[Pe].getData(e)}onLoadResource(){return this[Pe].load(this.object)}}i.registerClass("WallComponent",Le);let Ue=class extends THING.BaseResolver{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),this._styles=[],this._stylesMap={}}_resolveObjectData(e,t,r){var s;null==e||null===(s=e.components)||void 0===s||s.forEach((e=>{var s=e.type;"WallComponent"===s?t.call(this,e):"PlaneComponent"===s&&r.call(this,e)}))}onImport(e){this._styles=e.styles||[],this._styles.forEach((e=>{var t=e.map,r=e.aoMap;"number"==typeof t&&(e.map=this.toolkit.resolveURL(this.toolkit.getURIByIndex(t))),"number"==typeof r&&(e.aoMap=this.toolkit.resolveURL(this.toolkit.getURIByIndex(r)))}))}resolveImportObject(e){this._resolveObjectData(e,this._importWallComponent,this._importPlaneComponent)}_importWallComponent(e){var t=e.params;if(t){var r=t.type,s=t.walls;"ModelWall"===r?s.forEach((e=>{if(null!=e.model)if(this.toolkit.getURIByIndex)e.model=this.toolkit.resolveURL(this.toolkit.getURIByIndex(e.model));else if(this.toolkit.getModelDataByIndex){var t=this.toolkit.getModelDataByIndex(e.model);e.model=t.url}})):"TextureWall"===r&&s.forEach((e=>{this._replaceWallMatResToData(e,"leftMaterial"),this._replaceWallMatResToData(e,"rightMaterial"),this._replaceWallMatResToData(e,"edgeMaterial")}))}}_replaceWallMatResToData(e,t){var r=e[t];if(null!=r){var s=this._styles[r];s&&(e[t]=s)}}_importPlaneComponent(e){var t,r=null==e||null===(t=e.params)||void 0===t?void 0:t.materialResource;"number"==typeof r&&(e.params.materialResource=this._styles[r])}onExport(){if(!this._styles.length)return null;for(var e={styles:this._styles},t=0;t<this._styles.length;t++){var r=this._styles[t];r.map&&(r.map=this.toolkit.getIndexByURI(this.toolkit.resolveURL(r.map))),r.aoMap&&(r.aoMap=this.toolkit.getIndexByURI(this.toolkit.resolveURL(r.aoMap)))}return e}resolveExportObject(e){this._resolveObjectData(e,this._exportWallComponent,this._exportPlaneComponent)}_exportWallComponent(e){var t=null==e?void 0:e.params;if(t){var r=t.walls;"TextureWall"===t.type?r.forEach((e=>{e.leftMaterial=this._replaceMatResToIndex(e.leftMaterial),e.rightMaterial=this._replaceMatResToIndex(e.rightMaterial),e.edgeMaterial=this._replaceMatResToIndex(e.edgeMaterial)})):r.forEach((e=>{e.model=this.toolkit.getIndexByURI(this.toolkit.resolveURL(e.model))}))}}_exportPlaneComponent(e){var t,r=null==e||null===(t=e.params)||void 0===t?void 0:t.materialResource;r&&(e.params.materialResource=this._replaceMatResToIndex(r))}_replaceMatResToIndex(e){var t=function(e){var t=e.map,r=e.uv;e.aoMap&&(t+="_"+e.aoMap);e.transparent&&(t+="_"+e.transparent);e.sideType&&(t+="_"+e.sideType);e.defineFloorAo&&(t+="_"+e.defineFloorAo);e.defineWallAo&&(t+="_"+e.defineWallAo);e.color&&(t+="_"+e.color);r&&(r.angle&&(t+="_"+r.angle),r.repeat&&(t+="_"+r.repeat[0]+"_"+r.repeat[1]),r.center&&(t+="_"+r.center[0]+"_"+r.center[1]),r.offset&&(t+="_"+r.offset[0]+"_"+r.offset[1]));return t+="_"+e.metalness,t+="_"+e.roughness,t}(e),r=this._stylesMap[t];return null==r&&(r=this._styles.push(Object.assign({},e))-1,this._stylesMap[t]=r),r}};var Fe=Symbol("private");class je extends THING.Component{constructor(e){super(e);var t=this[Fe]={};t.materialResourceResolver=null,t.materialResourceIndex=null,t.materialResourceData=null}onImport(e,t){if(e){var r=this[Fe];!r.materialResourceResolver&&t.getResolver&&(r.materialResourceResolver=t.getResolver("MaterialResourceResolver")),r.materialResourceResolver&&i.isNumber(e.materialResource)&&(r.materialResourceIndex=e.materialResource,r.materialResourceData=r.materialResourceResolver.getMaterialResourceDataByIndex(e.materialResource))}}onExport(e){var t=this[Fe],r=e.getResolver("MaterialResourceResolver");return r||(r=new Ue,e.registerResolver("MaterialResourceResolver",r)),t.materialResourceResolver=r,t.materialResourceData?{materialResource:r.setMaterialResourceData(t.materialResourceData)}:null}loadMaterialResource(e,t){var r=this[Fe];return r.materialResourceData?r.materialResourceResolver.createMaterialResourceByIndex(r.materialResourceIndex,(()=>{e&&e()}),(()=>{t&&t()})):(e(),null)}get materialResourceResolver(){return this[Fe].materialResourceResolver}}var He=Symbol("private"),Ae=[0,0,0,1],Ge={};class Be extends THING.Component{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ge;super(e);var t=this[He]={dynamic:e.dynamic,points:null,holes:null,alwaysHide:!1};Ae[1]=l(),t.setData=e=>{t.materialResourceData=e.materialResource,t.alwaysHide=i.parseBoolean(e.alwaysHide,!1),t.uv=e.uv;var r=this.object.parent.external;t.selfPoints=e.points,!t.selfPoints&&r&&(t.selfPoints=r.points),t.selfHoles=e.holes,!t.selfHoles&&r&&(t.selfHoles=r.holes),t.instanceGroupName=e.instanceGroupName},t.getData=()=>{var e={};t.materialResourceData&&(e.materialResource=t.materialResourceData),!0===t.alwaysHide&&(e.alwaysHide=t.alwaysHide);var r=this.object.parent.external;return r&&r.points||(t.selfPoints&&(e.points=t.selfPoints),t.selfHoles&&(e.holes=t.selfHoles)),e},t.create=function(e,r){var s=i.createObject("ExtrudeShape",{materialResource:r});s.setQuaternion(Ae),e.body.setNode(s),s.begin(),s.setPoints(i.cloneObject(t.selfPoints,!1)),t.selfHoles&&s.setHoles(i.cloneObject(t.selfHoles,!1)),s.end(),t.uv&&t.updateVertexUV(e),t.instanceGroupName&&(e.instanceGroupName=t.instanceGroupName,e.makeInstancedDrawing(!0))},t.updateVertexUV=function(e){for(var r,s,n,o,a,i,l,h=e.node._node.geometry.attributes.a_Uv.buffer,c=h.array,u=(r=t.uv,s=r.offset||[0,0],n=r.repeat||[1,1],o=r.center||[0,0],a=(r.rotation||0)*Math.PI/180,i=Math.cos(a),l=Math.sin(a),[n[0]*i,-n[1]*l,0,n[0]*l,n[1]*i,0,-n[0]*(i*o[0]+l*o[1])+o[0]+s[0],-n[1]*(-l*o[0]+i*o[1])+o[1]+s[1],1]),p=0;p<c.length;p+=2){var d=g(c[p],c[p+1],u);c[p]=d[0],c[p+1]=d[1]}function g(e,t,r){return[r[0]*e+r[3]*t+1*r[6],r[1]*e+r[4]*t+1*r[7]]}h.version++}}onImport(e,t){super.onImport(e,t),this[He].setData(e)}onExport(e){return super.onExport(e),this[He].getData()}onLoadResource(){var e=this[He];return new Promise(((t,r)=>{e.alwaysHide?t():this.app._materialResourceLoader.createMaterialResource(e.materialResourceData,(r=>{e.create(this.object,r),t()}),r)}))}get alwaysHide(){return this[He].alwaysHide}}i.registerClass("PlaneComponent",Be);var ke=Symbol("private"),ze=[0,0,0,1],Ve={};class We extends je{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ve),this[ke]={};var e=this[ke];ze[1]=l(),e.setData=t=>{e.planes=t.planes,e.vertexData={indices:[],positions:[],normals:[],uvs:[]};for(var r=0;r<e.planes.length;r++)e.getvertexData(e.vertexData,e.planes[r])},e.create=(t,r)=>{var s=i.createObject("GeometryResource"),n=e.buildVertexBuffer(e.vertexData);s.setVertexData(n);var o=i.createObject("CustomNode",{geometryResource:s,materialResource:r});o.setQuaternion(ze),t.body.setNode(o)},e.buildVertexBuffer=e=>{for(var t=[{name:"positions",stride:3},{name:"normals",stride:3},{name:"uvs",stride:2}],r={vertexBuffer:[],attributes:{},indices:[]},s=0;s<t.length;s++){var n=t[s].name,o=e[n];if(o){var a=t[s].stride;r.vertexBuffer.push({array:o,stride:a}),r.attributes[n]=r.vertexBuffer.length-1}}return e.indices&&(r.indices=e.indices.slice(0)),r},e.getvertexData=function(){var t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1?arguments[1]:void 0,n=s.components[0].external,o=n.points.map((e=>(e[1]=-e[1],e))),a=null===(t=n.holes)||void 0===t?void 0:t.map((e=>e.map((e=>(e[1]=-e[1],e))))),i=THING.PolygonBuilder.getGeometryData({contour:o,holes:a});e.updateVertexUV(s,i.uvs);for(var l=r.positions.length/3,h=0;h<i.indices.length;h++)i.indices[h]+=l;for(var c=[],u=THING.MathUtils.getQuatFromAngles([-90,0,0]),p=0;p<i.positions.length;p+=3)c[0]=i.positions[p],c[1]=i.positions[p+1],c[2]=i.positions[p+2],THING.MathUtils.vec3ApplyQuat(c,u,c),i.positions[p]=c[0],i.positions[p+1]=c[1],i.positions[p+2]=c[2],i.normals[p]=0,i.normals[p+1]=1,i.normals[p+2]=0;r.indices.push(...i.indices),r.positions.push(...i.positions),r.normals.push(...i.normals),r.uvs.push(...i.uvs)},e.updateVertexUV=(e,t)=>{for(var r,s,n,o,a,i,l,h=(r=e.components[0].external.uv,s=r.offset||[0,0],n=r.repeat||[1,1],o=r.center||[0,0],a=(r.rotation||0)*Math.PI/180,i=Math.cos(a),l=Math.sin(a),[n[0]*i,-n[1]*l,0,n[0]*l,n[1]*i,0,-n[0]*(i*o[0]+l*o[1])+o[0]+s[0],-n[1]*(-l*o[0]+i*o[1])+o[1]+s[1],1]),c=0;c<t.length;c+=2){var u=p(t[c],t[c+1],h);t[c]=u[0],t[c+1]=u[1]}function p(e,t,r){return[r[0]*e+r[3]*t+1*r[6],r[1]*e+r[4]*t+1*r[7]]}}}onImport(e,t){super.onImport(e,t),this[ke].setData(e)}onLoadResource(){var e=this[ke];return new Promise(((t,r)=>{var s=this.loadMaterialResource((()=>{e.create(this.object,s),t()}),r)}))}}i.registerClass("CombinePlaneComponent",We);class qe extends THING.SceneBundleLoader{constructor(){super(),this._useDefaultTheme=!0}parseOptions(e,t){if(function(e,t){var r="";e.info.resourceLibrary?r=e.info.resourceLibrary._startsWith("http://")||e.info.resourceLibrary._startsWith("https://")||e.info.resourceLibrary._startsWith("file://")||e.info.resourceLibrary._startsWith("blob:")||e.info.resourceLibrary._startsWith("/")?e.info.resourceLibrary:e.url._appendPath(e.info.resourceLibrary):t.resourceLibraryUrl&&(r=t.resourceLibraryUrl),r&&(t.rootPath={model:r._appendPath("model"),texture:r._appendPath("texture")})}(e,t=Object.assign({},t)),!t.owner){var r=Object.assign({},t);r.url=null,r.complete=r.onComplete=null,r.tags=["helper"],r.app=this.app,t.owner=new THING.Object3D(r),t.owner._isTempRoot=!0}var s=t._index_;i.isValid(s)&&(t.progressParam={index:s,progress:0}),this._useDefaultTheme=i.parseBoolean(t.useDefaultTheme,!0),e.info.main&&(t.mainFileUrl=e.url._appendPath(e.info.main)),e.name=e.info.name;var n=t.onUpdateCreateOptions;t.onUpdateCreateOptions=(e,t,r)=>(n&&(r=n(e,t,r)),this.onUpdateCreateOptions(e,t,r));var o=t.onCreateObject;return t.onCreateObject=(e,t,r)=>{this.onCreateObject(e,t,r),o&&o(e,t,r)},t}onLoad(e,t){t=this.parseOptions(e,t),this.initLoadingBar(t),this.onLoadSceneFile(e,t).then((r=>{this.onLoadScene(e,t,r)}))}onLoadSceneFile(e,t){var r=i.parseBoolean(t.useCache,!0);return i.loadJSONFile(t.mainFileUrl,(()=>{}),(()=>{}),(()=>{}),{useCache:r})}onLoadScene(e,t,r){(new THING.SceneLoaderOld).parse(THING.SceneResourceType.Object,r,(r=>{this.onLoadComplete(r,e,t)}),(e=>{this.onProgressUpdate(t,e)}),t.onError,t)}onProgressUpdate(e,t){var r=t.progress;e.progressParam&&(e.progressParam.progress=r,r=e.progressParam),e.onProgress(r),e.owner.loadingBar&&(e.owner.loadingBar.value=t.progress)}onLoadComplete(e,t,r){var s=r.owner,n=i.parseBoolean(r.outputCompleteParam,!1)?{}:null,o=s.children,a=s.app;if(o.length){var l=o.query(".Campus"),h=l.length?l[0]:null;if(s._isTempRoot||(h=s,l=[s]),0!==l.length)i.parseValue(r.dynamic,!1)&&l.forEach((e=>{e.onNotifyComplete()}));n?(n.objects=e.objects,n.campus=h,n.campuses=l,n.rootObjects=[h],t.internalData.completeParam=n):(t.objects=e.objects,t.campus=h,t.campuses=l,t.rootObjects=[h],l.forEach((e=>{e.on(THING.EventType.Destroy,(e=>{var r=t.campuses.indexOf(e.object);t.campuses.splice(r,1)}))}))),s._isTempRoot&&s.children.forEach((e=>{(r.root||a.root).add(e)})),s.loadingBar?s.loadingBar.fadeOut({time:800,delayTime:200}).then((()=>{s._isTempRoot&&s.destroy()})):s._isTempRoot&&s.destroy();var c=e.envMap;c&&(a.view._compatibleRender&&(c.inner||(c.inner=i.getBlackEnvMap()),l.forEach((e=>{e.setAutoEnvMap(c)}))),c.outer&&c.outer.waitForComplete().then((()=>{a.envMap=c.outer}))),r.onComplete();var u={bundle:t};u.campuses=l,h&&(u.campus=h),a.trigger(THING.EventType.Load,u)}else r.onComplete()}onUpdateCreateOptions(e,t,r){var s=l()||0;if(this._useDefaultTheme&&this._parseCreateOptionsWithTheme(e,t,r),s){var n=i.parseValue(r.localQuaternion,[0,0,0,1]);r.localQuaternion=[n[0],n[1]+s,n[2],n[3]]}return r}onCreateObject(e,t,r){this._useDefaultTheme&&this._processOnCreateWithTheme(t,r);var s=t.resource;i.isValid(s.instanceId)&&t.makeInstancedDrawing(!0)}initLoadingBar(e){i.parseValue(e.progressBarVisible,!0)&&super.initLoadingBar(e.owner)}_parseCreateOptionsWithTheme(e,t,r){for(var s,n=e.app,o=e;null!==o;){if(o.userData._themeTag){s=o.userData._themeTag;break}o=o.parent}if(s){var a=n.themeManager.getTheme(s),i=a.styles;if(a&&i){var l,h=i.class,c=r.userData||{},u=t.className;if(c._styleTag_&&h[c._styleTag_]?l=c._styleTag_:h[u]&&(l=u),l&&h[l]&&h[l].enable){c._themeTag=s,c._styleTag_=l;var p=r.style||{};r.userData=c,n.themeManager._setStylesConfig(s,h[l],p,l),r.style={default:p}}}}}_processOnCreateWithTheme(e,t){var r=e.app;e.userData._themeTag&&e.waitForComplete().then((()=>{var t=e.userData._styleTag_,s=e.userData._themeTag;if(t&&s){var n=r.themeManager.getTheme(s),o=n.styles;if(n&&o){var a=o.class;e.style.beginDefaultValues(),r.themeManager._updateScrollMapUv(s,a[t],e,t),e.style.endDefaultValues()}}}))}}class Qe extends ye{constructor(e){super(e)}onSetCamera(e){var t=e.path;if(t&&t[t.length-1].isRootObject)return super.onSetCamera(e);return null}filterObject(e){return e.parents.find("tags:or(Campus)")}}function Ye(){Qe.register(),be.register(),xe.register(),Me.register(),Ce.register(),we.register()}function Ze(e){var t=e.level,r=new ge(e);t.controls=r,t.setControlOption=(e,r)=>{console.warn("Please call 'app.level.controls.setControlOption()' instead"),t.controls.setControlOption(e,r)}}r(Qe,"levelCondition",".RootObject"),r(Qe,"levelName","root");var Xe=Object.freeze({__proto__:null,initLevelControl:Ze,registerDefaultControls:Ye});function Ke(e,t){var r=t.onComplete||t.complete;t.onComplete=t.complete=e=>{var t=e.objects;if(t){for(var s=[],n=0;n<t.length;n++){var o=t[n];o&&o.isCampus&&s.push(o)}e.campuses=s,e.campus=s[0]||null,r&&r(e)}else r&&r(e)}}class $e extends THING.MixLoader{onLoadModelScene(e,t){Ke(0,t),super.onLoadModelScene(e,t)}onLoadTSFScene(e,t){Ke(0,t),super.onLoadTSFScene(e,t)}}var et=[0,0],tt=[1,1],rt={textureType:"HTMLElement"};class st{constructor(e){this.app=e,this._textureResourceMap={},this._textureLoadingMap={},this._materialResourceMap={},this._materialLoadingMap={}}createMaterialResource(e,t,r){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},n=function(e){var t=e.map,r=e.uv;e.aoMap&&(t+="_"+e.aoMap);e.transparent&&(t+="_"+e.transparent);e.sideType&&(t+="_"+e.sideType);e.defineFloorAo&&(t+="_"+e.defineFloorAo);e.defineWallAo&&(t+="_"+e.defineWallAo);e.color&&(t+="_"+e.color);r&&(r.angle&&(t+="_"+r.angle),r.repeat&&(t+="_"+r.repeat[0]+"_"+r.repeat[1]),r.center&&(t+="_"+r.center[0]+"_"+r.center[1]),r.offset&&(t+="_"+r.offset[0]+"_"+r.offset[1]));return t+="_"+e.metalness,t+="_"+e.roughness,t}(e),o=this._materialResourceMap[n],a=this._materialLoadingMap[n];if(!o){var i=[],h=e.map&&this._createImageTextureResource(e.map,i),c=e.aoMap&&this._createImageTextureResource(e.aoMap,i),u=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.angle||0,r=e.center||et,s=e.repeat||tt,n=e.offset||et,o=THING.MathUtils.degToRad(t),a=Math.cos(o),i=Math.sin(o);return[s[0]*a,-s[1]*i,0,s[0]*i,s[1]*a,0,-s[0]*(a*r[0]+i*r[1])+r[0]+n[0]+l(),-s[1]*(-i*r[0]+a*r[1])+r[1]+n[1],1]}(e.uv);this._materialResourceMap[n]=o=THING.Utils.createObject("MaterialResource",{type:"Standard",map:h,aoMap:c,color:e.color,transparent:THING.Utils.parseBoolean(e.transparent,!1),side:e.sideType||THING.SideType.Front,uvMatrix:u,defineFloorAo:THING.Utils.parseBoolean(e.defineFloorAo,!1),defineWallAo:THING.Utils.parseBoolean(e.defineWallAo,!1),metalness:e.metalness,roughness:e.roughness,defineUsePickId:THING.Utils.parseBoolean(s.defineUsePickId,!1)}),a=this._materialLoadingMap[n]=new Promise(((e,t)=>{Promise.all(i).then((()=>{e(o)}),t)}))}return a.then(t,r),{material:o,promise:a}}_createImageTextureResource(e,t){var r=this._textureResourceMap[e],s=this._textureLoadingMap[e];if(!r){r=THING.Utils.createObject("ImageTextureResource",rt);var n=this.app.loadImageTexture(e);s=this._textureLoadingMap[e]=new Promise(((e,t)=>{n.waitForComplete().then((()=>{r.setImage(n.resource),r.setWrapS(THING.ImageWrapType.Repeat),r.setWrapT(THING.ImageWrapType.Repeat),e(r)}),t)})),this._textureResourceMap[e]=r}return t.push(s),r}dispose(){this._textureResourceMap={},this._textureLoadingMap={},this._materialResourceMap={},this._materialLoadingMap={}}}THING.App.addCompleteCallback((e=>{var t=new qe;t.app=e,e.registerBundleLoader("scene",t),e.resourcePool.registerLoader("mix",$e),i.parseBoolean(e.options.enableDefaultLevelControl,!0)&&!e.level.controls&&(Ye(),Ze(e)),e.on(THING.EventType.AppQuit,(()=>{i.disposeBlackEnvMap()}),"_Campus_External_"),e._materialResourceLoader=new st(e),null===THING.SceneExporter||void 0===THING.SceneExporter||THING.SceneExporter.registerResolver("MaterialResourceResolver",Ue)}),-2);var nt=Object.freeze({__proto__:null,Building:T,BuildingLevelControl:xe,Campus:g,CampusBundleLoader:qe,CampusLevelControl:be,Ceiling:G,CombinePlaneComponent:We,DefaultLevelControl:ye,Door:J,EmptyObject:oe,ExpandObjectsComponent:M,Facade:C,Floor:P,FloorLevelControl:Me,Ground:f,Group:ne,LevelControlOptions:Ie,MaterialResourceResolver:Ue,Misc:m,PlacementLevelControl:we,PlaneComponent:Be,Roof:A,Room:E,RoomLevelControl:Ce,RootLevelControl:Qe,Slab:z,Thing:se,VideoProbe:ae,Wall:Y,WallComponent:Le,Window:X});THING.Utils.registerClasses(nt,THING);void 0!==g&&(g.className="Campus"),void 0!==v&&(v.className="BaseParser"),void 0!==m&&(m.className="Misc"),void 0!==f&&(f.className="Ground"),void 0!==M&&(M.className="ExpandObjectsComponent"),void 0!==T&&(T.className="Building"),void 0!==C&&(C.className="Facade"),void 0!==J&&(J.className="Door"),void 0!==P&&(P.className="Floor"),void 0!==S&&(S.className="SpaceComponent"),void 0!==E&&(E.className="Room"),void 0!==R&&(R.className="MaterialResourceManager"),void 0!==N&&(N.className="PartialModelParser"),void 0!==O&&(O.className="PlaneTextureParser"),void 0!==L&&(L.className="PlaneParser"),void 0!==j&&(j.className="BasePlane"),void 0!==A&&(A.className="Roof"),void 0!==G&&(G.className="Ceiling"),void 0!==B&&(B.className="RoomParse"),void 0!==z&&(z.className="Slab"),void 0!==V&&(V.className="WallParser"),void 0!==Y&&(Y.className="Wall"),void 0!==Z&&(Z.className="WallExtend"),void 0!==X&&(X.className="Window"),void 0!==$&&($.className="InstanceParser"),void 0!==ee&&(ee.className="MaterialParser"),void 0!==ne&&(ne.className="Group"),void 0!==oe&&(oe.className="EmptyObject"),void 0!==ae&&(ae.className="VideoProbe"),void 0!==he&&(he.className="LevelControlHelper"),void 0!==ge&&(ge.className="LevelControls"),void 0!==ye&&(ye.className="DefaultLevelControl"),void 0!==be&&(be.className="CampusLevelControl"),void 0!==xe&&(xe.className="BuildingLevelControl"),void 0!==Me&&(Me.className="FloorLevelControl"),void 0!==Ce&&(Ce.className="RoomLevelControl"),void 0!==we&&(we.className="PlacementLevelControl"),void 0!==Le&&(Le.className="WallComponent"),void 0!==Ue&&(Ue.className="MaterialResourceResolver"),void 0!==je&&(je.className="MaterialResourceComponent"),void 0!==Be&&(Be.className="PlaneComponent"),void 0!==We&&(We.className="CombinePlaneComponent"),void 0!==qe&&(qe.className="CampusBundleLoader"),void 0!==Qe&&(Qe.className="RootLevelControl"),void 0!==$e&&($e.className="CampusMixLoader"),void 0!==st&&(st.className="MaterialResourceLoader");var ot=Object.freeze({__proto__:null,Building:T,BuildingLevelControl:xe,COMPILETIME:"Thu, 21 Aug 2025 09:35:41 GMT",Campus:g,CampusBundleLoader:qe,CampusLevelControl:be,Ceiling:G,CombinePlaneComponent:We,DefaultLevelControl:ye,Door:J,EmptyObject:oe,ExpandObjectsComponent:M,Facade:C,Floor:P,FloorLevelControl:Me,Ground:f,Group:ne,LevelControlOptions:Ie,LevelExternal:Xe,MaterialResourceResolver:Ue,Misc:m,PlacementLevelControl:we,PlaneComponent:Be,Roof:A,Room:E,RoomLevelControl:Ce,Slab:z,Thing:se,Utils:i,VERSION:"2.0.11",VideoProbe:ae,Wall:Y,WallComponent:Le,Window:X}),at=["Entity","Facade","Placement","RoomFloor","RoomRoof","RoomCeiling","BuildingElement","Ground","Dummy","Wall","Group","Misc","Slab","Roof","Ceiling","Window","Door"],it=0,lt=1,ht=2,ct=3,ut="https://model.3dmomoda.com/models/",pt="https://static.3dmomoda.com/textures/",dt="FacadeMain",gt="Ground",vt="Thing",mt="Tree",ft="Objects",yt="FloorFloor",bt="FloorRoof",_t="FloorCeiling",xt="FloorManualWall",Mt="Door",Tt={BC4ACD398A9640859A6B386E1BF9231D:{id:"BC4ACD398A9640859A6B386E1BF9231D",type:"Wall",size:[.8,2.999,.8],version:"5"},"25DFE916055244849463F89A03DA97CD":{id:"25DFE916055244849463F89A03DA97CD",type:"Wall",size:[.845,3.099,.849],version:"5"}},Ct={"3629A959F80C4D0EA31D1E26524735B8":{id:"3629A959F80C4D0EA31D1E26524735B8",type:"Placement",size:[8.1,9.60776,8.7],version:"7"},BB23ED379CFB4A0AB14BD124EC2995BE:{id:"BB23ED379CFB4A0AB14BD124EC2995BE",type:"Placement",size:[.64347,1.34912,.8],version:"7"},A7D96546FA744C38A949DFC6FEE43B6A:{id:"A7D96546FA744C38A949DFC6FEE43B6A",type:"Placement",size:[.6,1.1,.6],version:"7"},FA5766D2AA074128ABB5D4CA3FF45B36:{id:"FA5766D2AA074128ABB5D4CA3FF45B36",type:"Placement",size:[.4,.61599,.39999],version:"6"},"8EC4FF7178E64C538B215D69684E4F92":{id:"8EC4FF7178E64C538B215D69684E4F92",type:"Placement",size:[.4,.5,.4],version:"6"},"449c02c5e8f84a2aa32f58ed53aa24b9":{id:"449c02c5e8f84a2aa32f58ed53aa24b9",type:"Placement",size:[.23118,.5986,.24155],version:"1"},c26acc8a9f804d8da2f49aba46283ac3:{id:"c26acc8a9f804d8da2f49aba46283ac3",type:"Placement",size:[7.85544,7.80654,7.44832],version:"2"},"07b2d180e1ea42de98723fe147f6750a":{id:"07b2d180e1ea42de98723fe147f6750a",type:"Placement",size:[10.3207,9.84333,10.0598],version:"3"},"2c969242db5f4da58442182ccbda7471":{id:"2c969242db5f4da58442182ccbda7471",type:"Placement",size:[7.20139,25.1363,6.56474],version:"4"},D26DB25C34C94CAABF24FED40F1A9719:{id:"D26DB25C34C94CAABF24FED40F1A9719",type:"Placement",size:[8.24071,19.2,7.6],version:"6"},"ebafecf0-cc89-42dc-b847-0f841a31bdca":{id:"ebafecf0-cc89-42dc-b847-0f841a31bdca",type:"Placement",size:[4.94077,5.83847,4.78861],version:"9"},"4EF86FC4FFA44013AC4F45E8CD0D343F":{id:"4EF86FC4FFA44013AC4F45E8CD0D343F",type:"Placement",size:[5.66699,7.4,6.233],version:"6"},"9C27FD900C4443FBA1151C9DF767D19A":{id:"9C27FD900C4443FBA1151C9DF767D19A",type:"Placement",size:[7.50716,8.2,7.87936],version:"6"},"6b768c2d-3c2f-4954-a625-ef4b57f72a47":{id:"6b768c2d-3c2f-4954-a625-ef4b57f72a47",type:"Placement",size:[6.32989,7.49752,5.72546],version:"8"},"9fc66d5b-a213-4fc6-9fc6-f759aa88716a":{id:"9fc66d5b-a213-4fc6-9fc6-f759aa88716a",type:"Placement",size:[4.5,9.4,4.4],version:"4"},"963de658-70b6-49e7-bb0e-504ad603fe27":{id:"963de658-70b6-49e7-bb0e-504ad603fe27",type:"Placement",size:[1.4073,4.03187,1.37224],version:"5"},"d5b06cf7-2a31-4252-8d7c-02d48815ed18":{id:"d5b06cf7-2a31-4252-8d7c-02d48815ed18",type:"Placement",size:[7.3,7.4,6.1],version:"4"},"f9058709-ee84-41f6-8260-fbb734dc9483":{id:"f9058709-ee84-41f6-8260-fbb734dc9483",type:"Placement",size:[4.3,7.2,4],version:"4"},"be7d0bfc-ce60-4132-8a88-afd1301c82b3":{id:"be7d0bfc-ce60-4132-8a88-afd1301c82b3",type:"Placement",size:[4.41539,7.57112,4.49063],version:"5"},"95bd04fe237f42e0adeabb78028c8ee7":{id:"95bd04fe237f42e0adeabb78028c8ee7",type:"Placement",size:[4.41539,7.57112,4.49063],version:"1"},"1d2827ffd12b4ac1a2035fa81646a450":{id:"1d2827ffd12b4ac1a2035fa81646a450",type:"Placement",size:[12.63521,15.81749,13.21056],version:"3"}};function Jt(e,t,r,s,n,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(s,n)}function wt(e){return function(){var t=this,r=arguments;return new Promise((function(s,n){var o=e.apply(t,r);function a(e){Jt(o,s,n,a,i,"next",e)}function i(e){Jt(o,s,n,a,i,"throw",e)}a(void 0)}))}}function It(e){return It="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},It(e)}function Pt(e){var t=function(e,t){if("object"!==It(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var s=r.call(e,t||"default");if("object"!==It(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===It(t)?t:String(t)}function St(e,t,r){return(t=Pt(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Et{constructor(e){if(this._mode=3,this._bigVersion=null,this._smallVersion=null,this._version=e,e)if(isNaN(e)){var t=e.split(".");this._mode=parseInt(t[0]),t[1]&&(this._bigVersion=parseInt(t[1])),t[2]&&(this._smallVersion=parseInt(t[2]))}else this._mode=e}get versionText(){return this._version}get mode(){return this._mode}get bigVersion(){return this._bigVersion}get smallVersion(){return this._smallVersion}}class Rt extends THING.Utils{static vec3ApplyQuat(e,t,r){var s=e[0],n=e[1],o=e[2],a=t[0],i=t[1],l=t[2],h=t[3],c=h*s+i*o-l*n,u=h*n+l*s-a*o,p=h*o+a*n-i*s,d=-a*s-i*n-l*o;return void 0===r&&(r=[0,0,0]),r[0]=c*h+d*-a+u*-l-p*-i,r[1]=u*h+d*-i+p*-a-c*-l,r[2]=p*h+d*-l+c*-i-u*-a,r}static multiplyQuat(e,t){var r=e[0],s=e[1],n=e[2],o=e[3],a=t[0],i=t[1],l=t[2],h=t[3];return[r*h+o*a+s*l-n*i,s*h+o*i+n*a-r*l,n*h+o*l+r*i-s*a,o*h-r*a-s*i-n*l]}static saveDecimal(e,t){if("number"==typeof e)return o(e,t);if(e.length>0){for(var r=[],s=0;s<e.length;s++){var n=o(e[s],t);r.push(n)}return r}return e;function o(e,t){t=null==t?3:t;for(var r=1;t>0;r*=10,t--);for(;t<0;r/=10,t++);return Math.round(e*r)/r}}static floatEquals(e,t,r){if(void 0===e||void 0===t)return!1;if(void 0!==r&&0!=r||(r=.002),"number"==typeof e&&"number"==typeof t)return Math.abs(e-t)<=r;if(e.length>0&&t.length>0&&e.length==t.length){for(var s=0;s<e.length;s++){var n=e[s],o=t[s];if(Math.abs(n-o)>r)return!1}return!0}return!1}static parseModel(e,t,r,s){e.loadversion&&(t=new Et(e.loadversion));var n=1===t.bigVersion?lt:ht;e.url?n=ct:e.localurl||(n=it);var o=null;switch(n){case lt:o="https://www.thingjs.com/"+e.localurl;break;case ht:switch(s.bundleInfo={main:"index.json",type:"model"},o=r+e.localurl,delete e.version,delete e.resourceType,delete e.hasanimation,e.applyTransposeToMesh=!1,e.applyTransposeToVertices=!1,t.smallVersion){case 0:case 1:case 2:break;case 3:case 4:case 5:!0!==e.keeprootrotation&&(e.applyTransposeToMesh=!0);break;default:!0!==e.keeprootrotation&&(e.applyTransposeToVertices=!0)}delete e.keeprootrotation;break;case ct:o=e.url;break;default:o=e.id}e.url=o,delete e.id,delete e.localurl}static parseTexture(e,t){return{url:e.id+"."+e.ext,flipY:t||!1}}static versionControl(e,t){switch(e.bigVersion+"_"+e.smallVersion){case"0_0":case"0_1":case"1_0":case"1_1":return null}return Xt.getIdOnesPlaceNumber(t)}static getParseCorners(e,t,r,s){var n=Rt.versionControl(s,r);if(t.corners&&t.corners[0][2]){e.corners=JSON.parse(JSON.stringify(t.corners));for(var o=0;o<e.corners.length;o++)e.corners[o][2]*=-1,n&&Xt.decodeArray(0,e.corners[o],n,3)}}static getParseTransform(e,t,r,s){var n=Rt.versionControl(s,r);t.position&&(e.realPosition=[t.position[0],t.position[1],t.position[2]],e.realPosition[2]*=-1),t.rotation&&(e.realRotation=[t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]],e.realRotation[2]*=-1,e.realRotation[3]*=-1),t.scale&&(e.realScale=[t.scale[0],t.scale[1],t.scale[2]]),n&&(t.position&&Xt.decodeArray(0,e.realPosition,n,3),t.rotation&&Xt.decodeArray(0,e.realRotation,n,3),t.scale&&Xt.decodeArray(1,e.realScale,n,3))}static loadFile(e,t){t.url=e;var r=new Promise(((r,s)=>{fetch(e+"index.json").then((e=>e.text())).then((e=>{t.index=JSON.parse(e),r()})).catch((e=>{console.error(e),s()}))})),s=new Promise(((r,s)=>{fetch(e+"scene.json").then((e=>e.text())).then((e=>{t.scene=JSON.parse(e),r()})).catch((e=>{console.error(e),s()}))}));return Promise.all([r,s])}static getBaseUrl(e){var t=e+"/";return"/"!==e.charAt(e.length-1)&&"\\"!==e.slice(e.length-1,e.length-2)||(t=e),t}}for(var Nt=[],Ot=0;Ot<256;Ot++)Nt[Ot]=(Ot<16?"0":"")+Ot.toString(16);var Dt=1234567,Lt={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(Nt[255&e]+Nt[e>>8&255]+Nt[e>>16&255]+Nt[e>>24&255]+"-"+Nt[255&t]+Nt[t>>8&255]+"-"+Nt[t>>16&15|64]+Nt[t>>24&255]+"-"+Nt[63&r|128]+Nt[r>>8&255]+"-"+Nt[r>>16&255]+Nt[r>>24&255]+Nt[255&s]+Nt[s>>8&255]+Nt[s>>16&255]+Nt[s>>24&255]).toUpperCase()},clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,s,n){return s+(e-t)*(n-s)/(r-t)},lerp:function(e,t,r){return(1-r)*e+r*t},smoothstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*(3-2*e)},smootherstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){return void 0!==e&&(Dt=e%2147483647),((Dt=16807*Dt%2147483647)-1)/2147483646},degToRad:function(e){return e*Lt.DEG2RAD},radToDeg:function(e){return e*Lt.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,r,s,n){var o=Math.cos,a=Math.sin,i=o(r/2),l=a(r/2),h=o((t+s)/2),c=a((t+s)/2),u=o((t-s)/2),p=a((t-s)/2),d=o((s-t)/2),g=a((s-t)/2);switch(n){case"XYX":e.set(i*c,l*u,l*p,i*h);break;case"YZY":e.set(l*p,i*c,l*u,i*h);break;case"ZXZ":e.set(l*u,l*p,i*c,i*h);break;case"XZX":e.set(i*c,l*g,l*d,i*h);break;case"YXY":e.set(l*d,i*c,l*g,i*h);break;case"ZYZ":e.set(l*g,l*d,i*c,i*h);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+n)}}};class Ut{constructor(e,t,r,s){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===s&&(s=1),Object.defineProperty(this,"isQuaternion",{value:!0}),this._x=e,this._y=t,this._z=r,this._w=s}static slerp(e,t,r,s){return r.copy(e).slerp(t,s)}static slerpFlat(e,t,r,s,n,o,a){var i=r[s+0],l=r[s+1],h=r[s+2],c=r[s+3],u=n[o+0],p=n[o+1],d=n[o+2],g=n[o+3];if(c!==g||i!==u||l!==p||h!==d){var v=1-a,m=i*u+l*p+h*d+c*g,f=m>=0?1:-1,y=1-m*m;if(y>Number.EPSILON){var b=Math.sqrt(y),_=Math.atan2(b,m*f);v=Math.sin(v*_)/b,a=Math.sin(a*_)/b}var x=a*f;if(i=i*v+u*x,l=l*v+p*x,h=h*v+d*x,c=c*v+g*x,v===1-a){var M=1/Math.sqrt(i*i+l*l+h*h+c*c);i*=M,l*=M,h*=M,c*=M}}e[t]=i,e[t+1]=l,e[t+2]=h,e[t+3]=c}static multiplyQuaternionsFlat(e,t,r,s,n,o){var a=r[s],i=r[s+1],l=r[s+2],h=r[s+3],c=n[o],u=n[o+1],p=n[o+2],d=n[o+3];return e[t]=a*d+h*c+i*p-l*u,e[t+1]=i*d+h*u+l*c-a*p,e[t+2]=l*d+h*p+a*u-i*c,e[t+3]=h*d-a*c-i*u-l*p,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,r,s){return this._x=e,this._y=t,this._z=r,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=e._x,s=e._y,n=e._z,o=e._order,a=Math.cos,i=Math.sin,l=a(r/2),h=a(s/2),c=a(n/2),u=i(r/2),p=i(s/2),d=i(n/2);switch(o){case"XYZ":this._x=u*h*c+l*p*d,this._y=l*p*c-u*h*d,this._z=l*h*d+u*p*c,this._w=l*h*c-u*p*d;break;case"YXZ":this._x=u*h*c+l*p*d,this._y=l*p*c-u*h*d,this._z=l*h*d-u*p*c,this._w=l*h*c+u*p*d;break;case"ZXY":this._x=u*h*c-l*p*d,this._y=l*p*c+u*h*d,this._z=l*h*d+u*p*c,this._w=l*h*c-u*p*d;break;case"ZYX":this._x=u*h*c-l*p*d,this._y=l*p*c+u*h*d,this._z=l*h*d-u*p*c,this._w=l*h*c+u*p*d;break;case"YZX":this._x=u*h*c+l*p*d,this._y=l*p*c+u*h*d,this._z=l*h*d-u*p*c,this._w=l*h*c-u*p*d;break;case"XZY":this._x=u*h*c-l*p*d,this._y=l*p*c-u*h*d,this._z=l*h*d+u*p*c,this._w=l*h*c+u*p*d;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){var r=t/2,s=Math.sin(r);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(e){var t=e.elements,r=t[0],s=t[4],n=t[8],o=t[1],a=t[5],i=t[9],l=t[2],h=t[6],c=t[10],u=r+a+c;if(u>0){var p=.5/Math.sqrt(u+1);this._w=.25/p,this._x=(h-i)*p,this._y=(n-l)*p,this._z=(o-s)*p}else if(r>a&&r>c){var d=2*Math.sqrt(1+r-a-c);this._w=(h-i)/d,this._x=.25*d,this._y=(s+o)/d,this._z=(n+l)/d}else if(a>c){var g=2*Math.sqrt(1+a-r-c);this._w=(n-l)/g,this._x=(s+o)/g,this._y=.25*g,this._z=(i+h)/g}else{var v=2*Math.sqrt(1+c-r-a);this._w=(o-s)/v,this._x=(n+l)/v,this._y=(i+h)/v,this._z=.25*v}return this._onChangeCallback(),this}setFromUnitVectors(e,t){var r=e.dot(t)+1;return r<1e-6?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=r):(this._x=0,this._y=-e.z,this._z=e.y,this._w=r)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=r),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Lt.clamp(this.dot(e),-1,1)))}rotateTowards(e,t){var r=this.angleTo(e);if(0===r)return this;var s=Math.min(1,t/r);return this.slerp(e,s),this}identity(){return this.set(0,0,0,1)}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){var r=e._x,s=e._y,n=e._z,o=e._w,a=t._x,i=t._y,l=t._z,h=t._w;return this._x=r*h+o*a+s*l-n*i,this._y=s*h+o*i+n*a-r*l,this._z=n*h+o*l+r*i-s*a,this._w=o*h-r*a-s*i-n*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,s=this._y,n=this._z,o=this._w,a=o*e._w+r*e._x+s*e._y+n*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=o,this._x=r,this._y=s,this._z=n,this;var i=1-a*a;if(i<=Number.EPSILON){var l=1-t;return this._w=l*o+t*this._w,this._x=l*r+t*this._x,this._y=l*s+t*this._y,this._z=l*n+t*this._z,this.normalize(),this._onChangeCallback(),this}var h=Math.sqrt(i),c=Math.atan2(h,a),u=Math.sin((1-t)*c)/h,p=Math.sin(t*c)/h;return this._w=o*u+this._w*p,this._x=r*u+this._x*p,this._y=s*u+this._y*p,this._z=n*u+this._z*p,this._onChangeCallback(),this}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}class Ft{constructor(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),Object.defineProperty(this,"isVector3",{value:!0}),this.x=e,this.y=t,this.z=r}set(e,t,r){return void 0===r&&(r=this.z),this.x=e,this.y=t,this.z=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Ht.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Ht.setFromAxisAngle(e,t))}applyMatrix3(e){var t=this.x,r=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[3]*r+n[6]*s,this.y=n[1]*t+n[4]*r+n[7]*s,this.z=n[2]*t+n[5]*r+n[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){var t=this.x,r=this.y,s=this.z,n=e.elements,o=1/(n[3]*t+n[7]*r+n[11]*s+n[15]);return this.x=(n[0]*t+n[4]*r+n[8]*s+n[12])*o,this.y=(n[1]*t+n[5]*r+n[9]*s+n[13])*o,this.z=(n[2]*t+n[6]*r+n[10]*s+n[14])*o,this}applyQuaternion(e){var t=this.x,r=this.y,s=this.z,n=e.x,o=e.y,a=e.z,i=e.w,l=i*t+o*s-a*r,h=i*r+a*t-n*s,c=i*s+n*r-o*t,u=-n*t-o*r-a*s;return this.x=l*i+u*-n+h*-a-c*-o,this.y=h*i+u*-o+c*-n-l*-a,this.z=c*i+u*-a+l*-o-h*-n,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){var t=this.x,r=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[4]*r+n[8]*s,this.y=n[1]*t+n[5]*r+n[9]*s,this.z=n[2]*t+n[6]*r+n[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this}cross(e,t){return void 0!==t?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)}crossVectors(e,t){var r=e.x,s=e.y,n=e.z,o=t.x,a=t.y,i=t.z;return this.x=s*i-n*a,this.y=n*o-r*i,this.z=r*a-s*o,this}projectOnVector(e){var t=e.lengthSq();if(0===t)return this.set(0,0,0);var r=e.dot(this)/t;return this.copy(e).multiplyScalar(r)}projectOnPlane(e){return jt.copy(this).projectOnVector(e),this.sub(jt)}reflect(e){return this.sub(jt.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){var t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;var r=this.dot(e)/t;return Math.acos(Lt.clamp(r,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){var t=this.x-e.x,r=this.y-e.y,s=this.z-e.z;return t*t+r*r+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,r){var s=Math.sin(t)*e;return this.x=s*Math.sin(r),this.y=Math.cos(t)*e,this.z=s*Math.cos(r),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,r){return this.x=e*Math.sin(t),this.y=r,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){var t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){var t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t,r){return void 0!==r&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}var jt=new Ft,Ht=new Ut;class At{constructor(){Object.defineProperty(this,"isMatrix4",{value:!0}),this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(e,t,r,s,n,o,a,i,l,h,c,u,p,d,g,v){var m=this.elements;return m[0]=e,m[4]=t,m[8]=r,m[12]=s,m[1]=n,m[5]=o,m[9]=a,m[13]=i,m[2]=l,m[6]=h,m[10]=c,m[14]=u,m[3]=p,m[7]=d,m[11]=g,m[15]=v,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new At).fromArray(this.elements)}copy(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],this}copyPosition(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this}extractBasis(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this}extractRotation(e){var t=this.elements,r=e.elements,s=1/Gt.setFromMatrixColumn(e,0).length(),n=1/Gt.setFromMatrixColumn(e,1).length(),o=1/Gt.setFromMatrixColumn(e,2).length();return t[0]=r[0]*s,t[1]=r[1]*s,t[2]=r[2]*s,t[3]=0,t[4]=r[4]*n,t[5]=r[5]*n,t[6]=r[6]*n,t[7]=0,t[8]=r[8]*o,t[9]=r[9]*o,t[10]=r[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,r=e.x,s=e.y,n=e.z,o=Math.cos(r),a=Math.sin(r),i=Math.cos(s),l=Math.sin(s),h=Math.cos(n),c=Math.sin(n);if("XYZ"===e.order){var u=o*h,p=o*c,d=a*h,g=a*c;t[0]=i*h,t[4]=-i*c,t[8]=l,t[1]=p+d*l,t[5]=u-g*l,t[9]=-a*i,t[2]=g-u*l,t[6]=d+p*l,t[10]=o*i}else if("YXZ"===e.order){var v=i*h,m=i*c,f=l*h,y=l*c;t[0]=v+y*a,t[4]=f*a-m,t[8]=o*l,t[1]=o*c,t[5]=o*h,t[9]=-a,t[2]=m*a-f,t[6]=y+v*a,t[10]=o*i}else if("ZXY"===e.order){var b=i*h,_=i*c,x=l*h,M=l*c;t[0]=b-M*a,t[4]=-o*c,t[8]=x+_*a,t[1]=_+x*a,t[5]=o*h,t[9]=M-b*a,t[2]=-o*l,t[6]=a,t[10]=o*i}else if("ZYX"===e.order){var T=o*h,C=o*c,J=a*h,w=a*c;t[0]=i*h,t[4]=J*l-C,t[8]=T*l+w,t[1]=i*c,t[5]=w*l+T,t[9]=C*l-J,t[2]=-l,t[6]=a*i,t[10]=o*i}else if("YZX"===e.order){var I=o*i,P=o*l,S=a*i,E=a*l;t[0]=i*h,t[4]=E-I*c,t[8]=S*c+P,t[1]=c,t[5]=o*h,t[9]=-a*h,t[2]=-l*h,t[6]=P*c+S,t[10]=I-E*c}else if("XZY"===e.order){var R=o*i,N=o*l,O=a*i,D=a*l;t[0]=i*h,t[4]=-c,t[8]=l*h,t[1]=R*c+D,t[5]=o*h,t[9]=N*c-O,t[2]=O*c-N,t[6]=a*h,t[10]=D*c+R}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(kt,e,zt)}lookAt(e,t,r){var s=this.elements;return qt.subVectors(e,t),0===qt.lengthSq()&&(qt.z=1),qt.normalize(),Vt.crossVectors(r,qt),0===Vt.lengthSq()&&(1===Math.abs(r.z)?qt.x+=1e-4:qt.z+=1e-4,qt.normalize(),Vt.crossVectors(r,qt)),Vt.normalize(),Wt.crossVectors(qt,Vt),s[0]=Vt.x,s[4]=Wt.x,s[8]=qt.x,s[1]=Vt.y,s[5]=Wt.y,s[9]=qt.y,s[2]=Vt.z,s[6]=Wt.z,s[10]=qt.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){var r=e.elements,s=t.elements,n=this.elements,o=r[0],a=r[4],i=r[8],l=r[12],h=r[1],c=r[5],u=r[9],p=r[13],d=r[2],g=r[6],v=r[10],m=r[14],f=r[3],y=r[7],b=r[11],_=r[15],x=s[0],M=s[4],T=s[8],C=s[12],J=s[1],w=s[5],I=s[9],P=s[13],S=s[2],E=s[6],R=s[10],N=s[14],O=s[3],D=s[7],L=s[11],U=s[15];return n[0]=o*x+a*J+i*S+l*O,n[4]=o*M+a*w+i*E+l*D,n[8]=o*T+a*I+i*R+l*L,n[12]=o*C+a*P+i*N+l*U,n[1]=h*x+c*J+u*S+p*O,n[5]=h*M+c*w+u*E+p*D,n[9]=h*T+c*I+u*R+p*L,n[13]=h*C+c*P+u*N+p*U,n[2]=d*x+g*J+v*S+m*O,n[6]=d*M+g*w+v*E+m*D,n[10]=d*T+g*I+v*R+m*L,n[14]=d*C+g*P+v*N+m*U,n[3]=f*x+y*J+b*S+_*O,n[7]=f*M+y*w+b*E+_*D,n[11]=f*T+y*I+b*R+_*L,n[15]=f*C+y*P+b*N+_*U,this}multiplyScalar(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){var e=this.elements,t=e[0],r=e[4],s=e[8],n=e[12],o=e[1],a=e[5],i=e[9],l=e[13],h=e[2],c=e[6],u=e[10],p=e[14];return e[3]*(+n*i*c-s*l*c-n*a*u+r*l*u+s*a*p-r*i*p)+e[7]*(+t*i*p-t*l*u+n*o*u-s*o*p+s*l*h-n*i*h)+e[11]*(+t*l*c-t*a*p-n*o*c+r*o*p+n*a*h-r*l*h)+e[15]*(-s*a*h-t*i*c+t*a*u+s*o*c-r*o*u+r*i*h)}transpose(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(e,t,r){var s=this.elements;return e.isVector3?(s[12]=e.x,s[13]=e.y,s[14]=e.z):(s[12]=e,s[13]=t,s[14]=r),this}getInverse(e,t){void 0!==t&&console.warn("THREE.Matrix4: .getInverse() can no longer be configured to throw on degenerate.");var r=this.elements,s=e.elements,n=s[0],o=s[1],a=s[2],i=s[3],l=s[4],h=s[5],c=s[6],u=s[7],p=s[8],d=s[9],g=s[10],v=s[11],m=s[12],f=s[13],y=s[14],b=s[15],_=d*y*u-f*g*u+f*c*v-h*y*v-d*c*b+h*g*b,x=m*g*u-p*y*u-m*c*v+l*y*v+p*c*b-l*g*b,M=p*f*u-m*d*u+m*h*v-l*f*v-p*h*b+l*d*b,T=m*d*c-p*f*c-m*h*g+l*f*g+p*h*y-l*d*y,C=n*_+o*x+a*M+i*T;if(0===C)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var J=1/C;return r[0]=_*J,r[1]=(f*g*i-d*y*i-f*a*v+o*y*v+d*a*b-o*g*b)*J,r[2]=(h*y*i-f*c*i+f*a*u-o*y*u-h*a*b+o*c*b)*J,r[3]=(d*c*i-h*g*i-d*a*u+o*g*u+h*a*v-o*c*v)*J,r[4]=x*J,r[5]=(p*y*i-m*g*i+m*a*v-n*y*v-p*a*b+n*g*b)*J,r[6]=(m*c*i-l*y*i-m*a*u+n*y*u+l*a*b-n*c*b)*J,r[7]=(l*g*i-p*c*i+p*a*u-n*g*u-l*a*v+n*c*v)*J,r[8]=M*J,r[9]=(m*d*i-p*f*i-m*o*v+n*f*v+p*o*b-n*d*b)*J,r[10]=(l*f*i-m*h*i+m*o*u-n*f*u-l*o*b+n*h*b)*J,r[11]=(p*h*i-l*d*i-p*o*u+n*d*u+l*o*v-n*h*v)*J,r[12]=T*J,r[13]=(p*f*a-m*d*a+m*o*g-n*f*g-p*o*y+n*d*y)*J,r[14]=(m*h*a-l*f*a-m*o*c+n*f*c+l*o*y-n*h*y)*J,r[15]=(l*d*a-p*h*a+p*o*c-n*d*c-l*o*g+n*h*g)*J,this}scale(e){var t=this.elements,r=e.x,s=e.y,n=e.z;return t[0]*=r,t[4]*=s,t[8]*=n,t[1]*=r,t[5]*=s,t[9]*=n,t[2]*=r,t[6]*=s,t[10]*=n,t[3]*=r,t[7]*=s,t[11]*=n,this}getMaxScaleOnAxis(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],s=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,s))}makeTranslation(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this}makeRotationX(e){var t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this}makeRotationY(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this}makeRotationZ(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){var r=Math.cos(t),s=Math.sin(t),n=1-r,o=e.x,a=e.y,i=e.z,l=n*o,h=n*a;return this.set(l*o+r,l*a-s*i,l*i+s*a,0,l*a+s*i,h*a+r,h*i-s*o,0,l*i-s*a,h*i+s*o,n*i*i+r,0,0,0,0,1),this}makeScale(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this}makeShear(e,t,r){return this.set(1,t,r,0,e,1,r,0,e,t,1,0,0,0,0,1),this}compose(e,t,r){var s=this.elements,n=t._x,o=t._y,a=t._z,i=t._w,l=n+n,h=o+o,c=a+a,u=n*l,p=n*h,d=n*c,g=o*h,v=o*c,m=a*c,f=i*l,y=i*h,b=i*c,_=r.x,x=r.y,M=r.z;return s[0]=(1-(g+m))*_,s[1]=(p+b)*_,s[2]=(d-y)*_,s[3]=0,s[4]=(p-b)*x,s[5]=(1-(u+m))*x,s[6]=(v+f)*x,s[7]=0,s[8]=(d+y)*M,s[9]=(v-f)*M,s[10]=(1-(u+g))*M,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,r){var s=this.elements,n=Gt.set(s[0],s[1],s[2]).length(),o=Gt.set(s[4],s[5],s[6]).length(),a=Gt.set(s[8],s[9],s[10]).length();this.determinant()<0&&(n=-n),e.x=s[12],e.y=s[13],e.z=s[14],Bt.copy(this);var i=1/n,l=1/o,h=1/a;return Bt.elements[0]*=i,Bt.elements[1]*=i,Bt.elements[2]*=i,Bt.elements[4]*=l,Bt.elements[5]*=l,Bt.elements[6]*=l,Bt.elements[8]*=h,Bt.elements[9]*=h,Bt.elements[10]*=h,t.setFromRotationMatrix(Bt),r.x=n,r.y=o,r.z=a,this}makePerspective(e,t,r,s,n,o){void 0===o&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var a=this.elements,i=2*n/(t-e),l=2*n/(r-s),h=(t+e)/(t-e),c=(r+s)/(r-s),u=-(o+n)/(o-n),p=-2*o*n/(o-n);return a[0]=i,a[4]=0,a[8]=h,a[12]=0,a[1]=0,a[5]=l,a[9]=c,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=p,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(e,t,r,s,n,o){var a=this.elements,i=1/(t-e),l=1/(r-s),h=1/(o-n),c=(t+e)*i,u=(r+s)*l,p=(o+n)*h;return a[0]=2*i,a[4]=0,a[8]=0,a[12]=-c,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*h,a[14]=-p,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(e){for(var t=this.elements,r=e.elements,s=0;s<16;s++)if(t[s]!==r[s])return!1;return!0}fromArray(e,t){void 0===t&&(t=0);for(var r=0;r<16;r++)this.elements[r]=e[r+t];return this}toArray(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}for(var Gt=new Ft,Bt=new At,kt=new Ft(0,0,0),zt=new Ft(1,1,1),Vt=new Ft,Wt=new Ft,qt=new Ft,Qt=[],Yt=0;Yt<256;Yt++)Qt[Yt]=(Yt<16?"0":"")+Yt.toString(16).toUpperCase();class Zt{static pointInsidePolygon(e,t){var r,s,n,o,a=0;for(e.push(e[0]),r=0;r<e.length-1;r++)n=e[r],o=e[r+1],t[0]>Math.min(n[0],o[0])&&t[0]<=Math.max(n[0],o[0])&&t[1]<=Math.max(n[1],o[1])&&n[0]!=o[0]&&(s=(t[0]-n[0])*(o[1]-n[1])/(o[0]-n[0])+n[1],(n[1]==o[1]||t[1]<=s)&&a++);return!!a%2}static processPosition(e){return e&&e.length>2?[Rt.saveDecimal(e[0],3),Rt.saveDecimal(e[1],3),Rt.saveDecimal(e[2],3)]:[0,0,0]}static processAngles(e){if(e&&e.length>2&&(0!=e[0]||0!=e[1]||0!=e[2])){var t=THING.Utils.parseQuaternion(e).toArray();return[Rt.saveDecimal(t[0],8),Rt.saveDecimal(t[1],8),Rt.saveDecimal(t[2],8),Rt.saveDecimal(t[3],8)]}return null}static processQuaternion(e){var t=new Ut(e[0],e[1],e[2],e[3]);if(Zt.getDecimalLength(e[0])<=7||Zt.getDecimalLength(e[1])<=7||Zt.getDecimalLength(e[2])<=7||Zt.getDecimalLength(e[3])<=7){var r=new At;r.compose(new Ft(0,0,0),t,new Ft(1,1,1)),r.decompose(new Ft,t,new Ft)}return THING.MathUtils.getAnglesFromQuat([t.x,t.y,t.z,t.w])}static processScale(e){return e&&e.length>2&&(1!=e[0]||1!=e[1]||1!=e[2])?[Rt.saveDecimal(e[0],3),Rt.saveDecimal(e[1],3),Rt.saveDecimal(e[2],3)]:null}static addResourceToArray(e,t){for(var r=0;r<e.length;r++){if(e[r].url==t.url)return r}return e.push(t)-1}static addTextureToArray(e,t){for(var r=0;r<e.length;r++){var s=e[r];if(s.url==t.url&&s.flipY===t.flipY)return r}return e.push(t)-1}static addStringToArray(e,t){for(var r=0;r<e.length;r++){if(e[r]==t)return r}return e.push(t)-1}static getIdOnesPlaceNumber(e){var t=-1,r=Number(e);if(isNaN(r)){if(t=0,Zt.isUUID(e)){var s=e.slice(e.length-2);if(s){var n=parseInt(s,16);isNaN(n)||(t=n)}}}else"number"==typeof e&&(e+=""),t=(r=parseInt(e.substring(e.length-1)))%10;return 1^t}static decodeArray(e,t,r,s){if(void 0===s&&(s=3),t)for(var n=0;n<s;n++){var o=t[n];Zt.isTwoDoublesEqual(e,o)||(t[n]=Zt.decodeNumber(o,r))}return t}static encodeArray(e,t,r,s){if(void 0===s&&(s=3),t)for(var n=0;n<s;n++){var o=t[n];Zt.isTwoDoublesEqual(e,o)||(t[n]=Zt.encodeNumber(o,r))}return t}static decodeNumber(e,t){return e>0?e-t:e+t}static encodeNumber(e,t){return e>0?e+t:e-t}static isUUID(e){var t=""+e;return null!==(t=t.match("^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"))}static isTwoDoublesEqual(e,t){return e===t}static getDecimalLength(e){if(e){var t=e.toString().split(".")[1];if(t)return t.length}return 0}static isDefaultVector3(e,t){return void 0===t&&(t=0),e&&e.length>2&&e[0]===t&&e[1]===t&&e[2]===t}static isDefaultQuat(e){return e&&e.length>3&&0===e[0]&&0===e[1]&&0===e[2]&&1===e[3]}static generateUUID(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return Qt[255&e]+Qt[e>>8&255]+Qt[e>>16&255]+Qt[e>>24&255]+"-"+Qt[255&t]+Qt[t>>8&255]+"-"+Qt[t>>16&15|64]+Qt[t>>24&255]+"-"+Qt[63&r|128]+Qt[r>>8&255]+"-"+Qt[r>>16&255]+Qt[r>>24&255]+Qt[255&s]+Qt[s>>8&255]+Qt[s>>16&255]+Qt[s>>24&255]}}var Xt=Zt,Kt=Symbol("private"),$t=[0,0],er=[1,1],tr={textureType:"HTMLElement"};class rr extends THING.BaseResolver{constructor(e){void 0===e&&(e={}),super(e);var t=this[Kt]={},r=e.data;t.styles=r&&r.styles||[],t.textureResourceMap={},t.textureLoadingMap={},t.materialResources=[],t.materialLoadings=[],t.stylesMap={},t.spliceUniqueKey=function(e){var t=e.map,r=e.uv;return e.aoMap&&(t+="_"+e.aoMap),e.transparent&&(t+="_"+e.transparent),e.sideType&&(t+="_"+e.sideType),e.defineFloorAo&&(t+="_"+e.defineFloorAo),e.defineWallAo&&(t+="_"+e.defineWallAo),e.color&&(t+="_"+e.color),r&&(r.angle&&(t+="_"+r.angle),r.repeat&&(t+="_"+r.repeat[0]+"_"+r.repeat[1]),r.center&&(t+="_"+r.center[0]+"_"+r.center[1]),r.offset&&(t+="_"+r.offset[0]+"_"+r.offset[1])),t+="_"+e.metalness,t+="_"+e.roughness},t.getUvMatrix=function(e){void 0===e&&(e={});var t=e.angle||0,r=e.center||$t,s=e.repeat||er,n=e.offset||$t,o=THING.MathUtils.degToRad(t),a=Math.cos(o),i=Math.sin(o);return[s[0]*a,-s[1]*i,0,s[0]*i,s[1]*a,0,-s[0]*(a*r[0]+i*r[1])+r[0]+n[0],-s[1]*(-i*r[0]+a*r[1])+r[1]+n[1],1]},t.createMaterialResourceByIndex=function(e,r,s,n){void 0===n&&(n={});var o=t.materialResources[e],a=t.materialLoadings[e];if(!o){var i=t.styles[e],l=[],h=i.map&&t.createImageTextureResource(i.map,l),c=i.aoMap&&t.createImageTextureResource(i.aoMap,l),u=t.getUvMatrix(i.uv);t.materialResources[e]=o=Rt.createObject("MaterialResource",{type:"Standard",map:h,aoMap:c,color:i.color,transparent:Rt.parseBoolean(i.transparent,!1),side:i.sideType||THING.SideType.Front,uvMatrix:u,defineFloorAo:Rt.parseBoolean(i.defineFloorAo,!1),defineWallAo:Rt.parseBoolean(i.defineWallAo,!1),metalness:i.metalness,roughness:i.roughness,defineUsePickId:Rt.parseBoolean(n.defineUsePickId,!1)}),a=t.materialLoadings[e]=Promise.all(l)}return a.then(r,s),o},t.createImageTextureResource=(e,r)=>{var s=t.textureResourceMap[e],n=t.textureLoadingMap[e];if(!s){s=Rt.createObject("ImageTextureResource",tr);var o=this.app.loadImageTexture(e);n=t.textureLoadingMap[e]=new Promise(((e,t)=>{o.waitForComplete().then((()=>{s.setImage(o.resource),s.setWrapS(THING.ImageWrapType.Repeat),s.setWrapT(THING.ImageWrapType.Repeat),e(s)}),t)})),t.textureResourceMap[e]=s}return r.push(n),s},t.addData=function(e){var r=t.spliceUniqueKey(e),s=t.stylesMap[r];return Rt.isNull(s)&&(s=t.styles.push(e)-1,t.stylesMap[r]=s),s}}getData(){return{styles:this[Kt].styles}}getMaterialResourceDataByIndex(e){return this[Kt].styles[e]}createMaterialResourceByIndex(e,t,r){return this[Kt].createMaterialResourceByIndex(e,t,r)}setMaterialResourceData(e){return this[Kt].addData(e)}}class sr{constructor(e){void 0===e&&(e={}),this.app=e.app,this.baseUrl=e.url}parse(e,t){e?(this.parseCamera(e.camera,t),!1!==t.useDefaultRenderSettings&&(this.parseEffectConfig(e.effectConfig),e.skybox&&this.parseSkybox(e.skybox),e.skyBox&&this.parseSkyBox(e.skyBox))):this.setMainLightRefresh(t)}parseLight(e,t){if(e&&e.light&&!1!==t.useDefaultRenderSettings){var r=e.light,s=r.ambientLight;s&&Object.assign(this.app.scene.ambientLight,s);var n=r.mainLight;if(n){var o=this.app.scene.mainLight;void 0!==n.shadow&&(o.castShadow=n.shadow),void 0!==n.intensity&&(o.intensity=n.intensity),void 0!==n.color&&(o.color=n.color);var a=o.adapter;void 0!==n.beta&&(a.horzAngle=n.beta),void 0!==n.alpha&&(a.vertAngle=n.alpha)}var i=r.secondaryLight;if(i&&i.intensity>0){var l=app.queryByName("secondaryLight").objects[0];l||(l=new THING.DirectionalLight({parent:this.app.root,name:"secondaryLight"})),void 0!==i.shadow&&(l.castShadow=i.shadow),void 0!==i.intensity&&(l.intensity=i.intensity),i.color&&(l.color=i.color);var h=l.adapter;void 0!==i.beta&&(h.horzAngle=i.beta),void 0!==i.alpha&&(h.vertAngle=i.alpha)}var c=r.hemisphereLight;if(c&&c.intensity>0){var u=app.query(".HemisphereLight").objects[0];u||(u=new THING.HemisphereLight({parent:this.app.root,name:"hemisphereLight"})),u.intensity=c.intensity,u.color=c.color,u.groundColor=c.groundColor}}else this.setMainLightRefresh(t)}setMainLightRefresh(e){Rt.parseBoolean(e.refreshShadow,!0)&&(this.app.scene.mainLight.adapter.needRefresh=!0)}parseEffectConfig(e){if(e){var t=this.app.camera.postEffect;for(var r in e)if("vignette"===r){var s=e[r];if(s&&s.enable){s.enable=!1;var n=s.type;"blur"===n?(t.blurEdge.enable=!0,t.blurEdge.offset=s.offset):"color"===n&&(t.vignetting.enable=!0,t.vignetting.offset=s.offset,t.vignetting.color=s.color)}}else t[r]||(t[r]={}),Object.assign(t[r],e[r])}}parseCamera(e,t){if(!1!==t.enableCameraParse&&e){var r=this.app.camera;if(e.fov&&(r.fov=e.fov),e.far&&(r.far=e.far),e.xAngleLimitRange){var s=[90-e.xAngleLimitRange[0],90-e.xAngleLimitRange[1]];r.vertAngleLimit=s}e.distanceLimited&&(r.distanceLimited=e.distanceLimited)}}parseSkybox(e){e&&!this.app.options.background&&(this.app.background=new THING.CubeTexture({url:sr.parseCubeTextureUrls(this.baseUrl,e)}))}parseSkyBox(e){this.app.options.background||(this.app.background=new THING.CubeTexture({url:{negx:this.baseUrl._appendPath(e[1]),negy:this.baseUrl._appendPath(e[3]),negz:this.baseUrl._appendPath(e[5]),posx:this.baseUrl._appendPath(e[0]),posy:this.baseUrl._appendPath(e[2]),posz:this.baseUrl._appendPath(e[4])}}))}static parseCubeTextureUrls(e,t){return{negx:e._appendPath(t.lf),negy:e._appendPath(t.dn),negz:e._appendPath(t.bk),posx:e._appendPath(t.rt),posy:e._appendPath(t.up),posz:e._appendPath(t.fr)}}static parseEnvTextureUrls(e,t){return t instanceof Array?{negx:e._appendPath(t[0]),negy:e._appendPath(t[3]),negz:e._appendPath(t[4]),posx:e._appendPath(t[1]),posy:e._appendPath(t[2]),posz:e._appendPath(t[5])}:{negx:e._appendPath(t.rt),negy:e._appendPath(t.dn),negz:e._appendPath(t.fr),posx:e._appendPath(t.lf),posy:e._appendPath(t.up),posz:e._appendPath(t.bk)}}}function nr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}class or{constructor(e){this.app=e.app,this.combineRoom=e.combineRoom,this.onParsePreviewHide=e.onParsePreviewHide,this.baseLocalUrl=e.baseLocalUrl._appendURL("/"),this.resourceLibraryUrl=e.resourceLibraryUrl||"",this.resourceLibraryModelsUrl=this.resourceLibraryUrl?this.resourceLibraryUrl._appendURL("/model")+"/":"",this.resourceLibraryTextureUrl=this.resourceLibraryUrl?this.resourceLibraryUrl._appendURL("/texture")+"/":"",this.importModels=e.models||[],this.importTextures=e.textures||[],this.exportModels=[],this.exportTextures=[],this.exportUuids=[],this.modelUseCount=[],this.exportInstanceCount=[],this.instancePlanes=new Map,this.matrixDataMap=new Map,this.renderOrderData={},this.matrixNode=null,this.cubeTextures=[];var t=e.thingjsconfig;t&&(t.environment&&(this.outerEnvMap=sr.parseEnvTextureUrls(e.baseLocalUrl,t.environment||t.env),this.cubeTextures.push(this.outerEnvMap),this.outerEnvMapIndex=0),5===e.version.mode&&t.environmentInside&&(this.innerEnvMap=sr.parseEnvTextureUrls(e.baseLocalUrl,t.environmentInside),this.cubeTextures.push(this.innerEnvMap),this.innerEnvMapIndex=this.cubeTextures.length-1)),this.materialResourceResolver=new rr({app:this.app}),this.setWallLightMap(e.wallMaterial)}setWallLightMap(e){e?e.straightmanualwall&&e.straightmanualwall.lightingtexture&&(this.wallLightMap=e.straightmanualwall.lightingtexture,this.useDefaultWallLightMap=!1):(this.wallLightMap={id:"18091219l1g1hnjt",ext:"png"},this.useDefaultWallLightMap=!0),this.wallLightMapIndex=this.addTexture(Rt.parseTexture(this.wallLightMap,!1))}getMatrixData(e,t){return new Promise(((r,s)=>{var n=null;switch(t){case 0:case 1:case 2:break;case 3:case 4:case 5:n="InverseRotationToMesh";break;default:n="InverseRotationToVertices"}this.app.resourceManager.loadModel(this.baseLocalUrl+e.localurl,(t=>{this.matrixDataMap.set(e.id,t.node.getSubNodesMatrixInfo()),this.renderOrderData=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?nr(Object(r),!0).forEach((function(t){St(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):nr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},this.renderOrderData,t.node.getSubNodesRenderOrderInfo()),this.matrixNode=t.node,r()}),void 0,void 0,{lights:!0,inverseRotationMode:n})}))}getTransform(e,t){if(null==e)return null;var r=this.getModelByIndex(e);if(!r)return null;var s=this.matrixDataMap.get(r.id);if(!s)return null;var n=s[t];if(!n)return null;var o=[],a=[],i=[];return THING.MathUtils.decomposeFromMat4(n,o,a,i),{position:o,quaternion:a,scale:i}}getRenderOrder(e){return this.renderOrderData[e]}addInstancePlanes(e){this.instancePlanes.has(e)?this.instancePlanes.get(e).value++:this.instancePlanes.set(e,{value:1,instanceCountIndex:null})}getInstancePlanes(e){return this.exportInstanceCount.push(Array(e))-1}getModelByIndex(e){var t=this.importModels[e];return t.id?t:null}getModelById(e){for(var t=0;t<this.importModels.length;t++)if(e===this.importModels[t].id)return this.importModels[t];return null}getTextureByIndex(e){var t=this.importTextures[e];return t||null}getTextureById(e){for(var t=0;t<this.importTextures.length;t++)if(e===this.importTextures[t].id)return this.importTextures[t];return null}addModel(e){return Xt.addResourceToArray(this.exportModels,e)}addModelUseCount(e){this.modelUseCount[e]?this.modelUseCount[e]++:this.modelUseCount[e]=1}getInstance(e){for(var t=0;t<this.exportInstanceCount.length;t++){if(e===this.exportInstanceCount[t][0])return this.exportInstanceCount[t].push(e),t}return this.exportInstanceCount[this.exportInstanceCount.length]=[e],this.exportInstanceCount.length-1}addTexture(e){return Xt.addTextureToArray(this.exportTextures,e)}addUUID(e){return this.exportUuids.push(e)-1}}class ar{constructor(e){this.param=e,this.version=e.version,this.app=e.app,this.combineRoom=e.combineRoom,this.onParsePreviewHide=null,this.onOverrideConverter=null,this.resourceLibraryUrl="",this._versionMap={},this._smallVersionLibs=[],this._bigVersions=[]}import(e){return this.resourceManager=new or({app:this.app,version:this.version,combineRoom:this.combineRoom,onParsePreviewHide:this.onParsePreviewHide,baseLocalUrl:e.url,resourceLibraryUrl:this.resourceLibraryUrl,models:e.scene.models,textures:e.scene.textures,wallMaterial:e.scene.materialsetting,thingjsconfig:e.scene.thingjsconfig}),new Promise(((t,r)=>{if(e.scene&&e.scene.models){for(var s=[],n=0;n<e.scene.models.length;n++){var o=e.scene.models[n];if(!0!==o.keeprootrotation)if(5===this.version.mode)s.push(this.resourceManager.getMatrixData(o,this.version.smallVersion));else if(7===this.version.mode&&o.loadversion){var a=new Et(o.loadversion);5===a.mode&&o.localurl&&s.push(this.resourceManager.getMatrixData(o,a.smallVersion))}}window.promises=s,Promise.all(s).then((()=>{t()}))}else t()}))}_getCreatorConfig(e,t){if(null==e){var r=this._smallVersionLibs[this._bigVersions.length-1];return t=r[r.length-1],this._versionMap[this._bigVersions.length-1][t]}if(null==t){var s=this._smallVersionLibs[e];return t=s[s.length-1],this._versionMap[e][t]}var n=this._smallVersionLibs[e];if(!(e>this._bigVersions[this._bigVersions.length-1])){var o=n[n.length-1];return t>o||!this._versionMap[e][t]?this._versionMap[e][o]:this._versionMap[e][t]}console.error("ubuilderLoader not support version "+e+"."+t)}_currentDate(e){var t=new Date,r=" ",s="/",n=":",o=t.getMonth()+1,a=t.getDate();return e&&(r=s=n=e),o>=1&&o<=9&&(o="0"+o),a>=0&&a<=9&&(a="0"+a),t.getFullYear()+s+o+s+a+r+t.getHours()+n+t.getMinutes()+n+t.getSeconds()}}class ir{static getStyleTag(e){var t=e.originalType,r=null;switch(t){case"Facade":r=dt;break;case"Placement":r=ir.placementStyleTag(e);break;case"Window":case"Door":r=ir.doorOrWindowStyleTag(e);break;case"VideoProbe":r=vt;break;case"Room":r=ir.roomStyleTag(e);break;case"RoomSlab":r=yt;break;case"RoomRoof":r=bt;break;case"RoomCeiling":r=_t;break;case"CombineWall":case"PlacementWall":r="Outdoors"===e.parent.originalType?gt:xt;break;default:-1!==t.indexOf("Combine")&&(r=ir.combinedStyleTag(e,t))}return r}static placementStyleTag(e){var t=e.baseModel.url;return ir.isTree(t)?mt:ir.isWall(t)?"Outdoors"===(e.parent.isMisc?e.parent.parent:e.parent).originalType?gt:xt:e.parent.isMisc?ft:vt}static doorOrWindowStyleTag(e){return e.originalJson.iswindow?"Outdoors"===e.parent.originalType?ft:vt:"Outdoors"===e.parent.originalType?ft:Mt}static roomStyleTag(e){if(!e.isFloorRoom)return gt}static combinedStyleTag(e,t){var r=ft;switch(t){case"CombineFloor":r=yt;break;case"CombineCeiling":r=_t;break;case"CombineRoof":r=bt;break;case"CombinePlacement":if(e.baseModel){var s=e.baseModel.id;if(ir.isTree(s))r=mt;else if(ir.isWall(s)){r="Outdoors"===(e.parent.isMisc?e.parent.parent:e.parent).originalType?gt:xt}r=ft}}return r}static isWall(e){return!!e&&!!Tt[e]}static isTree(e){return!!e&&!!Ct[e]}}class lr{constructor(e,t,r){void 0===e&&(e={}),this.options=e,this.resourceManager=e.resourceManager,this.creatorMap=e.creatorMap,this.parent=r,this.originalJson=t,this.children=[],this.baseModel={},this.convertJson={external:{material:{}},userData:{},body:{},style:{uv:{}},children:[]},!1===t.visible&&(this.convertJson.visible=!1)}_parseChildren(){}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{r=r||this,!1===this.originalJson.visible&&(e.visible=!1);var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}convert(e){return this._convertSelf(e),this._convertChildren(e),this._cutEmptyJson(),this.convertJson}_convertStyleTag(){var e=this.originalJson.properties;e||(e=this.originalJson.properties={}),e._styleTag_||(e._styleTag_=ir.getStyleTag(this)),e._styleTag_||delete e._styleTag_,this.originalJson.properties&&(this.convertJson.userData=this.originalJson.properties)}_convertSelf(e){this._convertStyleTag(),e&&!1===e.queryable&&(this.convertJson.queryable=!1),this.convertJson.type=this.thing2Type,this.originalJson.id&&(this.convertJson.uuid=this.resourceManager.addUUID(this.originalJson.id)),this.originalJson.userid&&(this.convertJson.id=this.originalJson.userid),this.originalJson.name?this.convertJson.name=this.originalJson.name:this.convertJson.name=this.originalJson.userid,this._convertTags(),this._convertTransform(),this._convertCamInfo()}_convertTags(){}_convertTransform(){}_convertCamInfo(){var e,t,r=!1;if(this.originalJson.caminfo&&(e=this.originalJson.caminfo.eye,t=this.originalJson.caminfo.target),this.originalJson.camInfo&&(e=o(this.originalJson.camInfo.eye),t=o(this.originalJson.camInfo.target),r=!0),e&&t){var s=this._getWorldPosition(),n={position:[e[0]-s[0],e[1]-s[1],-e[2]-s[2]],target:[t[0]-s[0],t[1]-s[1],-t[2]-s[2]]};this.convertJson.components=[{name:"level",type:"LevelComponent",external:{viewpoint:n}}],r&&(this.resourceManager.viewpoint=n)}function o(e,t){t=e.split(" ");for(var r=0;r<t.length;r++)t[r]=parseFloat(t[r]);return t}}_getWorldPosition(){return[0,0,0]}_to2DPoints(e,t){return void 0===t&&(t=!1),e.map((e=>{var r,s,n=t?(r=e,s=this.realPosition,[r[0]-s[0],r[1]-s[1],r[2]-s[2]]):e;return[n[0],n[2]]}))}_to2DHoles(e,t){return void 0===t&&(t=!1),e.map((e=>this._to2DPoints(e,t)))}_convertChildren(e){var t=[];this.children.forEach((r=>{t.push(r.convert(e))})),t.length&&this.convertJson.children.push(...t)}_cutEmptyJson(){this.convertJson.external&&!Object.keys(this.convertJson.external.corners||{}).length&&delete this.convertJson.external.corners,this.convertJson.external&&!Object.keys(this.convertJson.external.material||{}).length&&delete this.convertJson.external.material,Object.keys(this.convertJson.external||{}).length||delete this.convertJson.external,Object.keys(this.convertJson.userData||{}).length||delete this.convertJson.userData,Object.keys(this.convertJson.body||{}).length||delete this.convertJson.body,this.convertJson.style&&!Object.keys(this.convertJson.style.uv||{}).length&&delete this.convertJson.style.uv,Object.keys(this.convertJson.style||{}).length||delete this.convertJson.style,Object.keys(this.convertJson.body||{}).length||delete this.convertJson.body,this.convertJson.children&&!this.convertJson.children.length&&delete this.convertJson.children}_isShouldCombine(e){return!!(t(e.originalJson.userid)&&t(e.originalJson.name)&&t(e.originalJson.isshow)&&(t(e.originalJson.properties)||!t(e.originalJson.properties._styleTag_)&&1===Object.keys(e.originalJson.properties).length));function t(e){return null==e}}addCorners(e){for(var t=0;t<this.originalJson.corners.length;t++){var r=this.originalJson.corners[t];if(Rt.floatEquals(r,e))return t}return this.originalJson.corners.push(e)-1}}class hr{static getPlaneOriginalOffset(e,t,r){void 0===t&&(t=[1,1]),void 0===r&&(r=0);var s=hr.getCenter(e),n=[1/(t[0]||1e4),1/(t[1]||1e4)],o=-r,a=hr.setUVMatrix({offset:[-s[0],s[1]],repeat:[1,1],center:[0,0],rotation:0}),i=hr.setUVMatrix({offset:[0,0],repeat:n,center:[0,0],rotation:0}),l=hr.setUVMatrix({offset:[-.5,-.5],repeat:[1,1],center:[0,0],rotation:0}),h=hr.setUVMatrix({offset:[0,0],repeat:[1,1],center:[0,0],rotation:o}),c=hr.setUVMatrix({offset:[.5,.5],repeat:[1,1],center:[0,0],rotation:0}),u=THING.Math.mat3.multiply([],i,a);return u=THING.Math.mat3.multiply([],l,u),u=THING.Math.mat3.multiply([],h,u),u=THING.Math.mat3.multiply([],c,u),hr.parseUVMatrix(u,n,o)}static getPlaneRealOffset(e,t,r,s){void 0===t&&(t=[1,1]),void 0===r&&(r=0),void 0===s&&(s=[0,0]);var n=hr.getShapeCenter(e),o=[1/t[0],1/t[1]],a=-r,i=s,l=hr.setUVMatrix({offset:[-n[0]-i[0],- -n[1]-i[1]],repeat:[1,1],center:[0,0],rotation:0}),h=hr.setUVMatrix({offset:[0,0],repeat:o,center:[0,0],rotation:0}),c=hr.setUVMatrix({offset:[0,0],repeat:[1,1],center:[0,0],rotation:a}),u=THING.Math.mat3.multiply([],c,l);return u=THING.Math.mat3.multiply([],h,u),hr.parseUVMatrix(u,o,a)}static getBlockOffsetConvert(e,t,r){if(void 0===t&&(t=[1,1]),void 0===r&&(r=0),0===t[0]&&0===t[1])return[0,0];var s=[1/(t[0]||1e4),1/(t[1]||1e4)],n=-r,o=hr.setUVMatrix(hr.getPlaneOriginalOffset(e,t,r)),a=hr.setUVMatrix({offset:[0,0],repeat:s,center:[0,0],rotation:0}),i=THING.Math.mat3.invert([],a),l=hr.setUVMatrix({offset:[0,0],repeat:[1,1],center:[0,0],rotation:n}),h=THING.Math.mat3.invert([],l),c=THING.Math.mat3.multiply([],i,o);c=THING.Math.mat3.multiply([],h,c);var u=hr.getShapeCenter(e),p=[-u[0],- -u[1]],d=hr.parseUVMatrix(c).offset;return[-(d[0]-p[0]),-(d[1]-p[1])]}static setUVMatrix(e){var t=e.offset,r=e.repeat,s=e.center,n=THING.MathUtils.degToRad(e.rotation),o=Math.cos(n),a=Math.sin(n);return[r[0]*o,-r[1]*a,0,r[0]*a,r[1]*o,0,-r[0]*(o*s[0]+a*s[1])+s[0]+t[0],-r[1]*(-a*s[0]+o*s[1])+s[1]+t[1],1]}static parseUVMatrix(e,t,r){void 0===t&&(t=[1,1]),void 0===r&&(r=0);var s=Math.cos(r),n=Math.sin(r),o=[0,0],a=[0,0];return a[0]=e[6]-(-t[1]*(s*o[0]+n*o[1])+o[0]),a[1]=e[7]-(-t[0]*(-n*o[0]+s*o[1])+o[1]),{center:o,offset:a,repeat:t,rotation:r}}static getShapeCenter(e){var t=[0,0];if(e&&e.length>0){for(var r=e[0].slice(),s=e[0].slice(),n=1;n<e.length;n++)r[0]=Math.max(e[n][0],r[0]),r[2]=Math.max(e[n][2],r[2]),s[0]=Math.min(e[n][0],s[0]),s[2]=Math.min(e[n][2],s[2]);return t=[(r[0]+s[0])/2,(r[2]+s[2])/2]}return t}static getCenter(e){for(var t=[0,0],r=0;r<e.length;r++){var s=e[r];t[0]+=s[0],t[1]+=s[2]}return t[0]/=e.length,t[1]/=e.length,t}static getYAngle(e,t){var r=e[0]*t[0]+e[2]*t[2],s=e[0]*t[2]-e[2]*t[0],n=THING.Math.atan2(s,r),o=THING.Math.radToDeg(n);return o<0&&(o+=360),(THING.Math.equalsNumber(o,0)||THING.Math.equalsNumber(o,360))&&(o=0),o}}class cr extends lr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.version=e.version,this._parseSelf(),e.noCreateChildren||this._parseChildren()}_parseSelf(){this._parseDecodeNumber(),Rt.getParseTransform(this,this.originalJson,this.decodeNumber,this.version)}_parseDecodeNumber(){this.decodeNumber=this.originalJson.id}_convertSelf(e){if(super._convertSelf(e),"number"==typeof this.originalJson.texture){var t=this._convertTextureByType(this.originalJson.texture,this);"number"==typeof t&&(this.convertJson.style.map=t)}if("number"==typeof this.convertJson.body.id){var r=this.resourceManager.getModelByIndex(this.originalJson.model);if(this.resourceManager.modelUseCount[r.id]>1&&this.enableInstance){this.convertJson.external.instance=this.resourceManager.getInstance(r.id),this.convertJson.external.instanceId=1e4+this.convertJson.external.instance,this.convertJson.external.instanceCount=this.resourceManager.modelUseCount[r.id];var s=Object.keys(this.convertJson.style||{}).length;s&&(1!==s||Object.keys(this.convertJson.style.uv||{}).length)&&(this.convertJson.external.instanceStyle=this.convertJson.style,delete this.convertJson.style)}}}_convertTexture(e,t){void 0===t&&(t=!1);var r={};return Object.assign(r,this.resourceManager.getTextureByIndex(e)),Object.keys(r).length?this.resourceManager.addTexture(Rt.parseTexture(r,t)):null}_convertTransform(){this.realPosition&&(this.convertJson.position=this.realPosition),this.realScale&&(this.convertJson.scale=this.realScale),this.parent&&this.parent.useInverseRotation&&(this.convertJson.quaternion=[-this.parent.useInverseRotation[0],-this.parent.useInverseRotation[1],-this.parent.useInverseRotation[2],this.parent.useInverseRotation[3]],this.convertJson.position=Rt.vec3ApplyQuat(this.convertJson.position,this.convertJson.quaternion)),this.realRotation&&(this.convertJson.quaternion?this.convertJson.quaternion=Rt.multiplyQuat(this.realRotation,this.convertJson.quaternion):this.convertJson.quaternion=this.realRotation)}_convertTextureByType(e,t){return"Placement"===t.originalType?this._convertTexture(e):this._convertTexture(e,!0)}get thing2Type(){}_convertPlane(e){var t="custom",r={materialResource:{}};if(!this.isRoom){var s=this.resourceManager.instancePlanes.get(this.instanceString);(null==s?void 0:s.value)>1&&("number"!=typeof s.instanceCountIndex&&(s.instanceCountIndex=this.resourceManager.getInstancePlanes(s.value)),r.instanceGroupName=this.instanceString)}r.materialResource.sideType=this.sideType,r.materialResource.defineFloorAo=this.defineFloorAo,this.isRoom&&!this.isFloorRoom&&(r.materialResource.sideType="Double",r.materialResource.defineFloorAo=!0),!1===this.originalJson["isshow"+e]&&(r.alwaysHide=!0,this.convertJson.layerMask=0);var n=null;"number"==typeof this.originalJson[e+t+"texture"]?(n=this.resourceManager.getTextureByIndex(this.originalJson[e+t+"texture"]))&&(r.materialResource.map=(this.resourceManager.resourceLibraryTextureUrl||pt)+(n.texture||n.id)+"."+n.ext,n.color&&(r.materialResource.color=n.color)):(n=this.resourceManager.getTextureByIndex(this.originalJson[e+"texture"]))&&(r.materialResource.map=(this.resourceManager.resourceLibraryTextureUrl||pt)+n.id+"."+n.ext);var o=this.isRoom?this:this.parent,a=[];o.convertJson.external.points.forEach((e=>{a.push([e[0],0,e[1]])}));var i,l="roof"===e?[2,2]:[.6,.6],h=this.originalJson[e+"blocksize"]||l,c=this.originalJson[e+"blockangle"]||0;i=this.version.smallVersion<7?hr.getBlockOffsetConvert(a,h,c):this.originalJson[e+"blockoffset"]||[0,0];var u=hr.getPlaneRealOffset(a,h,c,i);r.uv=u,r.materialResource=this.resourceManager.materialResourceResolver.setMaterialResourceData(r.materialResource),this.convertJson.components=[{name:"PlaneComponent",type:"PlaneComponent",params:r}]}}let ur=class extends cr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.misc=this.misc||null,this.rooms=this.rooms||[],this.combinePlanes=new Map,this.parent&&this.parent.hideStruct&&(this.convertJson.visible=!1)}get thing2Type(){return"Floor"}get originalType(){return"Floorplan"}get isFloor(){return!0}_convertSelf(e){super._convertSelf(e),this.isFloor&&(this.convertJson.external.constantShowThings=!!this.originalJson.alwaysshowinsideobjs),this.corners.length&&(this.convertJson.external.corners=this.corners),this.convertJson.external.height=Rt.parseNumber(this.originalJson.height,3)}_getWorldPosition(){if(this.isFloor){return e=this.convertJson.position,t=this.parent.convertJson.position,[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}var e,t;return[0,0,0]}_parseSelf(){super._parseSelf(),Rt.getParseCorners(this,this.originalJson,this.decodeNumber,this.version),this.originalJson.corners||(this.corners=[])}_parseChildren(){var e=this.originalJson.walls;if(e){var t=[],r=[],s=[];if(e.forEach((e=>{0===e.type?r.push(e):1===e.type?t.push(e):2===e.type&&s.push(e)})),t.length){var n=new this.creatorMap.wall(this.options,{},this,"ModelWall");this.children.push(n),this._generateChildrenCreators(t,"modelWall",n)}if(r.length){var o=new this.creatorMap.wall(this.options,{},this,"TextureWall");this.children.push(o),this._generateChildrenCreators(r,"textureWall",o)}this._generateChildrenCreators(s,"placementWall")}this._generateChildrenCreators(this.originalJson.curvelines,"curveLine"),this._generateChildrenCreators(this.originalJson.routelines,"routeLine"),this._generateChildrenCreators(this.originalJson.leakwaterlines,"leakWaterLine"),this._generateChildrenCreators(this.originalJson.arrowlines,"arrowLine"),this._generateChildrenCreators(this.originalJson.arrowdatalines,"arrowDataLine"),this._generateChildrenCreators(this.originalJson.pipelines,"pipeLine"),this._generateChildrenCreators(this.originalJson.grounds,"ground"),this._generateChildrenCreators(this.originalJson.generalpolygonlines,"generalPolygonLine"),this._generateChildrenCreators(this.originalJson.generalroutelines,"generalRouteLine"),this.rooms=this._generateChildrenCreators(this.originalJson.rooms,"room"),this.__generateChildrenCreators(this.originalJson.placements,"placement"),this.__generateChildrenCreators(this.originalJson.videoprobes,"placement"),this.__generateChildrenCreators(this.originalJson.groups,"group")}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!0===this.parent.hideStruct?e.visible=!1:this.isFloor&&!this.originalJson.alwaysshowinsideobjs&&("room"===t||t.includes("Wall")||(e.visible=!1)),r&&r.isWall&&!1===e.visible&&(r.convertJson.visible=!1),r=r||this;var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}__generateChildrenCreators(e,t,r){void 0===r&&(r=this),e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{if((!0===this.parent.hideStruct||this.isFloor&&!this.originalJson.alwaysshowinsideobjs)&&(e.visible=!1),e.properties&&"Ground"===e.properties._tjsType_){var s=new this.creatorMap[t](this.options,e,this);this.children.push(s)}else{var n=r,o=!this.resourceManager.onParsePreviewHide||this.resourceManager.onParsePreviewHide(e),a=!1===e.isshow&&!0===o?"emptyObject":t,i=new this.creatorMap[a](this.options,e,this);if(this._isShouldCombine(i))this.misc||(this.misc=new this.creatorMap.misc(this.options,{visible:e.visible},r),r.children.push(this.misc)),n=this.misc;else if(this.isFloor&&i.originalJson._temp_belongroom)for(var l=0;l<this.rooms.length;l++){var h=this.rooms[l];if(h.originalJson.userid&&h.originalJson.userid===i.originalJson._temp_belongroom){i.realPosition&&(i.realPosition=[i.realPosition[0]-h.realPosition[0],i.realPosition[1]-h.realPosition[1],i.realPosition[2]-h.realPosition[2]]),n=h;break}}i.parent=n,n.children.push(i),n=r}})))}_convertChildren(e){var t=[],r=[];this.children.forEach((s=>{var n=s.convert(e);s.isRoom&&s.combineRoom?r.push(n):t.push(n)})),t.length&&this.convertJson.children.push(...t),this._convertCombinePlanes(r)}_convertCombinePlanes(e){var t=[];e.forEach((e=>{e.children.forEach((r=>{if(0!==r.layerMask){var s=this._getCombinePlaneKey(r);r.components[0].params.points=Rt.cloneObject(e.external.points,!1),e.external.holes&&(r.components[0].params.holes=Rt.cloneObject(e.external.holes,!1)),this._makeCombinePlane(t,s,r)}}))})),this._setCombinePlaneData(t)}_getCombinePlaneKey(e){var t=e.components[0].params.materialResource,r=this.resourceManager.materialResourceResolver.getData().styles[t],s="";return s+="_"+this.convertJson.uuid,s+="_"+r.sideType,s+="_"+r.map,r.color&&(s+="_"+r.color),s}_makeCombinePlane(e,t,r){var s=this.combinePlanes;s.has(t)||(s.set(t,[]),e.push(t)),s.get(t).push(r)}_setCombinePlaneData(e){e.forEach((e=>{var t,r,s,n=this.combinePlanes.get(e),o={type:"Object3D",tags:[6],position:[0,n[0].position[1],0],components:[{name:"CombinePlaneComponent",type:"CombinePlaneComponent",external:{planes:n,materialResource:n[0].components[0].params.materialResource}}]};null!=(t=n[0].tags)&&t.includes(3)?o.tags.push(12):null!=(r=n[0].tags)&&r.includes(4)?o.tags.push(13):null!=(s=n[0].tags)&&s.includes(5)&&o.tags.push(14),this.convertJson.children.push(o)}))}};class pr extends cr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.doororwindows=this.doororwindows||[]}_convertTags(){this.parent.isFloor&&(this.convertJson.tags=[6])}_parseChildren(){this.doororwindows=this.__generateChildrenCreators(this.originalJson.doororwindows,"doororwindow",this.parent.parent)}__generateChildrenCreators(e,t,r){var s=[];if(e){this.convertJson.holes=[];var n=this.parent.parent.corners[this.originalJson.corners[0]],o=this.parent.parent.corners[this.originalJson.corners[1]];Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible&&(e.visible=!1),r=r||this;var l=new this.creatorMap[t](this.options,e,r);r.children.push(l),s.push(l);var h,c,u,p=l.realPosition,d=i(n,p),g=i(n,o);this.convertJson.holes.push({loc:[d/g,l.originalJson.suspendpercent||0],size:a(l.baseModel.size,l.realScale)}),l.originalJson.suspendpercent&&this.convertJson.height&&(l.realPosition=[l.realPosition[0],l.realPosition[1]+this.convertJson.height*l.originalJson.suspendpercent,l.realPosition[2]]),l.realRotation=(h=[o[0]-n[0],o[1]-n[1],o[2]-n[2]],c=new Ft(...h).normalize(),(u=new Ut).setFromUnitVectors(new Ft(1,0,0),c),u.toArray())}))}function a(e,t,r){return t=t||[1,1,1],(r=r||[])[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r}function i(e,t){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])+(e[2]-t[2])*(e[2]-t[2]))}return s}_convertSelf(e){super._convertSelf(e),this.parent&&!1===this.parent.convertJson.visible&&delete this.convertJson.visible,!1===this.originalJson.isshow&&(this.convertJson.visible=!1),this._convertPoint()}_convertPoint(){var e=this.parent.parent;if(this.originalJson.corners){var t=e.corners[this.originalJson.corners[0]],r=e.corners[this.originalJson.corners[1]];this.convertJson.points=[t[0],t[2],r[0],r[2]]}}}let dr=class extends cr{get thing2Type(){return"Entity"}get originalType(){return"Placement"}_convertTags(){this.convertJson.tags=[2]}_parseSelf(){super._parseSelf(),this._convertModel()}_convertSelf(e){void 0===e&&(e={}),super._convertSelf(e),this._convertCustomType(e)}_convertCustomType(e){var t=this.originalJson.type;t&&(this.convertJson.type=t),!0===e.removeAnimation&&this.convertJson.external&&(this.convertJson.external.animInfo=null)}_convertModel(){if("number"==typeof this.originalJson.model){var e=this.resourceManager.getModelByIndex(this.originalJson.model);if(e){if("number"==typeof e.texture){var t=this._convertTextureByType(e.texture,this);"number"==typeof t&&(this.convertJson.style.map=t)}e.color&&(this.convertJson.style.color=[e.color[0],e.color[1],e.color[2]]);var r=e.rendermode;r&&1!==r&&(this.convertJson.style.opacity=1,this.convertJson.style.transparent=!0),e.color&&"number"==typeof e.color[3]&&(this.convertJson.style.opacity=e.color[3],this.convertJson.style.transparent=!0),"number"==typeof e.opacity&&(this.convertJson.style.opacity=e.opacity);var s=this.baseModel={};if(Object.assign(s,e.model?this.resourceManager.getModelById(e.model):e),this.originalJson.animinfo&&this.originalJson.animinfo.isplay){var n=this.originalJson.animinfo.clip;this.convertJson.external.animInfo={name:n},"_defaultAnim_"===n&&(this.convertJson.external.animInfo.loopType="Repeat"),delete s.hasanimation}Rt.parseModel(s,this.version,this.resourceManager.baseLocalUrl,this.convertJson),delete s.type,this.convertJson.body.id=this.resourceManager.addModel(s),this.addModelUseCount(e)}}}addModelUseCount(e){this.originalJson.animinfo&&this.originalJson.animinfo.clip.length&&this.originalJson.animinfo.isplay||this.realScale&&!(this.realScale[0]>0&&this.realScale[1]>0&&this.realScale[2]>0)||(this.resourceManager.addModelUseCount(e.id),this.enableInstance=!0)}_getWorldPosition(){var e=[0,0,0],t=function t(r){if(e=i(e,r.convertJson.position),r.parent.isGroup)return t(r.parent);return r}(this);if(t.parent.isWorld||t.parent.isOutdoor||t.parent.isMisc&&t.parent.parent.isWorld)return e;if(t.parent.isFloor){var r=i(e,t.parent.convertJson.position);return i(r,t.parent.parent.convertJson.position)}if(t.parent.isRoom){var s=i(e,t.parent.convertJson.position),n=i(s,t.parent.parent.convertJson.position);return i(n,t.parent.parent.parent.convertJson.position)}if(t.parent.isBuilding){var o=i(e,t.parent.convertJson.position);return i(o,t.parent.parent.convertJson.position)}var a=i(e,t.parent.parent.convertJson.position);return i(a,t.parent.parent.parent.convertJson.position);function i(e,t){return t||(t=[0,0,0]),[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}}};class gr extends cr{_convertSelf(e){super._convertSelf(e),this.originalJson.color&&(this.convertJson.style.color=[this.originalJson.color[0],this.originalJson.color[1],this.originalJson.color[2]]),!1===this.originalJson.isshow&&(this.convertJson.layerMask=0),this.convertJson.external.selfPoints=this.originalJson.path;for(var t=0;t<this.convertJson.external.selfPoints.length;t++)this.convertJson.external.selfPoints[t][2]*=-1;if(this.originalJson.pointuserids&&this.originalJson.pointproperteis){for(var r=[],s=0;s<this.originalJson.pointuserids.length;s++)r[s]={},r[s].id=this.originalJson.pointuserids[s],r[s].userData=this.originalJson.pointproperteis[s];this.convertJson.userData._NODEPROPERTY_=r}this.convertJson.external.cornerRadius=Rt.parseNumber(this.originalJson.bevelRadius,.3)}}let vr=class extends gr{get thing2Type(){return"RouteLine"}get originalType(){return"CurveLine"}_convertSelf(e){super._convertSelf(e);var t=this.convertJson.external.width=this.originalJson.width||2*parseFloat(this.originalJson.radius),r=[1,-t];this.originalJson.textiling&&(r=[this.originalJson.textiling[0],-t*this.originalJson.textiling[1]]),this.originalJson.blocksize&&(r=[t/this.originalJson.blocksize[0],-t/this.originalJson.blocksize[1]]),this.convertJson.style.uv.repeat=r;var s=[0,0];this.originalJson.texoffset&&(s=[this.originalJson.texoffset[0]*r[0]/t,this.originalJson.texoffset[1]*r[1]/t]),this.originalJson.blockoffset&&(s=[this.originalJson.blockoffset[0]*r[0]/t,this.originalJson.blockoffset[1]*r[1]/t]),this.convertJson.style.uv.offset=s;var n=90;this.originalJson.blockangle&&(n+=this.originalJson.blockangle),this.convertJson.style.uv.rotation=n;var o=[0,1];this.originalJson.matanimdirection&&(o=this.originalJson.matanimdirection);var a=-this.originalJson.matanimspeed||-1;this.originalJson.enableanim&&(this.convertJson.external.uvScroll=!0,this.convertJson.external.uvScrollSpeed=[-o[0]*a,-o[1]*a])}},mr=class extends gr{get thing2Type(){return"PolygonLine"}get originalType(){return"PipeLine"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.radius=parseFloat(this.originalJson.radius),"Square"===this.originalJson.sectiontype?(this.convertJson.external.radialSegments=4,this.convertJson.external.startDegree=45):"Triangle"===this.originalJson.sectiontype?this.convertJson.external.radialSegments=3:this.convertJson.external.radialSegments=8,this.convertJson.style.color=this.convertJson.style.color||[0,0,1];var t=2*this.convertJson.external.radius,r=[1,1],s=1.1*t*2*Math.PI/(this.originalJson.textiling?this.originalJson.textiling[0]:1);r=[s,-s],this.originalJson.blocksize&&(r=[t/this.originalJson.blocksize[0],-t/this.originalJson.blocksize[1]]),this.convertJson.style.uv.repeat=r;var n=[0,0];this.originalJson.texoffset&&(n=[this.originalJson.texoffset[0]*r[0]/t,this.originalJson.texoffset[1]*r[1]/t]),this.originalJson.blockoffset&&(n=[this.originalJson.blockoffset[0]*r[0]/t,this.originalJson.blockoffset[1]*r[1]/t]),this.convertJson.style.uv.offset=n;var o=0;this.originalJson.blockangle&&(o+=this.originalJson.blockangle),this.convertJson.style.uv.rotation=o;var a=[1,0];this.originalJson.matanimdirection&&(a=this.originalJson.matanimdirection);var i=this.originalJson.matanimspeed||1;this.originalJson.enableanim&&(this.convertJson.external.uvScroll=!0,this.convertJson.external.uvScrollSpeed=[a[0]*i,a[1]*i])}},fr=class extends mr{get originalType(){return"LeakWaterLine"}},yr=class extends vr{get originalType(){return"ArrowLine"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.arrow=!0}};class br extends lr{get thing2Type(){return"Object3D"}get isMisc(){return!0}_convertTags(){this.convertJson.tags=[11]}_convertSelf(e){this.convertJson={children:[]},!1===this.originalJson.visible&&(this.convertJson.visible=!1),this.convertJson.type=this.thing2Type,this._convertTags()}_convertChildren(e){void 0===e&&(e={}),e.queryable=!1,e.removeAnimation=!0,super._convertChildren(e)}}class _r extends lr{constructor(e,t,r,s){super({},t,r),this.wallType=s,this.resourceManager=this.parent.resourceManager}get thing2Type(){return"Object3D"}get originalType(){return"CombineWall"}get isWall(){return!0}_convertSelf(e){this._convertStyleTag(),this._convertTags(),this.convertJson.components=[{params:{type:this.wallType,walls:[]},name:"wallComponent",type:"WallComponent"}],this.convertJson.renderOrder=-9,this.convertJson.type=this.thing2Type}_convertTags(){this.convertJson.tags=[6,9]}_convertChildren(e){var t=this,r=this.convertJson.components[0].params.walls;this.children.forEach((s=>{var n=s.convert(e);"TextureWall"===t.wallType&&t._convertWallMaterial(n),r.push(n)})),this.convertJson.components[0].params.walls=r}_convertWallMaterial(e){var t,r=this.resourceManager,s=r.materialResourceResolver,n=e.uvrepeat;t=this.getWallMaterialResource(r.getTextureByIndex(e.lefttexture),n),e.leftMaterial=s.setMaterialResourceData(t),t=this.getWallMaterialResource(r.getTextureByIndex(e.righttexture),n),e.rightMaterial=s.setMaterialResourceData(t),t=this.getWallMaterialResource(r.getTextureByIndex(e.edgetexture),n),e.edgeMaterial=s.setMaterialResourceData(t),delete e.lefttexture,delete e.righttexture,delete e.edgetexture,delete e.uvrepeat}getWallMaterialResource(e,t){var r=this.resourceManager,s={color:[1,1,1],metalness:.5,roughness:.5,map:(r.resourceLibraryTextureUrl||pt)+e.id+"."+e.ext,uv:{repeat:[t[0],t[1]]}};return e.isDefault?(s.aoMap=(r.resourceLibraryTextureUrl||pt)+r.wallLightMap.id+"."+r.wallLightMap.ext,s.uv.repeat=[1,1],r.useDefaultWallLightMap&&(s.metalness=.2,s.roughness=.8,s.defineWallAo=!0)):(s.metalness=0,s.roughness=1),s}}class xr extends cr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.combineRoom=r.combineRoom,this._addInstancePlanes()}get sideType(){return"Double"}get defineFloorAo(){return!1}get typeKey(){return""}_parseSelf(){}_convertTags(){this.convertJson.tags=[6]}_addInstancePlanes(){if(!1!==this.originalJson.isshow&&!this.combineRoom){var e=this.typeKey,t=this.parent.convertJson.external.points;if(this.parent.convertJson.external.holes)for(var r=0;r<this.parent.convertJson.external.holes.length;r++)t=t.concat(this.parent.convertJson.external.holes[r]);var s=e;if(s+=t.length,s+=this.sideType,s+=this.originalJson[e+"texture"],s+=this.originalJson[e+"blockangle"],s+=this.originalJson[e+"blocksize"],"number"==typeof this.originalJson[e+"customtexture"]){var n=this.resourceManager.getTextureByIndex(this.originalJson[e+"customtexture"]);n&&n.color&&(s+=n.color)}for(var o=0;o<t.length;o++){for(var a=t[o],i="",l=0;l<2;l++)i+=a[l].toFixed(3);s+=i}this.instanceString=s,this.resourceManager.addInstancePlanes(s)}}_convertSelf(e){super._convertSelf(e)}}var Mr={world:class extends cr{get thing2Type(){return"Campus"}get originalType(){return"World"}get isWorld(){return!0}_parseChildren(){this._generateChildrenCreators(this.originalJson.buildings,"building"),this._generateChildrenCreators(this.originalJson.outdoors,"outdoors")}},building:class extends cr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.facades=this.facades||[],this.facadegroups=this.facadegroups||[]}get thing2Type(){return"Building"}get originalType(){return"Building"}get isBuilding(){return!0}get hideStruct(){if(this.originalJson.structshow)return!1;var e=this.originalJson.facades||[],t=this.originalJson.facadegroups||[];return!(!e.length&&!t.length)}_parseChildren(){this.facades=this._generateChildrenCreators(this.originalJson.facades,"facade"),this.facadegroups=this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}_convertSelf(e){super._convertSelf(e),this.hideStruct||(this.convertJson.external.constantShowStruct=!0)}_getWorldPosition(){return this.convertJson.position}},floorplan:ur,modelWall:class extends pr{get thing2Type(){return"PrefabWall"}get originalType(){return"ModelWall"}_parseSelf(){super._parseSelf(),void 0===this.originalJson.height||null===this.originalJson.height?this.convertJson.height=3:this.convertJson.height=this.originalJson.height}_convertSelf(e){if(super._convertSelf(e),this.convertJson.thickness=this.originalJson.thick||.25,"number"==typeof this.originalJson.model){var t=this.resourceManager.getModelByIndex(this.originalJson.model);if("C9FB3F9A29C842F79F02CECC4037FEA1"===t.id&&(this.convertJson.fillHole=!0),t){var r={};Object.assign(r,t),Rt.parseModel(r,this.version,this.resourceManager.baseLocalUrl,this.convertJson),delete r.type,this.convertJson.model=this.resourceManager.addModel(r),this.convertJson.modelSize=r.size}}}},textureWall:class extends pr{get thing2Type(){return"StraightManualWall"}get originalType(){return"TextureWall"}_parseSelf(){super._parseSelf(),void 0===this.originalJson.height||null===this.originalJson.height?this.convertJson.height=3:this.convertJson.height=this.originalJson.height}_convertSelf(e){super._convertSelf(e),this.convertJson.thickness=this.originalJson.thick||.25;var t=this.convertJson.height,r=[3,3];this.originalJson.uvmultiple&&(r=[3/parseFloat(this.originalJson.uvmultiple[0]),3/parseFloat(this.originalJson.uvmultiple[1])]);var s=[1/r[0]*t,1/r[1]*t];this.convertJson.uvrepeat=[s[0],s[1]],this.convertJson.lefttexture=this.originalJson.lefttexture,this.convertJson.righttexture=this.originalJson.righttexture,this.convertJson.edgetexture=this.originalJson.edgetexture}},placement:dr,group:class extends cr{get thing2Type(){return"Object3D"}get originalType(){return"Group"}get isGroup(){return!0}_convertTags(){this.convertJson.tags=[10]}_parseChildren(){this._generateChildrenCreators(this.originalJson.groups,"group"),this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.videoprobes,"placement")}},doororwindow:class extends dr{get thing2Type(){return this.originalJson.iswindow?"Window":"Door"}get originalType(){return"DoorOrWindow"}_convertTags(){this.parent.isFloor&&("Window"===this.thing2Type?this.convertJson.tags=[6,15]:this.convertJson.tags=[6,16])}addModelUseCount(e){this.originalJson.isopen||this.originalJson.diridx||this.realScale&&!(this.realScale[0]>0&&this.realScale[1]>0&&this.realScale[2]>0)||(this.resourceManager.addModelUseCount(e.id),this.enableInstance=!0)}_convertSelf(e){return super._convertSelf(e),this.convertJson.external.isOpen=this.originalJson.isopen||!1,this.convertJson.external.transformCorrection=!0,"number"==typeof this.originalJson.diridx&&(this.convertJson.external.dirIdx=this.originalJson.diridx),this.convertJson}},room:class extends cr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r)}get thing2Type(){return this.parent.isFloor?"Room":"Object3D"}_canCombine(){var e=this.originalJson;return t(e.name)&&t(e.userid)&&t(e.visible)&&t(e.layerMask)&&(t(e.properties)||1===Object.keys(e.properties).length&&"_styleTag_"===Object.keys(e.properties)[0]);function t(e){return null==e}}_convertTags(){this.parent.isFloor||(this.convertJson.tags=[3,6])}get originalType(){return"Room"}get isRoom(){return!0}_parseChildren(){if(this.parent.isFloor){var e=JSON.parse(JSON.stringify(this.originalJson));e.name=null,e.userid=null,e.properties={},this._generateChildrenCreators(e,"roomslab"),this._generateChildrenCreators(JSON.parse(JSON.stringify(e)),"roomceiling"),this._generateChildrenCreators(JSON.parse(JSON.stringify(e)),"roomroof")}}getPolygons(){var e=this.parent.corners,t=[];return this.originalJson.corners&&this.originalJson.corners.forEach((r=>{var s=e[r];t.push([s[0],s[2]])})),this.originalJson.holescorners&&this.originalJson.holescorners.forEach((r=>{r.forEach((r=>{var s=e[r];t.push([s[0],s[2]])}))})),t}_parseSelf(){this.combineRoom=this.resourceManager.combineRoom&&this._canCombine(),super._parseSelf();var e=this.parent.corners,t=[],r=[];if(this.originalJson.corners)for(var s=0;s<this.originalJson.corners.length;s++){var n=this.originalJson.corners[s];t.push(e[n])}if(this.originalJson.holescorners)for(var o=0;o<this.originalJson.holescorners.length;o++){for(var a=[],i=0;i<this.originalJson.holescorners[o].length;i++){var l=this.originalJson.holescorners[o][i];a.push(e[l])}r.push(a)}if(this.originalJson.points)for(var h=0;h<this.originalJson.points.length;h++){var c=this.originalJson.points[h];t.push([c[0],c[1],-c[2]])}if(this.originalJson.holespoints)for(var u=0;u<this.originalJson.holespoints.length;u++){for(var p=[],d=0;d<this.originalJson.holespoints[u].length;d++){var g=this.originalJson.holespoints[u][d];p.push([g[0],g[1],-g[2]])}r.push(p)}t.length&&(this.realPosition=THING.MathUtils.getLabelPosition(t)),this.parent.isFloor||"number"==typeof this.originalJson.floorheight&&(this.realPosition=[this.realPosition[0],this.realPosition[1]+(this.originalJson.floorheight||0),this.realPosition[2]]),t.length&&(this.convertJson.external.points=this._to2DPoints(t,!this.combineRoom)),r.length&&(this.convertJson.external.holes=this._to2DHoles(r,!this.combineRoom))}_convertSelf(e){super._convertSelf(e),this.parent.isFloor||(this._convertPlane("floor"),this.convertJson.components[0].params.points=this.convertJson.external.points,this.convertJson.components[0].params.holes=this.convertJson.external.holes,delete this.convertJson.external.points,delete this.convertJson.external.holes)}},outdoors:class extends ur{get thing2Type(){return"Object3D"}get originalType(){return"Outdoors"}get isFloor(){return!1}get isOutdoor(){return!0}_convertTags(){this.convertJson.tags=[7]}_parseDecodeNumber(){this.decodeNumber="3"}_generateChildrenCreators(e,t,r){super._generateChildrenCreators(e,t,r)}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}_convertCombinePlanes(e){var t=[];e.forEach((e=>{if(0!==e.layerMask){var r=this._getCombinePlaneKey(e);this._makeCombinePlane(t,r,e)}})),this._setCombinePlaneData(t)}},facade:class extends dr{get thing2Type(){return"BaseEntity"}_convertTags(){this.convertJson.tags=[1]}get originalType(){return"Facade"}},facadeGroup:class extends cr{get thing2Type(){return"Group"}get originalType(){return"FacadeGroup"}_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.groups,"facadeGroup")}_convertSelf(e){super._convertSelf(e),this.convertJson.external.tags="Facade"}},curveLine:vr,leakWaterLine:fr,arrowLine:yr,arrowDataLine:class extends yr{get originalType(){return"ArrowDataLine"}},pipeLine:mr,routeLine:class extends vr{_convertSelf(e){super._convertSelf(e),this.convertJson.style.color=this.convertJson.style.color||[0,0,1]}get originalType(){return"RouteLine"}},placementWall:class extends dr{get thing2Type(){return"Object3D"}get originalType(){return"PlacementWall"}_convertTags(){this.convertJson.tags=[6,9]}_convertSelf(e){super._convertSelf(e),this.convertJson.renderOrder=-9}_convertCustomType(){}},ground:class extends dr{get originalType(){return"Ground"}_convertTags(){}},generalPolygonLine:class extends fr{_convertSelf(e){super._convertSelf(e),this.originalJson.color||delete this.convertJson.style.color}get originalType(){return"GeneralPolygonLine"}},generalRouteLine:class extends vr{_convertSelf(e){super._convertSelf(e),this.originalJson.arrowVisible&&(this.convertJson.external.arrow=!0)}get originalType(){return"GeneralRouteLine"}},misc:br,wall:_r,roomslab:class extends xr{get defineFloorAo(){return!0}get thing2Type(){return"Object3D"}get originalType(){return"RoomSlab"}get typeKey(){return"floor"}_convertTags(){super._convertTags(),this.convertJson.tags.push(3)}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(Xt.generateUUID()),"number"==typeof this.originalJson.floorheight?this.convertJson.position=[0,this.originalJson.floorheight,0]:this.convertJson.position=[0,.01,0],this.convertJson.renderOrder=-10,this._convertPlane("floor")}},roomroof:class extends xr{get sideType(){return"Back"}get thing2Type(){return"Object3D"}get originalType(){return"RoomCeiling"}get typeKey(){return"ceiling"}_convertTags(){super._convertTags(),this.convertJson.tags.push(5)}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(Xt.generateUUID()),this.convertJson.position=[0,(this.originalJson.ceilingheight||this.parent.parent.convertJson.external.height||3)-.1,0],this.convertJson.castShadow=!1,this._convertPlane("ceiling")}},roomceiling:class extends xr{get thing2Type(){return"Object3D"}get originalType(){return"RoomRoof"}get sideType(){return"Front"}get typeKey(){return"roof"}_convertTags(){super._convertTags(),this.convertJson.tags.push(4)}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(Xt.generateUUID()),this.convertJson.position=[0,(this.originalJson.roofheight||this.parent.parent.convertJson.external.height||3)+.005,0],this._convertPlane("roof")}},emptyObject:class extends dr{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[8]}_convertSelf(e){super._convertSelf(e),this.convertJson.layerMask=0,this.convertJson.external.oriType="Thing",this.convertJson.body&&"number"==typeof this.convertJson.body.id&&(this.convertJson.external.body={},this.convertJson.external.body.id=this.convertJson.body.id,delete this.convertJson.body)}}};class Tr{static getMap(){return Mr}}class Cr extends ar{import(e,t){return new Promise(((r,s)=>{var n=super.import(e,t),o=Tr.getMap();this.onOverrideConverter&&this.onOverrideConverter(o,{type:"cb"});var a=new o.world({creatorMap:o,version:this.version,resourceManager:this.resourceManager},e.scene);n.then((()=>{r(a)}))}))}getCreatorConfig(){return Tr}}var Jr=new RegExp("[\\[\\]\\.:\\/]","g");class wr extends lr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.version=e.version,this.useInverseRotation=null,this._parseSelf(),e.noCreateChildren||this._parseChildren()}_parseSelf(){this._convertModel()}_convertSelf(e){if(super._convertSelf(e),this._convertExcludeNodeNames(),"number"==typeof this.convertJson.body.id&&this.resourceManager.modelUseCount[this.convertJson.body.id]>1){this.convertJson.external.instance=this.resourceManager.getInstance(this.convertJson.body.id),this.convertJson.external.instanceId=1e4+this.convertJson.external.instance,this.convertJson.external.instanceCount=this.resourceManager.modelUseCount[this.convertJson.body.id];var t=Object.keys(this.convertJson.style||{}).length;if(t){if(1===t&&this.convertJson.style.uv&&!Object.keys(this.convertJson.style.uv).length)return;this.convertJson.external.instanceStyle=this.convertJson.style,delete this.convertJson.style}}var r=this.resourceManager.getRenderOrder(this.convertJson.body.node);r&&(this.convertJson.renderOrder=r)}_convertExcludeNodeNames(){if("number"==typeof this.convertJson.body.id){for(var e=[],t=0;t<this.children.length;t++){var r=this.children[t];r.convertJson.body&&r.convertJson.body.node&&e.push(r.convertJson.body.node)}e.length&&(this.convertJson.body.excludeNodeNames=e)}}_convertTransform(){var e=this.resourceManager.getTransform(this.originalJson.model,this.convertJson.body.node),t=this.originalJson.position;!t||0===t[0]&&0===t[1]&&0===t[2]?e&&(this.convertJson.position=this.realPosition=e.position):this.convertJson.position=this.realPosition=[t[0],t[1],t[2]];var r=this.originalJson.rotation;!r||0===r[0]&&0===r[1]&&0===r[2]&&1===r[3]?e&&(this.convertJson.quaternion=this.useInverseRotation=this.realRotation=e.quaternion):this.convertJson.quaternion=this.realRotation=[r[0],r[1],r[2],r[3]];var s=this.originalJson.scale;!s||1===s[0]&&1===s[1]&&1===s[2]?e&&(this.convertJson.scale=this.realScale=e.scale):this.convertJson.scale=this.realScale=[s[0],s[1],s[2]]}_convertModel(){if("number"==typeof this.originalJson.model){var e=this.resourceManager.getModelByIndex(this.originalJson.model);if(e){var t={};if(Object.assign(t,e),Rt.parseModel(t,this.version,this.resourceManager.baseLocalUrl,this.convertJson),t.applyTransposeToMesh&&(this.convertJson.body.inverseRotationMode="InverseRotationToMesh"),t.applyTransposeToVertices&&(this.convertJson.body.inverseRotationMode="InverseRotationToVertices"),delete t.applyTransposeToMesh,delete t.applyTransposeToVertices,delete t.type,this.convertJson.body.id=this.resourceManager.addModel(t),this.originalJson.node){var r=this.originalJson.node.replace(/\s/g,"_").replace(Jr,"");this.convertJson.body.node=r}else this.resourceManager.addModelUseCount(this.convertJson.body.id)}}}}let Ir=class extends wr{get thing2Type(){return"Entity"}_convertTags(){this.convertJson.tags=[2]}get originalType(){return"Placement"}_convertSelf(e){super._convertSelf(e),this.originalJson.animinfo&&this.originalJson.animinfo.clip.length&&this.originalJson.animinfo.isplay&&(this.convertJson.external.animInfo={},this.convertJson.external.animInfo.clips=[this.originalJson.animinfo.clip])}},Pr=class extends wr{get thing2Type(){return"Floor"}get originalType(){return"Floorplan"}get isFloor(){return!0}_parseSelf(){super._parseSelf(),this.originalJson.corners||(this.originalJson.corners=[])}_parseChildren(){this._generateChildrenCreators(this.originalJson.walls,"placementWall"),this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement")}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible?e.visible=!1:this.isFloor&&!this.originalJson.alwaysshowinsideobjs&&("room"===t||t.includes("Wall")||(e.visible=!1)),r=r||this,!1===this.originalJson.visible&&(e.visible=!1);var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}__generateChildrenCreators(e,t,r){void 0===r&&(r=this),e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{(!1===this.originalJson.visible||this.isFloor&&!this.originalJson.alwaysshowinsideobjs)&&(e.visible=!1),this.misc||(this.misc=new this.creatorMap.misc(this.options,{visible:e.visible},r),r.children.push(this.misc));var s=new this.creatorMap[t](this.options,e,this.misc);this.misc.children.push(s)})))}_convertExcludeNodeNames(){this.isFloor&&"number"==typeof this.convertJson.body.id&&(this.convertJson.body.excludeNodeNames="All")}_convertSelf(e){super._convertSelf(e),this.originalJson.height&&(this.convertJson.external.height=this.originalJson.height),this.originalJson.corners&&(this.convertJson.external.corners=this.originalJson.corners),"Building"===this.parent.thing2Type&&this.parent.hideStruct&&(this.convertJson.visible=!1),this.isFloor&&(this.convertJson.external.constantShowThings=!!this.originalJson.alwaysshowinsideobjs)}},Sr=class extends Pr{get thing2Type(){return"Object3D"}get originalType(){return"Outdoors"}get isFloor(){return!1}_convertTags(){this.convertJson.tags=[7]}_parseChildren(){this._generateChildrenCreators(this.originalJson.walls,"placementWall"),this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreatorsByTjsType(this.originalJson.placements,"placement"),this._generateChildrenCreatorsByTjsType(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement")}_generateChildrenCreatorsByTjsType(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible&&(e.visible=!1),r=e.properties&&"Ground"===e.properties._tjsType_?this:this.parent;var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}_convertSelf(e){super._convertSelf(e),this.convertJson.name=""}_generateChildrenCreators(e,t,r){super._generateChildrenCreators(e,t,r)}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}},Er=class extends wr{get thing2Type(){return"Room"}get originalType(){return"Room"}_convertExcludeNodeNames(){}_convertSelf(e){if(super._convertSelf(e),this.originalJson.points&&this.originalJson.points.length){for(var t=0;t<this.originalJson.points[0].length;t++)this.convertJson.external.points=this._to2DPoints(this.originalJson.points[0],!1);if(this.originalJson.points.length>1){this.convertJson.external.holes=[];for(var r=1;r<this.originalJson.points.length;r++)this.convertJson.external.holes.push(this._to2DPoints(this.originalJson.points[r],!1))}}var s={uuid:this.resourceManager.addUUID(Xt.generateUUID()),type:"Object3D",name:"slab",tags:[3],body:this.convertJson.body,external:this.convertJson.external,quaternion:this.convertJson.quaternion,renderOrder:this.convertJson.renderOrder||-10,userData:{_styleTag_:yt}};return this.parent.isFloor&&s.tags.push(6),this.convertJson.children.push(s),delete this.convertJson.body,delete this.convertJson.quaternion,delete this.convertJson.renderOrder,this.convertJson}_parseSelf(){super._parseSelf()}};var Rr={world:class extends wr{_parseChildren(){this._generateChildrenCreators(this.originalJson.outdoors,"outdoors"),this._generateChildrenCreators(this.originalJson.buildings,"building")}_convertExcludeNodeNames(){}get thing2Type(){return"Campus"}get originalType(){return"World"}},building:class extends wr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.facades=[],this.facadegroups=[]}_parseChildren(){this.facades=this._generateChildrenCreators(this.originalJson.facades,"facade"),this.facadegroups=this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}get thing2Type(){return"Building"}get originalType(){return"Building"}get isBuilding(){return!0}get hideStruct(){if(this.originalJson.structshow)return!1;var e=this.originalJson.facades||[],t=this.originalJson.facadegroups||[];return!(!e.length&&!t.length)}_convertExcludeNodeNames(){"number"==typeof this.convertJson.body.id&&(this.convertJson.body.excludeNodeNames="All")}_convertSelf(e){super._convertSelf(e),this.hideStruct||(this.convertJson.external.constantShowStruct=!0)}},combinePlacement:class extends wr{get thing2Type(){return"Entity"}_convertTags(){this.convertJson.tags=[2]}get originalType(){return"CombinePlacement"}},doororwindow:class extends wr{get thing2Type(){return this.originalJson.iswindow?"Window":"Door"}get originalType(){return"DoorOrWindow"}_convertTags(){this.parent.isFloor&&("Window"===this.thing2Type?this.convertJson.tags=[6,15]:this.convertJson.tags=[6,16])}},facadeGroup:class extends wr{_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.groups,"facadeGroup")}get thing2Type(){return"Group"}get originalType(){return"FacadeGroup"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.tags="Facade"}},facade:class extends Ir{get thing2Type(){return"BaseEntity"}_convertTags(){this.convertJson.tags=[1]}get originalType(){return"Facade"}},floorplan:Pr,group:class extends wr{_parseChildren(){this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.groups,"group")}_convertTags(){this.convertJson.tags=[11]}get thing2Type(){return"Object3D"}get originalType(){return"Group"}},outdoors:Sr,placementWall:class extends wr{get thing2Type(){return"Object3D"}get originalType(){return"PlacementWall"}_convertTags(){this.parent.isFloor?this.convertJson.tags=[6,9]:this.convertJson.tags=[9]}_convertSelf(e){this.convertJson.renderOrder=-9,super._convertSelf(e)}},placement:Ir,room:Er,misc:br};class Nr{static getMap(){return Rr}}let Or=class extends Pr{};var Dr=Nr.getMap();Dr.floorplan=Or;class Lr{static getMap(){return Dr}}let Ur=class extends wr{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[3],this.parent.isFloor&&this.convertJson.tags.push(6)}_convertSelf(e){this.convertJson.renderOrder=-10,super._convertSelf(e)}};var Fr=Lr.getMap();Fr.floorplan=class extends Or{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling")}},Fr.outdoors=class extends Sr{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling")}},Fr.combineFloor=Ur,Fr.combineCeiling=class extends Ur{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[5],this.parent.isFloor&&this.convertJson.tags.push(6)}},Fr.combineRoof=class extends Ur{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[4],this.parent.isFloor&&this.convertJson.tags.push(6)}};class jr{static getMap(){return Fr}}let Hr=class extends Er{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.placements,"placement",this),this._generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement",this),this._generateChildrenCreators(this.originalJson.groups,"group",this)}};var Ar=jr.getMap();Ar.room=Hr;class Gr{static getMap(){return Ar}}var Br=Gr.getMap();Br.placement=class extends Ir{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.placements,"placement",this)}_convertTransform(){var e=this.resourceManager.getTransform(this.originalJson.model,this.convertJson.body.node);e?(this.convertJson.position=this.realPosition=e.position,this.convertJson.quaternion=this.useInverseRotation=this.realRotation=e.quaternion,this.convertJson.scale=this.realScale=e.scale):super._convertTransform()}},Br.room=class extends Hr{_convertExcludeNodeNames(){if("number"==typeof this.convertJson.body.id){for(var e=[],t=0;t<this.children.length;t++){var r=this.children[t];r.convertJson.body&&r.convertJson.body.node&&e.push(r.convertJson.body.node)}e.length&&(this.convertJson.body.excludeNodeNames=e)}}};class kr{static getMap(){return Br}}class zr extends ar{constructor(e){super(e),this._versionMap={0:{0:Nr,1:Lr,2:Lr,3:jr,4:Gr,5:Gr,6:kr}},this._smallVersionLibs=[[0,1,2,3,4,5,6]],this._bigVersions=[0]}import(e,t){return new Promise(((r,s)=>{var n=super.import(e,t),o=this._getCreatorConfig(this.version.bigVersion,this.version.smallVersion).getMap();this.onOverrideConverter&&this.onOverrideConverter(o,{type:"max",version:this.version});var a=new o.world({creatorMap:o,version:this.version,resourceManager:this.resourceManager},e.scene);n.then((()=>{r(a)}))}))}getCreatorConfig(e,t){return this._getCreatorConfig(e,t)}}class Vr extends lr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.dataHandleMap=e.dataHandleMap,this._parseLoadVersion(),this._parseSelf(),this._parseChildren()}_parseLoadVersion(){this.originalJson.loadversion?this.loadVersion=new Et(this.originalJson.loadversion):this.parent&&this.parent.loadVersion?this.loadVersion=new Et(this.parent.loadVersion.mode):this.loadVersion=new Et(3)}_parseSelf(){var e,t=this.dataHandleMap[this.loadVersion.mode].getCreatorConfig(this.loadVersion.bigVersion,this.loadVersion.smallVersion).getMap(),r=t[this.creatorType];this.parent&&(e=this.parent.creator||this.parent),this.creator=new r({creatorMap:t,noCreateChildren:this.noCreateChildren,version:this.loadVersion,resourceManager:this.resourceManager},this.originalJson,e)}convert(e){return this.convertJson=this.creator.convert(e),this.convertJson.children||(this.convertJson.children=[]),this._convertChildren(e),this._cutEmptyJson(),this.convertJson}get noCreateChildren(){return!0}}class Wr extends Vr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.rooms=this.rooms||[]}_parseSelf(){super._parseSelf(),this.corners=this.creator.corners}_parseChildren(){var e=this.originalJson.walls;if(e){var t=[],r=[],s=[];if(e.forEach((e=>{0===e.type?r.push(e):1===e.type?t.push(e):s.push(e)})),t.length){var n=new this.creatorMap.wall(this.options,{},this,"ModelWall");this.children.push(n),this._generateChildrenCreators(t,"modelWall",n)}if(r.length){var o=new this.creatorMap.wall(this.options,{},this,"TextureWall");this.children.push(o),this._generateChildrenCreators(r,"textureWall",o)}this._generateChildrenCreators(s,"placementWall")}this.rooms=this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.grounds,"ground"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling"),this._generateChildrenCreators(this.originalJson.curvelines,"curveLine"),this._generateChildrenCreators(this.originalJson.routelines,"routeLine"),this._generateChildrenCreators(this.originalJson.leakwaterlines,"leakWaterLine"),this._generateChildrenCreators(this.originalJson.arrowlines,"arrowLine"),this._generateChildrenCreators(this.originalJson.arrowdatalines,"arrowDataLine"),this._generateChildrenCreators(this.originalJson.pipelines,"pipeLine"),this._generateChildrenCreators(this.originalJson.generalpolygonlines,"generalPolygonLine"),this._generateChildrenCreators(this.originalJson.generalroutelines,"generalRouteLine"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement"),this.__generateChildrenCreators(this.originalJson.placements,"placement"),this.__generateChildrenCreators(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.videoprobes,"placement")}__generateChildrenCreators(e,t,r){if(void 0===r&&(r=this),e){Array.isArray(e)||(e=[e]);var s=this,n=r;function o(){s.misc||(s.misc=new s.creatorMap.misc(s.options,{},r),r.children.push(s.misc)),n=s.misc}e.forEach((e=>{var s=new this.creatorMap[t](this.options,e,this);if(s.isShouldCombine)o();else if(3===s.loadVersion.mode){this._isShouldCombine(s)&&o()}if(s.originalJson._temp_belongroom)for(var a=0;a<this.rooms.length;a++)if(3===this.rooms[a].loadVersion.mode){var i=this.rooms[a].creator,l=s.creator;if(i.originalJson.userid&&i.originalJson.userid===l.originalJson._temp_belongroom){l.realPosition&&(l.realPosition=[l.realPosition[0]-i.realPosition[0],l.realPosition[1]-i.realPosition[1],l.realPosition[2]-i.realPosition[2]]),n=i;break}}s.parent=n,n.children.push(s),n=r}))}}get creatorType(){return"floorplan"}get isFloor(){return!0}}var qr={world:class extends Vr{_parseChildren(){this._generateChildrenCreators(this.originalJson.buildings,"building"),this._generateChildrenCreators(this.originalJson.outdoors,"outdoors")}get creatorType(){return"world"}},building:class extends Vr{_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}get creatorType(){return"building"}},facadeGroup:class extends Vr{get creatorType(){return"facadeGroup"}get noCreateChildren(){return!1}},facade:class extends Vr{get creatorType(){return"facade"}},floorplan:Wr,outdoors:class extends Wr{get creatorType(){return"outdoors"}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}get isFloor(){return!1}},group:class extends Vr{get creatorType(){return"group"}get noCreateChildren(){return!1}},room:class extends Vr{_parseChildren(){this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement"),this._generateChildrenCreators(this.originalJson.groups,"group")}get creatorType(){return"room"}get noCreateChildren(){return!1}},placement:class extends Vr{get creatorType(){return"placement"}},combinePlacement:class extends Vr{get creatorType(){return"combinePlacement"}get isShouldCombine(){return!0}},doororwindow:class extends Vr{get thing2Type(){return this.originalJson.iswindow?"Window":"Door"}get creatorType(){return"doororwindow"}_convertTags(){this.parent.isFloor&&("Window"===this.thing2Type?this.convertJson.tags=[6,15]:this.convertJson.tags=[6,16])}},ground:class extends Vr{get creatorType(){return"ground"}},modelWall:class extends Vr{get creatorType(){return"modelWall"}get noCreateChildren(){return!1}},textureWall:class extends Vr{get creatorType(){return"textureWall"}get noCreateChildren(){return!1}},placementWall:class extends Vr{get thing2Type(){return"Object3D"}get creatorType(){return"placementWall"}_convertTags(){this.parent.isFloor?this.convertJson.tags=[6,9]:this.convertJson.tags=[9]}},arrowLine:class extends Vr{get creatorType(){return"arrowLine"}},arrowDataLine:class extends Vr{get creatorType(){return"arrowDataLine"}},curveLine:class extends Vr{get creatorType(){return"curveLine"}},leakWaterLine:class extends Vr{get creatorType(){return"leakWaterLine"}},pipeLine:class extends Vr{get creatorType(){return"pipeLine"}},routeLine:class extends Vr{get creatorType(){return"routeLine"}},generalPolygonLine:class extends Vr{get creatorType(){return"generalPolygonLine"}},generalRouteLine:class extends Vr{get creatorType(){return"generalRouteLine"}},combineCeiling:class extends Vr{get creatorType(){return"combineCeiling"}},combineFloor:class extends Vr{get creatorType(){return"combineFloor"}},combineRoof:class extends Vr{get creatorType(){return"combineRoof"}},misc:br,wall:_r};class Qr{static getMap(){return qr}}class Yr extends ar{import(e,t){return new Promise(((r,s)=>{var n=super.import(e,t),o=new Cr(this.param),a=new zr(this.param),i=Qr.getMap();this.onOverrideConverter&&this.onOverrideConverter(i,{type:"mix"});var l=new i.world({creatorMap:i,dataHandleMap:{3:o,5:a},resourceManager:this.resourceManager},e.scene);n.then((()=>{r(l)}))}))}getCreatorConfig(){return Qr}}class Zr{static getDataHandler(e){var t,r=e.index,s=new Et(r.version);if(e.version=s,3===s.mode?t=Cr:5===s.mode?t=zr:7===s.mode&&(t=Yr),t)return new t(e)}}var Xr=Symbol("private");class Kr{constructor(e){this[Xr]={};var t=this[Xr];t.app=e.app,t.combineRoom=e.combineRoom||!1,t.onParsePreviewHide=e.onParsePreviewHide,t.onOverrideConverter=e.onOverrideConverter,t.resourceLibraryUrl=e.resourceLibraryUrl,t.dataHandle=null}convert(e){var t=this;return wt((function*(){var r=yield t.parseTjs(e);return t.convertToThing2(r)}))()}parseTjs(e){var t=this;return wt((function*(){var r=t[Xr];return e.app=r.app,e.combineRoom=r.combineRoom,r.dataHandle=Zr.getDataHandler(e),r.dataHandle.onParsePreviewHide=r.onParsePreviewHide,r.dataHandle.onOverrideConverter=r.onOverrideConverter,r.dataHandle.resourceLibraryUrl=r.resourceLibraryUrl,yield r.dataHandle.import(e)}))()}convertToThing2(e){for(var t=this[Xr],r=e.convert(),s=t.dataHandle.resourceManager,n=[],o=0;o<s.exportInstanceCount.length;o++)n[o]=s.exportInstanceCount[o].length;var a={version:"1.0.0",objects:[r],resources:{rootPath:{model:ut,texture:pt},models:s.exportModels,images:s.exportTextures,cubeTextures:s.cubeTextures,uuids:s.exportUuids,tags:at,instanceCount:n}},i=s.materialResourceResolver.getData().styles;return a.resources.resolvers=[{type:"MaterialResourceResolver",data:{styles:i}}],s.viewpoint&&(a.viewpoint=s.viewpoint),a.envMap={outer:s.outerEnvMapIndex,inner:s.innerEnvMapIndex},s.outEnvMap,a}get matrixNode(){return this[Xr].dataHandle.resourceManager.matrixNode}set matrixNode(e){this[Xr].dataHandle.resourceManager.matrixNode=e}}class $r extends qe{constructor(){super(),this._restructureData=(e,t,r)=>{var s=t.objects[0];!e.uuid&&s.uuid&&(r.uuid=s.uuid),!e.id&&s.id&&(r.id=s.id),!e.name&&s.name&&(r.name=s.name);var n=s.extras||s.external;if(n){var o=r.external||{};for(var a in n)o[a]||(o[a]=n[a]);r.external=n}t.objects=s.children},this._thingjsConfigParse=null,this._thingjsconfig=null}parseOptions(e,t){return e.info.main="scene.json",super.parseOptions(e,t)}onLoadSceneFile(e,t){var r=t.owner.app;return new Promise(((s,n)=>{super.onLoadSceneFile(e,t).then((n=>{var o,a={url:e.url,index:e.info,scene:n},i=t.resourceLibraryUrl;!i&&e.url&&null!=(o=e.info)&&o.resourceLibrary&&(i=e.url._appendPath(e.info.resourceLibrary)),this._thingjsConfigParse=new sr({app:r,url:a.url}),this._thingjsconfig=a.scene.thingjsconfig||a.scene.config,this._thingjsConfigParse.parse(this._thingjsconfig,t),(this._convertManager=new Kr({app:r,combineRoom:t.combineRoom,onParsePreviewHide:t.onParsePreviewHide,onOverrideConverter:t.onOverrideConverter,resourceLibraryUrl:i})).convert(a).then((e=>{t.owner._isTempRoot||this._restructureData(t,e,t.owner),s(e)}))}))}))}onLoadComplete(e,t,r){this._thingjsConfigParse.parseLight(this._thingjsconfig,r),this._convertManager.matrixNode&&(this._convertManager.matrixNode.dispose(),this._convertManager.matrixNode=null),t.renderSettings=this._thingjsconfig,super.onLoadComplete(e,t,r)}}THING.App.addCompleteCallback((e=>{e.registerBundleLoader("scene",new $r)}),-4);var es=Object.freeze({__proto__:null,COMPILETIME:"Thu, 21 Aug 2025 09:35:41 GMT",VERSION:"1.0.0"});for(var ts in ot){var rs=ot[ts];"VERSION"!=ts&&"COMPILETIME"!=ts&&window.THING.Utils.registerClass(ts,rs)}window.THING.CAMPUS=ot,window.THING.SCENE_CONVERT=es}));
