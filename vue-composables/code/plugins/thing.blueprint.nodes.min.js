!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const virtualApp={monitorManager:{stop:()=>{}},off:()=>{},camera:{}};class BaseNode3D extends THING.BLUEPRINT.BaseNode{static BASEURL="https://cdn.uino.cn/blueprint/";static ROOTURL="";constructor(e={}){super(e),this.app=e.app||null}set app(e){this._app=e}get app(){return(this._app.isDisposing||this._app.isDisposed)&&(this._app=virtualApp),this._app}getFullPath(e){e=this._replaceVariables(e,this._blueprint.getVars());const t=this._blueprint.path;return t&&!this.isAbsolutePath(e)&&(e=this._appendURL(t,e)),THING.Utils.resolveURL(e)}isAbsolutePath(e){return!!new RegExp("^(?:[a-z]+:)?//","i").test(e)||!!e.startsWith("/")}_appendURL(e,t){return e.endsWith("/")||(e+="/"),t.startsWith("/")&&(t=t.substring(1)),e+t}setStyleProp(e,t,n=null,a=!0){const o=e;this.traverseObject(o,(e=>{e.style&&e.setStyle({[t]:n},a)}))}getDefaultTag(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}fixIrregularJSON(e){return e.replace(/'/g,'"').replace(/(\w+):/g,'"$1":').replace(/True/g,"true").replace(/False/g,"false")}handleTime(e){e=Number(this._replaceVariables(e,this._blueprint.getVars()));return/^\d+(\.\d+)?$/.test(e)?1e3*e:0}parseColor(e){return Array.isArray(e)?e:"#"==e[0]?[parseInt(e.substr(1,2),16)/255,parseInt(e.substr(3,2),16)/255,parseInt(e.substr(5,2),16)/255]:e}validNodeUserInterface(){let e=document.getElementById("uino-container-ui");if(!e){e=document.createElement("div"),e.setAttribute("id","uino-container-ui"),e.setAttribute("class","uino-container-ui");const t=e.style;t.position="absolute",t.top="50%",t.left="50%",t.transform="translate(-50%, -50%)",t.width="100%",t.height="100%",t.background="transparent",t["pointer-events"]="none";const n=document.getElementById("div3d");if(n)try{n.parentNode.style.position="relative",n.parentNode.appendChild(e)}catch{n.style.position="relative",n.appendChild(e)}}}recycleNodeUserInterface(){const e=document.getElementById("uino-container-ui");e&&0===e.childNodes.length&&e.remove()}toSelector(e){const t=new THING.Selector;return t.push(e),t}traverseObject(e,t){e&&(e.isSelector||THING.Utils.isArray(e)?e.forEach((e=>{!e.destroyed&&t(e)})):e.isBaseObject&&!e.destroyed&&t(e))}traverseObjectAfterLoaded(e,t){e&&(e.isSelector||THING.Utils.isArray(e)?e.forEach((e=>{this._loadObject(e,t)})):e.isBaseObject&&this._loadObject(e,t))}_loadObject(e,t){!e.destroyed&&t&&(e.loading?e.waitForComplete().then((()=>{t(e)})):e.loading||e.loaded?t(e):(e.loadResource(),e.waitForComplete().then((()=>{t(e)}))))}getParent(e){return e&&e.isBaseObject?e:e&&(e.isSelector||THING.Utils.isArray(e))?e[0]:this._blueprint.getRunner().args.options.root||this.app.root}filterParams(e){let t={};return Object.keys(e).filter((t=>void 0!==e[t]&&null!==e[t])).forEach((n=>{t[n]=e[n]})),t}getFirstObject(e){return e?e.isSelector||THING.Utils.isArray(e)?e[0]:e.isBaseObject?e:void 0:null}_replaceVariables(e,t){return String(e).includes("${")?e.replace(/\${(.*?)}/g,((e,n)=>void 0!==t[n]?t[n]:e)):e}}class BPPrint extends BaseNode3D{static config={name:"BPPrint",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"type",type:"select",value:["log","warn","error","debug"],visiblePin:!1},{name:"printOnScreen",type:"boolean",value:!0,visiblePin:!1},{name:"value",type:"any",input:!0}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onExecute(e,t,n){var a=t.value;if(THING.Utils.isNull(a))return;if(a.isSelector)a.length>0&&(a=a[0].name||a[0].id||a[0].type);else if("[object Object]"===Object.prototype.toString.call(a))a=a.name||a.id||a.type||JSON.stringify(a);var o=t.type;if(t.printOnScreen){var s=document.getElementById(this.app.container.id),c=s.parentNode;if(!s)return;if(!document.getElementById("scrollDisplay")){var i=document.createElement("div");i.id="scrollDisplay",i.style.right="10px",i.style.position="absolute",i.style.zIndex=1e6,c.insertBefore(i,c.childNodes[0])}var r=document.getElementById("scrollDisplay");i=r;var l=document.createElement("div");switch(i.insertBefore(l,i.children[0]),l.innerText=a,l.style.color="#fff",l.style.position="relative",l.style.zIndex="1",l.innerText&&setTimeout((()=>{var e=i.childNodes.length;i.removeChild(i.childNodes[e-1])}),3e3),o){case"debug":l.style.color="#f11caf";break;case"log":l.style.color="#fff";break;case"warn":l.style.color="#f1c31c";break;case"error":l.style.color="#ff0000"}}switch(o){case"debug":console.debug(a);break;case"log":console.log(a);break;case"warn":console.warn(a);break;case"error":console.error(a)}}}class BPLoad extends BaseNode3D{static config={name:"BPLoad",group:"Custom",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"url",type:"string",value:`${BaseNode3D.BASEURL}scene/factory/`},{name:"parent",type:["object","selector"],enabled:!1},{name:"hidden",type:"boolean",enabled:!1},{name:"dynamic",type:"boolean",enabled:!1},{name:"resetUUID",type:"boolean",enabled:!1},{name:"ignoreRenderSettings",type:"boolean",value:!0,enabled:!1},{name:"filterObject",type:"object",enabled:!1},{name:"offset",type:"vector3",enabled:!1},{name:"ignoreMainLight",type:"boolean",enabled:!1},{name:"ignoreMainCamera",type:"boolean",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"selector",type:"selector"}]};constructor(){super(),this.selector=new THING.Selector}onExecute(e,t,n){let a=this.getFullPath(t.url),o=this.getFirstObject(t.parent)||this.app.root,s=t.hidden,c=t.dynamic,i=t.resetUUID,r=t.ignoreMainLight??!1,l=t.ignoreMainCamera??!1,p=!(!1===t.ignoreRenderSettings),u=t.filterObject,m=t.offset,d=this.app;if(a){let e={root:o,hidden:s,dynamic:c,resetUUID:i,ignore:{renderSettings:p},ignoreThemeAll:!0,onFilterObject:e=>!1!==(e=>!(r&&("mainAmbientLight"===e.name||e.tags&&e.tags.includes("MainAmbientLight")||"mainDirectionalLight"===e.name||e.tags&&e.tags.includes("MainDirectionalLight"))||l&&("MainCamera"===e.name||e.tags&&e.tags.includes("MainCamera"))))(e)&&(!THING.Utils.isValid(u)||"function"!=typeof u||u(e))};THING.Utils.isValid(u)&&"function"==typeof u&&(e.onFilterObject=u),d.load(a,e).then((e=>{this._root=e.rootObjects,this._root&&this._root.length&&m&&this._root.forEach((e=>{e.translate(m)})),n.selector=this._root,this.selector.push(this._root),this.run("complete",n)}))}}onStop(){let e=this.app;!this._root&&e.query(".Campus")[0]&&e.query(".Campus")[0].destroy(),e.root.hasComponent("renderSetting")&&e.root.removeComponent("renderSetting"),this.selector.destroy(),this.selector.clear(),e.blueprint.clear()}}class BPLoadTheme extends BaseNode3D{static config={name:"BPLoadTheme",advanced:!0,group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"url",type:"string",value:"https://cdn.uino.cn/thingjs-web/blueprint/resource/testload/theme/resource.json"},{name:"apply",type:"boolean",value:!0},{name:"renderSettings",type:"boolean",value:!0},{name:"styles",type:"boolean",value:!0},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super(),this.selector=new THING.Selector}onSetup(){this.renderSettings=this.app.renderSettings}onExecute(e,t,n){let a=this.getFullPath(t.url),o=t.apply,s=void 0!==t.renderSettings&&!t.renderSettings,c=void 0!==t.styles&&!t.styles;this.object=t.object;let i=this.app;if(n.object=this.object,this.object&&this.object.isSelector&&(this.object=this.object[0]),a){let e={apply:o,ignoreRenderSettings:s,ignoreStyles:c,progressBarVisible:!1};this.object&&(e.root=this.object),i.load(a,e).then((e=>{this.bundle=e,this.run("complete",n)}))}}onStop(){this.app.renderSettings=this.renderSettings,this.app.query("[userData/_themeGround_]").forEach((e=>{e.destroy()})),this.object?this.object.destroyed||this.app.themeManager.clearStyles(this.object):this.app.query(".Campus")[0]&&this.app.themeManager.clearStyles(this.app.query(".Campus")[0]),this.app.themeManager.unregister(this.bundle.name)}}let _num$1=0;class BPLoadSceneTheme extends BaseNode3D{static config={name:"BPLoadSceneTheme",advanced:!0,group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"url",type:"string",value:"https://cdn.uino.cn/thingjs-web/blueprint/resource/testload/theme/bundle.json"},{name:"type",type:"select",value:["renderSettings","styles"],multiple:!0},{name:"duration",type:"number",value:0,unit:"s",enabled:!1},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};static _transitionEffect=null;constructor(){super(),this.selector=new THING.Selector,this._eventTag=null}onSetup(){this.renderSettings=this.app.renderSettings;let e=BPLoadSceneTheme._transitionEffect;e||(e=new THING.TransitionEffect,BPLoadSceneTheme._transitionEffect=e,this.app.camera.addEffect("ThemeTransitionEffect",e,101),e.progress=0)}onExecute(e,t,n){const a=this.app;let o=t.type;if(THING.Utils.isNull(o))return;"string"==typeof o&&(o=[o]);let s=!0,c=!0;o.forEach((e=>{"renderSettings"===e?s=!1:"styles"===e&&(c=!1)}));const i=t.duration,r=void 0!==i&&0!==i,l=this.getFullPath(t.url);if(this.object=t.object,n.object=this.object,this.object&&this.object.isSelector&&(this.object=this.object[0]),l){const e={apply:!0,ignoreRenderSettings:s,ignoreStyles:c,progressBarVisible:!1};this.object&&(e.root=this.object),a.load(l,e).then((e=>{this.bundle=e;const t=BPLoadSceneTheme._transitionEffect;if(t.active=!!r,r){const e="themeTransitionEffect"+_num$1++;let o=0;t.progress=0,a.on("update",(s=>{const c=s.deltaTime;o+=c,t.progress=o/i,o>=i&&(a.off("update",e),this._eventTag=null,this.syncRun("complete",n),t.progress=0)}),e),this._eventTag=e}else this.syncRun("complete",n)}))}}onStop(){const e=BPLoadSceneTheme._transitionEffect;this._eventTag&&(this.app.off("update",this._eventTag),this._eventTag=null),e&&(this.app.camera.removeEffect("ThemeTransitionEffect"),BPLoadSceneTheme._transitionEffect=null),this.app.renderSettings=this.renderSettings,this.app.query("[userData/_themeGround_]").forEach((e=>{e.destroy()})),this.object?this.object.destroyed||this.app.themeManager.clearStyles(this.object):this.app.query(".Campus")[0]&&this.app.themeManager.clearStyles(this.app.query(".Campus")[0]),this.app.themeManager.unregister(this.bundle.name)}}class BPCurrentCampus extends BaseNode3D{static config={name:"BPCurrentCampus",group:"Custom",outputs:[{name:"object",type:"object"}]};constructor(){super()}async onExecute(e,t,n){n.object=this.app.query(".Campus")[0]}}class BPBuildingExpandFloors extends BaseNode3D{static config={name:"BPBuildingExpandFloors",group:"Basic",inputs:[{name:"exec",type:"exec"},{name:"building",type:["object","selector"]},{name:"expand",type:"boolean",value:!0},{name:"time",type:"number",value:1,unit:"s"},{name:"distance",type:"number",value:10},{name:"direction",type:"select",value:["vertical","horizontal"]}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this.app;let a=t.building,o=this.handleTime(t.time),s=t.distance,c=t.direction||"vertical";a?(a.isSelector&&(a=a[0]),a.tags.has("Building")&&(t.expand||!1?a.expandFloors({time:o,distance:s,horzMode:"horizontal"===c}):a.unexpandFloors({time:o}))):console.error("Please provide the building input data")}}class BPChangeLevel extends BaseNode3D{static config={name:"BPChangeLevel",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"jumping",type:"boolean",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super(),this.campus=null}async onExecute(e,t,n){let a=this.getFirstObject(t.object),o=t.jumping||!1;n.object=t.object,a&&this.app.level.change(a,{complete:e=>{this.run("complete",{object:e.current})},stop:()=>{},jumping:o})}}class BPGetCurrentLevel extends BaseNode3D{static config={name:"BPGetCurrentLevel",group:"Custom",inputs:[],outputs:[{name:"object",type:["object","selector"]}]};onExecute(e,t,n){n.object=this.app.level.current}}class BPGetPrevLevel extends BaseNode3D{static config={name:"BPGetPrevLevel",group:"Custom",inputs:[],outputs:[{name:"object",type:["object","selector"]}]};async onExecute(e,t,n){n.object=this.app.level.prev}}class BPLevelBack extends BaseNode3D{static config={name:"BPLevelBack",group:"Custom",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"next",type:"exec"},{name:"callback",type:"callback"},{name:"current",type:["object","selector"]},{name:"prev",type:["object","selector"]}]};constructor(){super(),this.campus=null}async onExecute(e,t,n){let a=this.app,o=this;a.level.current&&a.level.back({onComplete:e=>{n.current=e.current,n.prev=e.prev,o.run("callback",n)}})}}const conditionMap={campus:"Campus",building:"Building",floor:"Floor",room:"Room",placement:"Placement,Entity,Line,Geometry,Region,Window,Door"};class BPLevelChangeEvent extends BaseNode3D{static config={name:"BPLevelChangeEvent",inputs:[{name:"bind",type:"exec"},{name:"unBind",type:"exec"},{name:"type",type:"select",value:["campus","building","floor","room","placement"],multiple:!0},{name:"checkCurrent",type:"boolean"}],outputs:[{name:"beforeEnter",type:"callback",enabled:!1},{name:"afterEnter",type:"callback"},{name:"beforeLeave",type:"callback",enabled:!1},{name:"afterLeave",type:"callback"},{name:"current",type:"object"},{name:"prev",type:"object"},{name:"next",type:"object"}]};constructor(){super(),this.type=""}onExecute(e,t,n){let a=this.curExecName,o=t.type;if(this.condition=null,THING.Utils.isNull(o))return;"string"==typeof o&&(o=[o]),o.forEach((e=>{this.condition?this.condition+=`,${conditionMap[e]}`:this.condition=`tags:or(${conditionMap[e]}`})),this.condition+=")";let s=t.checkCurrent;this.enterName="EnterLevel_BP"+this.id,this.leaveName="LeaveLevel_BP"+this.id;let c=this;"bind"==a?(this.app.on(THING.EventType.BeforeEnterLevel,this.condition,(e=>{n.current=e.current,n.prev=e.prev,n.next=e.next,c.syncRun("beforeEnter",n)}),this.enterName),this.app.on(THING.EventType.AfterEnterLevel,this.condition,(e=>{n.current=e.current,n.prev=e.prev,n.next=e.next,c.syncRun("afterEnter",n)}),this.enterName),this.app.on(THING.EventType.BeforeLeaveLevel,this.condition,(e=>{n.current=e.current,n.prev=e.prev,n.next=e.next,c.syncRun("beforeLeave",n)}),this.leaveName),this.app.on(THING.EventType.AfterLeaveLevel,this.condition,(e=>{n.current=e.current,n.prev=e.prev,n.next=e.next,c.syncRun("afterLeave",n)}),this.leaveName),s&&this.app.level.current&&this.app.level.current.test(this.condition)&&(n.current=this.app.level.current,n.prev=this.app.level.prev,c.syncRun("beforeEnter",n),c.syncRun("afterEnter",n))):"unBind"==a&&(this.app.off(THING.EventType.BeforeEnterLevel,this.condition,this.enterName),this.app.off(THING.EventType.AfterEnterLevel,this.condition,this.enterName),this.app.off(THING.EventType.BeforeLeaveLevel,this.condition,this.leaveName),this.app.off(THING.EventType.AfterLeaveLevel,this.condition,this.leaveName))}onStop(){this.app.off(THING.EventType.BeforeEnterLevel,this.condition,this.enterName),this.app.off(THING.EventType.AfterEnterLevel,this.condition,this.enterName),this.app.off(THING.EventType.BeforeLeaveLevel,this.condition,this.leaveName),this.app.off(THING.EventType.AfterLeaveLevel,this.condition,this.leaveName)}}class BPCreateEntity extends BaseNode3D{static config={name:"BPCreateEntity",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"entity",enabled:!1},{name:"name",type:"string",value:"entity"},{name:"url",type:"string",value:"https://model.3dmomoda.com/models/7bfb3321557a40fead822d7285ac5324/0/gltf"},{name:"parent",type:["selector","object"]},{name:"position",type:"vector3",value:[0,0,0],editor:"pickPoint",unit:"m"},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1,unit:"角度"},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1},{name:"batchRender",type:"boolean",value:!1,enabled:!1},{name:"dynamic",type:"boolean",value:!1,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a,{parent:o,position:s=[0,0,0],rotation:c=[0,0,0],scale:i=[1,1,1],id:r="entity",name:l="entity",url:p="https://model.3dmomoda.com/models/7bfb3321557a40fead822d7285ac5324/0/gltf",batchRender:u=!1,spaceType:m="Local",dynamic:d=!1}=t,b={id:r,name:l,url:p,parent:this.getParent(o),dynamic:d};"Local"===m?(b.localPosition=s,b.localScale=i,b.localRotation=c):(b.position=s,b.scale=i,b.rotation=c),p?(p=this.getFullPath(p),b.url=p,a=new THING.Entity({...b,onComplete:e=>{n.object=e.object,this.run("complete",n)}})):a=new THING.Object3D({...b,onComplete:e=>{n.object=e.object,this.run("complete",n)}}),this._objects.push(a),n.object=a,u&&a.makeInstancedDrawing()}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPBatchCreateEntity extends BaseNode3D{static config={name:"BPBatchCreateEntity",desc:"THING.Entity",inputs:[{name:"exec",type:"exec"},{name:"name",type:"string",value:"entity"},{name:"url",type:"any",value:"https://model.3dmomoda.com/models/98DEB861DA714DFC8776D4B937F368F7/0/gltf/"},{name:"parent",type:["selector","object"]},{name:"positions",type:"array"}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"result",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.url,o=t.positions,s=t.name||"entity",c=t.parent,i=this,r=new THING.Selector;for(let e=0;e<o.length;e++){new THING.Entity({name:s,url:"string"==typeof a?a:THING.Math.randomFromArray(a),position:o[e],parent:this.getParent(c),complete:async t=>{i._objects.push(t.object),r.push(t.object),n.result=r,e===o.length-1&&i.run("complete",n)}}).makeInstancedDrawing()}}onStop(){this._objects.destroy(),this._objects.clear()}}class BPQueryObject extends BaseNode3D{static config={name:"BPQueryObject",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"name",type:"string"},{name:"id",type:"string",enabled:!1},{name:"uuid",type:"string",enabled:!1},{name:"tag",type:"string"},{name:"type",type:"string",enabled:!1},{name:"attribute",type:"string",enabled:!1},{name:"customAttribute",type:"string",enabled:!1},{name:"regularExpression",title:"正则表达式",type:"string",enabled:!1},{name:"testPath",title:"属性(正则)",type:"string",enabled:!1},{name:"object",type:["object","selector"],enabled:!1},{name:"currentLevel",type:"boolean",enabled:!1},{name:"includeChildren",type:"boolean",value:!0,enabled:!1},{name:"includeSelf",type:"boolean",value:!1,enabled:!1},{name:"fuzzyQuery",type:"boolean",value:!1,enabled:!1},{name:"matchAll",type:"boolean",value:!1},{name:"dynamic",type:"boolean",value:!1,enabled:!1},{name:"disableCache",type:"boolean",visiblePin:!1,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"onAdd",type:"callback",enabled:!1},{name:"onRemove",type:"callback",enabled:!1},{name:"object",type:["object","selector"],enabled:!1},{name:"result",type:["object","selector"]}]};buildCondition(e){let t,n,a,o=e.name,s=e.tag,c=e.id,i=e.uuid,r=e.type,l=e.attribute,p=e.customAttribute,u=e.fuzzyQuery,m=e.matchAll,d=e.regularExpression;if(u&&o)try{n=new RegExp(o)}catch(e){console.error(e.message)}else d?a=d:m?o&&(t?t+=`&&${o}`:t=`${o}`):o&&(t?t+=`||${o}`:t=`${o}`);return m?(c&&(t?t+=`&&#${c}`:t=`#${c}`),i&&(t?t+=`&&[uuid=${i}]`:t=`[uuid=${i}]`),r&&(t?t+=`&&.${r}`:t=`.${r}`),l&&(t?t+=`&&[${l}]`:t=`[${l}]`),p&&(t?t+=`&&[userData/${p}]`:t=`[userData/${p}]`),s&&(t?t+=`&&tags:and(${s})`:t=`tags:and(${s})`)):(c&&(t?t+=`||#${c}`:t=`#${c}`),i&&(t?t+=`||[uuid=${i}]`:t=`[uuid=${i}]`),r&&(t?t+=`||.${r}`:t=`.${r}`),l&&(t?t+=`||[${l}]`:t=`[${l}]`),p&&(t?t+=`||[userData/${p}]`:t=`[userData/${p}]`),s&&(t?t+=`||tags:or(${s})`:t=`tags:or(${s})`)),t&&"*"!==t&&(t=THING.Selector.buildExpression(t)),{stringCondition:t,regCondition:n,regExpression:a}}onStop(){this.result&&this.result._unregisterEvents&&this.result._unregisterEvents()}onExecute(e,t,n){this.parent=t.object;let a=t.currentLevel,o=t.includeChildren,s=t.includeSelf,c=t.matchAll,i=t.dynamic;this.parent||(this.parent=a&&this.app.level.current||this.app),this.parent.isSelector&&(this.parent=this.parent[0]);let r=this.buildCondition(t).stringCondition,l=this.buildCondition(t).regCondition,p=this.buildCondition(t).regExpression,u=this.parent.query((e=>{if(c)return!(r&&!THING.Selector.testByExpression(r,e))&&(!(l&&!l.test(e.name))&&!!(r||l||p));if(r){if("*"===r)return!0;if(THING.Selector.testByExpression(r,e))return!0}if(l&&l.test(e.name))return!0;if(p){let n;p=p.replace(/\s+/g,"");try{if(n=new RegExp(p),n&&n.test(e.getAttribute(t.testPath||"name")))return!0}catch(e){console.error(e.message)}}return!1}),{recursive:o,dynamic:i,includeSelf:s,onAdd:e=>{n.object=e,this.syncRun("onAdd",n)},onRemove:e=>{n.object=e,this.syncRun("onRemove",n)}});this.result=u,n.result=u}}class BPGetValidObject extends BaseNode3D{static config={name:"BPGetValidObject",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object1",type:"object"},{name:"object2",type:"object"}],outputs:[{name:"exec",type:"exec"},{name:"validObject",type:"object"}]};constructor(){super()}onExecute(e,t,n){let a=t.object1,o=t.object2;n.validObject=a||o}onStop(){}}class BPObjectSet extends BPQueryObject{static config={name:"BPObjectSet",advanced:!0,inputs:[...BPQueryObject.config.inputs.slice(1).filter((e=>!("dynamic"==e.name||"disableCache"==e.name)))],outputs:[{name:"result",type:["object","selector"]}]}}class BPCreateObject extends BaseNode3D{static config={name:"BPCreateObject",inputs:[{name:"exec",type:"exec"},{name:"id",type:"string"},{name:"name",type:"string"}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}}class BPConcatSelector extends BPCreateObject{static config={name:"BPConcatSelector",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"exec",type:"exec"},{name:"selector",type:"selector"}],dynamic:{inputOrOutput:"input",type:"selector",label:"selector [index]",length:1}};isDynamicInputs(){return!0}constructor(){super()}onExecute(e,t,n){let a=Object.entries(t).filter((([e,t])=>"result"!==e)).map((([e,t])=>t)).reduce(((e,t)=>e.concat(t)),new THING.Selector);n.selector=a}}class BPCloneObject extends BaseNode3D{static config={name:"BPCloneObject",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"result",type:["object","selector"]}]};constructor(){super(),this._result=new THING.Selector,this._cloneObjArr=new THING.Selector}onExecute(e,t,n){if(this._result.clear(),this._object=t.object,this._object){if(this._object.isSelector&&(this.traverseObject(this._object,(e=>{if(e){let t=e.clone();this._result.push(t),this._cloneObjArr.push(t)}})),n.result=this._result),this._object.isObject3D){let e=this._object.clone();this._cloneObjArr.push(e),n.result=e}}else console.error("Please provide the object input data")}onStop(){const e=this._cloneObjArr.length;e&&e>0&&(this._cloneObjArr.destroy(),this._cloneObjArr.clear())}}class BPObjectGetParent extends BaseNode3D{static config={name:"BPObjectGetParent",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",enabled:!1},{name:"includeSelf",type:"boolean",value:!1,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"parent",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a,o=t.object,s=t.condition,c=t.includeSelf||!1;o?(o.isSelector&&(o=o[0]),a=s?o.getParents({includeSelf:c})?._queryByCondition(s):o.parent,n.parent=a):console.error("Please provide the object input data")}}class BPObjectGetChildren extends BaseNode3D{static config={name:"BPObjectGetChildren",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string"},{name:"includeChildren",type:"boolean",value:!1}],outputs:[{name:"next",type:"exec"},{name:"children",type:["object","selector"]}]};onExecute(e,t,n){let a,o=this.getFirstObject(t.object),s=t.condition,c=t.includeChildren;o&&(a=s?o.query(s,{recursive:c}):o.query("*",{recursive:c}),n.children=a)}}class BaseObjectGetAttribute extends BaseNode3D{static config={name:"BaseObjectGetAttribute",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(e,t){super(),this._key=e,this._outputInpName=t||"value"}onExecute(e,t,n){let a=this.getFirstObject(t.object);if(a){if(a.isBaseObject){let e=a.getAttribute(this._key);try{e=JSON.parse(e)}catch{}n[this._outputInpName]=e}n.object=a}else console.error("Please provide the object input data")}}class BPObjectGetBrothers extends BaseObjectGetAttribute{static config={name:"BPObjectGetBrothers",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"brothers",type:["object","selector"]}]};constructor(){super("brothers","brothers")}}class BPObjectGetVerticesInfo extends BaseNode3D{static config={name:"BPObjectGetVerticesInfo",group:"Custom",title:"获取对象顶点信息",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"value",type:"any"}]};constructor(){super()}onExecute(e,t,n){let a=t.object;if(!a)return void console.error("Please provide the object input data");a.isSelector&&a._objects[0]&&(a=a._objects[0]);let o=a.node.getVerticesInfo();n.value={index:o.indexes,position:o.vertices}}}class BPObjectAddChild extends BaseNode3D{static config={name:"BPObjectAddChild",desc:"obj.add",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"children",type:["object","selector"]},{name:"useChildLocalPosition",type:"boolean",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]},{name:"children",type:["object","selector"]}]};onExecute(e,t,n){let a=this.getFirstObject(t.object);if(!a)return;let o=t.children,s=t.useChildLocalPosition;o?(n.object=a,n.children=o,this.traverseObject(o,(e=>{let t={};s&&(t.localPosition=e.localPosition),a.add(e,t)}))):console.error("Please provide the children input data")}}class BPObjectRemoveChild extends BaseNode3D{static config={name:"BPObjectRemoveChild",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"children",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]},{name:"children",type:["object","selector"]}]};onExecute(e,t,n){let a=t.children;if(!a)return void console.error("Please provide the children input data");let o=t.object;o?(n.object=o,n.children=a,o.isSelector&&(o=o[0]),this.traverseObject(a,(e=>{o.remove(e)}))):console.error("Please provide the object input data")}}class BPObjectGetBasicAttribute extends BaseNode3D{static config={name:"BPObjectGetBasicAttribute",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"name",type:"string"},{name:"id",type:"string"},{name:"visible",type:"boolean",enabled:!1},{name:"type",type:"string",enabled:!1},{name:"tags",type:"array",enabled:!1},{name:"object",type:["object","selector"],enabled:!1}]};onExecute(e,t,n){let a=t.object;a?(a.isSelector&&a._objects[0]&&(a=a._objects[0]),a.isBaseObject&&(n.name=a.name,n.id=a.id,n.type=a.type,n.visible=a.visible,a.tags?n.tags=Array.from(a.tags):n.tags=[]),n.object=a):console.error("Please provide the object input data")}}class BPObjectSetBasicAttribute extends BaseNode3D{static config={name:"BPObjectSetBasicAttribute",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"name",type:"string"},{name:"id",type:"string"},{name:"visible",type:"boolean",enabled:!1},{name:"type",type:"string",enabled:!1},{name:"tags",type:"array",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object;a?(this.traverseObject(a,(e=>{t.name&&(e.name=t.name),t.id&&(e.id=t.id),t.type&&(e.type=t.type),t.tags&&(e.tags=t.tags),void 0!==t.visible&&(e.visible=t.visible)})),n.object=a):console.error("Please provide the object input data")}}class BPObjectSetPickable extends BaseNode3D{static config={name:"BPObjectSetPickable",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"pickable",type:"boolean",value:!0},{name:"recursive",type:"boolean",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.pickable||!1,s=t.recursive;a?(this.traverseObject(a,(e=>{e&&e.setPickable(o,s)})),n.object=a):console.error("Please provide the object input data")}}class BPObjectAlwaysOnTop extends BaseNode3D{static config={name:"BPObjectAlwaysOnTop",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"alwaysOnTop",type:"boolean",value:!0}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.alwaysOnTop||!1;a?(this.traverseObject(a,(e=>{e&&(e.alwaysOnTop=o)})),n.object=a):console.error("Please provide the object input data")}}class BPObjectShowAxes extends BaseNode3D{static config={name:"BPObjectShowAxes",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"show",type:"boolean",value:!0},{name:"length",type:"number",value:10}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object,o=t.show||!1,s=t.length;a?(this.traverseObject(a,(e=>{e&&(e.helper.axes=o,e.helper.axesLength=s)})),n.object=a):console.error("Please provide the object input data")}}class BPCreate3DObject extends BPCreateObject{static config={name:"BPCreate3DObject",inputs:[...BPCreateObject.config.inputs,{name:"position",type:"vector3",value:[0,0,0],unit:"m"},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1,unit:"角度"},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[...BPCreateObject.config.outputs,{name:"complete",type:"exec"}]};constructor(){super()}}class BPDestroyObject extends BaseNode3D{static config={name:"BPDestroyObject",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){const a=t.object||new THING.Selector;this.traverseObject(a,(e=>{e.destroy()}))}}class BPQueryObjectByDistance extends BPQueryObject{static config={name:"BPQueryObjectByDistance",desc:"查询半径空间内符合条件的对象（排除中心对象）",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"center",type:["vector3","object","selector"],value:[0,0,0],desc:"支持输入中心点坐标或对象"},{name:"radius",type:"number",value:10,unit:"m"},...BPQueryObject.config.inputs.filter((e=>!("exec"==e.name||"object"==e.name)))],outputs:[...BPQueryObject.config.outputs,{name:"center",type:["vector3","object","selector"],enabled:!1}]};constructor(){super()}onExecute(e,t,n){let a,o=t.center||[0,0,0],s=t.radius||0,c=t.containsChild,i=t.chainQuery,r=t.dynamic,l=this.buildCondition(t).stringCondition,p=this.buildCondition(t).regCondition;o.isSelector&&(o=o[0]),o.isBaseObject&&(a=o,o=o.position);let u=this.app.query((e=>(!a||e!=a)&&(!(THING.Math.getDistance(o,e.position)>s)&&(i?!(l&&!THING.Selector.testByExpression(l,e))&&!(p&&!p.test(e.name)):!(!l||!THING.Selector.testByExpression(l,e))||(!(!p||!p.test(e.name))||!l&&!p)))),{recursive:c,dynamic:r,onAdd:e=>{n.object=e,this.syncRun("onAdd",n)},onRemove:e=>{n.object=e,this.syncRun("onRemove",n)}});this.result=u,n.result=u,n.center=o}}class BPGetCurrentObject extends BaseNode3D{constructor(){super()}static config={name:"BPGetCurrentObject",inputs:[],outputs:[{name:"object",type:"selector"}]};onStop(){}onExecute(e,t,n){n.object=new THING.Selector([this._blueprint.object])}}class BPObjectSetOcclusion extends BaseNode3D{static config={name:"BPObjectSetOcclusion",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"occlusion",type:"boolean",value:!0}],outputs:[{name:"next",type:"exec"},{name:"occluded",type:"callback"},{name:"notOccluded",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super()}_onOcclusionChange(e){const t=this;e.occlusionTester.onOcclusionChange((n=>{n?t.syncRun("occluded",{object:e,occluded:n}):t.syncRun("notOccluded",{object:e,occluded:n})}))}onExecute(e,t,n){const a=t.object,o=t.occlusion;if(a)if(o)if(a.addComponent(THING.OcclusionTesterComponent,"occlusionTester"),a.isSelector){const e=a.length;for(let t=0;t<e;t++){const e=a[t];this._onOcclusionChange(e)}}else this._onOcclusionChange(a);else a.removeComponent("occlusionTester")}onStop(){}}class BPGetSelectionObjects extends BaseNode3D{constructor(){super()}static config={name:"BPGetSelectionObjects",inputs:[],outputs:[{name:"objects",type:"selector"}]};onStop(){}onExecute(e,t,n){n.objects=this.app.selection?.objects||new THING.Selector}}class BaseObjectSetStyle extends BaseNode3D{static config={name:"BaseObjectSetStyle",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"time",type:"number",value:0,enabled:!1,unit:"s"},{name:"loopType",type:"select",value:["Once","Repeat","PingPong","Blink"],enabled:!1},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(e,t){super(),this.timer,this._prop=e,this._startInpName=t,this._gradientName=`${e}Gradient`}onExecute(e,t,n){this._objCtr=t.object;let a=this.handleTime(t.time||0),o=!1,s=t.loopType||"Once",c=t.enable,i=t.recursive??!0;this.startValue=t[this._startInpName],this.startValue&&"color"===this._prop&&(this.startValue=this.parseColor(this.startValue)),this.value=t[this._prop],this.value&&"color"===this._prop&&(this.value=this.parseColor(this.value)),this._objCtr&&("Blink"===s&&(o=!0,s="Repeat"),c?(this.traverseObject(this._objCtr,(e=>{if(0!==a){let t,n,c=this.startValue||e.style[this._prop];if("color"===this._prop&&"string"==typeof c&&(c=this.parseColor(c)),i){const e=`style/${this._prop}`;t={[e]:c},n={[e]:this.value}}else{const e=`body/style/${this._prop}`;t={[e]:c},n={[e]:this.value}}e.lerp.to({from:t,to:n,time:a,loopType:s,noInterp:o},this._gradientName)}else{let t=e.lerp?._getTweenByName(this._gradientName);t&&e.lerp.stop(this._gradientName)}})),0===a&&this.setStyleProp(this._objCtr,this._prop,this.value,i)):(this.traverseObject(this._objCtr,(e=>{let t=e.lerp?._getTweenByName(this._gradientName);t&&e.lerp.stop(this._gradientName)})),this.setStyleProp(this._objCtr,this._prop,null,i)),n.object=this._objCtr)}onStop(){this.traverseObject(this._objCtr,(e=>{if(!e.destroyed){let t=e.lerp?._getTweenByName(this._gradientName);t&&t.stop(this._gradientName)}}))}}class BPObjectSetColor extends BaseObjectSetStyle{static config={name:"BPObjectSetColor",advanced:!0,inputs:[...BaseObjectSetStyle.config.inputs,{name:"color",type:"color",value:"#ffffff"},{name:"startColor",type:"color",enabled:!1}],outputs:[...BaseObjectSetStyle.config.outputs]};constructor(){super("color","startColor")}}class BPObjectSetMetalness extends BaseObjectSetStyle{static config={name:"BPObjectSetMetalness",advanced:!0,group:"Custom",inputs:[...BaseObjectSetStyle.config.inputs,{name:"metalness",type:"number"},{name:"startMetalness",type:"number",enabled:!1}],outputs:[...BaseObjectSetStyle.config.outputs]};constructor(){super("metalness","startMetalness")}}class BPObjectSetRoughness extends BaseObjectSetStyle{static config={name:"BPObjectSetRoughness",advanced:!0,group:"Custom",inputs:[...BaseObjectSetStyle.config.inputs,{name:"roughness",type:"number"},{name:"startRoughness",type:"number",enabled:!1}],outputs:[...BaseObjectSetStyle.config.outputs]};constructor(){super("roughness","startRoughness")}}class BPObjectSetEmissive extends BaseNode3D{static config={name:"BPObjectSetEmissive",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"emissive",type:"color",value:"#ffffff"},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this.timer}onExecute(e,t,n){this._objCtr=t.object;let a=t.enable,o=null==t.recursive||t.recursive;this._objCtr&&(a?this.setStyleProp(this._objCtr,"emissive",t.emissive,o):this.setStyleProp(this._objCtr,"emissive",null,o),n.object=this._objCtr)}onStop(){}}class BPObjectSetOutline extends BaseNode3D{static config={name:"BPObjectSetOutline",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"outlineColor",type:"color",value:"#ffffff"},{name:"enableBlink",type:"boolean",value:!1,enabled:!1},{name:"time",type:"number",enabled:!1,unit:"s"},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this.blinkTag="BP_outlineBlink"}onExecute(e,t,n){this.object=t.object;let a=t.outlineColor,o=t.enable,s=t.enableBlink,c=this.handleTime(t.time||1),i=null==t.recursive||t.recursive;if(this.object){if(o)if(s&&0!==c){let e=Date.now();this.object.on("update",(t=>{let n=Date.now(),o=Math.floor((n-e)/c)%2;if(t.object.style){let e=t.object.style.outlineColor;o&&e?i?t.object.style.outlineColor=null:t.object.body.style.outlineColor=null:o||e||(i?t.object.style.outlineColor=a:t.object.body.style.outlineColor=a)}}),this.blinkTag)}else this.object.off("update",this.blinkTag),this.setStyleProp(this.object,"outlineColor",a,i);else this.object.off("update",this.blinkTag),this.setStyleProp(this.object,"outlineColor",null,i);n.object=this.object}}onStop(){this.object.off("update",this.blinkTag)}}class BPObjectSetOpacity extends BaseNode3D{static config={name:"BPObjectSetOpacity",advanced:!0,group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"opacity",type:"number",value:1},{name:"startOpacity",type:"number",enabled:!1},{name:"time",type:"number",value:"0",enabled:!1,unit:"s"},{name:"loopType",type:"select",value:["Once","Repeat","PingPong","Blink"],enabled:!1},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){this._object=t.object;let a=t.opacity,o=t.startOpacity,s=this.handleTime(t.time||0),c=t.loopType||"Once",i=t.enable,r=!1,l=null==t.recursive||t.recursive;this._object&&("Blink"===c&&(r=!0,c="Repeat"),i?(this.traverseObject(this._object,(e=>{if(0!==s){let t,n;l?(t={"style/opacity":o??e.style.opacity??1},n={"style/opacity":a}):(t={style:{opacity:o??e.style.opacity??1}},n={style:{opacity:a}}),e.lerp.to({from:t,to:n,time:s,loopType:c,noInterp:r},"opacityGradient")}else{let t=e.lerp?._getTweenByName("opacityGradient");t&&e.lerp.stop("opacityGradient")}})),0===s&&this.setStyleProp(this._object,"opacity",a,l)):(this.traverseObject(this._object,(e=>{let t=e.lerp?._getTweenByName("opacityGradient");t&&e.lerp.stop("opacityGradient")})),this.setStyleProp(this._object,"opacity",1,l)),n.object=this._object)}onStop(){this.traverseObject(this._objCtr,(e=>{if(!e.destroyed){let t=e.lerp?._getTweenByName("opacityGradient");t&&t.stop("opacityGradient")}}))}}class BPObjectSetTransparent extends BaseNode3D{static config={name:"BPObjectSetTransparent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"recursive",type:"boolean",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.enable||!1,s=t.recursive;a?(this.setStyleProp(a,"transparent",o,s),n.object=a):console.error("Please provide the object input data")}}class BPObjectSetVisible extends BaseNode3D{static config={name:"BPObjectSetVisible",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"visible",type:"boolean",value:!0},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.visible,s=t.recursive??!0;a?(this.traverseObject(a,(e=>{e&&void 0!==o&&e.setVisible(o,s)})),n.object=a):console.error("Please provide the object input data")}}class BPShowObject extends BPObjectSetVisible{static config={name:"BPShowObject",advanced:!0,inputs:[...BPObjectSetVisible.config.inputs.filter((e=>"visible"!==e.name))],outputs:[...BPObjectSetVisible.config.outputs]};constructor(){super()}onExecute(e,t,n){t.visible=!0,super.onExecute(e,t,n)}}class BPHideObject extends BPObjectSetVisible{static config={name:"BPHideObject",advanced:!0,inputs:[...BPObjectSetVisible.config.inputs.filter((e=>"visible"!==e.name))],outputs:[...BPObjectSetVisible.config.outputs]};constructor(){super()}onExecute(e,t,n){t.visible=!1,super.onExecute(e,t,n)}}class BPShowBoundingBox extends BaseNode3D{static config={name:"BPShowBoundingBox",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"show",type:"boolean",value:!0},{name:"type",type:"select",value:["AABB","OBB"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.type||"AABB",o=t.object||new THING.Selector,s=t.show;o?(this.traverseObject(o,(e=>{var t;e&&(s?(t=e,"AABB"===a?t.helper.boundingBox.visible=!0:t.helper.orientedBox.visible=!0):function(e){"AABB"===a?e.helper.boundingBox.visible=!1:e.helper.orientedBox.visible=!1}(e))})),n.object=o):console.error("Please provide the object input data")}onStop(){}}class BPObjectSetWireframe extends BaseNode3D{static config={name:"BPObjectSetWireframe",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=null==t.recursive||t.recursive;a?(this.setStyleProp(a,"wireframe",t.enable,o),n.object=a):console.error("Please provide the object input data")}}class BPObjectSetTexture extends BaseNode3D{static config={name:"BPObjectSetTexture",advanced:!0,group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"texture",type:"string",value:`${BaseNode3D.BASEURL}image/alarm_build.png`},{name:"repeat",type:"vector2",value:[1,1],enabled:!1},{name:"offset",type:"vector2",value:[0,0],enabled:!1},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.texture,s=t.enable,c=null==t.recursive||t.recursive,i={};if(t.repeat&&(i.repeat=t.repeat),t.offset&&(i.offset=t.offset),!a)return void console.error("Please provide the object input data");let r=new THING.ImageTexture(o);s?(this.setStyleProp(a,"image",r,c),0!==Object.keys(i).length&&this.setStyleProp(a,"uv",i,c)):this.setStyleProp(a,"image",null,c),n.object=a}}class BPObjectSetTransformControl extends BaseNode3D{static config={name:"BPObjectSetTransformControl",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"mode",type:"select",value:["translate","angle","scale"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){this._objCtr=t.object,this._tag="TransformControlTag",this._mode=t.mode;let a,o=t.enable;if(this._objCtr){if(a=this._objCtr.isSelector?this._objCtr:[this._objCtr],!o&&this._objCtr.controlObject.TransformControlTag)this._objCtr.controlObject.removeComponent(this._tag),this._objCtr.controlObject=null;else if(o&&!this._objCtr.controlObject){this.controlObject=new THING.BaseObject3D;const e=new THING.EXTEND.TransformControlComponent;this.controlObject.addComponent(e,this._tag),this._objCtr.controlObject=this.controlObject,this.controlObject[this._tag].setObjects(a,!1)}this._objCtr.controlObject.TransformControlTag&&(this._objCtr.controlObject.TransformControlTag.mode=this._mode),n.object=this._objCtr}else console.error("Please provide the object input data")}onStop(){this.controlObject&&this.controlObject.removeComponent(this._tag)}}class BPObjectSetEdge extends BaseNode3D{static config={name:"BPObjectSetEdge",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"enable",type:"boolean",value:!0},{name:"color",type:"color",value:"#ffffff"},{name:"opacity",type:"number"},{name:"glow",type:"boolean"},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.enable,s=null==t.recursive||t.recursive;if(!a)return void console.error("Please provide the object input data");let c={};(o||0==o)&&(c.enable=o),t.color&&(c.color=t.color),t.opacity&&(c.opacity=t.opacity),t.glow&&(c.glow=t.glow),this.setStyleProp(a,"edge",c,s),n.object=a}}class BPObjectSetGlow extends BaseNode3D{static config={name:"BPObjectSetGlow",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"glow",type:"number",value:.5},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=null==t.recursive||t.recursive;a&&(this.setStyleProp(a,"effect",{glow:t.glow},o),n.object=a)}}class BPObjectResetStyle extends BaseNode3D{static config={name:"BPObjectResetStyle",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object;a?(this.traverseObject(a,(e=>{if(e){e.style.image=null,e.style.opacity=1,e.style.color=null,e.style.effect||(e.style.effect={}),e.style.effect.glow=0,e.style.edge||(e.style.edge={}),e.style.edge.enable=!1,e.style.outlineColor=null,e.style.wireframe=!1;let t=e.lerp?._getTweenByName("colorGradient");t&&t.stop();let n=e.lerp?._getTweenByName("opacityGradient");n&&n.stop(),e.off("update","BP_outlineBlink"),e.off("update","每帧改变透明度")}})),n.object=a):console.error("Please provide the object input data")}}class BPObjectGetName extends BaseObjectGetAttribute{static config={name:"BPObjectGetName",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"name",type:"string"}]};constructor(){super("name","name")}}class BPObjectSetName extends BaseNode3D{static config={name:"BPObjectSetName",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"name",type:"string"}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object,o=t.name;n.object=a,a?this.traverseObject(a,(e=>{e.name=o})):console.error("Please provide the object input data")}}class BPObjectGetAttribute extends BaseObjectGetAttribute{static config={name:"BPObjectGetAttribute",inputs:[...BaseObjectGetAttribute.config.inputs,{name:"key",type:"string"}],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"value",type:"any"}]};constructor(){super()}onExecute(e,t,n){this._key=t.key,super.onExecute(e,t,n)}}class BPObjectSetAttribute extends BaseNode3D{static config={name:"BPObjectSetAttribute",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"key",type:"string"},{name:"value",type:"any"}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object,o=t.key,s=t.value;a?(this.traverseObject(a,(e=>{e.setAttribute(o,s)})),n.object=a):console.error("Please provide the object input data")}}class BPObjectSetUserData extends BaseNode3D{static config={name:"BPObjectSetUserData",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"key",type:"string"},{name:"value",type:"any"}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object,o=t.key,s=t.value;a?(this.traverseObject(a,(e=>{e.userData[o]=s})),n.object=a):console.error("Please provide the object input data")}}class BPObjectGetUserData extends BaseObjectGetAttribute{static config={name:"BPObjectGetUserData",inputs:[...BaseObjectGetAttribute.config.inputs,{name:"key",type:"string"}],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"value",type:"any"}]};constructor(){super()}onExecute(e,t,n){const a=t.key;this._key=`userData/${a}`,super.onExecute(e,t,n)}}class BPLightSetIntensity extends BaseNode3D{static config={name:"BPLightSetIntensity",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]},{name:"value",type:"number",value:.5}],outputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.light,o=t.value;a?(this.traverseObject(a,(e=>{e.setAttribute("intensity",o)})),n.light=a):console.error("Please provide the light input data")}}class BPLightSetAngle extends BaseNode3D{static config={name:"BPLightSetAngle",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]},{name:"value",type:"number",value:30}],outputs:[{name:"next",type:"exec"},{name:"light",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.light,o=t.value;a?(this.traverseObject(a,(e=>{e.setAttribute("angle",o)})),n.light=a):console.error("Please provide the light input data")}}class BPLightSetPenumbra extends BaseNode3D{static config={name:"BPLightSetPenumbra",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]},{name:"value",type:"number",value:.5}],outputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.light,o=t.value;a?(this.traverseObject(a,(e=>{e.setAttribute("penumbra",o)})),n.light=a):console.error("Please provide the light input data")}}class BPLightSetDistance extends BaseNode3D{static config={name:"BPLightSetDistance",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]},{name:"value",type:"number",value:25}],outputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.light,o=t.value;a?(this.traverseObject(a,(e=>{e.setAttribute("distance",o)})),n.light=a):console.error("Please provide the light input data")}}class BPLightSetShadow extends BaseNode3D{static config={name:"BPLightSetShadow",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]},{name:"value",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"},{name:"light",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.light,o=t.value;a?(this.traverseObject(a,(e=>{e.setAttribute("enableShadow",o)})),n.light=a):console.error("Please provide the light input data")}}class BPObjectSetCastShadow extends BaseNode3D{static config={name:"BPObjectSetCastShadow",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"castShadow",type:"boolean",value:!0},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.castShadow,s=!(0==t.recursive);a&&(this.traverseObject(a,(e=>{e&&void 0!==o&&e.setCastShadow(o,s)})),n.object=a)}}class BPEnableObjectCastShadow extends BPObjectSetCastShadow{static config={name:"BPEnableObjectCastShadow",advanced:!0,inputs:[...BPObjectSetCastShadow.config.inputs.filter((e=>"castShadow"!==e.name))],outputs:[...BPObjectSetCastShadow.config.outputs]};constructor(){super()}onExecute(e,t,n){t.castShadow=!0,super.onExecute(e,t,n)}}class BPDisableObjectCastShadow extends BPObjectSetCastShadow{static config={name:"BPDisableObjectCastShadow",advanced:!0,inputs:[...BPObjectSetCastShadow.config.inputs.filter((e=>"castShadow"!==e.name))],outputs:[...BPObjectSetCastShadow.config.outputs]};constructor(){super()}onExecute(e,t,n){t.castShadow=!1,super.onExecute(e,t,n)}}class BPObjectGetMetalness extends BaseObjectGetAttribute{static config={name:"BPObjectGetMetalness",advanced:!0,group:"Custom",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"value",type:"number"}]};constructor(){super("style/metalness")}}class BPObjectGetRoughness extends BaseObjectGetAttribute{static config={name:"BPObjectGetRoughness",advanced:!0,group:"Custom",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"value",type:"number"}]};constructor(){super("style/roughness")}}class BPObjectMovePath extends BaseNode3D{static config={name:"BPObjectMovePath",advanced:!0,desc:"obj.movePath",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"path",type:"any",editor:"PathEditor"},{name:"orientToPath",type:"boolean",value:!0,enabled:!1},{name:"time",type:"number",value:1,unit:"s"},{name:"loopType",type:"select",value:["Repeat","Once","PingPong"],enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1},{name:"showLine",type:"boolean",value:!1,enabled:!1},{name:"lineImage",type:"string",enabled:!1},{name:"lineSpeed",type:"number",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super(),this.lines=new THING.Selector}onExecute(e,t,n){const a=t.object;let o=this.handleTime(t.time),s=t.orientToPath??!0,c=t.loopType||"Repeat";c=THING.LoopType[c];let i=t.spaceType||"Local";i=THING.SpaceType[i];let r=t.path||[[10,0,0],[10,0,10],[0,0,10],[0,0,0]],l=t.showLine,p=t.lineImage,u=t.lineSpeed;if(a){if("string"==typeof r&&(r=JSON.parse(r)),this.traverseObject(a,(e=>{if(e&&(e.movePath(r,{time:o,loopType:c,spaceType:i,orientToPath:s,complete:()=>{this.lines&&(this.lines.destroy(),this.lines.clear()),this.run("complete",n)},onStop:()=>{this.lines&&(this.lines.destroy(),this.lines.clear())}}),l&&"Local"==i)){let t=r.map((t=>e.localToWorld(t))),n=new THING.RouteLine({parent:this.getParent(),points:t,style:{image:p?this.getFullPath(p):null}});p&&u&&n.on("update",(e=>{n.style.uv.offset[0]=n.style.uv.offset[0]-e.deltaTime*u})),this.lines.push(n)}})),l&&"World"==i){let e=new THING.RouteLine({parent:this.getParent(),points:r,style:{image:p?this.getFullPath(p):null}});p&&u&&e.on("update",(t=>{e.style.uv.offset[0]=e.style.uv.offset[0]-t.deltaTime*u})),this.lines.push(e)}n.object=a}else console.error("Please provide the object input data")}onStop(){this.lines&&(this.lines.destroy(),this.lines.clear())}}class BPObjectMoveTo extends BaseNode3D{static config={name:"BPObjectMoveTo",advanced:!0,group:"Basic",desc:"obj.moveTo",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"position",type:"vector3",value:[0,0,0]},{name:"orientToPath",type:"boolean",value:!0,enabled:!1},{name:"time",type:"number",value:1,unit:"s"},{name:"loopType",type:"select",value:["Repeat","Once","PingPong"],enabled:!1},{name:"spaceType",type:"select",value:["Self","Local","World"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object,o=t.position||[0,0,0],s=this.handleTime(t.time),c=t.orientToPath??!0;let i=t.loopType||"Repeat",r=t.spaceType||"Self";r=THING.SpaceType[r],i=THING.LoopType[i],a?(this.traverseObject(a,(e=>{e&&e.moveTo(o,{time:s,loopType:i,spaceType:r,orientToPath:c,complete:()=>{this.run("complete",n)}})})),n.object=a):console.error("Please provide the object input data")}}class BPObjectRotateTo extends BaseNode3D{static config={name:"BPObjectRotateTo",advanced:!0,group:"Basic",desc:"obj.rotateTo obj.rotateOnAxis",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"angles",type:"vector3",value:[0,0,0]},{name:"time",type:"number",value:1,unit:"s"},{name:"loopType",type:"select",value:["Repeat","Once","PingPong"],enabled:!1},{name:"spaceType",type:"select",value:["Self","Local","World"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback",enabled:!1},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object;let o=t.angles||[0,0,0],s=this.handleTime(t.time),c=t.loopType||"Repeat";c=THING.LoopType[c];let i=t.spaceType||"Self";i=THING.SpaceType[i],a?(this.traverseObject(a,(e=>{e&&e.rotateTo(o,{time:s,spaceType:i,loopType:c,complete:()=>{this.run("complete",n)}})})),n.object=a):console.error("Please provide the object input data")}}class BPObjectStopRotating extends BaseNode3D{static config={name:"BPObjectStopRotating",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object;a?(this.traverseObject(a,(e=>{e&&e.stopRotating()})),n.object=a):console.error("Please provide the object input data")}}class BPObjectScaleTo extends BaseNode3D{static config={name:"BPObjectScaleTo",advanced:!0,group:"Basic",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"scale",type:"vector3",value:[1,1,1]},{name:"time",type:"number",value:1,unit:"s"},{name:"loopType",type:"select",value:["Repeat","Once","PingPong"],enabled:!1},{name:"spaceType",type:"select",value:["Self","Local","World"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback",enabled:!1},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object;let o=t.scale||[0,0,0];const s=this.handleTime(t.time);let c=t.loopType||"Repeat";c=THING.LoopType[c];let i=t.spaceType||"Self";i=THING.SpaceType[i],a?(this.traverseObject(a,(e=>{e&&e.scaleTo(o,{time:s,loopType:c,spaceType:i,complete:()=>{this.run("complete",n)}})})),n.object=a):console.error("Please provide the object input data")}}class BPObjectStopScaling extends BaseNode3D{static config={name:"BPObjectStopScaling",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object;a?(this.traverseObject(a,(e=>{e&&e.stopScaling()})),n.object=a):console.error("Please provide the object input data")}}class BPObjectFadeIn extends BaseNode3D{static config={name:"BPObjectFadeIn",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"time",type:"number",value:"1",unit:"s"}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object;let o=this.handleTime(t.time||1);a?(this.traverseObject(a,(e=>{e&&e.fadeIn({time:o,complete:()=>{this.run("complete",n)}})})),n.object=a):console.error("Please provide the object input data")}}class BPObjectFadeOut extends BaseNode3D{static config={name:"BPObjectFadeOut",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"time",type:"number",value:1,unit:"s"}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object;let o=this.handleTime(t.time||1);a?(this.traverseObject(a,(e=>{e&&e.fadeOut({time:o,complete:()=>{this.run("complete",n)}})})),n.object=a):console.error("Please provide the object input data")}}class BPObjectStopFading extends BaseNode3D{static config={name:"BPObjectStopFading",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object;a?(this.traverseObject(a,(e=>{e&&e.stopFading()})),n.object=a):console.error("Please provide the object input data")}}class BPObjectPlayAnimation extends BaseNode3D{static config={name:"BPObjectPlayAnimation",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"name",type:"string"},{name:"loopType",type:"select",value:["Repeat","Once","PingPong"],enabled:!1},{name:"speed",type:"number",value:1,enabled:!1},{name:"stopAll",type:"boolean",value:!0,enabled:!1},{name:"reverse",type:"boolean",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super()}async onExecute(e,t,n){this._objCtr=t.object,this._nameAnimation=t.name;const a=t.speed||1,o=t.reverse||!1;let s=t.loopType||"Repeat";const c=t.stopAll??!0;if(s=THING.LoopType[s],!this._objCtr)return void console.error("Please provide the object input data");const i=[];this.traverseObject(this._objCtr,(e=>{i.push(e.waitForComplete())})),await Promise.all(i),this.traverseObject(this._objCtr,(async e=>{e.animationNames.indexOf(this._nameAnimation)>=0&&e.playAnimation({name:this._nameAnimation,speed:a,reverse:o,loopType:s,stopAll:c,onComplete:()=>{this.run("complete",n)}})})),n.object=this._objCtr}onStop(){this.traverseObject(this._objCtr,(e=>{e&&!e.destroyed&&e.animationNames.indexOf(this._nameAnimation)>=0&&e.stopAnimation(this._nameAnimation)}))}}class BPObjectStopAnimation extends BaseNode3D{static config={name:"BPObjectStopAnimation",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"name",type:"string",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){this._objCtr=t.object,this._nameAnimation=t.name,n.object=this._objCtr,this._objCtr?this.traverseObject(this._objCtr,(e=>{e&&e.hasAnimation(this._nameAnimation)?e.stopAnimation(this._nameAnimation):e&&!this._nameAnimation&&e.stopAllAnimations()})):console.error("Please provide the object input data")}onStop(){}}class BPObjectPauseAnimation extends BaseNode3D{static config={name:"BPObjectPauseAnimation",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"name",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){this._objCtr=t.object;let a=t.name,o=t.pause;n.object=this._objCtr,this._objCtr?this.traverseObject(this._objCtr,(e=>{a?e.hasAnimation(a)&&(o?e.pauseAnimation(a):e.resumeAnimation(a)):o?e.pauseAllAnimations():e.resumeAllAnimations()})):console.error("Please provide the object input data")}}class BPObjectGetAnimationNames extends BaseObjectGetAttribute{static config={name:"BPObjectGetAnimationNames",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"names",type:"any"}]};constructor(){super("animationNames","names")}}class BPCreateSpace3D extends BaseNode3D{static config={name:"BPCreateSpace3D",inputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3",value:[0,0,0]},{name:"size",type:"vector3",value:[1,1,1],unit:"m"},{name:"show",type:"boolean",value:!1}],outputs:[{name:"next",type:"exec"},{name:"space",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let{position:a=[0,0,0],size:o=[1,1,1],show:s=!1}=t;this.space=new THING.Space3D({parent:this.getParent(),position:a,size:o}),this.space.showBounding(s),n.space=this.space}onStop(){this.space.destroy(),this.space=null}}class BPSpace3DShowBounding extends BaseNode3D{static config={name:"BPSpace3DShowBounding",inputs:[{name:"exec",type:"exec"},{name:"space",type:["object","selector"]},{name:"show",type:"boolean",value:!0}],outputs:[{name:"next",type:"exec"},{name:"space",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.space,o=t.show||!1;a?(this.traverseObject(a,(e=>{e.showBounding(o)})),n.space=a):console.error("Please provide the space input data")}}class BPSpace3DIsContains extends BaseNode3D{static config={name:"BPSpace3DIsContains",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"space",type:["object","selector"]},{name:"object",type:["object","selector"]}],outputs:[{name:"contains",type:"callback"},{name:"notContains",type:"callback"},{name:"space",type:["object","selector"],enabled:!1},{name:"object",type:["object","selector"],enabled:!1}]};constructor(){super()}onExecute(e,t,n){let a=t.space,o=t.object;n.space=a,n.object=o,a&&o?(a.isSelector&&(a=a[0]),o.isSelector&&(o=o[0]),a.contains(o,!0)?this.syncRun("contains",n):this.syncRun("notContains",n)):console.error("Please provide the correct input data")}onStop(){}}class BPSpace3DIsIntersects extends BaseNode3D{static config={name:"BPSpace3DIsIntersects",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"space",type:["object","selector"]},{name:"object",type:["object","selector"]}],outputs:[{name:"intersects",type:"callback"},{name:"notIntersects",type:"callback"},{name:"space",type:["object","selector"],enabled:!1},{name:"object",type:["object","selector"],enabled:!1}]};constructor(){super()}onExecute(e,t,n){let a=t.space,o=t.object;n.space=a,n.object=o,a&&o?(a.isSelector&&(a=a[0]),o.isSelector&&(o=o[0]),a.intersects(o,!0)?this.syncRun("intersects",n):this.syncRun("notIntersects",n)):console.error("Please provide the correct input data")}onStop(){}}class BPSpace3DIsDisjoint extends BaseNode3D{static config={name:"BPSpace3DIsDisjoint",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"space",type:["object","selector"]},{name:"object",type:["object","selector"]}],outputs:[{name:"disjoint",type:"callback"},{name:"notDisjoint",type:"callback"},{name:"space",type:["object","selector"],enabled:!1},{name:"object",type:["object","selector"],enabled:!1}]};constructor(){super()}onExecute(e,t,n){let a=t.space,o=t.object;n.space=a,n.object=o,a&&o?(a.isSelector&&(a=a[0]),o.isSelector&&(o=o[0]),a.disjoint(o,!0)?this.syncRun("disjoint",n):this.syncRun("notDisjoint",n)):console.error("Please provide the correct input data")}onStop(){}}class BPObjectGetPosition extends BaseObjectGetAttribute{static config={name:"BPObjectGetPosition",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"position",type:"vector3"}]};constructor(){super("position","position")}}class BPObjectSetPosition extends BaseNode3D{static config={name:"BPObjectSetPosition",advanced:!0,group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"position",type:"vector3",value:[0,0,0]},{name:"offset",type:"boolean",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object,o=t.position,s=t.offset||!1,c=t.spaceType||"Local";a?(this.traverseObject(a,(e=>{s?e.translate(o):o&&("Local"===c?e.localPosition=o:e.position=o)})),n.object=a):console.error("Please provide the object input data")}}class BPObjectLookAt extends BaseNode3D{static config={name:"BPObjectLookAt",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"target",type:["vector3","object","selector"],value:[0,0,0]},{name:"always",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]},{name:"target",type:["vector3","object","selector"],value:[0,0,0]}]};constructor(){super()}onExecute(e,t,n){this._objCtr=t.object;let a=t.target||[0,0,0];const o=t.onPlane,s=t.always||!1,c=o?THING.AxisType.Y:null;n.object=this._objCtr,this._objCtr?(a.isSelector&&(a=a[0]),this.traverseObject(this._objCtr,(e=>{e.lookAt(a,{always:s,lockAxis:c})})),n.target=a):console.error("Please provide the object input data")}onStop(){this.traverseObject(this._objCtr,(e=>{e&&!e.destroyed&&e.lookAt(null)}))}}class BPObjectFlyTo extends BaseNode3D{static config={name:"BPObjectFlyTo",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"position",type:"vector3",value:[0,0,0]},{name:"target",type:["vector3","object","selector"],value:[0,0,0]},{name:"time",type:"number",value:1,unit:"s"},{name:"delayTime",type:"number",value:0,enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback"},{name:"target",type:["vector3","object","selector"]}]};constructor(){super()}onExecute(e,t,n){this._object=t.object;let a=t.target||[0,0,0],o=t.position||[0,0,0],s=this.handleTime(t.time),c=1e3*t.delayTime||0,i=this;this._object?(this._object.isSelector&&(this._object=this._object[0]),a.isSelector&&(a=a[0]),n.target=a,this._object.target=THING.Math.addVector(this._object.position,this._object.forward),this._object.flyTo({target:a,position:o,time:s,delayTime:c,complete:()=>{i.run("complete",n)}})):console.error("Please provide the object input data")}onStop(){this._object&&!this._object.destroyed&&this._object.stopFlying()}}class BPObjectStopFlying extends BaseNode3D{static config={name:"BPObjectStopFlying",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.object;a?(a.isSelector&&(a=a[0]),a.stopFlying()):console.error("Please provide the object input data")}}class BPCameraLookAt extends BaseNode3D{static config={name:"BPCameraLookAt",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"target",type:["vector3","object","selector"],value:[0,0,0],editor:"CameraEditor"},{name:"always",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"target",type:["vector3","object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.target||[0,0,0];this._camera=t.camera;const o=t.onPlane,s=t.always||!1,c=o?THING.AxisType.Y:null;this._camera||(this._camera=this.app.camera),this._camera.isSelector&&(this._camera=this._camera[0]),a.isSelector&&(a=a[0]),this._camera.lookAt(a,{always:s,lockAxis:c}),n.target=a}onStop(){this._camera.destroyed||this._camera.lookAt(null)}}class BPObjectGetPivot extends BaseObjectGetAttribute{static config={name:"BPObjectGetPivot",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"pivot",type:"vector3"}]};constructor(){super("pivot","pivot")}}class BPObjectSetPivot extends BaseNode3D{static config={name:"BPObjectSetPivot",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"pivot",type:"vector3",value:[0,0,0]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object,o=t.pivot||[0,0,0];a?(this.traverseObject(a,(e=>{e&&(e.pivot=o)})),n.object=a):console.error("Please provide the object input data")}}class BPObjectSetRotation extends BaseNode3D{static config={name:"BPObjectSetRotation",advanced:!0,group:"Basic",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"rotation",type:"vector3",value:[0,0,0]},{name:"offset",type:"boolean",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object,o=t.rotation;let s=t.offset,c=t.spaceType||"Local";c=THING.SpaceType[c];const i="Local"===c;a?(this.traverseObject(a,(e=>{if(s){let t=THING.Math.addVector(i?e.localRotation:e.rotation,o);i?e.localRotation=t:e.rotation=t}else o&&(i?e.localRotation=o:e.rotation=o)})),n.object=a):console.error("Please provide the object input data")}}class BPObjectGetRotation extends BaseObjectGetAttribute{static config={name:"BPObjectGetRotation",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"rotation",type:["array","vector3"]}]};constructor(){super("rotation","rotation")}}class BPObjectGetScale extends BaseObjectGetAttribute{static config={name:"BPObjectGetScale",inputs:[...BaseObjectGetAttribute.config.inputs],outputs:[...BaseObjectGetAttribute.config.outputs,{name:"scale",type:"vector3"}]};constructor(){super("scale","scale")}}class BPObjectSetScale extends BaseNode3D{static config={name:"BPObjectSetScale",advanced:!0,group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"scale",type:"vector3",value:[1,1,1]},{name:"offset",type:"boolean",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object,o=t.scale,s=t.offset,c=t.spaceType||"Local";c=THING.SpaceType[c];const i="Local"===c;a?(this.traverseObject(a,(e=>{if(s){let t=THING.Math.addVector(i?e.localScale:e.scale,o);i?e.localScale=t:e.scale=t}else o&&("Local"===c?e.localScale=o:e.scale=o)})),n.object=a):console.error("Please provide the object input data")}}class BPObjectStopMoving extends BaseNode3D{static config={name:"BPObjectStopMoving",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object;a?(this.traverseObject(a,(e=>{e&&e.stopMoving()})),n.object=a):console.error("Please provide the object input data")}}class BPObjectSetTransform extends BaseNode3D{static config={name:"BPObjectSetTransform",group:"Basic",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0]},{name:"scale",type:"vector3",value:[1,1,1]},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object,o=t.rotation,s=t.position,c=t.scale;let i=t.spaceType||"Local";a?(this.traverseObject(a,(e=>{"Local"===i?(o&&(e.localRotation=o),s&&(e.localPosition=s),c&&(e.localScale=c)):(o&&(e.rotation=o),s&&(e.position=s),c&&(e.scale=c))})),n.object=a):console.error("Please provide the object input data")}}class BPVolumeMesh extends BaseNode3D{static config={name:"BPVolumeMesh",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"volumeMesh",enabled:!1},{name:"name",type:"string",value:"volumeMesh",enabled:!1},{name:"data",type:"any",input:!0},{name:"alphaThreshold",type:"number",value:0,enabled:!1},{name:"opacity",type:"number",value:1},{name:"unitDistanceOpacity",type:"number",value:1.2,enabled:!1},{name:"mixType",type:"select",value:["normal","mix"]},{name:"colorRampTexture",type:"string",value:"https://cdn.uino.cn/blueprint/image/platte.png"},{name:"ValueAffectsOpacity",type:"boolean",value:!0,enabled:!1},{name:"volumeSize",type:"vector3",value:[64,64,64],enabled:!1},{name:"volumeOffset",type:"vector3",value:[0,0,0],enabled:!1},{name:"volumeRotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"heatCloudData",type:"any",input:!0},{name:"textureSize",type:"vector3",value:[32,32,32]},{name:"showRibbonImage",type:"boolean"},{name:"heatCloudDataType",type:"select",value:["volumeData","image"],title:"热云数据类型",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"volumeMesh",type:["object","selector"]}]};constructor(){super()}async onExecute(e,t,n){const{data:a,heatCloudData:o,colorRampTexture:s,id:c="volumeMesh",name:i="volumeMesh",alphaThreshold:r=0,opacity:l=1,unitDistanceOpacity:p=1.2,mixType:u="normal",ValueAffectsOpacity:m=!0,volumeSize:d=[64,64,64],volumeOffset:b=[0,0,0],volumeRotation:h=[0,0,0],textureSize:y=[32,32,32],showRibbonImage:g}=t;if(!a||!o||!s)return void console.error("Please provide the correct input data");const v=new THING.ImageTexture(s);let x;await v.waitForComplete(),x="image"===t.heatCloudDataType?new THING.ImageTexture(o):this.parseData(o);let B=this.parseData(a),j=x.range&&x.range instanceof Array?x.range.map((e=>2*e)):d;const f=new THING.EXTEND.VolumeMesh({id:c,name:i,data:B,alphaThreshold:r,opacity:l,unitDistanceOpacity:p,mixType:u,colorRampTexture:v,ValueAffectsOpacity:m,volumeSize:j,volumeOffset:b,volumeRotation:h});if(await f.waitForComplete(),f.setData({data:x,textureSize:y}),n.volumeMesh=f,g){let P=document.querySelector("#"+this.app.container.id).parentNode;function S(e,t){return(new DOMParser).parseFromString(e,"text/html").querySelector(`.${t}`)}function N(){let e=S(`<style class="ribbonImageStyle">\n\t\t\t\thtml{\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t}\n\t\t\t\t#tuli{\n\t\t\t\t\tbackground: url('${THING.Utils.resolveURL(s)}');\n\t\t\t\t\tposition:relative;bottom:50px;left:10px;z-index:10000;\n\t\t\t\t\tcursor:pointer;\n\t\t\t\t\twidth: 230px;\n\t\t\t\t\theight: 10px;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\tjustify-content: space-between;\n\t\t\t\t\talign-items: center;\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\t.hover{\n\t\t\t\t\twidth: 10px;\n\t\t\t\t\theight: 10px;\n\t\t\t\t\tborder-radius: 50%;\n\t\t\t\t\tcursor: pointer;\n\t\t\t\t\tposition: relative;\n\t\t\t\t\tborder: none;\n\t\t\t\t}\n\t\t\t\t.hover .value{\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\ttop: 20px;\n\t\t\t\t\tleft: -5px;\n\t\t\t\t\tbackground: #000;\n\t\t\t\t\tcolor: #fff;\n\t\t\t\t\tfont-size: 12px;\n\t\t\t\t\tpadding: 4px;\n\t\t\t\t\tborder-radius: 5px;\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\t\t\t\t.hover:hover{\n\t\t\t\t\tborder: 3px solid #fff;\n\t\t\t\t}\n\t\t\t\t.hover:hover .value{\n\t\t\t\t\tdisplay: block;\n\t\t\t\t}\n\t\t\t\t</style>`,"ribbonImageStyle");P.appendChild(e)}N();const E=x.minValue,C=x.maxValue,T=Array.from({length:C-E+1},((e,t)=>E+t));let _='<div class="ribbonImage" id="tuli">';T.forEach((e=>{_+=`<div class="hover"><div class="value">${e}</div></div>`})),_+="</div>",this.ribbonImage=S(_,"ribbonImage"),P.appendChild(this.ribbonImage)}this.run("complete",n)}parseData(data){return"object"==typeof data||data.startsWith("{")&&data.endsWith("}")&&(data=eval(`(${data.replace(/"/g,"'")})`)),data}onStop(){this.ribbonImage&&this.ribbonImage.remove()}}class BPGetDistance extends BaseNode3D{static config={name:"BPGetDistance",inputs:[{name:"exec",type:"exec"},{name:"v1",type:"vector3"},{name:"v2",type:"vector3"}],outputs:[{name:"next",type:"exec"},{name:"distance",type:"number"}]};constructor(){super()}onExecute(e,t,n){const{v1:a,v2:o}=t;a&&o&&(n.distance=THING.Math.getDistance(a,o))}onStop(){}}class BPGetFullPath extends BaseNode3D{static config={name:"BPGetFullPath",title:"获取完整路径",inputs:[{name:"exec",type:"exec"},{name:"path",type:"string"}],outputs:[{name:"next",type:"exec"},{name:"fullpath",type:"string",title:"绝对路径"}]};constructor(){super()}onExecute(e,t,n){n.fullpath=this.getFullPath(t.path)}}class BPCreateRelationShip extends BaseNode3D{static config={name:"BPCreateRelationShip",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"type",type:"string"},{name:"name",type:"string"},{name:"source",type:["object","selector","array"]},{name:"target",type:["object","selector","array"]},{name:"queryDirection",type:"select",value:["Out","In","InOut","None"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"relationship",type:["object","selector"]}]};constructor(){super(),this.relationships=[]}onExecute(e,t,n){let a=t.type,o=t.name,s=t.source,c=t.target,i=t.queryDirection;if(!s||!c)return void console.error("Please provide the current input data");const r={type:a,name:o,source:s,target:c,queryDirection:i},l=this.filterParams(r);let p=new THING.Relationship(l);this.relationships.push(p),n.relationship=p}onStop(){this.relationships.length&&this.relationships.forEach((e=>{e.destroy()}))}}class BPDestroyRelationShip extends BaseNode3D{static config={name:"BPDestroyRelationShip",inputs:[{name:"exec",type:"exec"},{name:"relationship",type:["object","selector","array"]}],outputs:[{name:"next",type:"exec"}]};constructor(){super(),this.relationships=[]}onExecute(e,t,n){let a=t.relationship;a&&(THING.Utils.isArray(a)?a.forEach((e=>{e.destroy()})):a.destroy())}}class BPQueryObjectByRelationShip extends BaseNode3D{static config={name:"BPQueryObjectByRelationShip",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"type",type:"string"},{name:"name",type:"string"},{name:"queryDirection",type:"select",value:["Out","In","InOut","None"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]},{name:"result",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.type,s=t.name,c=t.queryDirection;if(!a)return void console.error("Please provide the object input data");a.isSelector&&(a=a[0]);let i=a.relationship.query({type:o,name:s,queryDirection:c});n.object=t.object,n.result=i}onStop(){}}class BPQueryRelationShip extends BaseNode3D{static config={name:"BPQueryRelationShip",inputs:[{name:"exec",type:"exec"},{name:"type",type:"string"},{name:"name",type:"string"}],outputs:[{name:"next",type:"exec"},{name:"relationship",type:"array"}]};constructor(){super()}onExecute(e,t,n){let a=t.type,o=t.name,s=this.app.queryRelationships({type:a,name:o});n.relationship=s}onStop(){}}class BPCreateSpotLight extends BaseNode3D{static config={name:"BPCreateSpotLight",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3"},{name:"target",type:"vector3"},{name:"intensity",type:"number",value:.7},{name:"angle",type:"number",value:30,enabled:!1},{name:"distance",type:"number",value:100,enabled:!1},{name:"color",type:"color",value:"#FFFFFF",enabled:!1},{name:"enableShadow",type:"boolean",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"light",type:["object","selector"]}]};constructor(){super(),this._object}onExecute(e,t,n){const a=t.position?t.position:this.app.camera.position,o=t.target?t.target:this.app.camera.target;this._object=new THING.SpotLight({parent:this.getParent()}),this._object.localPosition=a,this._object.target=THING.Math.addVector(this.getParent().position,o),t.intensity&&(this._object.intensity=t.intensity),t.enableShadow&&(this._object.enableShadow=t.enableShadow),t.angle&&(this._object.angle=t.angle),t.color&&(this._object.color=t.color),t.distance&&this._object.distance,n.light=this._object}onStop(){this._object&&(this._object.destroy(),this._object=null)}}class BPSetAmbientLight extends BaseNode3D{static config={name:"BPSetAmbientLight",inputs:[{name:"exec",type:"exec"},{name:"intensity",type:"number",value:.7},{name:"color",type:"color",value:"#FFFFFF"}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onExecute(e,t,n){const a=t.intensity||.7,o=t.color||"#FFFFFF";let s=this.app;this.initialColor=s.scene.ambientLight.color,this.initIntensity=s.scene.ambientLight.intensity,s.scene.ambientLight.color=o,s.scene.ambientLight.intensity=a}onStop(){this.app.scene.ambientLight.color=this.initialColor,this.app.scene.ambientLight._initIntensity=this.initIntensity}}class BPSetMainLight extends BaseNode3D{static config={name:"BPSetMainLight",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3"},{name:"target",type:"vector3"},{name:"intensity",type:"number",value:.7},{name:"color",type:"color",value:"#FFFFFF"},{name:"enableShadow",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onSetup(){let e=this.app.scene.mainLight;this.intensity=e?e.intensity:.9,this.color=e?e.color:"#ffff",this.position=e?e.localPosition:[19.97622732059412,76.69182530991057,125.42472389758775],this.target=e?e.target:[-39.110000084741216,23.62071942081996,55.00850011444092],this.enableShadow=!e||e.enableShadow}onExecute(e,t,n){const a=t.intensity??.7,o=t.color||"#FFFFFF",s=t.position?t.position:this.position,c=t.target?t.target:this.target,i=t.enableShadow;let r=this.app;r.scene.mainLight.position=THING.Math.addVector(this.getParent().position,s),r.scene.mainLight.target=THING.Math.addVector(this.getParent().position,c),r.scene.mainLight.color=o,r.scene.mainLight.intensity=a,void 0!==i&&r.scene.mainLight.enableShadow}onStop(){this.app.scene.mainLight.color=this.color,this.app.scene.mainLight.intensity=this.intensity,this.app.scene.mainLight.position=this.position,this.app.scene.mainLight.target=this.target,this.app.scene.mainLight.enableShadow=this.enableShadow}}class BPCreateDirectionalLight extends BaseNode3D{static config={name:"BPCreateDirectionalLight",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3"},{name:"target",type:"vector3"},{name:"intensity",type:"number",value:.7},{name:"color",type:"color",value:"#FFFFFF",enabled:!1},{name:"enableShadow",type:"boolean",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"light",type:["object","selector"]}]};constructor(){super(),this._object}onExecute(e,t,n){const a=t.position?t.position:this.app.camera.position;let o=t.target?t.target:this.app.camera.target;this._object=new THING.DirectionalLight({parent:this.getParent()}),this._object.localPosition=a,this._object.target=THING.Math.addVector(this.getParent().position,o),this._object.intensity=t.intensity||.7,this._object.color=t.color||"#FFFFFF",void 0!==t.enableShadow&&(this._object.enableShadow=t.enableShadow),n.light=this._object}onStop(){this._object&&(this._object.destroy(),this._object=null)}}class BPCreateBox extends BaseNode3D{static config={name:"BPCreateBox",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"box",enabled:!1},{name:"name",type:"string",value:"box"},{name:"size",type:"vector3",value:[1,1,1]},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.name||"box",o=t.id||"box",s=t.position||[0,0,0],c=t.size||[1,1,1],i=t.rotation||[0,0,0],r=t.scale||[1,1,1],l=t.spaceType||"Local",p={id:o,name:a,parent:this.getParent(),style:{color:t.color}};"Local"===l?(p.localPosition=s,p.localScale=r,p.localRotation=i):(p.position=s,p.scale=r,p.rotation=i);let u=new THING.Box(c[0],c[1],c[2],p);this._objects.push(u),n.object=u}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateCylinder extends BaseNode3D{static config={name:"BPCreateCylinder",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"cylinder",enabled:!1},{name:"name",type:"string",value:"cylinder"},{name:"radiusTop",type:"number",value:1},{name:"radiusBottom",type:"number",value:1},{name:"height",type:"number",value:2},{name:"radialSegments",type:"number",value:64,enabled:!1},{name:"heightSegments",type:"number",value:1,enabled:!1},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.name||"box",o=t.id||"box",s=t.radiusTop,c=t.radiusBottom,i=t.height,r=t.radialSegments,l=t.heightSegments,p=t.position||[0,0,0];const u=t.rotation||[0,0,0],m=t.scale||[1,1,1];let d=t.spaceType||"Local",b={id:o,name:a,radiusTop:s,radiusBottom:c,height:i,radialSegments:r,heightSegments:l,parent:this.getParent(),style:{color:t.color}};"Local"===d?(b.localPosition=p,b.localScale=m,b.localRotation=u):(b.position=p,b.scale=m,b.rotation=u);let h=this.filterParams(b),y=new THING.Cylinder(h);this._objects.push(y),n.object=y}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateCapsule extends BaseNode3D{static config={name:"BPCreateCapsule",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"capsule",enabled:!1},{name:"name",type:"string",value:"capsule"},{name:"radius",type:"number",value:.5},{name:"height",type:"number",value:1},{name:"widthSegments",type:"number",value:64,enabled:!1},{name:"heightSegments",type:"number",value:64,enabled:!1},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.name||"box",o=t.id||"box",s=t.radius,c=t.height,i=t.widthSegments,r=t.heightSegments,l=t.position||[0,0,0],p=t.rotation||[0,0,0],u=t.scale||[1,1,1],m=t.spaceType||"Local",d={id:o,name:a,radius:s,height:c,widthSegments:i,heightSegments:r,parent:this.getParent(),style:{color:t.color}};"Local"===m?(d.localPosition=l,d.localScale=u,d.localRotation=p):(d.position=l,d.scale=u,d.rotation=p);let b=this.filterParams(d),h=new THING.Capsule(b);this._objects.push(h),n.object=h}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateTorus extends BaseNode3D{static config={name:"BPCreateTorus",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"torus",enabled:!1},{name:"name",type:"string",value:"torus"},{name:"radius",type:"number",value:.8},{name:"tube",type:"number",value:.2},{name:"tubularSegments",type:"number",value:64,enabled:!1},{name:"radialSegments",type:"number",value:64,enabled:!1},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.name||"box",o=t.id||"box",s=t.radius,c=t.tube,i=t.radialSegments,r=t.tubularSegments,l=t.position||[0,0,0],p=t.rotation||[0,0,0],u=t.scale||[1,1,1],m=t.spaceType||"Local",d={id:o,name:a,radius:s,tube:c,radialSegments:i,tubularSegments:r,parent:this.getParent(),style:{color:t.color}};"Local"===m?(d.localPosition=l,d.localScale=u,d.localRotation=p):(d.position=l,d.scale=u,d.rotation=p);const b=this.filterParams(d);let h=new THING.Torus(b);this._objects.push(h),n.object=h}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreatePlane extends BaseNode3D{static config={name:"BPCreatePlane",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"plane",enabled:!1},{name:"name",type:"string",value:"plane"},{name:"size",type:"vector3",value:[2,2,0]},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.size||[2,2,0],o=t.position||[0,0,0],s=t.id||"plane",c=t.name||"plane",i=t.color||"#ffffff",r=t.rotation||[0,0,0],l=t.scale||[1,1,1],p=t.spaceType||"Local",u={id:s,name:c,parent:this.getParent(),style:{color:i}};"Local"===p?(u.localPosition=o,u.localScale=l,u.localRotation=r):(u.position=o,u.scale=l,u.rotation=r);let m=new THING.Plane(a[0],a[1],u);this._objects.push(m),n.object=m}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateLine extends BaseNode3D{static config={name:"BPCreateLine",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"line",enabled:!1},{name:"name",type:"string",value:"line"},{name:"type",type:"select",value:["PixelLine","RouteLine","PolygonLine","FatLine"]},{name:"points",type:["array","string"],editor:"PathEditor"},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"width",type:"number",value:1,enabled:!1},{name:"cornerRadius",type:"number",value:"0.3",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.color||"#ffffff",o=t.width||1,s=t.id||"line",c=t.name||"line",i=t.cornerRadius||.3,r={sideType:THING.SideType.Double,color:a},l=t.type,p=t.points;"string"==typeof p&&(p=JSON.parse(p));let u={id:s,name:c,selfPoints:p,style:r,parent:this.getParent()},m=null;"PixelLine"==l?m=new THING.PixelLine({...u,width:o}):"RouteLine"==l?m=new THING.RouteLine({...u,width:o}):"PolygonLine"==l?m=new THING.PolygonLine({...u,radius:o,cornerRadius:i}):"FatLine"==l&&(m=new THING.FatLine({...u,width:o})),this._objects.push(m),n.object=m}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreatePlaneRegion extends BaseNode3D{static config={name:"BPCreatePlaneRegion",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"planeRegion",enabled:!1},{name:"name",type:"string",value:"planeRegion"},{name:"points",type:["array","string"],editor:"AreaEditor"},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.name||"planeRegion",o=t.id||"planeRegion";const s=t.position||[0,0,0];let c=t.points,i=t.rotation||[0,0,0],r=t.scale||[1,1,1];const l=t.color||"#ffffff";let p=t.spaceType||"Local";"string"==typeof c&&(c=JSON.parse(c));let u={id:o,name:a,style:{color:l},parent:this.getParent()};c&&c.length&&(u.points=c),this.object=new THING.PlaneRegion(u),"Local"===p?(this.object.localScale=r,this.object.localRotation=i,this.object.localPosition=s):(this.object.scale=r,this.object.rotation=i,this.object.position=s),n.object=this.object}onStop(){this.object&&(this.object.destroy(),this.object=null)}}class BPCreateSphere extends BaseNode3D{static config={name:"BPCreateSphere",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"sphere",enabled:!1},{name:"name",type:"string",value:"sphere"},{name:"radius",type:"number",value:.5},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"widthSegments",type:"number",value:16,enabled:!1},{name:"heightSegments",type:"number",value:12,enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.position||[0,0,0],o=t.rotation||[0,0,0],s=t.scale||[1,1,1],c=t.name||"sphere",i=t.id||"sphere",r=t.widthSegments||16,l=t.heightSegments||12,p=t.radius||.5,u=t.spaceType||"Local",m={id:i,name:c,widthSegments:r,heightSegments:l,parent:this.getParent(),style:{color:t.color||"#ffffff"}};"Local"===u?(m.localPosition=a,m.localScale=s,m.localRotation=o):(m.position=a,m.scale=s,m.rotation=o);let d=new THING.Sphere(p,m);this._objects.push(d),n.object=d}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateParticleSystem extends BaseNode3D{static config={name:"BPCreateParticleSystem",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"particle",enabled:!1},{name:"name",type:"string",value:"particle"},{name:"url",type:"string",value:`${BaseNode3D.BASEURL}model/particles`},{name:"position",type:"vector3",value:[0,0,0],unit:"m"},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1,unit:"角度"},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.name||"particle",o=t.id||"particle",s=t.url||`${BaseNode3D.BASEURL}model/particles`,c=t.position||[0,0,0],i=t.rotation||[0,0,0],r=t.scale||[1,1,1],l=t.spaceType||"Local",p={id:o,name:a,url:this.getFullPath(s),parent:this.getParent()};"Local"===l?(p.localPosition=c,p.localScale=r,p.localRotation=i):(p.position=c,p.scale=r,p.rotation=i);let u=new THING.ParticleSystem(p);this._objects.push(u),n.object=u}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateCircle extends BaseNode3D{static config={name:"BPCreateCircle",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"circle",enabled:!1},{name:"name",type:"string",value:"circle"},{name:"radius",type:"number",value:1},{name:"segments",type:"number",value:64},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[-90,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.position||[0,0,0],o=t.radius||1,s=t.name||"circle",c=t.id||"circle",i=t.segments||64,r=t.color||"#ffffff",l=t.rotation||[-90,0,0],p=t.scale||[1,1,1],u=t.spaceType||"Local",m={id:c,name:s,radius:o,segments:i,parent:this.getParent(),style:{color:r}};"Local"===u?(m.localPosition=a,m.localScale=p,m.localRotation=l):(m.position=a,m.scale=p,m.rotation=l);let d=new THING.Circle(m);this._objects.push(d),n.object=d}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreatePoints extends BaseNode3D{static config={name:"BPCreatePoints",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"point",enabled:!1},{name:"name",type:"string",value:"point"},{name:"points",type:["array","string"]},{name:"size",type:"number",value:"2",enabled:!1},{name:"color",type:"color",value:"#ffffff",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.name||"point",o=t.id||"point",s=t.size||2,c=t.color||"#FF0000",i=t.points;"string"==typeof i&&(i=JSON.parse(i));let r=new THING.Points({id:o,name:a,points:i,size:s,parent:this.getParent(),style:{color:c}});this._objects.push(r),n.object=r}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateAttachedPoint extends BaseNode3D{static config={name:"BPCreateAttachedPoint",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"parent",type:"selector"},{name:"child",type:"selector"},{name:"position",type:"vector3",value:[0,0,0],unit:"m"},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"attachedPoint",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=this.getParent(t.parent),o=t.child;const s=t.position||[0,0,0];let c=t.spaceType||"Local";if(!a)return;a.isSelector&&(a=a[0]),o&&o.isSelector&&(o=o[0]);let i={parent:a};"Local"===c?i.localPosition=s:i.position=s;let r=new THING.AttachedPoint(i);o&&(r.add(o),o.localPosition=[0,0,0]),n.attachedPoint=r,this._objects.push(r)}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateExtrudeShape extends BaseNode3D{static config={name:"BPCreateExtrudeShape",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"extrudeShape",enabled:!1},{name:"name",type:"string",value:"extrudeShape"},{name:"points",type:["array","string"]},{name:"hole",type:"array"},{name:"height",type:"number",value:0},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a,o=t.name||"ExtrudeShape",s=t.id||"ExtrudeShape",c=t.position||[0,0,0],i=t.hole,r=t.height,l=t.points,p=t.rotation||[0,0,0],u=t.scale||[1,1,1],m=t.spaceType||"Local";"string"==typeof l&&(l=JSON.parse(l)),i&&i[0]&&(a=Array.isArray(i[0][0])?i:[i]);const d={name:o,id:s,selfPlaneHoles:a,selfPlanePoints:l,height:r,parent:this.getParent()},b=this.filterParams(d);let h=new THING.ExtrudeShape(b);"Local"==m?(h.localPosition=c,h.localScale=u,h.localRotation=p):(h.position=c,h.scale=u,h.rotation=p),this._objects.push(h),n.object=h}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateCubeTexture extends BaseNode3D{static config={name:"BPCreateCubeTexture",inputs:[{name:"exec",type:"exec"},{name:"urlContents",type:"string",value:`${BaseNode3D.BASEURL}image/skyboxes/blue/`}],outputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.urlContents,o=new THING.CubeTexture({url:a});this._objects.push(o),n.object=this.toSelector(o),this.run("complete",n)}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.clear(),this._objects.destroy())}}class BPCreateGrid extends BaseNode3D{static config={name:"BPCreateGrid",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"width",type:"number",value:60,unit:"m"},{name:"length",type:"number",value:60,unit:"m"},{name:"density",type:"number",value:1},{name:"enable",type:"boolean",value:!0}],outputs:[{name:"next",type:"exec"}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.width||60,o=t.length||60,s=t.density||1;t.enable??!0?(this.app.helper.grid=!0,this.app.helper.grid={width:a,length:o,density:s}):this.app.helper.grid=!1}onStop(){this.app.helper.grid=!1}}class BPCreateWater extends BaseNode3D{static config={name:"BPCreateWater",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"water",enabled:!1},{name:"name",type:"string",value:"water"},{name:"points",type:["array","string"],editor:"AreaEditor"},{name:"size",type:"vector3",unit:"m"},{name:"flowSpeedX",type:"number",enabled:!1,value:1},{name:"flowSpeedY",type:"number",enabled:!1,value:1},{name:"flowWeight",type:"number",enabled:!1,value:.5},{name:"noiseTimeScale",type:"number",enabled:!1,value:.9},{name:"envMap",type:"selector",enabled:!1},{name:"rotation",type:"vector3",value:[0,0,0],enabled:!1,unit:"角度"},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"spaceType",type:"select",value:["Local","World"],enabled:!1},{name:"metalness",type:"number",value:.5,enabled:!1},{name:"roughness",type:"number",value:.12,enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.id||"water",o=t.name||"water",s=t.flowSpeedX||1,c=t.flowSpeedY||1,i=t.flowWeight||.5,r=t.noiseTimeScale||.9,l=t.points||[[-10,0,-10],[10,0,-10],[10,0,10],[-10,0,10]],p=t.size,u=t.rotation||[0,0,0],m=t.scale||[1,1,1],d=t.spaceType||"Local",b=t.metalness,h=t.roughness;"string"==typeof l&&(l=JSON.parse(l)),p&&p.length&&(l=[[-p[0],p[1],-p[2]],[p[0],p[1],-p[2]],[p[0],p[1],p[2]],[-p[0],p[1],p[2]]]);let y=t.envMap,g=new THING.Water({id:a,name:o,points:l,parent:this.getParent()});g.flowSpeed=[s,c],g.flowWeight=i,g.noiseTimeScale=r,void 0!==h&&(g.style.roughness=h),void 0!==b&&(g.style.metalness=b),y&&y.isSelector&&y.length>0&&(g.style.imageSlotType=THING.ImageSlotType.EnvMap,g.style.envMap=y.objects[0]),"Local"===d?(g.localScale=m,g.localRotation=u):(g.scale=m,g.rotation=u),this._objects.push(g),n.object=g}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCameraFlyTo extends BaseNode3D{static config={name:"BPCameraFlyTo",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"position",type:"vector3",value:[0,0,0],editor:"CameraEditor"},{name:"target",type:["vector3","object","selector"],value:[0,0,0],editor:"CameraEditor"},{name:"up",type:"vector3",value:[0,1,0],enabled:!1},{name:"time",type:"number",value:1,unit:"s"},{name:"delayTime",type:"number",value:0,enabled:!1},{name:"horzAngle",type:"number",value:45,enabled:!1},{name:"vertAngle",type:"number",value:45,enabled:!1},{name:"lerpType",type:"select",value:["Linear_None","Quadratic_In","Quadratic_Out","Quadratic_InOut","Cubic_In","Cubic_Out","Cubic_InOut","Quartic_In","Quartic_Out","Quartic_InOut","Quintic_In","Quintic_Out","Quintic_InOut","Sinusoidal_In","Sinusoidal_Out","Sinusoidal_InOut","Exponential_In","Exponential_Out","Exponential_InOut","Circular_In","Circular_Out","Circular_InOut","Elastic_In","Elastic_Out","Elastic_InOut","Back_In","Back_Out","Back_InOut","Bounce_In","Bounce_Out","Bounce_InOut"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback"},{name:"target",type:["vector3","object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a={time:this.handleTime(null==t.time?1:t.time),delayTime:1e3*t.delayTime||0,horzAngle:t.horzAngle,vertAngle:t.vertAngle,up:t.up},o=t.lerpType||"Linear_None";o=o.split("_"),a.lerpType=THING.LerpType[o[0]][o[1]],this._camera=t.camera;let s=t.target,c=t.position,i=this.app,r=this;if(this._camera||(this._camera=i.camera,this.position=i.camera.position,this.target=i.camera.target),this._camera.isSelector&&(this._camera=this._camera[0]),s.isSelector&&(s=s[0]),!s)return;const l=this.filterParams(a);s.isBaseObject?i.camera.flyToAsync({target:s,...l,complete:()=>{r.run("complete",n)}}):this._camera.flyTo({target:s,position:c,...l,complete:()=>{r.run("complete",n)}}),n.target=s}onStop(){this._camera&&!this._camera.destroyed&&this._camera.stopFlying(),this.position&&this.target&&(this.app.camera.position=this.position,this.app.camera.target=this.target)}}class BPCameraStopFlying extends BaseNode3D{static config={name:"BPCameraStopFlying",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.camera;a||(a=this.app.camera),a.isSelector&&(a=a[0]),a.stopFlying()}}class BPCameraStopMoving extends BaseNode3D{static config={name:"BPCameraStopMoving",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.camera;a||(a=this.app.camera),a.isSelector&&(a=a[0]),a.stopFlying(),a.off("update",null,"自定义摄像机跟随");let o=a.getComponentByName("rotateAround");o&&o.stop()}}class BPCameraFit extends BaseNode3D{static config={name:"BPCameraFit",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"position",type:["vector3","object","selector"],value:[0,0,0],editor:"CameraEditor",enabled:!1},{name:"target",type:["vector3","object","selector"],value:[0,0,0],editor:"CameraEditor"}],outputs:[{name:"exec",type:"exec"},{name:"position",type:["vector3","object","selector"],enabled:!1},{name:"target",type:["vector3","object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.target||[0,0,0],o=t.position;this._camera=t.camera,this._camera||(this._camera=this.app.camera),this._camera.isSelector&&(this._camera=this._camera[0]),a.isSelector&&(a=a[0]);let s={target:a};THING.Utils.isValid(o)&&(s.position=o),this._camera.fit(s),n.target=a,n.position=o}}class BPCameraFollow extends BaseNode3D{static config={name:"BPCameraFollow",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:"selector",enabled:!1},{name:"target",type:["object","selector"],value:[0,0,0]},{name:"offsetPosition",type:"vector3",value:[0,5,-10]}],outputs:[{name:"exec",type:"exec"},{name:"target",type:["object","selector"]}]};constructor(){super(),this._target=null}onExecute(e,t,n){let a=t.target;const o=t.offsetPosition;let s=this.app;this._camera=t.camera,this._camera||(this._camera=s.camera),this._camera.isSelector&&(this._camera=this._camera[0]),a?(a.isSelector&&(a=a[0]),this._camera.off("update",null,"自定义摄像机跟随"),this._camera.on("update",(()=>{const e=a.position;this._camera.target=e,o&&(this._camera.position=a.selfToWorld(o))}),"自定义摄像机跟随"),n.target=a):console.error("Please provide the object input data")}onStop(){this._camera.off("update",null,"自定义摄像机跟随")}}class BPCameraSetProjection extends BaseNode3D{static config={name:"BPCameraSetProjection",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"mode",type:"select",value:["Orthographic","Perspective"]},{name:"time",type:"number",value:1,unit:"s"}],outputs:[{name:"next",type:"exec"}]};onExecute(e,t,n){let a=t.mode||"Orthographic",o=this.handleTime(t.time),s="Orthographic"===a?THING.ProjectionType.Orthographic:THING.ProjectionType.Perspective,c=t.camera;c||(c=this.app.camera),c.isSelector&&(c=c[0]),c.setProjectionType(s,o)}}class BPCameraSetFog extends BaseNode3D{static config={name:"BPCameraSetFog",advanced:!0,group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"enable",type:"boolean",value:!0},{name:"far",type:"number",value:300},{name:"color",type:"color",value:"#ffffff",enabled:!1}],outputs:[{name:"next",type:"exec"}]};constructor(){super(),this._fog=null}onExecute(e,t,n){let a=t.enable,o=t.far,s=t.color;this.camera=t.camera,this.camera||(this.camera=this.app.camera),this.camera.isSelector&&(this.camera=this.camera[0]);let c=this.camera.fog;this._fog={far:c.far,color:c.color},null!=a&&(c.enable=a),a&&(o&&(c.far=o),s&&(c.color=s))}onStop(){this.camera&&!1===this.camera.destroyed&&(this.camera.fog.far=this._fog.far,this.camera.fog.color=this._fog.color)}}class BPCameraSetFov extends BaseNode3D{static config={name:"BPCameraSetFov",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"fov",type:"number",value:50}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onSetup(){this.oldFov=this.app.camera.fov}onExecute(e,t,n){this.camera=t.camera;let a=t.fov;this.camera||(this.camera=this.app.camera),this.camera.isSelector&&(this.camera=this.camera[0]),a&&(this.camera.fov=a)}onStop(){this.oldFov&&!1===this.camera.destroyed&&(this.camera.fov=this.oldFov)}}class BPCameraSetPosition extends BaseNode3D{static config={name:"BPCameraSetPosition",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:"selector",enabled:!1},{name:"position",type:"vector3",value:[0,0,0],editor:"CameraEditor"},{name:"target",type:"vector3",value:[0,0,0],editor:"CameraEditor"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.position,o=t.target,s=this.app,c=t.camera;c&&c.isSelector&&c.length>0?c=c[0]:(c=s.camera,this.position=s.camera.localPosition,this.target=s.camera.target),a&&(a=THING.Math.addVector(this.getParent().position,a),c.localPosition=a),o&&(o=THING.Math.addVector(this.getParent().position,o),c.target=o)}onStop(){this.position&&this.target&&(this.app.camera.localPosition=this.position,this.app.camera.target=this.target)}}class BPCameraGetPosition extends BaseNode3D{static config={name:"BPCameraGetPosition",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3"},{name:"target",type:"vector3"}]};constructor(){super()}onExecute(e,t,n){let a=t.camera;a||(a=this.app.camera),a.isSelector&&(a=a[0]),n.position=a.position,n.target=a.target}}class BPCameraStopFollowing extends BaseNode3D{static config={name:"BPCameraStopFollowing",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.camera;a||(a=this.app.camera),a.isSelector&&(a=a[0]),a.off("update",null,"自定义摄像机跟随")}}class BPCameraSetViewMode extends BaseNode3D{static config={name:"BPCameraSetViewMode",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"target",type:["object","selector"],enabled:!1},{name:"duration",type:"number",value:1,enabled:!1},{name:"mode",type:"select",value:["None","Top","Bottom","Left","Right","Front","Back"]}],outputs:[{name:"exec",type:"exec"}]};constructor(){super(),this.index=0}onExecute(e,t,n){let a=t.mode;this.camera=t.camera;let o=t.target;const s=void 0===t.duration?1:t.duration;o&&(o.isSelector||Array.isArray(o))&&(o=o[0]),this.camera||(this.camera=this.app.camera),this.camera.isSelector&&(this.camera=this.camera[0]),"None"===a?this.camera.setViewMode(o,null,1e3*s):this.camera.setViewMode(o,a,1e3*s)}onStop(){!1===this.camera.destroyed&&(this.camera.viewModeType=null)}}class BPCreateCamera extends BaseNode3D{static config={name:"BPCreateCamera",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3",value:[0,0,0]},{name:"target",type:"vector3",value:[0,0,0]},{name:"viewport",type:"any",value:[10,10,200,200],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"]}]};constructor(){super(),this.cameraSelector=new THING.Selector}onExecute(e,t,n){let a=t.position||[0,0,0],o=t.target||[0,0,0],s=t.viewport||[10,10,200,200],c=this.app;this._camera||(this._camera=new THING.Camera({parent:this.getParent()})),"string"==typeof s&&(s=s.split(",").map(Number)),s instanceof Array&&4===s.length?(this._camera.name="ffff",this._camera.enableViewport=!0,this._camera.viewport=[c.size[0]-s[2]-s[1],s[0],s[2],s[3]],this._camera.enable=!1,this._camera.localPosition=a,this._camera.target=THING.Math.addVector(this.getParent().position,o),this.cameraSelector.push(this._camera),n.camera=this._camera):console.error("视口参数格式不正确")}onStop(){const e=this.cameraSelector.length;e&&e>0&&(this.cameraSelector.destroy(),this.cameraSelector.clear())}}class BPCameraRotateAround extends BaseNode3D{static config={name:"BPCameraRotateAround",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"target",type:["vector3","object","selector"],value:[0,0,0],editor:"CameraEditor"},{name:"time",type:"number",value:1,unit:"s"},{name:"XAngle",type:"number",value:0},{name:"YAngle",type:"number",value:0},{name:"loopType",type:"select",value:["Once","Repeat","PingPong"],enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback"},{name:"target",type:["vector3","object","selector"]}]};constructor(){super()}onExecute(e,t,n){this._camera=t.camera;let a=t.target||[0,0,0],o=this.handleTime(t.time),s=t.XAngle||0,c=t.YAngle||0,i=t.loopType||"Once";i=THING.LoopType[i];let r=this.app,l=this;this._camera||(this._camera=r.camera),this._camera.isSelector&&(this._camera=this._camera[0]),a.isSelector&&(a=a[0]);let p=new THING.EXTEND.RotateAroundComponent;this._camera.addComponent(p,"rotateAround"),this._camera.rotateAround.start({target:a,time:o,xRotateAngle:s,yRotateAngle:c,loopType:i,complete:()=>{this.run("complete",n)},update:()=>{l._camera.lookAt(a)}}),n.target=a}onStop(){let e=this.app;this._camera&&e.camera.rotateAround&&(e.camera.rotateAround.stop(),e.camera.removeComponent("rotateAround"))}}class BPCameraStopRotating extends BaseNode3D{static config={name:"BPCameraStopRotating",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this.app;let a=t.camera;a||(a=this.app.camera),a.isSelector&&(a=a[0]);let o=a.getComponentByName("rotateAround");o&&o.stop()}}class BPCameraPan extends BaseNode3D{static config={name:"BPCameraPan",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"x",type:"number",value:0},{name:"y",type:"number",value:0},{name:"time",type:"number",value:.5,enabled:!1,unit:"s"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.x||0,o=t.y||0,s=this.handleTime(t.time||.5),c=t.camera;c||(c=this.app.camera),c.isSelector&&(c=c[0]),c.pan(a,o,s)}}class BPCameraZoom extends BaseNode3D{static config={name:"BPCameraZoom",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"distance",type:"number",value:0},{name:"time",type:"number",value:.5,enabled:!1,unit:"s"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.distance||0,o=this.handleTime(t.time||.5),s=t.camera;s||(s=this.app.camera),s.isSelector&&(s=s[0]),s.zoom(a,{time:o})}}class BPCameraEnablePan extends BaseNode3D{static config={name:"BPCameraEnablePan",inputs:[{name:"exec",type:"exec"},{name:"enable",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.enable||!1;this.app.camera.enablePan=a}onStop(){this.app.camera.enablePan=!0}}class BPCameraEnableRotate extends BaseNode3D{static config={name:"BPCameraEnableRotate",inputs:[{name:"exec",type:"exec"},{name:"enable",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.enable||!1;this.app.camera.enableRotate=a}onStop(){this.app.camera.enableRotate=!0}}class BPCameraEnableZoom extends BaseNode3D{static config={name:"BPCameraEnableZoom",inputs:[{name:"exec",type:"exec"},{name:"enable",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.enable||!1;this.app.camera.enableZoom=a}onStop(){this.app.camera.enableZoom=!0}}class BPCameraSetAngleLimit extends BaseNode3D{static config={name:"BPCameraSetAngleLimit",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:["object","selector"],enabled:!1},{name:"horzAngleLimit",type:"vector2"},{name:"vertAngleLimit",type:"vector2"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.horzAngleLimit,o=t.vertAngleLimit;this.camera=t.camera,this.camera||(this.camera=this.app.camera),this.camera.isSelector&&(this.camera=this.camera[0]),a instanceof Array&&2===a.length&&(this.camera.horzAngleLimit=a),o instanceof Array&&2===o.length&&(this.camera.vertAngleLimit=o)}onStop(){this.camera&&!1===this.camera.destroyed&&(this.camera.horzAngleLimit=[-360,360],this.camera.vertAngleLimit=[0,180])}}class BPCameraSetDistanceLimit extends BaseNode3D{static config={name:"BPCameraSetDistanceLimit",inputs:[{name:"exec",type:"exec"},{name:"distanceLimit",type:"vector2"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.distanceLimit||[0,0];this.app.camera.distanceLimited=a}onStop(){this.app.camera.distanceLimited=null}}class BPSetCameraControl extends BaseNode3D{static config={name:"BPSetCameraControl",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:"selector",enabled:!1},{name:"vertAngleLimit",type:"vector2"},{name:"distanceLimited",type:"vector2"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){const{vertAngleLimit:a,distanceLimited:o}=t,s=this.app;this._camera=t.camera,this._camera?.isSelector&&this._camera.length>0?this._camera=this._camera[0]:this._camera=s.camera,a&&(this._vertAngleLimit=this._camera.control.vertAngleLimit,this._camera.control.vertAngleLimit=a),o&&(this._distanceLimited=this._camera.control.distanceLimited,this._camera.control.distanceLimited=o)}onStop(){this._camera&&!this._camera.destroyed&&(this._vertAngleLimit&&(this._camera.control.vertAngleLimit=this._vertAngleLimit),this._distanceLimited&&(this._camera.control.distanceLimited=this._distanceLimited))}}class BPObjectLevelEvent extends BaseNode3D{static config={name:"BPObjectLevelEvent",title:"对象层级",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"tags",type:"string",value:"ObjectLevelEvent_BP",enabled:!1}],outputs:[{name:"enter",type:"callback"},{name:"fromParent",type:"callback",enabled:!1},{name:"fromChild",type:"callback",enabled:!1},{name:"leave",type:"callback"},{name:"back",type:"callback",enabled:!1},{name:"enterNext",type:"callback",enabled:!1},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){this.object=t.object||this.app,this.tags=t.tags;let a=this;this.object.on(THING.EventType.AfterEnterLevel,(e=>{a.syncRun("enter",{object:e.current,nextObject:e.next}),e.current.isChildOf(e.prev)?a.syncRun("fromParent",{object:e.current}):a.syncRun("fromChild",{object:e.current})}),this.tags),this.object.on(THING.EventType.AfterLeaveLevel,(e=>{e.next.isChildOf(e.current)?a.syncRun("enterNext",{object:e.current}):a.syncRun("back",{object:e.current}),a.syncRun("leave",{object:e.current})}),this.tags)}onStop(){this.object&&(this.object==this.app?(this.object.off(THING.EventType.AfterEnterLevel,null,this.tags),this.object.off(THING.EventType.AfterLeaveLevel,null,this.tags)):this.traverseObject(this.object,(e=>{e.destroyed||(e.off(THING.EventType.AfterEnterLevel,null,this.tags),e.off(THING.EventType.AfterLeaveLevel,null,this.tags))})))}}class BaseBindMouseEvent extends BaseNode3D{static config={advanced:!0,inputs:[{name:"exec",title:"开启",type:"exec"},{name:"close",title:"关闭",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",value:"*"},{name:"tag",type:"string",enabled:!1},{name:"useCapture",type:"boolean",enabled:!1}],outputs:[{name:"callback",type:"callback"},{name:"event",type:"object"},{name:"target",type:["object","selector"]},{name:"pickedPosition",type:"vector3",enabled:!1},{name:"openCallback",type:"callback",enabled:!1},{name:"closeCallback",type:"callback",enabled:!1},{name:"object",type:["object","selector"],enabled:!1}]};constructor(e){super(),this._eventType=e}onExecute(e,t,n){this._tag=t.tag,this._object=t.object||this.app,n.object=this._object,this.condition=t.condition||null,this.useCapture=t.useCapture||!1;let a=this[{exec:"bindEvent",close:"unBindEvent"}[this.curExecName||"exec"]].bind(this);a&&a(n)}bindEvent(e){this._object.on(this._eventType,this.condition,(t=>{this.handleEvent(t,e)}),this._tag,1,{useCapture:this.useCapture,includeSelf:!0}),this.syncRun("openCallback")}unBindEvent(){this._object.off(this._eventType,this.condition,this._tag),this.syncRun("closeCallback")}onStop(){this._object==this.app&&this._object.off(this._eventType,this.condition,this._tag)}handleEvent(e,t){t.event=e,t.target=e.object,t.pickedPosition=e.pickedPosition,this.syncRun("callback",t)}}class BPBindMouseClickEvent extends BaseBindMouseEvent{static config={name:"BPBindMouseClickEvent",advanced:!0,inputs:[...BaseBindMouseEvent.config.inputs,{name:"type",type:"select",value:["left","middle","right"]}],outputs:[...BaseBindMouseEvent.config.outputs]};constructor(){super("click")}onExecute(e,t,n){t.type instanceof Array||!t.type?this.button="left":this.button=t.type,super.onExecute(e,t,n)}handleEvent(e,t){({left:0,middle:1,right:2})[this.button]===e.button&&super.handleEvent(e,t)}}class BPUnbindMouseClickEvent extends BaseNode3D{static config={name:"BPUnbindMouseClickEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this._tag=t.tag;let a=t.condition||null;this._object=t.object||this.app,this._event="click",this._object.off(this._event,a,this._tag)}}class BPPauseMouseClickEvent extends BaseNode3D{static config={name:"BPPauseMouseClickEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this._event="click",this._tag=t.tag;let a=t.condition||null,o=t.pause??!0;this._object=t.object||this.app,o?this._object.pauseEvent(this._event,a,this._tag):this._object.resumeEvent(this._event,a,this._tag)}onStop(){}}class BPBindMouseEnterEvent extends BaseBindMouseEvent{static config={name:"BPBindMouseEnterEvent",advanced:!0,inputs:BaseBindMouseEvent.config.inputs,outputs:BaseBindMouseEvent.config.outputs};constructor(){super("mouseenter")}}class BPUnbindMouseEnterEvent extends BaseNode3D{static config={name:"BPUnbindMouseEnterEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",value:"*"},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this._tag=t.tag,this._object=t.object||this.app,this._event="mouseenter";let a=t.condition;this._object.off(this._event,a,this._tag)}}class BPBindMouseLeaveEvent extends BaseBindMouseEvent{static config={name:"BPBindMouseLeaveEvent",advanced:!0,inputs:BaseBindMouseEvent.config.inputs,outputs:BaseBindMouseEvent.config.outputs};constructor(){super("mouseleave")}}class BPUnbindMouseLeaveEvent extends BaseNode3D{static config={name:"BPUnbindMouseLeaveEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",value:"*"},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this._tag=t.tag,this._object=t.object||this.app,this._event="mouseleave";let a=t.condition;this._object.off(this._event,a,this._tag)}}class BPBindMouseDoubleClickEvent extends BaseBindMouseEvent{static config={name:"BPBindMouseDoubleClickEvent",advanced:!0,inputs:[...BaseBindMouseEvent.config.inputs,{name:"type",type:"select",value:["left","middle","right"]},{name:"debounce",type:"boolean",enabled:!1},{name:"debounceTime",type:"number",unit:"s",enabled:!1}],outputs:[...BaseBindMouseEvent.config.outputs]};constructor(){super("dblclick")}onExecute(e,t,n){this.debounce=t.debounce||!1,this.debounceTime=this.handleTime(t.debounceTime||1),t.type instanceof Array||!t.type?this.button="left":this.button=t.type,super.onExecute(e,t,n)}handleEvent(e,t){({left:0,middle:1,right:2})[this.button]===e.button&&(this.debounce?(null!==this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{super.handleEvent(e,t)}),this.debounceTime)):super.handleEvent(e,t))}onStop(){this.timer&&clearTimeout(this.timer),super.onStop()}}class BPUnbindMouseDoubleClickEvent extends BaseNode3D{static config={name:"BPUnbindMouseDoubleClickEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this._tag=t.tag,this._object=t.object||this.app,this._event="dblclick";let a=t.condition||null;this._object.off(this._event,a,this._tag)}}class BPPauseMouseDoubleClickEvent extends BaseNode3D{static config={name:"BPPauseMouseDoubleClickEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a="dblclick",o=t.tag,s=t.pause??!0,c=t.object||this.app,i=t.condition||null;s?c.pauseEvent(a,i,o):c.resumeEvent(a,i,o)}}class BPBindMouseMoveEvent extends BaseBindMouseEvent{static config={name:"BPBindMouseMoveEvent",advanced:!0,inputs:BaseBindMouseEvent.config.inputs,outputs:BaseBindMouseEvent.config.outputs};constructor(){super("mousemove")}}class BPUnbindMouseMoveEvent extends BaseNode3D{static config={name:"BPUnbindMouseMoveEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this._tag=t.tag,this._object=t.object||this.app,this._event="mousemove";let a=t.condition||null;this._object.off(this._event,a,this._tag)}}class BPPauseMouseMoveEvent extends BaseNode3D{static config={name:"BPPauseMouseMoveEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a="mousemove",o=t.tag,s=t.pause??!0,c=t.object||this.app,i=t.condition||null;s?c.pauseEvent(a,i,o):c.resumeEvent(a,i,o)}}class BPBindObjectUpdateEvent extends BaseNode3D{static config={name:"BPBindObjectUpdateEvent",advanced:!0,inputs:[{name:"exec",title:"开启",type:"exec"},{name:"close",title:"关闭",type:"exec"},{name:"object",type:["object","selector"]},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"callback",type:"callback"},{name:"event",type:"object"},{name:"target",type:["object","selector"]},{name:"openCallback",type:"callback",enabled:!1},{name:"closeCallback",type:"callback",enabled:!1}]};constructor(){super()}onExecute(e,t,n){if(this._tag=t.tag,this._object=t.object,!this._object)return void console.error("Please provide the object input data");let a=this[{exec:"bindEvent",close:"unBindEvent"}[this.curExecName||"exec"]].bind(this);a&&a(n)}bindEvent(e){let t=this;this._object.on("update",(function(n){e.event=n,e.target=n.object,t.syncRun("callback",e)}),t._tag,1),this.syncRun("openCallback")}unBindEvent(e){this._object.off("update",this._tag),this.syncRun("closeCallback")}onStop(){this._object&&this.traverseObject(this._object,(e=>{e.destroyed||e.off("update",this._tag)}))}}class BPBindUpdateEvent extends BaseNode3D{static config={name:"BPBindUpdateEvent",advanced:!0,inputs:[{name:"exec",title:"开启",type:"exec"},{name:"close",title:"关闭",type:"exec"},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"callback",type:"callback"},{name:"event",type:"object"},{name:"deltaTime",type:"number"},{name:"openCallback",type:"callback",enabled:!1},{name:"closeCallback",type:"callback",enabled:!1}]};constructor(){super()}onExecute(e,t,n){this._tag=t.tag;let a=this[{exec:"bindEvent",close:"unBindEvent"}[this.curExecName||"exec"]].bind(this);a&&a(n)}bindEvent(e){let t=this;this.app.on("update",(function(n){e.event=n,e.deltaTime=n.deltaTime,t.syncRun("callback",e)}),this._tag),this.syncRun("openCallback")}unBindEvent(e){this.app.off("update",this._tag),this.syncRun("closeCallback")}onStop(){this.app.off("update",this._tag)}}class BPUnbindObjectUpdateEvent extends BaseNode3D{static config={name:"BPUnbindObjectUpdateEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"exec",type:"exec"}]};onExecute(e,t,n){let a=t.tag,o=t.object;o?o.off("update",a):console.error("Please provide the object input data")}}class BPUnbindUpdateEvent extends BaseNode3D{static config={name:"BPUnbindUpdateEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"exec",type:"exec"}]};onExecute(e,t,n){let a=t.tag;this.app.off("update",a)}}class BPPauseObjectUpdateEvent extends BaseNode3D{static config={name:"BPPauseObjectUpdateEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"tag",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a="update",o=t.tag,s=t.pause??!0,c=t.object;c?s?c.pauseEvent(a,o):c.resumeEvent(a,o):console.error("Please provide the object input data")}}class BPPauseUpdateEvent extends BaseNode3D{static config={name:"BPPauseUpdateEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"tag",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a="update",o=t.tag,s=t.pause??!0,c=this.app;s?c.pauseEvent(a,o):c.resumeEvent(a,o)}}class BPBindKeyboardEvent extends BaseNode3D{static config={name:"BPBindKeyboardEvent",advanced:!0,inputs:[{name:"exec",title:"开启",type:"exec"},{name:"close",title:"关闭",type:"exec"},{name:"event",type:"select",value:["keydown","keypress","keyup"]},{name:"keyCode",type:"string",desc:"默认监听键盘的所有键，如果想监听某一个键，如：键A，则输入keyA"},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"callback",type:"callback"},{name:"event",type:"object",disabled:!1},{name:"keyCode",type:"number"},{name:"openCallback",type:"callback",enabled:!1},{name:"closeCallback",type:"callback",enabled:!1}]};constructor(){super()}onExecute(e,t,n){this._event=t.event||"keydown",this._tag=t.tag,this._keyCode=t.keyCode||"allKeyCode",this._app=this.app,this.condition=t.condition||null;let a=this[{exec:"bindEvent",close:"unBindEvent"}[this.curExecName||"exec"]].bind(this);a&&a(n)}bindEvent(e){isNaN(this._keyCode)&&(this._keyCode=function(e){let t=e;1==e.length&&(t=(e=e.toLocaleLowerCase()).charCodeAt(0));return t}(this._keyCode)),this._app.on(this._event,this.condition,(t=>{this._keyCode!=t.keyCode&&this._keyCode!=t.code&&"allKeyCode"!=this._keyCode||(e.event=t,e.keyCode=t.keyCode,this.syncRun("callback",e))}),this._tag),this.syncRun("openCallback")}unBindEvent(e){this.app.off(this._event,this.condition,this._tag),this.syncRun("closeCallback")}onStop(){this.app.off(this._event,this.condition,this._tag)}}class BPUnbindKeyboardEvent extends BaseNode3D{static config={name:"BPUnbindKeyboardEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"event",type:"select",value:["keydown","keypress","keyup"]},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this._event=t.event;let a=t.condition||null;this._tag=t.tag,this.app.off(this._event,a,this._tag)}}class BPPauseKeyboardEvent extends BaseNode3D{static config={name:"BPPauseKeyboardEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"event",type:"select",value:["keydown","keypress","keyup"]},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.event||"keydown",o=t.tag,s=t.pause??!0,c=this.app,i=t.condition||null;s?c.pauseEvent(a,i,o):c.resumeEvent(a,i,o)}}class BPBindMouseDragEvent extends BaseNode3D{_ctrDraggable;static config={name:"BPBindMouseDragEvent",advanced:!0,inputs:[{name:"exec",title:"开启",type:"exec"},{name:"close",title:"关闭",type:"exec"},{name:"object",type:["object","selector"],desc:"需要绑定鼠标拖拽事件的对象（必填）"},{name:"condition",type:"string",enabled:!1}],outputs:[{name:"target",type:["object","selector"]},{name:"mouseenter",type:"callback",enabled:!1},{name:"mouseleave",type:"callback",enabled:!1},{name:"dragstart",type:"callback"},{name:"dragging",type:"callback"},{name:"dragend",type:"callback"},{name:"coordinates",type:"array",enabled:!1},{name:"openCallback",type:"callback",enabled:!1},{name:"closeCallback",type:"callback",enabled:!1},{name:"object",type:["object","selector"],enabled:!1}]};constructor(){super()}onExecute(e,t,n){if(this._objCtr=t.object,this._ctrDraggable=[],this.condition=t.condition||null,!this._objCtr)return void console.error("Please provide the object input data");n.object=this._objCtr;let a=this[{exec:"bindEvent",close:"unBindEvent"}[this.curExecName||"exec"]].bind(this);a&&a(n)}bindEvent(e){this.traverseObject(this._objCtr,(t=>{this.handleDragComponent(t),this.handleDraggableHighlight(t,e)})),this.syncRun("openCallback")}unBindEvent(e){this.traverseObject(this._objCtr,(e=>{e.drag&&(e.drag.enable=!1,e.off("dragstart",this.condition,"eventMouseDragDragStart"),e.off("dragend",this.condition,"eventMouseDragDragEnd"),e.off("mouseenter",this.condition,"eventMouseDragMouseEnter"),e.off("mouseLeave",this.condition,"eventMouseDragMouseLeave"))})),this.syncRun("closeCallback")}handleDragComponent(e){try{e.drag||e.addComponent(THING.EXTEND.DragComponent,"drag"),e.drag.enable=!0,this._ctrDraggable.push(e)}catch(e){console.error(e)}}handleDraggableHighlight(e,t){e.on("dragstart",this.condition,(e=>{t.coordinates=[e.clientX,e.clientY],t.target=e.object,this.syncRun("dragstart",t)}),"eventMouseDragDragStart"),e.on("dragging",this.condition,(e=>{t.coordinates=[e.clientX,e.clientY],t.target=e.object,this.syncRun("dragging",t)}),"eventMouseDragDragStart"),e.on("dragend",this.condition,(e=>{t.coordinates=[e.clientX,e.clientY],t.target=e.object,this.syncRun("dragend",t)}),"eventMouseDragDragEnd"),e.on("mouseenter",this.condition,(()=>{this.syncRun("mouseenter",t)}),"eventMouseDragMouseEnter"),e.on("mouseleave",this.condition,(()=>{this.syncRun("mouseleave",t)}),"eventMouseDragMouseLeave")}onStop(){if(this._ctrDraggable.length>0){const e=this._ctrDraggable.length;for(let t=0;t<e;t++){const e=this._ctrDraggable[t];e.drag&&(e.drag.enable=!1,e.off("dragstart",this.condition,"eventMouseDragDragStart"),e.off("dragend",this.condition,"eventMouseDragDragEnd"),e.off("mouseenter",this.condition,"eventMouseDragMouseEnter"),e.off("mouseLeave",this.condition,"eventMouseDragMouseLeave"),e.removeComponent("drag"))}}}}class BPUnBindMouseDragEvent extends BaseNode3D{static config={name:"BPUnBindMouseDragEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object;this.traverseObject(a,(e=>{e.drag&&(e.drag.enable=!1,e.off("dragstart",this.condition,"eventMouseDragDragStart"),e.off("dragend",this.condition,"eventMouseDragDragEnd"),e.off("mouseenter",this.condition,"eventMouseDragMouseEnter"),e.off("mouseLeave",this.condition,"eventMouseDragMouseLeave"))}))}}class BPBindAppEvent extends BaseNode3D{static config={name:"BPBindAppEvent",advanced:!0,inputs:[{name:"exec",title:"开启",type:"exec"},{name:"close",title:"关闭",type:"exec"},{name:"object",type:["object","selector"]},{name:"pause",title:"暂停",type:"exec",enabled:!1},{name:"resume",title:"恢复",type:"exec",enabled:!1},{name:"global",type:"boolean",value:!0},{name:"name",type:"select"},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1},{name:"useCapture",type:"boolean",enabled:!1},{name:"priority",type:"number",value:1,enabled:!1}],outputs:[{name:"callback",type:"callback"},{name:"afterPause",title:"暂停后",type:"exec"},{name:"afterResume",title:"恢复后",type:"exec"},{name:"openCallback",type:"callback",enabled:!1},{name:"closeCallback",type:"callback",enabled:!1},{name:"object",type:["object","selector"],enabled:!1},{name:"params",type:"any"}]};constructor(){super()}bindAppEvent(e){let t=this;this.global?this._object.on(this.name,this.condition,(function(n){e.params=n.param||n||{},t.syncRun("callback",e)}),this._tag,this.eventPriority,{useCapture:this.useCapture}):this._object.on(this.name+this.blueprint.uuid,this.condition,(function(n){e.params=n.param||n||{},t.syncRun("callback",e)}),this._tag,this.eventPriority,{useCapture:this.useCapture}),this.syncRun("openCallback")}unBindAppEvent(e){global?this._object.off(this.name,this.condition,this._tag):this._object.off(this.name+this._blueprint.uuid,this.condition,this._tag),this.syncRun("closeCallback")}pauseAppEvent(){global?(this._object.pauseEvent(this.name,this.condition,this._tag),this.syncRun("afterPause")):(this._object.pauseEvent(this.name+this._blueprint.uuid,this.condition,this._tag),this.syncRun("afterPause"))}resumeAppEvent(){global?(this._object.resumeEvent(this.name,this.condition,this._tag),this.syncRun("afterResume")):(this._object.resumeEvent(this.name+this._blueprint.uuid,this.condition,this._tag),this.syncRun("afterResume"))}onExecute(e,t,n){this.name=t.name,this.condition=t.condition||null,this._tag=t.tag||this.constructor.config.name+this.id,this.useCapture=t.useCapture||!1,this.global=!(!1===t.global),this.eventPriority=t.priority,this._object=t.object||this.app,n.object=this._object;let a=this[{exec:"bindAppEvent",close:"unBindAppEvent",pause:"pauseAppEvent",resume:"resumeAppEvent"}[this.curExecName||"exec"]].bind(this);a&&a(n)}onStop(){this._object===this.app&&(this.global?this._object.off(this.name,this.condition,this._tag):this._object.off(this.name+this.blueprint.uuid,this.condition,this._tag))}}class BPTriggerAppEvent extends BaseNode3D{static config={name:"BPTriggerAppEvent",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"global",type:"boolean",value:!0},{name:"name",type:"string"},{name:"tag",type:"string",enabled:!1},{name:"param",type:"any"}],outputs:[{name:"next",type:"exec"}]};constructor(){super(),this._object=null}onExecute(e,t,n){let a=t.name,o=t.param,s=t.tag,c=!(!1===t.global);this._object=t.object||this.app;const i={};THING.Utils.isValid(o)&&(i.param=o),c?this._object.trigger(a,i,{tag:s}):this._object.trigger(a+this.blueprint.uuid,i,{tag:s})}}class BPAddFontMSDFWasmFike extends BaseNode3D{constructor(){super()}static config={name:"BPAddFontMSDFWasmFike",title:"加载MSDF字体依赖",inputs:[{name:"path",type:"string"},{name:"exec",type:"exec"}],outputs:[{name:"callback",type:"callback"}]};async onExecute(e,t,n){let{path:a}=t;a&&(await THING.Utils.loadWasmFile(a+"/tool-msdf-atlas-gen.js",{onGetWasmModule:()=>MSDFAtlasGenModule}),this.app.view.setAttribute("FontWorker",a+"/tool-msdf-atlas-gen.worker.js"),this.run("callback",{}))}}class BPSetTimeOfDay extends BaseNode3D{constructor(){super()}static config={name:"BPSetTimeOfDay",title:"设置时间系统",inputs:[{name:"next",type:"exec"},{name:"timeOfDay",title:"时间",type:"number"}],outputs:[{name:"next",type:"exec"},{name:"timeOfDay",title:"时间",type:"number"}]};onExecute(e,t,n){const a=this.app,o=t.timeOfDay;void 0!==o&&(a.time.timeOfDay=o),n.timeOfDay=o}}class BPPostMessage extends BaseNode3D{constructor(){super()}static config={name:"BPPostMessage",inputs:[{name:"next",type:"exec"},{name:"message",type:"any"},{name:"targetOrigin",type:"string",value:"*"}],outputs:[{name:"next",type:"exec"}]};onExecute(e,t,n){const a=t.message,o=t.targetOrigin||"*";if(!a)return;const s=this.parseMessage(a);window.parent.postMessage(s,o)}parseMessage(e){if(Array.isArray(e))return e;try{return"string"==typeof e?JSON.parse(e):e}catch(t){return console.warn("Failed to parse message:",t),e}}}class BPReceiveMessage extends BaseNode3D{constructor(){super()}static config={name:"BPReceiveMessage",inputs:[{name:"open",type:"exec"},{name:"close",type:"exec"},{name:"targetOrigin",type:"string",value:"*"}],outputs:[{name:"next",type:"exec",enabled:!1},{name:"callback",type:"callback"},{name:"message",type:"any"}]};onExecute(e,t,n){const a=this.curExecName;this.targetOrigin=t.targetOrigin||"*","open"===a&&(this.boundMessageHandler=e=>this.messageHandler(e,n),window.addEventListener("message",this.boundMessageHandler)),"close"===a&&this.boundMessageHandler&&(window.removeEventListener("message",this.boundMessageHandler),this.boundMessageHandler=null)}messageHandler=(e,t)=>{"*"!==this.targetOrigin&&e.origin!==this.targetOrigin||(t.message=e.data,this.syncRun("callback",t))};onStop(){this.boundMessageHandler&&(window.removeEventListener("message",this.boundMessageHandler),this.boundMessageHandler=null)}}class BPCreateButton extends BaseNode3D{static config={name:"BPCreateButton",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"text",type:"string",value:"按钮"},{name:"width",type:"number",value:0,enabled:!1},{name:"height",type:"number",value:30,enabled:!1},{name:"x",type:"number",value:10,enabled:!1},{name:"y",type:"number",enabled:!1}],outputs:[{name:"next",type:"exec",enabled:!1},{name:"callback",type:"callback"},{name:"text",type:"string",enabled:!1}]};constructor(){super()}onExecute(e,t,n){let{text:a="按钮",width:o=0,height:s=30,x:c=10,y:i}=t;isNaN(o)&&(o=0),isNaN(s)&&(s=30),isNaN(c)&&(c=10),i||(i=10);let r=document.querySelector("#"+this.app.container.id).parentNode;function l(e,t){return(new DOMParser).parseFromString(e,"text/html").querySelector(`.${t}`)}r.style.position="relative";let p=`<div class="control-ui-root" style="position: absolute; top: 0px; width: auto; max-height:${r.offsetHeight}px; padding-bottom:10px; overflow-y: overlay; z-index:100; pointer-events: none;" > </div>`,u=`<button \n            class="thingBtn BPText" \n            style="display: block; margin-left:${c}px;margin-top:${i}px;\n            cursor:pointer;text-align:center;\n            height:${s}px;line-height:${s}px;\n            min-width:60px;\n            padding:0 6px;box-sizing: border-box;\n            white-space: nowrap;\n\t\t\tpointer-events: auto;\n\t\t\t" >\n            ${a}\n        </button>`;this.controlUIRoot=document.querySelector(".control-ui-root"),this.controlUIRoot||(this.controlUIRoot=l(p,"control-ui-root"));let m=l(u,"thingBtn");o&&(m.style.width=`${o}px`),n.text=a,m.onclick=()=>{this.syncRun("callback",n)},this.controlUIRoot.appendChild(m),r.appendChild(this.controlUIRoot)}onStop(){this.controlUIRoot&&this.controlUIRoot.remove()}}class BPCreateSlider extends BaseNode3D{static config={name:"BPCreateSlider",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"text",type:"string",value:"滑块"},{name:"value",type:"number",value:50},{name:"min",type:"number",value:0,enabled:!1},{name:"max",type:"number",value:100,enabled:!1},{name:"step",type:"number",value:1,enabled:!1},{name:"showInput",type:"boolean",value:!0,enabled:!1},{name:"showInputControls",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec",enabled:!1},{name:"input",type:"callback"},{name:"change",type:"callback",enabled:!1},{name:"currentValue",type:"number"}]};constructor(){super()}createDocument(e,t){return(new DOMParser).parseFromString(e,"text/html").querySelector(`.${t}`)}onExecute(e,t,n){const{text:a,value:o=50,min:s=0,max:c=100,step:i=1,showInput:r=!0,showInputControls:l=!0}=t;n.currentValue=o;const p=l?"block":"none";if(this.sliderControlRoot=document.querySelector(".control-ui-root"),!this.sliderControlRoot){let e=document.querySelector("#"+this.app.container.id).parentNode,t=`<div class="control-ui-root" style="position: absolute; top: 0px; width: auto; max-height:${e.offsetHeight}px; padding-bottom:10px; overflow-y: overlay; z-index:100" > </div>`;this.sliderControlRoot=this.createDocument(t,"control-ui-root"),e.style.position="relative",e.appendChild(this.sliderControlRoot)}let u=`<div class="slider-root" style="display:flex; align-items: center; margin-top:10px; padding: 0px 10px; pointer-events: auto;" >\n            <span style="color:#c7c7c7;">${a}</span>\n            <input class="slider-input" type="range" min=${s} max=${c} value=${o} step=${i} style="margin: 0px 10px">\n\t\t    </div>`,m=`<div class="slider-control-root" style="display: flex; border: 1px solid ##dcdfe4; border-radius:3px; background:#f5f6fa">\n        \t<span class="slider-decrease" style="display:${p}; cursor: pointer; padding:0px 4px; line-height:20px;"> -</span>\n        \t<input class="slider-control-input" type="text" value=${o} style="width: 30px; border:none; text-align: center;">\n        \t<span class="slider-increase" style="display:${p}; cursor: pointer; padding:0px 4px; line-height:20px;">+</span>\n      \t\t</div>`;const d=this.createDocument(u,"slider-root"),b=d.querySelector(".slider-input");let h=null,y=null,g=null;if(r){const e=this.createDocument(m,"slider-control-root");d.appendChild(e),h=e.querySelector(".slider-control-input"),y=e.querySelector(".slider-decrease"),g=e.querySelector(".slider-increase");const t=e=>{let t=Number(h.value)+e;t<s||t>c||(h.value=t,b.value=t,n.currentValue=t,this.syncRun("input",n),this.syncRun("change",n))},a=(e,t)=>{let a=e.target.value;a<s&&(a=s,"change"===t&&(h.value=s)),a>c&&(a=c,"change"===t&&(h.value=c)),b.value=a,n.currentValue=a,this.syncRun(t,n)};y.addEventListener("click",(()=>t(-i))),g.addEventListener("click",(()=>t(i))),h.addEventListener("input",(e=>a(e,"input"))),h.addEventListener("change",(e=>a(e,"change")))}b.addEventListener("input",(e=>{const t=e.target.value;n.currentValue=t,this.syncRun("input",n),h&&(h.value=t)})),b.addEventListener("change",(e=>{n.currentValue=e.target.value,this.syncRun("change",n)})),this.sliderControlRoot.appendChild(d)}onStop(){this.sliderControlRoot&&this.sliderControlRoot.remove()}}class BPCreateSceneHierarchyUI extends BaseNode3D{static config={name:"BPCreateSceneHierarchyUI",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"exec",type:"exec"},{name:"callback",type:"callback"},{name:"clickObj",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object;if(!a)return void console.error("Please provide the object input data");let o=document.getElementById("levelDom"),s=document.querySelector("#"+this.app.container.id).parentNode;o&&oLayerButtonRoot.remove();let c='<div class="levelDom">',i=0,r=this;function l(e){return{id:e.id,checked:!0,text:e.type+" ("+e.name+")"}}function p(e,t){return(new DOMParser).parseFromString(e,"text/html").querySelector(`.${t}`)}function u(e,t){c+=`<ul style = "display: ${t?"block":""};padding-left: 0px;background-color: #fff;">`;for(let n=0;n<e.length;n++)e[n].children&&e[n].children.length?(c+=`<li><span class="objName" id="${e[n].id}" style = "padding-left:${20*i}px;"><i class="itemIcon iconfont ${t?"icon-xiajiantou":"icon-youjiantou"}"></i>${e[n].text}</span>`,i++,u(e[n].children,!!t),i--,c+="</li>"):c+=`<li><span id="${e[n].id}" class="objName" style = "padding-left:${20*i}px;">${e[n].text}</span></li>`;c+="</ul>"}let m=function(e){var t=[];return t.push(function(e){var t={id:e.id,checked:!0,state:"open",text:"root",children:[]};return r.traverseObject(a,(e=>{t.children.push(function(e){var t={id:e.id,checked:!0,state:"open",text:e.type+" ("+e.id+")",children:[]};return e.buildings.forEach((function(e){t.children.push(function(e){var t={id:e.id,checked:!0,state:"open",text:e.type+" ("+e.id+")",children:[]};return e.floors.forEach((function(e){t.children.push(function(e){var t={id:e.id,checked:!0,state:"open",text:e.type+" (level:"+e.levelNumber+")",children:[]},n=e.queryByTags("Placement");return n.query(/binet/).forEach((function(e){t.children.push(l(e))})),t}(e))})),t}(e))})),e.queryByTags("Placement").query(/a/).forEach((function(e){t.children.push(l(e))})),t}(e))})),t}(e)),t}(this.app.root);!function(){let e=p('<style class="levelDom"> \n      .levelDom {\n        position:absolute;\n        top:0px;\n        right:0px;\n        background-color:#fff;\n        overflow-y: scroll;\n        overflow-x: hidden;\n        max-width:250px;\n        padding:10px;\n        max-height:480px;\n      }\n      .levelDom ul:first-child {\n        padding-inline-start: 0px;\n        padding-left:0px !important;\n      }\n      .levelDom ul {\n        padding-inline-start: 0px;\n      }\n      .levelDom ul li {\n        list-style: none;\n      }\n      .levelDom ul li span {\n        display:inline-block;\n        width:250px;\n      }\n      .levelDom ul li span:hover {\n        background-color:#EAF2FF;\n        cursor: pointer;\n      }\n\n    </style>',"levelDom");s.appendChild(e)}(),u(m,!0),c+="</div>",r.rootDom=p(c,"levelDom"),s.appendChild(r.rootDom),function(){let e=document.getElementsByClassName("objName"),t=document.getElementsByClassName("itemIcon");for(let t=0;t<e.length;t++)e[t].addEventListener("click",(t=>{for(let t=0;t<e.length;t++)e[t].style.backgroundColor="";t.target.style.backgroundColor="#FFE48D";let a=r.app.query("#"+t.target.id)[0];a&&(n.clickObj=a,r.syncRun("callback",n))}));for(let e=0;e<t.length;e++)t[e].addEventListener("click",(e=>{e.stopPropagation(),e.target.parentNode.nextElementSibling&&("none"==window.getComputedStyle(e.target.parentNode.nextElementSibling,null).getPropertyValue("display")?(e.target.parentNode.nextElementSibling.style.display="block",e.target.className="itemIcon iconfont icon-xiajiantou"):(e.target.parentNode.nextElementSibling.style.display="none",e.target.className="itemIcon iconfont icon-youjiantou"))}),!1)}()}onStop(){this.rootDom&&this.rootDom.remove()}}class BPCreateRadioMultipleButtons extends BaseNode3D{static config={name:"BPCreateRadioMultipleButtons",title:"创建顶部下拉菜单",inputs:[{name:"exec",type:"exec"},{name:"isExclusive",title:"是否互斥",type:"boolean",value:!0},{name:"options",type:"string"},{name:"name1",type:"string",title:"菜单1"},{name:"name2",type:"string",title:"菜单2"},{name:"name3",type:"string",title:"菜单3"},{name:"name4",type:"string",title:"菜单4"}],outputs:[{name:"next",type:"exec"},{name:"root1press1",type:"callback",title:"菜单1选中"},{name:"root1press1canel1",type:"callback",title:"菜单1取消"},{name:"root1press2",type:"callback",title:"菜单2选中"},{name:"root1press2canel2",type:"callback",title:"菜单2取消"},{name:"root1press3",type:"callback",title:"菜单3选中"},{name:"root1press3canel3",type:"callback",title:"菜单3取消"},{name:"root1press4",type:"callback",title:"菜单4选中"},{name:"root1press4canel4",type:"callback",title:"菜单4取消"}]};onExecute(e,t,n){let a=document.querySelectorAll(".multipleButtonRoot").length,o=t.isExclusive;if(!document.querySelector(".multipleButtonsRootContainer")){let e=document.querySelector("#"+this.app.container.id).parentNode,t='<style class="multipleButtonsStyle">\n                                    .multipleButtonsRootContainer{\n                                        box-sizing:border-box;\n                                        cursor:pointer;\n                                        width:auto;\n                                        height:30px;\n                                        z-index:10000;\n                                        top: 2%;\n                                        left: 50%;\n                                        transform: translateX(-50%);\n                                        position:absolute; \n                                        display:flex;\n                                        background: rgba(255,255,255,0.1);\n                                        border-radius: 10px;\n                                        align-items: center;\n                                        color:#ffffff;\n                                        }\n\n                                        .multipleButtonsRootContainer::before {\n                                            content: "";\n                                            position: absolute;\n                                            top: 0;\n                                            right: 0;\n                                            bottom: 0;\n                                            left: 0;\n                                            border-radius: 10px; \n                                            backdrop-filter: blur(80px);\n                                            z-index: -1;\n                                        }\n\n\n                                    .multipleButtonRoot{\n                                        height: 30px;\n                                        min-width: 100px;\n                                        font-size: 13px;\n                                        border-radius: 8px;\n                                        text-align: center;\n                                        padding-top: 8px;\n                                        }\n\n\n                                    .buttonText{\n                                        width:100px;\n                                        height:40px;\n                                    }\n\n                                    .multipleButtonRoot:hover{\n                                        background: rgba(30,54,102,0.06);\n                                    }\n\n                                    .multipleButtonRoot:hover .fatelDiv{\n                                        transform:scaleY(1);\n                                    }\n\n\t\t\t\t\t\t\t\t\t.fatelDiv{\n\t\t\t\t\t\t\t\t\t\ttransition: transform 0.3s ease;\n                                        transform:scaleY(0);\n\t\t\t\t\t\t\t\t\t\ttransform-origin: top;\n\t\t\t\t\t\t\t\t\t}\n\n                                    .multipleUi {\n\t\t\t\t\t\t\t\t\t\tpadding:0px;\n\t\t\t\t\t\t\t\t\t\tmargin:0px;\n\t\t\t\t\t\t\t\t\t\tborder-radius: 7px;\n                                        cursor: pointer;\n                                        list-style: none;\n                                        display:block;\n                                        background: rgba(255,255,255,0.1);\n                                        backdrop-filter:blur(80px);\n                                    }\n\n                                \n                                \n                                    .multipleUi li {\n                                        height:29px;\n                                        padding: 3px 0px;\n                                        text-align: center;\n                                        border-radius: 7px;\n                                        margin-top:1px;\n\t\t\t\t\t\t\t\t\t\tline-height:24px;\n                                    }\n                                \n                                    .multipleUi li:hover {\n                                        background: rgba(30,54,102,0.06);\n                                    }\n                                        \n                                </style>',n=s('<div class="multipleButtonsRootContainer"></div>',"multipleButtonsRootContainer");e.appendChild(n);let a=s(t,"multipleButtonsStyle");e.appendChild(a)}function s(e,t){return(new DOMParser).parseFromString(e,"text/html").querySelector(`.${t}`)}let c=s(`<div class="multipleButtonRoot" id="button${a+1}"><a class="buttonText" id="button${a+1}text">${t.options}</a>\n\t\t<div class="fatelDiv" style="margin-top:2px;"><div class="uiContianer" style="padding-top:7px"><ul class="multipleUi" id="multipleUi${a+1}"></ul></div></div></div>`,"multipleButtonRoot");document.querySelector(".multipleButtonsRootContainer").appendChild(c);let i,r,l=document.querySelector(`#multipleUi${a+1}`),p=[];for(let e in t)e.includes("name")&&""!==t[e]&&p.push(t[e]);p.forEach(((e,t)=>{const a=document.createElement("li");a.textContent=e,a.classList.add(`root1press${t+1}`),l.appendChild(a),a.addEventListener("click",(e=>{let a=e.target.parentNode.parentNode.parentNode.parentNode;const s=a.querySelectorAll(".uiContianer li");if(o){if(i&&r!==e.target)this.syncRun(i,n),r.classList.toggle("clicked"),r.style.backgroundColor="";else if(i&&r===e.target){this.syncRun(i,n),e.target.classList.toggle("clicked"),e.target.classList.contains("clicked")?e.target.style.backgroundColor="#ff9900":e.target.style.backgroundColor="",r=null,i=null;const t=Array.from(s).every((e=>!e.classList.contains("clicked")));return void(a.style.backgroundColor=t?"":"#ff9900")}this.syncRun(`${e.target.className}`,n),e.target.classList.toggle("clicked"),r=e.target,i=`root1press${t+1}canel${t+1}`,e.target.classList.contains("clicked")?e.target.style.backgroundColor="#ff9900":(e.target.style.backgroundColor="",this.syncRun(`root1press${t+1}canel${t+1}`));const o=Array.from(s).every((e=>!e.classList.contains("clicked")));a.style.backgroundColor=o?"":"#ff9900"}else{this.syncRun(`${e.target.className}`,n),e.target.classList.toggle("clicked"),e.target.classList.contains("clicked")?e.target.style.backgroundColor="#ff9900":(e.target.style.backgroundColor="",this.syncRun(`root1press${t+1}canel${t+1}`));const o=Array.from(s).every((e=>!e.classList.contains("clicked")));a.style.backgroundColor=o?"":"#ff9900"}}))}))}onStop(){let e=document.querySelectorAll(".multipleButtonsRootContainer")[0],t=document.querySelectorAll(".multipleButtonsStyle")[0];e&&e.remove(),t&&t.remove()}}class BPCreateRadioMultipleButtonsBottom extends BaseNode3D{static config={name:"BPCreateRadioMultipleButtonsBottom",title:"创建底部下拉菜单",inputs:[{name:"exec",type:"exec"},{name:"isExclusive",title:"是否互斥",type:"boolean",value:!0},{name:"options",type:"string"},{name:"name1",type:"string",title:"菜单1"},{name:"name2",type:"string",title:"菜单2"},{name:"name3",type:"string",title:"菜单3"},{name:"name4",type:"string",title:"菜单4"},{name:"name5",type:"string",title:"菜单5"},{name:"name6",type:"string",title:"菜单6"}],outputs:[{name:"next",type:"exec"},{name:"root1press1",type:"callback",title:"菜单1选中"},{name:"root1press1canel1",type:"callback",title:"菜单1取消"},{name:"root1press2",type:"callback",title:"菜单2选中"},{name:"root1press2canel2",type:"callback",title:"菜单2取消"},{name:"root1press3",type:"callback",title:"菜单3选中"},{name:"root1press3canel3",type:"callback",title:"菜单3取消"},{name:"root1press4",type:"callback",title:"菜单4选中"},{name:"root1press4canel4",type:"callback",title:"菜单4取消"},{name:"root1press5",type:"callback",title:"菜单5选中"},{name:"root1press5canel5",type:"callback",title:"菜单5取消"},{name:"root1press6",type:"callback",title:"菜单6选中"},{name:"root1press6canel6",type:"callback",title:"菜单6取消"}]};onExecute(e,t,n){let a=document.querySelectorAll(".multipleButtonRoot").length,o=t.isExclusive;if(!document.querySelector(".multipleButtonsRootContainer")){let e=document.querySelector("#"+this.app.container.id).parentNode,t='<style class="multipleButtonsStyle">\n                                    .multipleButtonsRootContainer{\n                                        box-sizing:border-box;\n                                        cursor:pointer;\n                                        height:30px;\n                                        z-index:10000;\n                                        bottom: 40px;\n                                        left: 50%;\n                                        transform: translateX(-50%);\n                                        position:relative; \n                                        display:inline-flex;\n                                        background: rgba(255,255,255,0.1);\n                                        border-radius: 10px;\n                                        align-items: center;\n                                        color:#ffffff;\n                                        }\n\n                                        .multipleButtonsRootContainer::before {\n                                            content: "";\n                                            position: absolute;\n                                            top: 0;\n                                            right: 0;\n                                            bottom: 0;\n                                            left: 0;\n                                            border-radius: 10px; \n                                            backdrop-filter: blur(80px);\n                                            z-index: -1;\n                                        }\n\n\n\n                                    .multipleButtonRoot{\n                                        height: 30px;\n                                        min-width: 100px;\n                                        font-size: 13px;\n                                        border-radius: 8px;\n                                        text-align: center;\n                                        padding-top: 8px;\n                                        }\n\n\n                                    .buttonText{\n                                        width:100px;\n                                        height:40px;\n                                    }\n\n                                    .multipleButtonRoot:hover{\n                                        background: rgba(30,54,102,0.06);\n                                    }\n\n                                    .multipleButtonRoot:hover .fatelDiv{\n\t\t\t\t\t\t\t\t\t\ttransform: translateY(calc(-100% - 26px)) scaleY(1);\n\t\t\t\t\t\t\t\t\t\t\n                                    }\n\n\t\t\t\t\t\t\t\t\t.fatelDiv{\n\t\t\t\t\t\t\t\t\t\ttransform: translateY(calc(-100% - 26px)) scaleY(0);\n\t\t\t\t\t\t\t\t\t\ttransition: transform 0.3s ease;\n\t\t\t\t\t\t\t\t\t\ttransform-origin: bottom;\n\t\t\t\t\t\t\t\t\t}\n\n                                    .multipleUi {\n\t\t\t\t\t\t\t\t\t\tpadding:0px;\n\t\t\t\t\t\t\t\t\t\tmargin:0px;\n                                        border-radius: 7px;\n                                        cursor: pointer;\n                                        list-style: none;\n                                        display:block;\n                                        background: rgba(255,255,255,0.1);\n                                        backdrop-filter:blur(80px);\n                                    }\n\n                                \n                                \n                                    .multipleUi li {\n\t\t\t\t\t\t\t\t\t\theight:30px;\n                                        padding: 4px 0px;\n                                        text-align: center;\n                                        border-radius: 7px;\n                                        margin-top:1px;\n\t\t\t\t\t\t\t\t\t\tline-height:24px;\n                                    }\n                                \n                                    .multipleUi li:hover {\n                                        background: rgba(30,54,102,0.06);\n                                    }\n                                        \n                                </style>',n=s('<div class="multipleButtonsRootContainer"></div>',"multipleButtonsRootContainer");e.appendChild(n);let a=s(t,"multipleButtonsStyle");e.appendChild(a)}function s(e,t){return(new DOMParser).parseFromString(e,"text/html").querySelector(`.${t}`)}let c=s(`<div class="multipleButtonRoot" id="buttontransform: translateY(calc(-100% - 7px));${a+1}"><a class="buttonText" id="button${a+1}text">${t.options}</a>\n\t\t<div class="fatelDiv"><div class="uiContianer" style="padding-top:7px"><ul class="multipleUi" id="multipleUi${a+1}"></ul></div></div></div>`,"multipleButtonRoot");document.querySelector(".multipleButtonsRootContainer").appendChild(c);let i,r,l=document.querySelector(`#multipleUi${a+1}`),p=[];for(let e in t)e.includes("name")&&""!==t[e]&&p.push(t[e]);p.forEach(((e,t)=>{const a=document.createElement("li");a.textContent=e,a.classList.add(`root1press${t+1}`),l.appendChild(a),a.addEventListener("click",(e=>{let a=e.target.parentNode.parentNode.parentNode.parentNode;const s=a.querySelectorAll(".uiContianer li");if(o){if(i&&r!==e.target)this.syncRun(i,n),r.classList.toggle("clicked"),r.style.backgroundColor="";else if(i&&r===e.target){this.syncRun(i,n),e.target.classList.toggle("clicked"),e.target.classList.contains("clicked")?e.target.style.backgroundColor="#ff9900":e.target.style.backgroundColor="",r=null,i=null;const t=Array.from(s).every((e=>!e.classList.contains("clicked")));return void(a.style.backgroundColor=t?"":"#ff9900")}this.syncRun(`${e.target.className}`,n),e.target.classList.toggle("clicked"),r=e.target,i=`root1press${t+1}canel${t+1}`,e.target.classList.contains("clicked")?e.target.style.backgroundColor="#ff9900":(e.target.style.backgroundColor="",this.syncRun(`root1press${t+1}canel${t+1}`));const o=Array.from(s).every((e=>!e.classList.contains("clicked")));a.style.backgroundColor=o?"":"#ff9900"}else{this.syncRun(`${e.target.className}`,n),e.target.classList.toggle("clicked"),e.target.classList.contains("clicked")?e.target.style.backgroundColor="#ff9900":(e.target.style.backgroundColor="",this.syncRun(`root1press${t+1}canel${t+1}`));const o=Array.from(s).every((e=>!e.classList.contains("clicked")));a.style.backgroundColor=o?"":"#ff9900"}}))}))}onStop(){let e=document.querySelectorAll(".multipleButtonsRootContainer")[0],t=document.querySelectorAll(".multipleButtonsStyle")[0];e&&e.remove(),t&&t.remove()}}class BPCreateTopMenu extends BaseNode3D{static config={name:"BPCreateTopMenu",title:"创建菜单",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"exec",type:"exec"}],dynamic:[{inputOrOutput:"input",type:"string",label:"menu [index]",length:2},{inputOrOutput:"output",type:"callback",label:"then [index]",length:2}]};isDynamicInputs(){return!0}constructor(){super()}onExecute(e,t,n){this.outputs=n,this.mainContainer=this.getOrCreateMainContainer(),this.addGlobalStyles();const{menuLabelArr:a,subMenuLabelArr:o}=this.collectMenuLabels(t);this.createCaseMap([...a,...o]),this.createMenuItems(a),this.createSubMenuItems(o),document.addEventListener("click",this.handleDocumentClick)}getOrCreateMainContainer(){let e=document.querySelector(".menu-container");if(!e){let t='<div class="menu-container" > </div>';e=this.createDocument(t,"menu-container"),document.querySelector("#"+this.app.container.id).parentNode.appendChild(e)}return e}collectMenuLabels(e){const t=[],n=[];return Object.values(e).forEach((e=>{e.includes("/")?n.push(e):t.push(e)})),{menuLabelArr:t,subMenuLabelArr:n}}createDocument(e,t){return(new DOMParser).parseFromString(e,"text/html").querySelector(`.${t}`)}createCaseMap(e){this.caseMap=new Map,e.forEach(((e,t)=>{this.caseMap.set(e,t)}))}createMenuItems(e){e.forEach((e=>{if(document.querySelector(`.menu-item-${e}`))return;const t=`<div class='menu-item-${e} menu-item'>${e}</div>`,n=this.createDocument(t,`menu-item-${e}`);n.addEventListener("click",this.menuItemClickCallback.bind(this)),n.addEventListener("click",(()=>this.setMenuActive(e))),this.mainContainer.appendChild(n)}))}createSubMenuItems(e){e.forEach((e=>{const[t,n]=e.split("/");let a=document.querySelector(`.submenu-container-${t}`);if(a||(a=this.createSubMenuContainer(t)),!a)return;let o=document.querySelector(`.submenu-item-${t}-${n}`);if(o)return;const s=`<div class='submenu-item-${t}-${n} submenu-item'>${n}</div>`;o=this.createDocument(s,`submenu-item-${t}-${n}`),o.addEventListener("click",this.menuItemClickCallback.bind(this)),o.addEventListener("click",this.setSubmenuActivce.bind(this)),a.appendChild(o)}))}createSubMenuContainer(e){const t=`<div class='submenu-container-${e} submenu-container'></div>`,n=this.createDocument(t,`submenu-container-${e}`),a=document.querySelector(`.menu-item-${e}`);return a?(a.appendChild(n),n):null}setMenuActive(e){const t=document.querySelector(`.submenu-container-${e}`);if(t){t.classList.contains("expand")?t.classList.remove("expand"):(this.handleDocumentClick(),t.classList.add("expand"))}else{this.handleDocumentClick();const t=document.querySelector(`.menu-item-${e}`);t.classList.contains("active")?t.classList.remove("active"):(this.deActiveItems(),t.classList.add("active"))}}setSubmenuActivce(e){e.stopPropagation();const t=e.target.parentNode;t.classList.remove("expand");e.target.classList.contains("active")?(e.target.classList.remove("active"),t.parentNode.classList.remove("active")):(this.deActiveItems(),e.target.classList.add("active"),t.parentNode.classList.add("active"))}deActiveItems(){const e=document.querySelector(".menu-container"),t=e?.querySelectorAll(".active");t&&t.length&&t.forEach((e=>e.classList.remove("active")))}menuItemClickCallback(e){e.stopPropagation();const[t,...n]=e.target.classList[0].split("-");let a=n.pop();"submenu"===t&&(a=`${n.pop()}/${a}`);const o=this.caseMap.get(a);void 0!==o&&this.syncRun(`BPCreateTopMenu--${o}`,this.outputs)}addGlobalStyles(){const e=document.createElement("style");e.innerHTML="\n\t\t\t.menu-container {\n\t\t\t\tposition: absolute;\n\t\t\t\ttop: 0px;\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: row;\n\t\t\t\twidth: 100%;\n\t\t\t\theight:40px;\n\t\t\t\tz-index:100;\n\t\t\t\tfont-size: 12px;\n\t\t\t\tbackground-color:#2e2e2e;\n\t\t\t\tpadding: 0px 20px;\n\t\t\t}\n\n\t\t\t.menu-container .menu-item {\n\t\t\t\twidth: 80px;\n\t\t\t\tline-height:40px;\n\t\t\t\ttext-align: center;\n\t\t\t\tmargin-right: 10px;\n\t\t\t\tcursor: pointer;\n\t\t\t\tcolor:#959b9d;\n\t\t\t}\n\n            .menu-container .menu-item:hover {\n                color: #ffffff;\n            }\n\n\t\t\t.menu-container .menu-item.active {\n                color: #ffffff;\n            }\n\n\t\t\t.menu-container .submenu-container.expand {\n\t\t\t\ttransform:scaleY(1);\n            }\n\n\t\t\t.menu-container .submenu-container {\n\t\t\t \tposition: relative;\n    \t\t\ttop: 5px;\n\t\t\t\twidth: 80px;\n\t\t\t\tpadding: 10px 0;\n\t\t\t\toverflow: hidden;\n\t\t\t\tbackground-color: #1d1e1f;\n\t\t\t\ttransition: transform 0.3s ease;\n                transform:scaleY(0);\n\t\t\t\ttransform-origin: top;\n\t\t\t\tborder-radius: 5px;\n\t\t\t\tbox-shadow: 0px 0px 12px rgba(0, 0, 0, 0.72);\n\t\t\t}\n\n\t\t\t.menu-container\t.submenu-item {\n\t\t\t\theight: 30px;\n\t\t\t\tline-height: 30px;\n\t\t\t\tcursor: pointer;\n\t\t\t\tcolor:#babdc5;\n\t\t\t}\n\n\t\t\t.menu-container\t.submenu-item.active {\n\t\t\t\tcolor:#ffffff;\n\t\t\t\tbackground-color:#444;\n\t\t\t}\n\n\t\t\t.menu-container\t.submenu-item:hover {\n\t\t\t\tbackground-color:#444;\n\t\t\t\tcolor:#ffffff;\n\t\t\t}\n        ",document.head.appendChild(e)}handleDocumentClick(){document.querySelectorAll(".submenu-container")?.forEach((e=>{e.classList.remove("expand")}))}onStop(){this.mainContainer&&this.mainContainer.remove(),document.removeEventListener("click",this.handleDocumentClick)}}class BPCreateMarker extends BaseNode3D{static config={name:"BPCreateMarker",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"marker",enabled:!1},{name:"name",type:"string",value:"marker"},{name:"position",type:"vector3",value:[0,0,0]},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"image",type:"string",value:`${BaseNode3D.BASEURL}image/alarm_build.png`},{name:"parent",type:["selector","object"]},{name:"alignMode",type:"select",value:["None","Top","Bottom","Left","Right","Front","Back"]},{name:"renderType",type:"select",value:["Sprite","Plane"],enabled:!1},{name:"spaceType",type:"select",value:["Local","World"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["selector","object"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.parent,o=t.position||[0,0,0],s=t.scale||[1,1,1],c=t.image||"./resource/bluePrint/images/alarm_build.png",i=t.spaceType||"Local",r=t.alignMode||"None";a&&a.isSelector&&(a=a[0]);let l={id:t.id||"marker",name:t.name||"marker",renderType:t.renderType,style:{image:c}},p=o;if(a){let e="Local"===i?[0,0,0]:a.position,t=a.boundingBox.size;const n={Top:[.5,0,.5],Bottom:[.5,0,.5],Left:[1,.5,.5],Right:[0,.5,.5],Front:[.5,.5,.5],Back:[.5,.5,.5],None:[.5,.5,.5]};p={Top:THING.Math.addVector([e[0],e[1]+t[1],e[2]],o),Bottom:THING.Math.addVector([e[0],e[1],e[2]],o),Left:THING.Math.addVector([e[0]-t[0]/2,e[1]+t[1]/2,e[2]],o),Right:THING.Math.addVector([e[0]+t[0]/2,e[1]+t[1]/2,e[2]],o),Front:THING.Math.addVector([e[0],e[1]+t[1]/2,e[2]+t[2]/2],o),Back:THING.Math.addVector([e[0],e[1]+t[1]/2,e[2]-t[2]/2],o),None:o}[r],l.pivot=n[r],l.parent=a}l.parent=this.getParent(a),"Local"===i?(l.localScale=s,l.localPosition=p):(l.scale=s,l.position=p);let u=new THING.Marker(l);this._objects.push(u),n.object=u}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateHTMLMarker extends BaseNode3D{static config={name:"BPCreateHTMLMarker",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"id",type:"string",value:"htmlMarker",enabled:!1},{name:"name",type:"string",value:"htmlMarker"},{name:"position",type:"vector3",value:[0,0,0]},{name:"scale",type:"vector3",value:[1,1,1],enabled:!1},{name:"url",type:"string"},{name:"parent",type:["selector","object"]},{name:"alignMode",type:"select",value:["None","Top","Bottom","Left","Right","Front","Back"]},{name:"renderType",type:"select",value:["Sprite","Plane"],enabled:!1},{name:"spaceType",type:"select",value:["Local","World"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["selector","object"]}]};constructor(){super(),this._objects=new THING.Selector}async onExecute(e,t,n){let a=t.url;if(!a)return;const o=this.getFullPath(a),s=document.createElement("div");s.classList.add("html-marker");try{const e=await fetch(o),t=await e.text();s.innerHTML=t}catch(e){return void console.error("Error loading HTML:",e)}let c=t.parent,i=t.position||[0,0,0],r=t.scale||[1,1,1],l=t.spaceType||"Local",p=t.alignMode||"None";c&&c.isSelector&&(c=c[0]);let u={id:t.id||"htmlMarker",name:t.name||"htmlMarker",renderType:t.renderType,element:s},m=i;if(c){let e="Local"===l?[0,0,0]:c.position,t=c.boundingBox.size;const n={Top:[.5,0,.5],Bottom:[.5,0,.5],Left:[1,.5,.5],Right:[0,.5,.5],Front:[.5,.5,.5],Back:[.5,.5,.5],None:[.5,.5,.5]};m={Top:THING.Math.addVector([e[0],e[1]+t[1],e[2]],i),Bottom:THING.Math.addVector([e[0],e[1],e[2]],i),Left:THING.Math.addVector([e[0]-t[0]/2,e[1]+t[1]/2,e[2]],i),Right:THING.Math.addVector([e[0]+t[0]/2,e[1]+t[1]/2,e[2]],i),Front:THING.Math.addVector([e[0],e[1]+t[1]/2,e[2]+t[2]/2],i),Back:THING.Math.addVector([e[0],e[1]+t[1]/2,e[2]-t[2]/2],i),None:i}[p],u.pivot=n[p],u.parent=c}u.parent=this.getParent(c),"Local"===l?(u.localScale=r,u.localPosition=m):(u.scale=r,u.position=m);let d=new THING.HTMLMarker(u);this._objects.push(d),n.object=d}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPCreateTextLabel extends BaseNode3D{static config={name:"BPCreateTextLabel",advanced:!0,inputs:[{name:"show",type:"exec"},{name:"hide",type:"exec"},{name:"id",type:"string",value:"label",enabled:!1},{name:"name",type:"string",value:"label"},{name:"position",type:"vector3",value:[0,0,0]},{name:"scale",type:"vector3",value:[1,1,1]},{name:"parent",type:["object","selector"]},{name:"fontText",type:"string",value:"label",desc:'未勾选富文本时，可输入普通文本，如：“文本内容”；当勾选富文本时，可输入p、span标签富文本，如：<p><span style="color:#974806">文本内容</span></p>'},{name:"color",type:"color",value:"#ffffff",enabled:!1},{name:"fontSize",type:"number",value:20},{name:"alwaysOnTop",type:"boolean",value:!0,title:"对象置顶",enabled:!1},{name:"keepSize",type:"boolean",value:!1,enabled:!1},{name:"richText",type:"boolean",enabled:!1},{name:"alignMode",type:"select",value:["None","Top","Bottom","Left","Right","Front","Back"]},{name:"spaceType",type:"select",value:["Local","World"]},{name:"mode",type:"select",title:"模式",value:["defalt","sdf","msdf-worker"],enabled:!1},{name:"fontLineWidth",title:"行最大宽度",type:"number",value:99999,enabled:!0},{name:"fontType",type:"string",title:"字体信息",value:"Arial",enabled:!1},{name:"renderType",type:"string",title:"渲染模式",value:"Sprite",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let a=t.parent,o=t.position||[0,0,0],s=t.spaceType||"Local",c=t.alignMode||"None";const i=this.curExecName;"show"===i?(this.traverseObject(a,(e=>{let n=t.fontText;if(!n)return void console.error("Please provide the text input data");{n=n.toString();const t=this._getValueByPath(e,n);t&&(n=t)}let a={id:t.name,name:t.name,fontSize:t.fontSize,fontColor:t.color,richText:t.richText,fontText:n,scale:t.scale,alwaysOnTop:t.alwaysOnTop,keepSize:t.keepSize,mode:t.mode,fontLineWidth:t.fontLineWidth,fontType:t.fontType,userData:{_createdByBP:!0}},i=o;if(e){let t=e.position,n=e.boundingBox.size;const s={Top:[.5,0,.5],Bottom:[.5,0,.5],Left:[1,.5,.5],Right:[0,.5,.5],Front:[.5,.5,.5],Back:[.5,.5,.5],None:[.5,.5,.5]};i={Top:THING.Math.addVector([t[0],t[1]+n[1],t[2]],o),Bottom:THING.Math.addVector([t[0],t[1],t[2]],o),Left:THING.Math.addVector([t[0]-n[0]/2,t[1]+n[1]/2,t[2]],o),Right:THING.Math.addVector([t[0]+n[0]/2,t[1]+n[1]/2,t[2]],o),Front:THING.Math.addVector([t[0],t[1]+n[1]/2,t[2]+n[2]/2],o),Back:THING.Math.addVector([t[0],t[1]+n[1]/2,t[2]-n[2]/2],o),None:o}[c],a.pivot=s[c],a.parent=e}"Local"===s?a.localPosition=i:a.position=i;const r=this.filterParams(a);new THING.Label(r)})),n.object=this._objects):"hide"==i&&this.traverseObject(a,(e=>{e.query("[userData/_createdByBP=true]").destroy()})),this.parent=a}onStop(){this.traverseObject(this.parent,(e=>{e.query("[userData/_createdByBP=true]").destroy()}))}_getValueByPath(e,t){const n=t.split("/").filter(Boolean);let a=e;for(const e of n){if(!a||"object"!=typeof a||!(e in a))return;a=a[e]}return a}}const AttachmentTags$1="BP_attachment",CssTag$1="BP_css",AttachmentType$1={Image:"image",Prefab:"prefab",Attachment:"attachment",Html:"html"};class BPAttachment extends BaseNode3D{static config={name:"BPAttachment",advanced:!0,inputs:[{name:"showAttachment",type:"exec"},{name:"hideAttachment",type:"exec"},{name:"options",type:"object",enabled:!1},{name:"object",title:"父对象",type:["object","selector"]},{name:"url",type:"string"},{name:"edit",type:"object",editor:"AttachmentEditor",visiblePin:!1},{name:"batchRender",type:"boolean",enabled:!1}],outputs:[{name:"complete",type:"callback"},{name:"onHide",type:"callback"},{name:"object",title:"父对象",type:["object","selector"]},{name:"attachment",title:"标记",type:["object","selector"]},{name:"clickCallback",title:"点击后",type:"callback"},{name:"clickedAttachment",title:"点击标记",type:["object","selector"]}]};constructor(){super(),this.attachments=new THING.Selector,this.currentAttachment=new THING.Selector,this._count=0,this._object=null}getMaxFacade(e){let t=-1/0,n=0;return e.facades.forEach(((e,a)=>{e.boundingBox.size[1]>t&&(t=e.boundingBox.size[1],n=a)})),e.facades[n]}isImage(e){return-1!==["png","jpg","jpeg"].indexOf(e.toLowerCase())}getType(e){let t=e._getExtension();return new Promise(((n,a)=>{if(this.isImage(t))return n(AttachmentType$1.Image);if("html"==t.toLowerCase())return n(AttachmentType$1.Html);let o="json"==t?e:e._appendPath("bundle.json");THING.Utils.loadJSONFile(o).then((e=>{let t=e.type;return n(t||null)})).catch((()=>n(AttachmentType$1.Prefab)))}))}hasAttachment(e,t){if(e.userData.BPAttachmentUrl){if(e.userData.BPAttachmentUrl!=t){let t=e.find(`tags(${AttachmentTags$1})`,{recursive:!1});return this.type==AttachmentType$1.Attachment&&e.isBuilding&&e.facades[0]&&(t=t||this.getMaxFacade(e).find(`tags(${AttachmentTags$1})`,{recursive:!1})),t&&t.destroy(),!1}{let t=e.find(`tags(${AttachmentTags$1})`,{recursive:!1});return this.type==AttachmentType$1.Attachment&&e.isBuilding&&e.facades[0]&&(t=t||this.getMaxFacade(e).find(`tags(${AttachmentTags$1})`,{recursive:!1})),!(!t||t.destroyed)&&t}}return!1}async setVisible(e,t){this.traverseObject(e,(e=>{if(this.type==AttachmentType$1.Html){e.find(`tags(${AttachmentTags$1})`,{recursive:!1})[CssTag$1].visible=t}let n=e.find(`tags(${AttachmentTags$1})`,{recursive:!1});this.type==AttachmentType$1.Attachment&&e.isBuilding&&e.facades[0]&&(n=n||this.getMaxFacade(e).find(`tags(${AttachmentTags$1})`,{recursive:!1})),n?.setVisible(t,!0),n?.traverse((e=>e.level.config={ignoreVisible:!t}))}))}complete(e){this._count++,this._count>=this._object.length&&(e.object=this._object,e.attachment=this.currentAttachment,this.currentAttachment.forEach((e=>{e.on("click",(()=>{this.run("clickCallback",{clickedAttachment:e})}),{useCapture:!0})})),this.run("complete",e))}async createAttachment(e,t){switch(this.type){case AttachmentType$1.Image:return(e,n,a)=>{let o=THING.Math.addVector(e.boundingBox.center,[0,e.boundingBox.size[1]/2,0]);o=t?.offset?THING.Math.addVector(o,t.offset):o;let s=new THING.Marker({parent:e,position:o,style:{image:n},keepSize:t?.keepSize||!1,pivot:t?.pivot||[.5,0,0],scale:t?.scaleFactor?[t.scaleFactor,t.scaleFactor,t.scaleFactor]:[1,1,1],onComplete:()=>{this.attachmentSettings(s,n,a)}})};case AttachmentType$1.Html:if(!t.id)return void console.warn("缺少标签id");"html"!==e._getExtension().toLowerCase()&&(e=e._appendPath("index.html"));let n=await fetch(e),a=await n.text();a=a.replace(/(url\(|src=|href=)[\"\']*([^\"\'\(\)\<\>\[\] ]+)[\"\'\)]*/gi,(t=>t.replace(/[\"\'].+[\"\']/g,(t=>e._getPath()._appendPath(t.substring(1,t.length-1))))));const o=(new DOMParser).parseFromString(a,"text/html");let s=document.getElementById(this.app.container.id);for(let e=0;e<o.head.children.length;e++){let t=o.head.children[e].cloneNode(!0);s.appendChild(t)}for(let e=0;e<o.body.children.length;e++){let t=o.body.children[e].cloneNode(!0);s.appendChild(t)}for(let e=0;e<o.scripts.length;e++){let t=o.scripts[e],n=document.createElement("script");n.text=t.innerText,document.body.appendChild(n)}return(e,n,a)=>{let o=((s=document.querySelector("#"+t.id).cloneNode(!0)).style.display="block",s);var s;let c=[0,0,0],i=[.5,.5],r=e.boundingBox.center,l=e.boundingBox.halfSize;switch(t.localPosition){case"none":c=t.offset,i=t.pivot;break;case"top":c=[0,l[1],0],i=[.5,0];break;case"bottom":c=[0,-l[1],0],i=[.5,1];break;case"left":c=[l[0],0,0],i=[1,.5];break;case"right":c=[-l[0],0,0],i=[0,.5];break;case"front":c=[0,0,l[2]],i=[.5,.5];break;case"back":c=[0,0,-l[2]],i=[.5,.5]}let p=new THING.AttachedPoint({parent:e,position:THING.Math.addVector(r,c),keepSize:t?.keepSize||!1,localScale:t?.scaleFactor?[t.scaleFactor,t.scaleFactor,t.scaleFactor]:[1,1,1]});p.addComponent(THING.DOM.CSS3DComponent,CssTag$1),p[CssTag$1].domElement=o,o.setAttribute("objectId",e.id),p[CssTag$1].pivot=i,this.attachmentSettings(p,n,a)};case AttachmentType$1.Attachment:let c=new THING.ATTACHMENT.Attachment(e);return await c.waitForComplete(),async(e,n,a)=>{if(t){let n=Object.entries(t).map((([e,t])=>({src:e,value:t})));await c.addForObject(e,n)}else await c.addForObject(e);let o=e.find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith("__AttachmentRoot")));if(e.isBuilding&&e.facades[0]&&(o=o||this.getMaxFacade(e).find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith("__AttachmentRoot")))),!o)return;o.visible=!0,this.attachmentSettings(o,n,a);let s=t||await c.getConfig(),i=this.getAttachmentMonitorDataKey(s);if(0===i.length){const e="monitorData/";Object.keys(s).forEach((t=>{if("string"==typeof s[t]&&s[t].includes(e)){const n=s[t].replace(e,"");i.push(n)}}))}e.userData.attachmentNodeWatcher=e.monitorData?.subscribe(i,(async e=>{o.refresh?o.refresh():await o.children.forEachAsync((async e=>{await e.attachment.update()}))}))};case AttachmentType$1.Prefab:return(e,n,a)=>{let o=THING.Math.addVector(e.boundingBox.center,[0,e.boundingBox.size[1]/2,0]);o=t?.offset?THING.Math.addVector(o,t.offset):o;let s=new THING.AttachedObject({parent:e,url:n,position:o,keepSize:t?.keepSize||!1,pivot:t?.pivot||[.5,0,0],scale:t?.scaleFactor?[t.scaleFactor,t.scaleFactor,t.scaleFactor]:[1,1,1],onComplete:()=>{this.attachmentSettings(s,n,a)}})}}}getAttachmentMonitorDataKey(e){const t="propertyPath",n="monitorData/";let a=[];if(!e)return"*";if(e.configUI)e.configUI.forEach((o=>{let s=o.des;if(s.endsWith(t)&&THING.Utils.hasAttribute(e.config,s)){let t=THING.Utils.getAttribute(e.config,s);t&&t.startsWith(n)&&a.push(t.replace(n,""))}}));else for(let[o,s]of Object.entries(e))o.endsWith(t)&&s&&s.startsWith(n)&&a.push(s.replace(n,""));return a}attachmentSettings(e,t,n){this.attachments.push(e),this.currentAttachment.push(e),e.tags.add(AttachmentTags$1),this._batchRender&&(e.instanceGroupName="BP_Attachment",e.makeInstancedDrawing()),this.complete(n)}async showAttachment(e,t,n){let a=this.url;this.currentAttachment.clear(),this._count=0;let o=t.edit||{},s=o.configUIPro?[...o.configUI,...o.configUIPro]:o.configUI,c=[];if(this.traverseObject(this._object,(async e=>{let t=this.hasAttachment(e,a);if(t){if(this.setVisible(e,!0),this.type===AttachmentType$1.Attachment)for(const e of t.children.objects)await(e?.attachment?.update({userConfig:s}));this.complete(n)}else c.push(e)})),c.length){this.attachmentLoader=await this.createAttachment(a,s);for(const e of c)await this.attachmentLoader(e,a,n),e.userData.BPAttachmentUrl=a}}hideAttachment(e,t,n){this.setVisible(this._object,!1),n.object=this._object,n.attachment=this.currentAttachment,this.run("onHide",n)}async update(e,t,n){this.currentAttachment.clear(),this._count=0;let a,o=t.edit||{},s=o.configUIPro?[...o.configUI,...o.configUIPro]:o.configUI;t.object.isSelector?a=t.object.objects:t.object.isObject3D&&(a=[t.object]);for(const e of a){let a=e.find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith("__AttachmentRoot")));if(e.isBuilding&&e.facades[0]&&(a=a||this.getMaxFacade(e).find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith("__AttachmentRoot")))),a){for(const e of a.children.objects){const{options:n={},edit:a}=t,{id:o,key:s,value:c}=n;await(e?.attachment?.update({userConfig:a?.configUI,id:o,key:s,value:c}))}this.attachmentSettings(a,this.url,n)}else{let t=new THING.ATTACHMENT.Attachment(this.url);await t.waitForComplete();let a=Object.entries(s).map((([e,t])=>({src:e,value:t})));await t.addForObject(e,a);let o=e.find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith("__AttachmentRoot")));if(e.isBuilding&&e.facades[0]&&(o=o||this.getMaxFacade(e).find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith("__AttachmentRoot")))),!o)return;this.attachmentSettings(o,this.url,n),e.userData.BPAttachmentUrl=this.url}}}async onExecute(e,t,n){this._object=t.object,this._batchRender=t.batchRender;let a=t.url;if(this.url=this.getFullPath(a),!this.object)return;this._object&&this._object.isObject3D&&(this._object=[this._object]),n.object=t.object,this.type=await this.getType(a);let o=this[this.curExecName].bind(this);if(o){if(!this._object||!t.url)return;o(e,t,n)}n.attachment=this.currentAttachment}onStop(){this.attachments&&this.attachments.destroy(),this.currentAttachment.clear(),this._count=null,this._object=null}}const AttachmentTags="BP_attachment",CssTag="BP_css",AttachmentType={Image:"image",Prefab:"prefab",Attachment:"attachment",Html:"html"};class BPAttachmentV2 extends BaseNode3D{static config={name:"BPAttachmentV2",title:"标记",advanced:!0,inputs:[{name:"showAttachment",type:"exec"},{name:"hideAttachment",type:"exec"},{name:"options",type:"any",enabled:!1},{name:"object",title:"父对象",type:["object","selector"]},{name:"url",type:"string"},{name:"tag",type:["string","array"],enabled:!1},{name:"cursorStyle",title:"鼠标悬浮样式",type:"select",value:["default","pointer"],enabled:!1},{name:"edit",title:"编辑",type:"object",editor:"AttachmentEditor",visiblePin:!1},{name:"batchRender",type:"boolean",enabled:!1},{name:"autoHideIfObstructed",type:"boolean",enabled:!1}],outputs:[{name:"complete",title:"显示后",type:"callback"},{name:"onHide",title:"隐藏后",type:"callback"},{name:"object",title:"父对象",type:["object","selector"]},{name:"attachment",title:"标记",type:["object","selector"]},{name:"clickCallback",title:"点击后",type:"callback"},{name:"clickedAttachment",title:"点击标记",type:["object","selector"]}]};constructor(){super(),this.attachments=new THING.Selector,this.currentAttachment=new THING.Selector,this._count=0,this._object=null}getMaxFacade(e){let t=-1/0,n=0;return e.facades.forEach(((e,a)=>{e.boundingBox.size[1]>t&&(t=e.boundingBox.size[1],n=a)})),e.facades[n]}isImage(e){return-1!==["png","jpg","jpeg"].indexOf(e.toLowerCase())}getType(e){let t=e._getExtension();return new Promise(((n,a)=>{if(this.isImage(t))return n(AttachmentType.Image);if("html"==t.toLowerCase())return n(AttachmentType.Html);let o="json"==t?e:e._appendPath("bundle.json");THING.Utils.loadJSONFile(o).then((e=>{let t=e.type;return n(t||null)})).catch((()=>n(AttachmentType.Prefab)))}))}hasAttachment(e,t){if(e.userData.BPAttachmentUrl){if(e.userData.BPAttachmentUrl!=t){let t=e.find(`tags(${AttachmentTags})`,{recursive:!1});return t&&t.destroy(),!1}{let t=e.find(`tags(${AttachmentTags})`,{recursive:!1});return!(!t||t.destroyed)&&t}}return!1}async setVisible(e,t){this.traverseObject(e,(e=>{if(this.type==AttachmentType.Html){e.find(`tags(${AttachmentTags})`,{recursive:!1})[CssTag].visible=t}let n=e.find(`tags(${AttachmentTags})`,{recursive:!1});n?.setVisible(t,!0),n?.traverse((e=>e.level.config={ignoreVisible:!t}))}))}complete(e){this._count++,this._count>=this._object.length&&(e.object=this._object,e.attachment=this.currentAttachment,this.currentAttachment.forEach((e=>{if(e.on("click",(()=>{this.run("clickCallback",{clickedAttachment:e})}),{useCapture:!0}),this.autoHideIfObstructed){let t=e.attachedPoints[0].find((e=>"Marker"===e.type));t.pivot=[.5,-.01,.5],t.localPosition=[0,.05,0],t.render.autoHideIfObstructed=this.autoHideIfObstructed}})),this.run("complete",e))}async createAttachment(e,t,n){switch(this.type){case AttachmentType.Image:return(e,a,o)=>{let s=THING.Math.addVector(e.boundingBox.center,[0,e.boundingBox.size[1]/2,0]);s=t?.offset?THING.Math.addVector(s,t.offset):s;let c=new THING.Marker({parent:e,position:s,style:{image:a},keepSize:t?.keepSize||!1,pivot:t?.pivot||[.5,0,0],scale:t?.scaleFactor?[t.scaleFactor,t.scaleFactor,t.scaleFactor]:[1,1,1],onComplete:()=>{this.attachmentSettings(c,a,o,n)}})};case AttachmentType.Html:if(!t.id)return void console.warn("缺少标签id");"html"!==e._getExtension().toLowerCase()&&(e=e._appendPath("index.html"));let a=await fetch(e),o=await a.text();o=o.replace(/(url\(|src=|href=)[\"\']*([^\"\'\(\)\<\>\[\] ]+)[\"\'\)]*/gi,(t=>t.replace(/[\"\'].+[\"\']/g,(t=>e._getPath()._appendPath(t.substring(1,t.length-1))))));const s=(new DOMParser).parseFromString(o,"text/html");let c=document.getElementById(this.app.container.id);for(let e=0;e<s.head.children.length;e++){let t=s.head.children[e].cloneNode(!0);c.appendChild(t)}for(let e=0;e<s.body.children.length;e++){let t=s.body.children[e].cloneNode(!0);c.appendChild(t)}for(let e=0;e<s.scripts.length;e++){let t=s.scripts[e],n=document.createElement("script");n.text=t.innerText,document.body.appendChild(n)}return(e,a,o)=>{let s=((c=document.querySelector("#"+t.id).cloneNode(!0)).style.display="block",c);var c;let i=[0,0,0],r=[.5,.5],l=e.boundingBox.center,p=e.boundingBox.halfSize;switch(t.localPosition){case"none":i=t.offset,r=t.pivot;break;case"top":i=[0,p[1],0],r=[.5,0];break;case"bottom":i=[0,-p[1],0],r=[.5,1];break;case"left":i=[p[0],0,0],r=[1,.5];break;case"right":i=[-p[0],0,0],r=[0,.5];break;case"front":i=[0,0,p[2]],r=[.5,.5];break;case"back":i=[0,0,-p[2]],r=[.5,.5]}let u=new THING.AttachedPoint({parent:e,position:THING.Math.addVector(l,i),keepSize:t?.keepSize||!1,localScale:t?.scaleFactor?[t.scaleFactor,t.scaleFactor,t.scaleFactor]:[1,1,1]});u.addComponent(THING.DOM.CSS3DComponent,CssTag),u[CssTag].domElement=s,s.setAttribute("objectId",e.id),u[CssTag].pivot=r,this.attachmentSettings(u,a,o,n)};case AttachmentType.Attachment:let i=new THING.ATTACHMENT.Attachment(e);return await i.waitForComplete(),async(e,a,o)=>{if(t){let a=Object.entries(t).map((([e,t])=>({src:e,value:t})));await i.addForObject(e,a,n.options)}else await i.addForObject(e,[],n.options);let s=a.split("/"),c=`${s[s.length-1]}__AttachmentRoot`,r=e.find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith(c)));if(!r)return;r.visible=!0,this.attachmentSettings(r,a,o,n);let l=t||await i.getConfig(),p=this.getAttachmentMonitorDataKey(l);if(0===p.length){const e="monitorData/";Object.keys(l).forEach((t=>{if("string"==typeof l[t]&&l[t].includes(e)){const n=l[t].replace(e,"");p.push(n)}}))}e.userData.attachmentNodeWatcher=e.monitorData?.subscribe(p,(async e=>{r.refresh?r.refresh():await r.children.forEachAsync((async e=>{await e.attachment.update(n.options)}))}))};case AttachmentType.Prefab:return(e,a,o)=>{let s=THING.Math.addVector(e.boundingBox.center,[0,e.boundingBox.size[1]/2,0]);s=t?.offset?THING.Math.addVector(s,t.offset):s;let c=new THING.AttachedObject({parent:e,url:a,position:s,keepSize:t?.keepSize||!1,pivot:t?.pivot||[.5,0,0],scale:t?.scaleFactor?[t.scaleFactor,t.scaleFactor,t.scaleFactor]:[1,1,1],onComplete:()=>{this.attachmentSettings(c,a,o,n)}})}}}getAttachmentMonitorDataKey(e){const t="propertyPath",n="monitorData/";let a=[];if(!e)return"*";if(e.configUI)e.configUI.forEach((o=>{let s=o.des;if(s.endsWith(t)&&THING.Utils.hasAttribute(e.config,s)){let t=THING.Utils.getAttribute(e.config,s);t&&t.startsWith(n)&&a.push(t.replace(n,""))}}));else for(let[o,s]of Object.entries(e))o.endsWith(t)&&s&&s.startsWith(n)&&a.push(s.replace(n,""));return a}attachmentSettings(e,t,n,a){this.attachments.push(e),this.currentAttachment.push(e),e.tags.add(AttachmentTags);let o=a.tag;THING.Utils.isArray(o)?o.forEach((t=>e.tags.add(t))):e.tags.add(o),this._setCursorStyle(a.cursorStyle,e),this._batchRender&&(e.instanceGroupName="BP_Attachment",e.makeInstancedDrawing()),this.complete(n)}async showAttachment(e,t,n){let a=this.url;this.currentAttachment.clear(),this._count=0;let o=t.edit||{},s=o.configUIPro?[...o.configUI,...o.configUIPro]:o.configUI,c=[];if(this.traverseObject(this._object,(async e=>{let o=this.hasAttachment(e,a);if(o){if(this.setVisible(e,!0),this.type===AttachmentType.Attachment){this._setCursorStyle(t.cursorStyle,o);for(const t of o.children.objects){await(t?.attachment?.update({userConfig:s}));let n=s,a=this.getAttachmentMonitorDataKey(n);if(0===a.length){const e="monitorData/";Object.keys(n).forEach((t=>{if("string"==typeof n[t]&&n[t].includes(e)){const o=n[t].replace(e,"");a.push(o)}}))}e.monitorData?.unsubscribe(e.userData.attachmentNodeWatcher),e.userData.attachmentNodeWatcher=e.monitorData?.subscribe(a,(async e=>{t?.attachment?.update({userConfig:s})}))}}this.currentAttachment.push(o),this.complete(n)}else c.push(e)})),c.length){this.attachmentLoader=await this.createAttachment(a,s,t);for(const e of c)await this.attachmentLoader(e,a,n),e.userData.BPAttachmentUrl=a}}_setCursorStyle(e,t){void 0!==e&&("default"!==e?(t.on("mouseenter",(()=>{document.body.style.cursor=e}),"BPAttachment_CursorStyle",{useCapture:!0}),t.on("mouseleave",(()=>{document.body.style.cursor="default"}),"BPAttachment_CursorStyle",{useCapture:!0})):(t.off("mouseenter","BPAttachment_CursorStyle"),t.off("mouseleave","BPAttachment_CursorStyle")))}hideAttachment(e,t,n){this.setVisible(this._object,!1),n.object=this._object,n.attachment=this.currentAttachment,this.run("onHide",n)}async update(e,t,n){this.currentAttachment.clear(),this._count=0;let a,o=t.edit||{},s=o.configUIPro?[...o.configUI,...o.configUIPro]:o.configUI;t.object.isSelector?a=t.object.objects:t.object.isObject3D&&(a=[t.object]);for(const e of a){let a=url.split("/"),o=`${a[a.length-1]}__AttachmentRoot`,c=e.find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith(o)));if(c){for(const e of c.children.objects){const{options:n,edit:a}=t;await(e?.attachment?.update({userConfig:a?.configUI,idsConfig:n.idsConfig}))}this.attachmentSettings(c,this.url,n,t)}else{let a=new THING.ATTACHMENT.Attachment(this.url);await a.waitForComplete();let o=Object.entries(s).map((([e,t])=>({src:e,value:t})));await a.addForObject(e,o,t.options);let c=url.split("/"),i=`${c[c.length-1]}__AttachmentRoot`,r=e.find((e=>e.id.endsWith("__default__AttachmentRoot")||e.id.endsWith(i)));if(!r)return;this.attachmentSettings(r,this.url,n,t),e.userData.BPAttachmentUrl=this.url}}}async onExecute(e,t,n){this._object=t.object,this._batchRender=t.batchRender;let a=t.url;if(this.url=this.getFullPath(a),this.autoHideIfObstructed=t.autoHideIfObstructed,!this.object)return;this._object&&this._object.isObject3D&&(this._object=[this._object]),n.object=t.object,this.type=await this.getType(a);let o=this[this.curExecName].bind(this);if(o){if(!this._object||!t.url)return;o(e,t,n)}n.attachment=this.currentAttachment}onStop(){this.attachments&&this.attachments.destroy(),this.currentAttachment.clear(),this._count=null,this._object=null}}class BPSetBackgroundColor extends BaseNode3D{static config={name:"BPSetBackgroundColor",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"color",type:"color",value:"#FFFFFF"}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onSetup(){this._preBackground=this.app.background}onExecute(e,t,n){let a=t.color;this.app.background=a}onStop(){this.app.background=this._preBackground}}class BPSetBackgroundImage extends BaseNode3D{static config={name:"BPSetBackgroundImage",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"image",type:"string",value:`${BaseNode3D.BASEURL}image/background.png`}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onSetup(){this._preBackground=this.app.background}onExecute(e,t,n){let a=t.image;a=this.getFullPath(a),this.app.background=new THING.ImageTexture(a)}onStop(){this.app.background=this._preBackground}}class BPSetSkyBox extends BaseNode3D{static config={name:"BPSetSkyBox",inputs:[{name:"exec",type:"exec"},{name:"url",type:"string",value:`${BaseNode3D.BASEURL}image/skyboxes/blue/`}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onSetup(){this.pre_envMap=this.app.envMap,this.pre_background=this.app.background}onExecute(e,t,n){let a=t.url||`${BaseNode3D.BASEURL}image/skyboxes/blue/`;a=this.getFullPath(a);const o=new THING.CubeTexture({url:a});this.app.envMap||(this.app.envMap=o),this.app.background=o}onStop(){this.app.envMap=this.pre_envMap,this.app.background=this.pre_background}}class BPNumber extends BaseNode3D{static config={name:"BPNumber",inputs:[{name:"value",type:"number",visiblePin:!1}],outputs:[{name:"result",type:"number"}]};constructor(){super()}onExecute(e,t,n){n.result=t.value}}class BPString extends BaseNode3D{static config={name:"BPString",inputs:[{name:"value",type:"string",visiblePin:!1}],outputs:[{name:"result",type:"string"}]};constructor(){super()}onExecute(e,t,n){n.result=t.value}}class BPVector3 extends BaseNode3D{static config={name:"BPVector3",inputs:[{name:"value",type:"vector3",value:[0,0,0]}],outputs:[{name:"result",type:"vector3"}]};constructor(){super()}onExecute(e,t,n){let a=t.value||[0,0,0];n.result=a}}class BPVector2 extends BaseNode3D{static config={name:"BPVector2",inputs:[{name:"value",type:"vector2",value:[0,0],visiblePin:!1}],outputs:[{name:"result",type:"vector2"}]};constructor(){super()}onExecute(e,t,n){let a=t.value||[0,0];n.result=a}}class BPObjectCallFunction extends BaseNode3D{static config={name:"BPObjectCallFunction",desc:"obj.callFunction",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"func",type:"string"},{name:"params",type:"string"},{name:"recursive",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(data,inputs,outputs){let _name=inputs.func,_object=inputs.object,_parameters=inputs.params,recursive=inputs.recursive,_args;try{_args=_parameters.startsWith("{")&&_parameters.endsWith("}")?eval(`(${_parameters.replace(/"/g,"'")})`):_parameters}catch(e){console.error(e,"e")}_object?this.traverseObject(_object,(e=>{e.callFunction({funcName:_name,args:_args,recursive:recursive})})):console.error("Please provide the object input data")}}class BPBranch extends BaseNode3D{static config={name:"BPBranch",inputs:[{name:"exec",type:"exec"},{name:"condition",type:"any"}],outputs:[{name:"true",type:"exec"},{name:"false",type:"exec"}]};constructor(){super()}onExecute(e,t,n){t.condition?n.false=!1:n.true=!1}}class BPSwitchCase extends BaseNode3D{static config={name:"BPSwitchCase",inputs:[{name:"exec",type:"exec"},{name:"condition",type:"string"}],outputs:[{name:"exec",type:"exec"},{name:"default",type:"callback"}],dynamic:[{inputOrOutput:"input",type:"string",label:"case [index]",length:2},{inputOrOutput:"output",type:"callback",label:"then [index]",length:2}]};isDynamicInputs(){return!0}constructor(){super()}onExecute(data,inputs,outputs){let value=inputs.condition;"string"==typeof value&&(value="'"+value+"'");let caseArray=Object.entries(inputs).filter((([e,t])=>"condition"!==e)).map((([e,t])=>t));for(var str="switch("+value+"){",j=0;j<caseArray.length;j++)"number"==typeof caseArray[j]||"string"==typeof caseArray[j]?("string"==typeof caseArray[j]&&(caseArray[j]="'"+caseArray[j]+"'"),str=str+"case "+caseArray[j]+":this.syncRun('BPSwitchCase--"+j+"', outputs);break;"):console.warn("case value can only be number or string!");str+="default :this.syncRun('default', outputs);break;",str+="}",eval(str)}}class BPAnyTrigger extends BaseNode3D{static config={name:"BPAnyTrigger",inputs:[],outputs:[{name:"exec",type:"callback"}],dynamic:{inputOrOutput:"input",type:"exec",label:"then [index]",length:1}};isEntrance(){return!1}constructor(){super()}onExecute(e,t,n){this.syncRun("exec",n)}}class BPDelay extends BaseNode3D{static config={name:"BPDelay",inputs:[{name:"exec",type:"exec"},{name:"stop",type:"exec"},{name:"time",type:"number",value:1,unit:"s"}],outputs:[{name:"trigger",type:"callback"},{name:"onStop",type:"callback"},{name:"timer",type:"number",enabled:!1}]};constructor(){super(),this._timers=[]}onExecute(e,t,n){let a=this.curExecName,o=null;if("exec"==a){let e=this.handleTime(t.time);o=setTimeout((()=>{this.syncRun("trigger",n)}),e),this.timer=o,this._timers.push(o),n.timer=o}else"stop"==a&&(this.timer&&clearTimeout(this.timer),this.syncRun("onStop",n))}onStop(){this._timers.forEach((e=>{clearTimeout(e)})),this._timers=[]}}class BPClearDelay extends BaseNode3D{static config={name:"BPClearDelay",inputs:[{name:"exec",type:"exec"},{name:"timer",type:"number"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.timer;a&&clearTimeout(a)}}class BPForLoop extends BaseNode3D{static config={name:"BPForLoop",inputs:[{name:"exec",type:"exec"},{name:"firstIndex",type:"number",value:1},{name:"lastIndex",type:"number",value:100}],outputs:[{name:"complete",type:"callback"},{name:"next",type:"callback"},{name:"index",type:"number"}]};constructor(){super(),this.index=0}onExecute(e,t,n){let a=t.firstIndex,o=t.lastIndex;for(let e=a;e<o;e++)n.index=e,this.syncRun("next",n);this.syncRun("complete",n)}onStop(){}}class BPForEachLoop extends BaseNode3D{static config={name:"BPForEachLoop",inputs:[{name:"exec",type:"exec"},{name:"array",type:["array","selector"]}],outputs:[{name:"complete",type:"callback"},{name:"next",type:"callback"},{name:"element",type:["any","selector"]},{name:"index",type:"number"}]};constructor(){super(),this.index=0,this._objects=new THING.Selector}onExecute(e,t,n){let a,o=t.array;if(o&&(o.isSelector||THING.Utils.isArray(o))){for(let e=0;e<o.length;e++)o.isSelector?(this._objects.clear(),this._objects.push(o[e]),a=this._objects):a=o[e],n.element=a,n.index=e,this.syncRun("next",n);this.syncRun("complete")}}onStop(){}}class BPFlipFlop extends BaseNode3D{static config={name:"BPFlipFlop",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"default",type:"boolean",value:!1}],outputs:[{name:"A",type:"callback"},{name:"B",type:"callback"},{name:"IsA",type:"boolean"}]};constructor(){super(),this._isA=!1}onExecute(e,t,n){this._isA=!this._isA,n.IsA=this._isA,t.default?this._isA?this.syncRun("B",{IsA:!1}):this.syncRun("A",{IsA:!0}):this._isA?this.syncRun("A",{IsA:!0}):this.syncRun("B",{IsA:!1})}onStop(){this._isA=!1}}class BPTimer extends BaseNode3D{static config={name:"BPTimer",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"stop",type:"exec"},{name:"time",type:"number",value:1,unit:"s"},{name:"times",type:"number",enabled:!1},{name:"runNow",type:"boolean",enabled:!1}],outputs:[{name:"callback",type:"callback"},{name:"onStop",type:"callback"},{name:"currentTimes",type:"number",enabled:!1},{name:"timer",type:"number",title:"定时器",enabled:!1}]};constructor(){super(),this._timers=[]}onExecute(e,t,n){let a=this.curExecName;if("exec"==a){let e=t.times,a=this.handleTime(t.time),o=!0===t.runNow;if(this.currentTimes=0,o&&(this.currentTimes++,n.currentTimes=this.currentTimes,this.syncRun("callback",n),e===this.currentTimes))return;this._timer=setInterval((()=>{this.currentTimes++,n.currentTimes=this.currentTimes,this.syncRun("callback",n),e===this.currentTimes&&clearInterval(this._timer)}),a),this._timers.push(this._timer),n.timer=this._timer}else"stop"==a&&(this._timer&&clearInterval(this._timer),this.syncRun("onStop",n))}onStop(){this._timers.forEach((e=>{clearInterval(e)})),this._timers=[]}}class BPClearTimer extends BaseNode3D{static config={name:"BPClearTimer",title:"清除定时器",inputs:[{name:"exec",type:"exec"},{name:"timer",type:"number",title:"定时器"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.timer;a&&clearInterval(a)}}class CountDownLatch extends BaseNode3D{static config={name:"CountDownLatch",inputs:[],outputs:[{name:"done",type:"callback"}],dynamic:{inputOrOutput:"input",type:"exec",label:"then [index]",length:2}};onInitConnection(e,t){super.onInitConnection(e,t),this.inputKeys=Object.keys(e)}onExecute(e,t,n){this._execName&&(this.execCount=this.execCount??new Set,this.execCount.add(this._execName),this.execCount.size>=this.inputKeys.length&&(this.execCount.clear(),this.run("done")))}}class BPOneTimeExecution extends BaseNode3D{static config={name:"BPOneTimeExecution",inputs:[{name:"exec",type:"exec"},{name:"clear",type:"exec",enabled:!1},{name:"value",type:"string"}],outputs:[{name:"next",type:"callback"}]};constructor(){super(),this.oneTimeVarName="BP_oneTimeVar"}onExecute(e,t,n){let a=this.curExecName,o=t.value;if("exec"==a){this._blueprint.getVar(this.oneTimeVarName)!==o&&(this.syncRun("next",n),this._blueprint.setVar(this.oneTimeVarName,o))}else"clear"==a&&this._blueprint.setVar(this.oneTimeVarName,null)}}class BPIsEqual extends BaseNode3D{static config={name:"BPIsEqual",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"param1",type:"any",input:!0},{name:"param2",type:"any",input:!0}],outputs:[{name:"equal",type:"callback"},{name:"notEqual",type:"callback"},{name:"param1",type:"any",enabled:!1},{name:"param2",type:"any",enabled:!1}]};constructor(){super()}isObject(e){return"object"==typeof e&&null!==e}isEqual(e,t){if(e===t)return!0;var n=this.isObject(e),a=this.isObject(t);if(!n||!a)return!n&&!a&&String(e)===String(t);try{var o=Array.isArray(e),s=Array.isArray(t);if(o&&s)return e.length===t.length&&e.every(((e,n)=>this.isEqual(e,t[n])));if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(o||s)return!1;var c=Object.keys(e),i=Object.keys(t);return c.length===i.length&&c.every((n=>this.isEqual(e[n],t[n])))}catch(e){return console.log(e),!1}}onExecute(e,t,n){let a=t.param1,o=t.param2;n.param1=a,n.param2=o,this.isEqual(a,o)?this.syncRun("equal",n):this.syncRun("notEqual",n)}onStop(){}}class BPRegExpTest extends BaseNode3D{static config={name:"BPRegExpTest",inputs:[{name:"exec",type:"exec"},{name:"RegExp",type:"string"},{name:"string",type:"string"}],outputs:[{name:"match",type:"callback"},{name:"notMatch",type:"callback"},{name:"string",type:"string"}]};constructor(){super()}onExecute(e,t,n){let a=new RegExp(t.RegExp),o=t.string;n.string=o,a.test(o)?this.syncRun("match",n):this.syncRun("notMatch",n)}}class BPRegExpTestCase extends BaseNode3D{static config={name:"BPRegExpTestCase",inputs:[{name:"exec",type:"exec"},{name:"condition",type:"string"}],outputs:[{name:"exec",type:"exec"},{name:"default",type:"callback"}],dynamic:[{inputOrOutput:"input",type:"string",label:"RegExp [index]",length:2},{inputOrOutput:"output",type:"callback",label:"then [index]",length:2}]};isDynamicInputs(){return!0}constructor(){super()}onExecute(e,t,n){let a=t.condition,o=Object.entries(t).filter((([e,t])=>"condition"!==e)).map((([e,t])=>t));for(let e=0;e<o.length;e++){if(new RegExp(o[e]).test(a))return void this.syncRun(`BPRegExpTestCase--${e}`,n)}this.syncRun("default",n)}}class BPNumberCompare extends BaseNode3D{static config={name:"BPNumberCompare",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"value1",type:"number",input:!0},{name:"value2",type:"number",input:!0}],outputs:[{name:"greater",type:"callback"},{name:"less",type:"callback"},{name:"equal",type:"callback"},{name:"value1",type:"number",enabled:!1},{name:"value2",type:"number",enabled:!1}]};constructor(){super()}onExecute(e,t,n){let a=t.value1,o=t.value2;n.value1=a,n.value2=o,a>o&&a!=o?this.syncRun("greater",n):a<o&&a!=o?this.syncRun("less",n):a==o&&this.syncRun("equal",n)}onStop(){}}class BPCheckNumberRange extends BaseNode3D{static config={name:"BPCheckNumberRange",inputs:[{name:"exec",type:"exec"},{name:"value",type:"number"},{name:"min",type:"number"},{name:"max",type:"number"},{name:"inclusive",type:"boolean"}],outputs:[{name:"exec",type:"exec",enabled:!1},{name:"inside",type:"callback"},{name:"outside",type:"callback"}]};constructor(){super()}onExecute(e,t,n){const{value:a,min:o,max:s,inclusive:c}=t;let i=!1;i=c?a>=o&&a<=s:a>o&&a<s,i?this.run("inside"):this.run("outside")}}class BPIsObjectValid extends BaseNode3D{static config={name:"BPIsObjectValid",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"param",type:"any",input:!0}],outputs:[{name:"exist",type:"callback"},{name:"notExist",type:"callback"},{name:"param",type:"any",enabled:!1}]};constructor(){super()}onExecute(e,t,n){let a=t.param;n.param=a,a?this.syncRun("exist",n):this.syncRun("notExist",n)}onStop(){}}class BPIsContains extends BaseNode3D{static config={name:"BPIsContains",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"collection",type:["array","selector","string"]},{name:"param",type:"any"}],outputs:[{name:"contains",type:"callback"},{name:"notContains",type:"callback"},{name:"collection",type:["array","selector"],enabled:!1},{name:"param",type:"any",enabled:!1}]};constructor(){super()}isObject(e){return"object"==typeof e&&null!==e}isEqual(e,t){if(e===t)return!0;var n=this.isObject(e),a=this.isObject(t);if(!n||!a)return typeof e==typeof t?e===t:typeof e!=typeof t&&String(e)===String(t);try{var o=Array.isArray(e),s=Array.isArray(t);if(o&&s)return e.length===t.length&&e.every(((e,n)=>this.isEqual(e,t[n])));if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(o||s)return!1;var c=Object.keys(e),i=Object.keys(t);return c.length===i.length&&c.every((n=>this.isEqual(e[n],t[n])))}catch(e){return console.log(e),!1}}isContains(e,t){let n=!1;if(!THING.Utils.isNull(e)&&!THING.Utils.isNull(t))return"string"==typeof e?-1!==e.indexOf(t)?(n=!0,n):n:(Array.isArray(e)&&e.forEach((e=>{e.isSelector&&e.length>0&&(e=e[0]),this.isEqual(e,t)&&(n=!0)})),n)}onExecute(e,t,n){let a=t.collection;a&&a.isSelector&&(a=a.objects);let o=t.param;o&&o.isSelector&&o.length>0&&(o=o[0]),n.collection=t.collection,n.param=t.param,this.isContains(a,o)?this.syncRun("contains",n):this.syncRun("notContains",n)}onStop(){}}class BPIsCollectionEmpty extends BaseNode3D{static config={name:"BPIsCollectionEmpty",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"param",type:"any",input:!0}],outputs:[{name:"empty",type:"callback"},{name:"notEmpty",type:"callback"},{name:"param",type:"any",enabled:!1}]};constructor(){super()}isObject(e){return"object"==typeof e&&null!==e}isEmpty(e){let t=!0;if(e instanceof Array)e.length&&(t=!1);else if(e&&e.isSelector){e.objects.length&&(t=!1)}else e&&(t=!1);return t}onExecute(e,t,n){let a=t.param;n.param=a,this.isEmpty(a)?this.syncRun("empty",n):this.syncRun("notEmpty",n)}onStop(){}}class BPCheckObjectTag extends BaseNode3D{static config={name:"BPCheckObjectTag",inputs:[{name:"exec",type:"exec"},{name:"tag",type:["string","array"]},{name:"object",type:["object","selector"]},{name:"contain",type:"boolean",value:!1}],outputs:[{name:"exec",type:"exec"},{name:"yes",type:"exec"},{name:"no",type:"exec"},{name:"object",type:"any"},{name:"result",type:"boolean"}]};constructor(){super()}onExecute(e,t,n){let a=t.tag,o=t.contain,s=this.getFirstObject(t.object);if(n.object=s,n.result=!1,s){if("string"==typeof a&&a.startsWith("[")&&a.endsWith("]"))try{a=JSON.parse(a.replace(/'/g,'"'))}catch(e){console.error(e)}if(o)if("string"==typeof a)s&&s.tags&&s.tags.has(a)?(n.result=!0,n.no=!1):n.yes=!1;else if(s&&s.tags){for(let e=0;e<a.length;e++)if(s.tags.has(a[e]))return n.result=!0,void(n.no=!1);n.yes=!1}else n.yes=!1;else a instanceof Array?Array.from(s.tags).sort().toString()===a.sort().toString()?(n.result=!0,n.no=!1):n.yes=!1:"string"==typeof a&&1===s.tags.size&&Array.from(s.tags)[0]===a?(n.result=!0,n.no=!1):n.yes=!1}}onStop(){}}class BPIsTrue extends BaseNode3D{static config={name:"BPIsTrue",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"value",type:"boolean"}],outputs:[{name:"true",type:"exec"},{name:"false",type:"exec"},{name:"value",type:"boolean",enabled:!1}]};constructor(){super()}onExecute(e,t,n){let a=t.value;n.value=a,!0===a?n.false=!1:!1===a&&(n.true=!1)}}const DEFAULT_CODE$1="\nfunction onExecute(params) {\n\n    // 参数获取方式：params\n    console.info(params)\n\n    // 输出返回值：return xx\n    return params\n\n    // 异步逻辑需要返回Promise，如\n    // return new Promise((resolve, reject) => {\n    //  fetch('/xx')\n    //    .then(res => res.json())\n    //    .then(res => resolve(res))\n    //    .catch(err => reject(err))\n    // })\n}\n\n// 蓝图结束时执行\n// function onStop() {\n\n// }\n//# sourceMappingURL=controlKit.min.js.map\n";class BPCode extends BaseNode3D{constructor(){super()}static config={title:"代码",name:"BPCode",advanced:!0,propertyPanel:{code:{name:"自定义",type:"code",default:DEFAULT_CODE$1}},inputs:[{name:"exec",type:"exec"},{name:"params",type:"any"},{name:"propertyPanel",type:"object",visible:!1,language:"javascript",value:{code:DEFAULT_CODE$1}}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback"},{name:"fail",type:"callback"},{name:"returns",type:"any"}]};execStr(e,t){let n="//@ sourceURL=debug.js";const a=e.match(/sourceMappingURL=(.*)/);a&&(n=n.replace("debug.js",a[1]));let o=`${n}\nreturn onExecute.call(this,params);\n${e}`,s=`${n}\ntypeof onStop === "function" ? onStop() : false;\n${e}`;this.userOnStop=new Function("params",s);return new Function("params",o).call(this,t)}onStop(){this.userOnStop?.()}onExecute(data,inputs,outputs){const{propertyPanel:propertyPanel,params:params}=inputs,codeText=propertyPanel?.code;if(!codeText)return;let param,res;try{param=Array.isArray(params)?params:eval("("+params+")")}catch(e){param=params}try{res=this.execStr(codeText,param)}catch(e){return console.error(e),void this.run("fail",outputs)}res instanceof Promise?res.then((e=>{outputs.returns=e,this.run("complete",outputs)})).catch((e=>{console.error(e),this.run("fail",outputs)})):(outputs.returns=res,this.run("complete",outputs))}}class BPExecuteCode extends BaseNode3D{constructor(){super()}static config={name:"BPExecuteCode",title:"加载脚本",inputs:[{name:"exec",type:"exec"},{name:"url",type:"string",editor:"ExecuteCodeEditor"}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback"},{name:"fail",type:"callback"}]};onStop(){}async onExecute(e,t,n){const{url:a}=t;let o,s=this.getFullPath(a);s=`${s}?t=${Date.now()}`,await fetch(s).then((e=>e.text())).then((e=>o=e)).catch((e=>console.error(e)));const c=function(e){try{return new Function(`${e};`),!0}catch(e){return e.message}}(`{${o}}`);if(!0!==c)return this.run("fail",n),void console.error(c);Promise.resolve().then((async()=>{const e=document.createElement("script");e.textContent=`{${o}}`,e.onload=()=>{this.run("complete",n)},e.onerror=()=>{this.run("fail",n)},document.head.appendChild(e)})).catch((e=>{this.run("fail",n)}))}}const DEFAULT_JSON="\n{}\n";class BPJSON extends BaseNode3D{constructor(){super()}static config={name:"BPJSON",advanced:!0,propertyPanel:{code:{name:"自定义",type:"code",default:DEFAULT_JSON}},inputs:[{name:"propertyPanel",type:"object",visible:!1,language:"javascript",value:{code:DEFAULT_JSON}}],outputs:[{name:"data",type:"any"}]};onExecute(e,t,n){const a=t.propertyPanel;let o=a?.code;if(o)try{o=JSON.parse(o),n.data=o}catch(e){console.error("error",e)}}}class BPRandomInt extends BaseNode3D{static config={name:"BPRandomInt",inputs:[{name:"min",type:"number",value:0},{name:"max",type:"number",value:100}],outputs:[{name:"result",type:"number"}]};onExecute(e,t,n){let a=t.min,o=t.max,s=a+Math.random()*(o-a);s=parseInt(s),n.result=s}}class BPRandomFloat extends BaseNode3D{static config={name:"BPRandomFloat",inputs:[{name:"min",type:"number",value:0},{name:"max",type:"number",value:100}],outputs:[{name:"result",type:"number"}]};onExecute(e,t,n){let a=t.min,o=t.max,s=a+Math.random()*(o-a);n.result=s}}class BPGetElementFromArray extends BaseNode3D{static config={name:"BPGetElementFromArray",inputs:[{name:"exec",type:"exec"},{name:"array",type:["array","selector","vector3"]},{name:"index",type:"number",value:0}],outputs:[{name:"next",type:"exec"},{name:"element",type:"any"}]};onExecute(e,t,n){let a=t.array,o=t.index||0;a?a.isSelector&&a.length>o?n.element=a.slice(o,o+1):a.length>o&&(n.element=a[o]):console.error("please check the array!")}}class BPArrayAddElement extends BaseNode3D{static config={name:"BPArrayAddElement",inputs:[{name:"exec",type:"exec"},{name:"array",type:"array"},{name:"element",type:"any"}],outputs:[{name:"exec",type:"exec"},{name:"array",type:"array"}]};constructor(){super()}onExecute(e,t,n){let a=t.array,o=t.element;a&&a instanceof Array&&o&&a.push(o),n.array=a}}class BPConvertAnyToVector3 extends BaseNode3D{static config={name:"BPConvertAnyToVector3",inputs:[{name:"exec",type:"exec"},{name:"param",type:"any"}],outputs:[{name:"exec",type:"exec"},{name:"result",type:"vector3"}]};constructor(){super()}onExecute(e,t,n){let a=t.param,o=[];if("number"==typeof a)o=[a,a,a];else if("string"==typeof a){var s=a.split(",");3===s.length?(o.push(Number(s[0])),o.push(Number(s[1])),o.push(Number(s[2]))):o=[0,0,0]}else a instanceof Array&&3==a.length?(a.forEach((e=>{e=Number(e),o.push(e)})),(isNaN(o[0])||isNaN(o[1])||isNaN(o[2]))&&(o=[0,0,0])):o=[0,0,0];n.result=o}}class BPConvertAnyToString extends BaseNode3D{static config={name:"BPConvertAnyToString",inputs:[{name:"exec",type:"exec"},{name:"param",type:"any"}],outputs:[{name:"exec",type:"exec"},{name:"result",type:"string"}]};constructor(){super()}onExecute(e,t,n){let a=t.param;("object"!=typeof a||Array.isArray(a))&&(n.result=String(a))}}class BPArray extends BaseNode3D{static config={name:"BPArray",inputs:[{name:"array",type:"any"}],outputs:[{name:"result",type:"array"}]};constructor(){super()}onExecute(e,t,n){let a=t.array,o=[];try{a instanceof Array?a.forEach((e=>{e=JSON.parse(e),o.push(e)})):"string"==typeof a&&(a=this.fixIrregularJSON(a),o=JSON.parse(a))}catch(e){}n.result=o}}class BPRandomVector3Array extends BaseNode3D{static config={name:"BPRandomVector3Array",group:"Basic",inputs:[{name:"min",type:"vector3",value:[0,0,0]},{name:"max",type:"vector3",value:[1,1,1]},{name:"length",type:"number",value:5}],outputs:[{name:"result",type:"array"}]};constructor(){super(),this.points=[]}onExecute(e,t,n){const a=t.min||[0,0,0],o=t.max||[1,0,1];let s=t.length||10,c=this._randomPoints(a,o,s);this.points=c,n.result=c}_randomPoints(e,t,n){const a=[];for(let o=0;o<n;o++)a.push(THING.Math.randomVector(e,t));return a}onStop(){this.points=[]}}class BPRandomVector3 extends BaseNode3D{static config={name:"BPRandomVector3",group:"Basic",inputs:[{name:"min",type:"vector3",value:[0,0,0]},{name:"max",type:"vector3",value:[1,1,1]}],outputs:[{name:"result",type:"vector3"}]};constructor(){super()}onExecute(e,t,n){const a=t.min||[0,0,0],o=t.max||[1,1,1];let s=THING.Math.randomVector(a,o);n.result=s}}class BPVector3Add extends BaseNode3D{static config={name:"BPVector3Add",inputs:[{name:"value1",type:"vector3",value:[0,0,0]},{name:"value2",type:"vector3",value:[0,0,0]}],outputs:[{name:"result",type:"vector3"}]};constructor(){super()}onExecute(e,t,n){let a=t.value1||[0,0,0],o=t.value2||[0,0,0];n.result=THING.Math.addVector(a,o)}}class BPGetLastNumberStr extends BaseNode3D{static config={name:"BPGetLastNumberStr",inputs:[{name:"exec",type:"exec"},{name:"string",type:"string"}],outputs:[{name:"next",type:"exec"},{name:"lastNumber",type:"string"}]};constructor(){super()}onExecute(e,t,n){let a=t.string;n.lastNumber=null;var o=/(\d+)$/g.exec(a);o&&(n.lastNumber=o[1])}onStop(){}}class BPRandomElementFromArray extends BaseNode3D{static config={name:"BPRandomElementFromArray",inputs:[{name:"exec",type:"exec"},{name:"array",type:"array"}],outputs:[{name:"next",type:"exec"},{name:"result",type:"any"}]};onExecute(e,t,n){let a=THING.Math.randomFromArray(t.array);n.result=a}}class BPRandomColor extends BaseNode3D{static config={name:"BPRandomColor",outputs:[{name:"color",type:"color"}]};onExecute(e,t,n){let a=THING.Math.randomColor();n.color=a}}class BPCreateCircleVector3Array extends BaseNode3D{static config={name:"BPCreateCircleVector3Array",group:"Basic",inputs:[{name:"position",type:"vector3",value:[0,0,0]},{name:"radius",type:"number",value:5},{name:"segments",type:"number",value:50}],outputs:[{name:"result",type:"array"}]};constructor(){super()}onExecute(e,t,n){let a=t.position,o=t.radius,s=t.segments,c=[];for(var i=0;i<s;i++){let e=360/s*i,t=a[0]+Math.cos(2*Math.PI/360*e)*o,n=a[2]+Math.sin(2*Math.PI/360*e)*o;c.push([t,a[1],n])}c.push([o+a[0],a[1],0+a[2]]),n.result=c}}class BPStringAdd extends BaseNode3D{static config={name:"BPStringAdd",inputs:[{name:"exec",type:"exec"},{name:"value1",type:"any",input:!0},{name:"value2",type:"any",input:!0}],outputs:[{name:"next",type:"exec"},{name:"result",type:"string"}]};onExecute(e,t,n){let a=t.value1.toString(),o=t.value2.toString();n.result=a+o}}class BaseNumberCalculator extends BaseNode3D{static config={name:"BaseNumberCalculator",inputs:[{name:"exec",type:"exec"},{name:"value1",type:"number",input:!0},{name:"value2",type:"number",input:!0}],outputs:[{name:"next",type:"exec"},{name:"result",type:"number"}]};constructor(e){super(),this.operation=e}onExecute(e,t,n){this.num1=t.value1,this.num2=t.value2,this.isFloat(this.num1)||this.isFloat(this.num2)?n.result=this.calculatePrecise(this.operation):n.result=this.calculateSimple(this.operation)}isFloat(e){return Number(e)===e&&e%1!=0}getTotleDecimalPlaces(e,t){switch(this.operation){case"+":case"-":return Math.max(e,t);case"*":case"/":return e+t}}calculateSimple(e){switch(e){case"+":return this.num1+this.num2;case"-":return this.num1-this.num2;case"*":return this.num1*this.num2;case"/":return this.num1/this.num2}}calculatePrecise(e){let t,n=this.num1.toString(),a=this.num2.toString(),o=n.split(".")[1]?.length||0,s=a.split(".")[1]?.length||0,c=this.getTotleDecimalPlaces(o,s),i=Math.pow(10,c),r=Math.round(this.num1*i),l=Math.round(this.num2*i);switch(e){case"+":t=(r+l)/i;break;case"-":t=(r-l)/i;break;case"*":t=r*l/(i*i);break;case"/":t=r/l;break;default:throw new Error("Unknown operation.")}return Number(t.toFixed(c))}}class BPNumberMultiply extends BaseNumberCalculator{static config={name:"BPNumberMultiply",inputs:[...BaseNumberCalculator.config.inputs],outputs:[...BaseNumberCalculator.config.outputs]};constructor(){super("*")}}class BPNumberDivision extends BaseNumberCalculator{static config={name:"BPNumberDivision",inputs:[...BaseNumberCalculator.config.inputs],outputs:[...BaseNumberCalculator.config.outputs]};constructor(){super("/")}}class BPNumberSubtract extends BaseNumberCalculator{static config={name:"BPNumberSubtract",inputs:[...BaseNumberCalculator.config.inputs],outputs:[...BaseNumberCalculator.config.outputs]};constructor(){super("-")}}class BPNumberAdd extends BaseNumberCalculator{static config={name:"BPNumberAdd",inputs:[...BaseNumberCalculator.config.inputs],outputs:[...BaseNumberCalculator.config.outputs]};constructor(){super("+")}}class BPInvertBoolean extends BaseNode3D{static config={name:"BPInvertBoolean",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"inputBool",type:"boolean"}],outputs:[{name:"exec",type:"exec"},{name:"result",type:"boolean"}]};constructor(){super()}onExecute(e,t,n){let a=!t.inputBool;n.result=a}onStop(){}}class BPColorPicker extends BaseNode3D{static config={name:"BPColorPicker",inputs:[{name:"exec",type:"exec"},{name:"color",type:"color",value:"#ffffff"}],outputs:[{name:"next",type:"exec"},{name:"color",type:"color"}]};onExecute(e,t,n){n.color=t.color}}class BPStringToJSON extends BaseNode3D{static config={name:"BPStringToJSON",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"value",type:"string"}],outputs:[{name:"exec",type:"exec"},{name:"result",type:"object"}]};constructor(){super()}onExecute(data,inputs,outputs){let inputString=inputs.value,result=null;try{result=eval(`(${inputString.replace(/"/g,"'")})`)}catch(e){console.error(e,"e")}outputs.result=result}onStop(){}}class BPJSONToString extends BaseNode3D{static config={name:"BPJSONToString",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"value",type:"object"}],outputs:[{name:"exec",type:"exec"},{name:"result",type:"string"}]};constructor(){super()}onExecute(e,t,n){let a,o=t.value;try{a=JSON.stringify(o)}catch(e){console.error(e,"Invalid JSON object"),a=null}n.result=a}onStop(){}}class BPGetCurrentTimestamp extends BaseNode3D{static config={name:"BPGetCurrentTimestamp",inputs:[],outputs:[{name:"timestamp",type:"number"}]};onExecute(e,t,n){n.timestamp=Date.now()}}class BPDataProcessor extends BaseNode3D{static config={name:"BPDataProcessor",inputs:[{name:"id",type:"string",visiblePin:!1},{name:"key",type:"string",visiblePin:!1},{name:"value",type:"any",visiblePin:!1}],outputs:[{name:"data",type:"object"}]};constructor(){super()}isDynamicInputs(){return!0}onExecute(e,t,n){let a={id:t.id,key:t.key,value:t.value};n.data=a}}class BPStartWebsocketDataMonitor extends BaseNode3D{static config={name:"BPStartWebsocketDataMonitor",inputs:[{name:"start",type:"exec"},{name:"stop",type:"exec"},{name:"url",type:"string"},{name:"interval",type:["string","number"],value:"5",visiblePin:!1,unit:"s"},{name:"distributeToObjects",title:"分发给对象",type:"boolean",enabled:!1,visiblePin:!1},{name:"dataProcessor",type:"object"}],outputs:[{name:"receive",type:"callback"},{name:"update",title:"更新数据后",type:"callback"},{name:"data",type:"any"}]};constructor(){super()}onExecute(e,t,n){let a={type:"websocket",url:t.url,interval:this.handleTime(t.interval),distributeToObjects:t.distributeToObjects,onReceiveData:e=>{this.syncRun("receive",{data:e})},onMessage:e=>{this.syncRun("update",{data:e})}};a.url=this._replaceVariables(a.url,this._blueprint.getVars()),a.interval?a.needsDuplicateRequest=!0:(a.needsDuplicateRequest=!1,a.interval=1);let o=this.curExecName;"start"==o?this.taskId=this.app.monitorManager.start(a,{root:t.root,processor:function(e){let n=t.dataProcessor;if("function"==typeof n)return n(e);for(let t in n){let a=n[t];!e.hasOwnProperty(t)&&e.hasOwnProperty(a)&&(e[t]=e[a],delete e[a])}return e}}):"stop"==o&&this.app.monitorManager.stop(this.taskId)}onStop(){this.app.monitorManager.stop(this.taskId)}}const DEFAULT_CODE="\nfunction onExecute(params) {\n    // 输出返回值：return xx\n    return (data) => {\n      let outputData;\n      try{\n          outputData = JSON.parse(data[params]);\n      } catch (e) {\n          outputData = data[params];\n\t\t  if (!outputData){\n\t\t\ttry{\n\t\t\t\toutputData = JSON.parse(data);\n\t\t\t} catch (e) {\n\n\t\t\t}\n\t\t  }\n      }\n    \n      return outputData;\n    }\n}\n";class BPProcessData extends BaseNode3D{constructor(){super()}static config={title:"数据处理",name:"BPProcessData",advanced:!0,propertyPanel:{code:{name:"自定义",type:"code",default:DEFAULT_CODE}},inputs:[{name:"params",type:"any"},{name:"fileName",type:"string",visible:!1},{name:"propertyPanel",type:"object",visible:!1,visiblePin:!1,language:"javascript",value:{code:DEFAULT_CODE}}],outputs:[{name:"returns",type:"any"}]};execStr(e,t,n){let a="//@ sourceURL=debug.js";e&&(a=a.replace("debug",e));return new Function("params",`${a}\nreturn onExecute(params);\n${t}`)(n)}onStop(){this.userOnStop?.()}getParam(params){try{return Array.isArray(params)?params:eval("("+params+")")}catch(e){return params}}onExecute(e,t,n){const{propertyPanel:a,params:o,fileName:s}=t,c=a?.code;if(!c)return;let i=this.getParam(o);const r=this.execStr(s,c,i);n.returns=r}}class BPStartAjaxDataMonitor extends BaseNode3D{static config={name:"BPStartAjaxDataMonitor",inputs:[{name:"start",type:"exec"},{name:"stop",type:"exec"},{name:"url",type:"string"},{name:"requestMethod",type:"select",value:["POST","GET"],visiblePin:!1},{name:"requestData",type:"any"},{name:"requestContentType",title:"请求数据类型",type:"select",value:["application/json","application/x-www-form-urlencoded","text/plain"],enabled:!1},{name:"disableCache",title:"禁用缓存",type:"boolean",visiblePin:!1},{name:"interval",type:["string","number"],value:"5",visiblePin:!1,unit:"s"},{name:"distributeToObjects",title:"分发给对象",type:"boolean",enabled:!1,visiblePin:!1},{name:"dataProcessor",type:"object"},{name:"root",type:"object",enabled:!1}],outputs:[{name:"receive",type:"callback"},{name:"data",type:"any"}]};constructor(){super()}onExecute(e,t,n){let a=t.url,o=t.requestData,s={type:"ajax",requestMethod:t.requestMethod,requestContentType:t.requestContentType,requestData:{},disableCache:t.disableCache,distributeToObjects:t.distributeToObjects,interval:this.handleTime(t.interval),onReceiveData:e=>{this.syncRun("receive",{data:e})}};if(o&&(o.isBaseObject||o.isSelector)){let e=[];this.traverseObject(o,(t=>{e.push(t.id)})),s.requestData.ids=e}else s.requestData=o||{};a=this._replaceVariables(a,this._blueprint.getVars()),s.url=a,s.interval?s.needsDuplicateRequest=!0:(s.needsDuplicateRequest=!1,s.interval=1);let c=this.curExecName;if("start"==c){let e=this.app.monitorManager.start(s,{root:t.root,processor:function(e){let n=t.dataProcessor;if("function"==typeof n)return n(e);for(let t in n){let a=n[t];!e.hasOwnProperty(t)&&e.hasOwnProperty(a)&&(e[t]=e[a],delete e[a])}return e}});this.taskId=e}else"stop"==c&&this.app.monitorManager.stop(this.taskId)}onStop(){this.app.monitorManager.stop(this.taskId)}}class BPStartSimulationDataMonitor extends BaseNode3D{static config={name:"BPStartSimulationDataMonitor",title:"对接数据 - 模拟数据",inputs:[{name:"start",type:"exec"},{name:"stop",type:"exec"},{name:"interval",type:["string","number"],value:"5",visiblePin:!1,unit:"s"},{name:"distributeToObjects",title:"分发给对象",type:"boolean",enabled:!1,visiblePin:!1},{name:"onGenerateData",type:"any"},{name:"dataProcessor",type:"object"},{name:"root",type:"object",enabled:!1}],outputs:[{name:"receive",type:"callback"},{name:"data",type:"any"}]};constructor(){super()}onExecute(e,t,n){let a={type:"simulation",url:t.url,interval:this.handleTime(t.interval),distributeToObjects:t.distributeToObjects,onReceiveData:e=>{this.syncRun("receive",{data:e})}};a.url=this._replaceVariables(a.url,this._blueprint.getVars()),a.onGenerateData=t.onGenerateData;let o=t.dataProcessor;a.interval?a.needsDuplicateRequest=!0:(a.needsDuplicateRequest=!1,a.interval=1);let s=this.curExecName;if("start"==s){let e=this.app.monitorManager.start(a,{root:t.root,processor:function(e){if("function"==typeof o)return o(e);for(let t in o){let n=o[t];!e.hasOwnProperty(t)&&e.hasOwnProperty(n)&&(e[t]=e[n],delete e[n])}return e}});this.taskId=e}else"stop"==s&&this.app.monitorManager.stop(this.taskId)}onStop(){this.app.monitorManager.stop(this.taskId)}}class BPObjectMonitorDataSubscribe extends BaseNode3D{static config={name:"BPObjectMonitorDataSubscribe",group:"Custom",inputs:[{name:"subscribe",type:"exec"},{name:"unsubscribe",type:"exec"},{name:"object",type:["object","selector"]},{name:"key",type:"string"}],outputs:[{name:"next",type:"exec",enabled:!1},{name:"callback",type:"callback"},{name:"object",type:["object","selector"]},{name:"data",type:"any"},{name:"subscribeCallback",type:"callback",enabled:!1},{name:"unsubscribeCallback",type:"callback",enabled:!1}]};constructor(){super()}onExecute(e,t,n){let a=this.curExecName||"subscribe";this._objCtr=t.object,this._key=t.key||"*";let o=this[a].bind(this);o&&o(n)}subscribe(e){if(this._objCtr){if(this._objCtr.isSelector&&this._objCtr._objects[0]&&(this._objCtr=this._objCtr._objects[0]),this._objCtr.isBaseObject){e.object=this._objCtr;const t=this;this.subscriber=this._objCtr.monitorData.subscribe(this._key,(n=>{e.data="*"===t._key?n.data:n.data[t._key],this.run("callback",e)})),this.run("subscribeCallback",e)}}else console.error("Please provide the object input data")}unsubscribe(e){this._objCtr.monitorData.unsubscribe(this.subscriber),this.run("unsubscribeCallback",e)}onStop(){this._objCtr.destroyed||this._objCtr.monitorData.unsubscribe(this.subscriber)}}class BPObjectSetMonitorData extends BaseNode3D{static config={name:"BPObjectSetMonitorData",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"name",type:"string"},{name:"value",type:"any"}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object||new THING.Selector,o=t.name,s=t.value;this.traverseObject(a,(e=>{e.monitorData.setAttributes(o,s)})),n.object=a}}class BPObject extends BaseNode3D{static config={name:"BPObject",inputs:[{name:"uuid",type:"string",visible:!1}],outputs:[{name:"object",type:"selector"}]};onExecute(e,t,n){let a=t.uuid,o=this.object||this.app;n.object=o.query(`[uuid = ${a}]`).slice(0,1)}}class BPGetObject extends BaseNode3D{static config={name:"BPGetObject",inputs:[{name:"uuid",type:"string",visible:!1}],outputs:[{name:"object",type:"object"}]};onExecute(e,t,n){let a=t.uuid,o=(this.object||this.app).queryAll(`[uuid = ${a}]`);o&&0!==o.length?n.object=o[0]:n.object=null}}class BPObjects extends BaseNode3D{static config={name:"BPObjects",inputs:[{name:"uuids",type:"array",visible:!1}],outputs:[{name:"objects",type:"selector"}]};onExecute(e,t,n){let a=t.uuids;n.objects=new THING.Selector;let o=this.object||this.app;a.forEach((e=>{const t=o.queryAll(`[uuid = ${e}]`);t&&t.length>0&&n.objects.push(t[0])}))}}class BPState extends BaseNode3D{static config={name:"BPState",advanced:!0,inputs:[{name:"enter",type:"exec"},{name:"leave",type:"exec"},{name:"stateName",title:"状态名",type:"string",enabled:!1},{name:"groupName",title:"组名",type:"select",value:["default"]},{name:"mutex",type:"boolean",value:!0,desc:"先退出之前状态，再进入此状态"},{name:"repeatedChange",type:"boolean",value:!0,enabled:!1,desc:"允许重复进入此状态"},{name:"leaveWithLevel",type:"boolean",value:!0,enabled:!1,desc:"仅当前层级生效"}],outputs:[{name:"enterComplete",type:"callback",enabled:!1},{name:"leaveComplete",type:"callback",enabled:!1},{name:"then0",type:"callback",enabled:!1},{name:"then1",type:"callback",enabled:!1},{name:"options",enabled:!1,type:"any"}]};constructor(){super()}async onExecute(e,t,n){const{groupName:a,stateName:o=e.id,mutex:s=!0,repeatedChange:c=!0,leaveWithLevel:i=!1}=t,{id:r}=e;this.id=r,this.groupName=a,this.stateName=o;const l=this.curExecName;if(this._registerState(a,o),this.app.on(`state_then_${this.id}`,(e=>{this.syncRun(`then${e.triggerNum}`,n)}),`state_then_${this.id}`),"enter"===l)if(this.app.on(`state_after_enter_${this.id}`,(e=>{this.syncRun("enterComplete",n)}),`state_after_enter_${this.id}`),this.app.on(`state_after_leave_${this.id}`,(e=>{this.syncRun("leaveComplete",n)}),`state_after_leave_${this.id}`),s){let e=this.app.stateGroupManager.current;c&&e?.groupName===a&&e?.state?.name===o&&this.app.stateGroupManager.leave(a,o,{notifyEvent:!1}),this.app.stateGroupManager.change(a,o)}else this.app.stateGroupManager.set(a,o);else"leave"===l&&this.app.stateGroupManager.leave(a,o);if(i){let e=this.app.level.current,t=this;this.app.on(THING.EventType.BeforeEnterLevel,(n=>{e!==n.current&&t.app.stateGroupManager.leave(a,o)}),`ChangeLevel-BP_${a}_${o}`)}}onStop(){this.app.stateGroupManager.get(this.groupName,this.stateName)&&this.app.stateGroupManager.leave(this.groupName,this.stateName),this.app.off(THING.EventType.AfterEnterState,`EnterState-BP_${this.groupName}_${this.stateName}`),this.app.off(THING.EventType.AfterLeaveState,`LeaveState-BP_${this.groupName}_${this.stateName}`),this.leaveWithLevel&&this.app.off(THING.EventType.BeforeEnterLevel,`ChangeLevel-BP_${this.groupName}_${this.stateName}`)}_registerState(e,t){this.app.stateGroupManager.get(e,t)||this.app.stateGroupManager.register(new THING.BaseState({group:e,name:t}))}}class BPStateEvent extends BaseNode3D{static config={name:"BPStateEvent",title:"输入",outputs:[{name:"enter",type:"callback"},{name:"leave",type:"callback"},{name:"options",enabled:!1,type:"any"}]};constructor(){super()}isEntrance(){return!0}onExecute(e,t,n){const{stubID:a}=e;this.groupName=e.groupName,this.stateName=e.stateName,this.uid=a,this.stateName||(this.stateName=a);const o=this;this.app.on(THING.EventType.EnterState,(function(e){e.current?.groupName===o.groupName&&e.current?.state?.name===o.stateName&&(n.options=e.options,o.syncRun("enter",n),o.app.trigger(`state_after_enter_${o.uid}`,`state_after_enter_${o.uid}`))})),this.app.on(THING.EventType.LeaveState,(function(e){e.current?.groupName===o.groupName&&e.current?.state?.name===o.stateName&&(n.options=e.options,o.syncRun("leave",n),o.app.trigger(`state_after_leave_${o.uid}`,`state_after_leave_${o.uid}`))}))}onStop(){this.app.off(THING.EventType.EnterState),this.app.off(THING.EventType.LeaveState)}}class BPStateComplete extends BaseNode3D{static config={name:"BPStateComplete",title:"输出",advanced:!0,inputs:[{name:"enterComplete",type:"exec",enabled:!1},{name:"leaveComplete",type:"exec",enabled:!1},{name:"then0",type:"exec"},{name:"then1",type:"exec"}]};constructor(){super()}onExecute(e,t,n){const{stubID:a,then0Count:o,then1Count:s}=e;this.stubID=a;const c=this.curExecName,i=(e,t,n)=>{const a=this.blueprint._stateMacroMap?.get(this.stubID);if(!a)return;let o=a[t]||0;if(o++,a[t]=o,e===o){const e=a[n];e?.resolve(),a[t]=0}},r=(e,t,n)=>{this.app.trigger(`state_then_${this.stubID}`,{triggerNum:n},`state_then_${this.stubID}`)};"enterComplete"===c&&i(enterCount,"completeEnterCount","enterPromise"),"leaveComplete"===c&&i(leaveCount,"completeLeaveCount","leavePromise"),"then0"===c&&r(0,0,0),"then1"===c&&r(0,0,1)}onStop(){}}class BPChangeState extends BaseNode3D{static config={name:"BPChangeState",title:"状态",inputs:[{name:"enter",title:"进入",type:"exec",desc:"进入此状态"},{name:"leave",type:"exec"},{name:"stateName",title:"状态名",type:"string"},{name:"groupName",title:"组名",type:"string"},{name:"mutex",title:"互斥",type:"boolean",value:!0,desc:"先退出之前状态，再进入此状态"},{name:"repeatedChange",title:"重复进入",type:"boolean",value:!0,enabled:!1,desc:"允许重复进入此状态"},{name:"leaveWithLevel",title:"仅当前层级生效",type:"boolean",value:!1,enabled:!1,desc:"仅当前层级生效"}],outputs:[{name:"enter",title:"进入后",type:"callback"},{name:"leave",title:"退出后",type:"callback"}]};constructor(){super()}onExecute(e,t,n){let{groupName:a,stateName:o,mutex:s=!0,repeatedChange:c=!0,leaveWithLevel:i=!1}=t;const{macroUuid:r}=e;o||(o=r),this.groupName=a,this.stateName=o;let l=this.curExecName;if(this._registerState(a,o),"enter"===l)if(this.app.on(THING.EventType.EnterState,(e=>{e.current?.groupName===a&&e.current?.state?.name===o&&(n.options=e.options,this.syncRun("enter",n))}),`EnterState-BP_${a}_${o}`),this.app.on(THING.EventType.LeaveState,(e=>{e.current?.groupName===a&&e.current?.state?.name===o&&(n.options=e.options,this.syncRun("leave",n))}),`LeaveState-BP_${a}_${o}`),s){let e=this.app.stateGroupManager.current;c&&e?.groupName===a&&e?.state?.name===r&&this.app.stateGroupManager.leave(a,o,{notifyEvent:!1}),this.app.stateGroupManager.change(a,o)}else this.app.stateGroupManager.set(a,o);else"leave"===l&&this.app.stateGroupManager.leave(a,o);if(i){let e=this.app.level.current,t=this;this.app.on(THING.EventType.BeforeEnterLevel,(n=>{e!==n.current&&t.app.stateGroupManager.leave(a,o)}),`ChangeLevel-BP_${a}_${o}`)}}onStop(){this.app.stateGroupManager.get(this.groupName,this.stateName)&&this.app.stateGroupManager.leave(this.groupName,this.stateName),this.leaveWithLevel&&this.app.off(THING.EventType.BeforeEnterLevel,`ChangeLevel-BP_${groupName}_${stateName}`),this.app.off(THING.EventType.EnterState,`EnterState-BP_${this.groupName}_${this.stateName}`),this.app.off(THING.EventType.LeaveState,`LeaveState-BP_${this.groupName}_${this.stateName}`)}_registerState(e,t){this.app.stateGroupManager.get(e,t)||this.app.stateGroupManager.register(new THING.BaseState({name:t,group:e}))}}class BPChartSetting extends BaseNode3D{static config={name:"BPChartSetting",group:"Custom",inputs:[{name:"show",type:"exec",enabled:!1},{name:"hide",type:"exec",enabled:!1},{name:"updatedata",type:"exec"},{name:"chart",type:"object"},{name:"data",type:"object"}],outputs:[]};constructor(){super()}async onExecute(e,t,n){let a=t.chart;if(!a)return;let o=this.curExecName;if("show"==o)a.show();else if("hide"==o)a.hide();else if("updatedata"==o){let e=t.data;e&&("function"==typeof e&&(e=e()),a.setData(e))}}onStop(){}}class BPGetChartById extends BaseNode3D{static config={name:"BPGetChartById",group:"Custom",inputs:[{name:"id",type:"string",visiblePin:!1}],outputs:[{name:"chart",type:"object"}]};constructor(){super()}async onExecute(e,t,n){let a=t.id;ui&&(n.chart=ui.query(`#${a}`).app)}onStop(){}}class BPObjectUpdateData extends BaseNode3D{static config={name:"BPObjectUpdateData",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"type",type:"select",value:["monitor","custom"],visiblePin:!1},{name:"data",type:"object"},{name:"path",type:"string",value:"MONITOR",visiblePin:!1,enabled:!1}],outputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.type,o=t.data;o&&(THING.Utils.isArray(o)||(o=[o]),o.forEach((e=>{let o=[];if(THING.Utils.isString(e))try{e=JSON.parse(e)}catch(t){e={}}e&&e.id?(o=this.app.queryById(e.id),n.object=o,o.forEach((n=>{"monitor"===a?n.monitorData.setAttributes({[e.key]:e.value}):"custom"===a&&n.setAttribute(t.path||"MONITOR",e.value)}))):console.warn("The data is illegal and should contain an ID attribute or query condition.")})))}onStop(){}}class BPGetJSONPropertyByPath extends BaseNode3D{static config={name:"BPGetJSONPropertyByPath",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"property",type:"string"},{name:"data",type:"object"}],outputs:[{name:"exec",type:"exec"},{name:"data",type:"any"}]};constructor(){super()}onExecute(e,t,n){let a=t.property,o=t.data;if(THING.Utils.isString(o))try{o=JSON.parse(o)}catch(e){console.warn("Failed to parse data as JSON:",e)}let s=this._getValueByPath(o,a);if(s&&!Array.isArray(s))try{s=JSON.parse(s)}catch(e){}n.data=s}onStop(){}_getValueByPath(e,t){const n=t.split("/").filter(Boolean);if(1===n.length)return e[n[0]];for(const t of n){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}if(!e||"object"!=typeof e||!(t in e))return;e=e[t]}return e}}class BPGetStrByNumberAndLength extends BaseNode3D{static config={name:"BPGetStrByNumberAndLength",title:"根据数字生成固定长度的字符串",inputs:[{name:"exec",type:"exec"},{name:"number",type:"number",title:"输入数字"},{name:"stringLength",type:"number",title:"字符串长度"}],outputs:[{name:"next",type:"exec"},{name:"result",type:"string",title:"输出字符串"}]};constructor(){super()}onExecute(e,t,n){const a=t.number;let o="";const s=t.stringLength-a.toString().length;if(s>0){for(let e=0;e<s;e++)o+="0";o+=a.toString()}else o=a.toString().substr(-s);n.result=o}onStop(){}}class BPViewProbeStart extends BaseNode3D{static config={name:"BPViewProbeStart",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"scanningObject",type:["object","selector"],value:!0},{name:"update",type:"boolean",value:!0,enabled:!1},{name:"useCache",type:"boolean",value:!1,enabled:!1},{name:"saveCache",type:"boolean",value:!1,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.scanningObject||[],s=t.update??!0,c=t.useCache||!1,i=t.saveCache||!1;o.isBaseObject&&(o=[o]),this.traverseObject(a,(e=>{e&&e.start(o,s,c,i)})),n.object=a}}class BPViewProbeStop extends BaseNode3D{static config={name:"BPViewProbeStop",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object;this.traverseObject(a,(e=>{e&&e.stop()})),n.object=a}}class BPViewProbePause extends BaseNode3D{static config={name:"BPViewProbePause",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object;this.traverseObject(a,(e=>{e&&e.pause()})),n.object=a}}class BPViewProbeIntersectObject extends BaseNode3D{static config={name:"BPViewProbeIntersectObject",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"toBeTestedObject",type:["object","selector"],value:!0},{name:"testObjects",type:["object","selector"],value:!0},{name:"occlusionCulling",type:"boolean",value:!1,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"toBeTestedObject",type:"object",value:!0},{name:"intersectState",type:"number"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.toBeTestedObject||[],s=t.testObjects||[],c=t.occlusionCulling;if(!a||!o)return void console.error("Please provide the object input data");a.isSelector&&(a=a[0]),o.isSelector&&(o=o[0]),s.isBaseObject&&(s=[s]);let i=a.intersectObject(o,s,c);n.toBeTestedObject=o,n.intersectState=i,n.object=a}}class BPViewProbeIntersectObjects extends BaseNode3D{static config={name:"BPViewProbeIntersectObjects",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"testObjects",type:["object","selector"],value:!0},{name:"occlusionCulling",type:"boolean",value:!1,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"result",type:"selector"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=t.testObjects||[],s=t.occlusionCulling;if(!a)return void console.error("Please provide the object input data");a.isSelector&&(a=a[0]),o.isBaseObject&&(o=[o]);let c=a.intersectObjects(o,s);n.result=c,n.object=a}}class BPLoadJSONFile extends BaseNode3D{constructor(){super()}static config={name:"BPLoadJSONFile",title:"加载文件 - JSON",inputs:[{name:"exec",type:"exec"},{name:"path",type:"string"},{name:"editorWork",type:"boolean",enabled:!1}],outputs:[{name:"callback",type:"callback"},{name:"data",type:"any"}]};async onExecute(e,t,n){let{path:a,editorWork:o}=t;if(o&&(a=this.getFullPath(a)),a){const e=await THING.Utils.loadJSONFileAsync(a);n.data=e,this.run("callback",n)}else THING.Utils.error("请输入有效路径！")}}class BPObjectGetMonitorData extends BaseNode3D{static config={name:"BPObjectGetMonitorData",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"key",type:"string"},{name:"convertJSON",title:"转成JSON",type:"boolean"}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]},{name:"value",type:"any"}]};constructor(){super()}onExecute(e,t,n){let a=t.object;const o=t.key;if(a){if(a.isSelector&&a._objects[0]&&(a=a._objects[0]),a.isBaseObject){let e=a.monitorData[o];if(t.convertJSON)try{e=JSON.parse(e)}catch{}n.value=e}n.object=a}else console.error("Please provide the object input data")}}class BPCreateEntityFromJSON extends BaseNode3D{static config={name:"BPCreateEntityFromJSON",enabled:!1,inputs:[{name:"exec",type:"exec"},{name:"batchRender",type:"boolean",value:!1,enabled:!1},{name:"JSON",type:"object"}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:["object","selector"]}]};constructor(){super(),this._objects=new THING.Selector}onExecute(e,t,n){let{JSON:a,batchRender:o}=t;if(a){try{a=a.parse(a)}catch(e){}THING.Utils.isArray(a)||(a=[a]),a.forEach((e=>{const{type:t="Entity"}=e,n=new THING[t](e);o&&n.makeInstancedDrawing(),this._objects.push(n)})),n.object=this._objects,this._objects.waitForComplete().then((()=>{this.run("complete",n)}))}}onStop(){const e=this._objects.length;e&&e>0&&(this._objects.destroy(),this._objects.clear())}}class BPObjectSetLevelViewpoint extends BaseNode3D{constructor(){super()}static config={name:"BPObjectSetLevelViewpoint",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"position",type:"vector3",editor:"CameraEditor"},{name:"target",type:"vector3",editor:"CameraEditor"},{name:"spaceType",type:"select",value:["World","Local"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]},{name:"position",type:"vector3"},{name:"target",type:"vector3"}]};onExecute(e,t,n){let a=t.object,o=t.position,s=t.target,c=t.spaceType||"World";if(n.object=t.object,!o||!s)return;let i="viewpoint";"Local"===c&&(i="localViewpoint"),this.traverseObject(a,(e=>{e.level[i]={position:o,target:s}})),n.position=t.position,n.target=t.target}}class BPObjectGetLevelViewpoint extends BaseNode3D{constructor(){super()}static config={name:"BPObjectGetLevelViewpoint",inputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"next",type:"exec"},{name:"object",type:"object"},{name:"position",type:"vector3"},{name:"target",type:"vector3"}]};getNearestObjectPosition(e){const t=e.target,n=e.boundingBox||t.boundingBox,a=e.radius||n.radius,o=e.camera,s=[];for(let e=0;e<4;e++)s[e]=THING.Math.getPositionByBoundingBoxAngles(t,45+90*e,45,n,a);let c=THING.Math.getDistance(s[0],o.position),i=0;for(let e=1;e<s.length;e++){let t=THING.Math.getDistance(s[e],o.position);c>t&&(c=t,i=e)}return s[i]}onExecute(e,t,n){let a=this.getFirstObject(t.object);if(n.object=t.object,!a)return;n.target=a;let o=a.level.viewpoint;if(o)n.position=o.position,n.target=o.target;else if(a.tags.has("Campus")){let e=a.boundingBox,t=this.getNearestObjectPosition({target:a,boundingBox:e,radius:Math.min(e.radius,300),camera:this.app.camera});n.position=t,n.target=e.center}else if(a.tags.has("Building")){let e,t=a.floors||[],o=new THING.Selector;t.forEach((e=>{e.walls.forEach((e=>{o.push(e)}))})),e=0===o.length?a.boundingBox:o.getBoundingBox();let s=this.getNearestObjectPosition({target:a,boundingBox:e,camera:this.app.camera});n.position=s,n.target=e.center}else if(a.tags.has("Floor")||a.tags.has("Room")){let e=a.boundingBox,t=this.getNearestObjectPosition({target:a,boundingBox:e,camera:this.app.camera});n.position=t,n.target=e.center}}}class BPObjectTraverseChild extends BaseNode3D{constructor(){super()}static config={name:"BPObjectTraverseChild",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"recursive",type:"boolean"},{name:"includeSelf",type:"boolean"}],outputs:[{name:"complete",type:"callback"},{name:"callback",type:"callback"},{name:"child",type:"object"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=this.getFirstObject(t.object),o=t.recursive,s=t.includeSelf;if(n.object=a,a){if(o){let e;e=s?a:a.children,e.traverse((e=>{n.child=e,this.syncRun("callback",n)}))}else s&&(n.child=a,this.syncRun("callback",n)),a.children.forEach((e=>{n.child=e,this.syncRun("callback",n)}));this.syncRun("complete",n)}else this.syncRun("complete",n)}}class BPObjectTraverseChildByCondition extends BaseNode3D{constructor(){super()}static config={name:"BPObjectTraverseChildByCondition",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string"},{name:"recursive",type:"boolean"},{name:"includeSelf",type:"boolean"}],outputs:[{name:"complete",type:"callback"},{name:"yes",type:"callback"},{name:"no",type:"callback"},{name:"child",type:"object"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=this.getFirstObject(t.object),o=t.condition,s=t.recursive,c=t.includeSelf;if(n.object=a,a){if(s){let e;e=c?a:a.children,e.traverse((e=>{n.child=e,e.test(o)?this.syncRun("yes",n):this.syncRun("no",n)}))}else c&&(n.child=a,a.test(o)?this.syncRun("yes",n):this.syncRun("no",n)),a.children.forEach((e=>{n.child=e,e.test(o)?this.syncRun("yes",n):this.syncRun("no",n)}));this.syncRun("complete",n)}else this.syncRun("complete",n)}}class BPTriggerLevelComplete extends BaseNode3D{constructor(){super()}static config={name:"BPTriggerLevelComplete",inputs:[{name:"next",type:"exec"}],outputs:[]};onExecute(e,t,n){this.app.trigger(THING.EventType.ObjectLevelComplete)}}class BPGetLevelChangeOptions extends BaseNode3D{constructor(){super()}static config={name:"BPGetLevelChangeOptions",advanced:!0,inputs:[],outputs:[{name:"current",type:"object"},{name:"next",type:"object"},{name:"prev",type:"object"},{name:"origin",type:"object"},{name:"path",type:"selector"}]};onExecute(e,t,n){let a=this.app.level.changingOptions;n.current=a.current,n.next=a.next,n.prev=a.prev,n.origin=a.origin,n.path=a.path}}class BPCheckLevelEnterChild extends BaseNode3D{constructor(){super()}static config={name:"BPCheckLevelEnterChild",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"yes",type:"callback"},{name:"no",type:"callback"},{name:"current",type:"object",enabled:!1},{name:"next",type:"object",enabled:!1}]};onExecute(e,t,n){let a=this.app.level.changingOptions,o=a.current,s=a.next;n.current=o,n.next=s,o&&s&&s.isChildOf(o)?this.syncRun("yes",n):this.syncRun("no",n)}}class BPCheckLevelEnterBrother extends BaseNode3D{static config={name:"BPCheckLevelEnterBrother",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"yes",type:"callback"},{name:"no",type:"callback"}]};constructor(){super(),this.tags=THING.Math.generateUUID(),this.state=null}onSetup(){this.app.on(THING.EventType.BeforeEnterLevel,(()=>{this.state="enter"}),this.tags),this.app.on(THING.EventType.BeforeLeaveLevel,(()=>{this.state="leave"}),this.tags)}onExecute(e,t,n){let a=this.app.level.changingOptions,o=null,s=a.path;switch(this.state){case"enter":o=a.prev;break;case"leave":o=a.curretn}if(!o||!s)return void this.syncRun("no",n);let c=s[s.length-1];c&&c!=o&&o.isBrotherOf(c)?this.syncRun("yes",n):this.syncRun("no",n)}onStop(){this.app.off(THING.EventType.BeforeEnterLevel,null,this.tags),this.app.off(THING.EventType.BeforeLeaveLevel,null,this.tags)}}class BPSetDynamicSky extends BaseNode3D{constructor(){super()}static config={name:"BPSetDynamicSky",title:"设置动态天空",inputs:[{name:"next",type:"exec"},{name:"active",title:"激活",type:"boolean",value:!0},{name:"sunLightIntensity",title:"太阳光强度",type:"number",enabled:!0},{name:"moonLightIntensity",title:"月光强度",type:"number",enabled:!0},{name:"camera",title:"相机",type:"object",enabled:!1},{name:"lightColorGradient",title:"太阳光颜色",type:"object",enabled:!1},{name:"hemisphereLight",title:"半球光",type:"object",enabled:!1},{name:"skyColorGradient",title:"天光颜色",type:"object",enabled:!1},{name:"groundColorGradient",title:"地面光颜色",type:"object",enabled:!1},{name:"activeSkyRender",title:"激活渲染天空贴图",type:"boolean",value:!1},{name:"exposure",title:"曝光度",type:"number",enabled:!1},{name:"lightExposure",title:"天空的光照曝光度",type:"number",enabled:!1},{name:"sunEquatorOffset",title:"太阳赤道偏移量",type:"number",enabled:!1},{name:"cloudsTexture",title:"云层贴图",type:"string",enabled:!1},{name:"nightSkyTexture",title:"天空夜晚贴图",type:"string",enabled:!1},{name:"moonTexture",title:"月亮贴图",type:"string",enabled:!1},{name:"starsData",title:"星星数据",type:["string","array"],enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"envMap",title:"天空贴图",type:"object",enabled:!1}]};onExecute(e,t,n){const a=this.app,o=(t.camera||a.camera).dynamicSky,s=t.active;if(o.active=s,!s)return void(n.envMap=null);const c=t.sunLightIntensity,i=t.moonLightIntensity,r=t.lightColorGradient,l=t.hemisphereLight,p=t.skyColorGradient,u=t.groundColorGradient,m=t.activeSkyRender,d=t.exposure,b=t.lightExposure,h=t.sunEquatorOffset,y=t.cloudsTexture,g=t.nightSkyTexture,v=t.moonTexture,x=t.starsData;void 0!==c&&(o.sunLightIntensity=c),void 0!==i&&(o.moonLightIntensity=i),void 0!==l&&(o.hemisphereLight=l),void 0!==d&&(o.exposure=d),void 0!==b&&(o.lightExposure=b),void 0!==h&&(o.sunEquatorOffset=h),void 0!==r&&(o.lightColorGradient=r),void 0!==p&&(o.skyColorGradient=p),void 0!==u&&(o.groundColorGradient=u),void 0!==m&&(o.activeSkyRender=m),void 0!==y&&(o.cloudsTexture=y),void 0!==g&&(o.nightSkyTexture=g),void 0!==v&&(o.moonTexture=v),void 0!==x&&(o.starsData=x),n.envMap=o.envMap}}let _num=0;class BPFullscreenAnimateTransition extends BaseNode3D{constructor(){super(),this._eventTag=null}static _transitionEffect=null;static config={name:"BPFullscreenAnimateTransition",title:"全屏效果切换动画",inputs:[{name:"next",type:"exec"},{name:"duration",type:"number",value:1},{name:"active",type:"boolean",title:"激活",value:!0}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"}]};onSetup(){const e=this.app;let t=BPFullscreenAnimateTransition._transitionEffect;t||(t=new THING.TransitionEffect,BPFullscreenAnimateTransition._transitionEffect=t,e.camera.addEffect("TransitionEffect",t,100),t.progress=0)}onExecute(e,t,n){const a=t.duration,o=t.active,s=this.app;let c=BPFullscreenAnimateTransition._transitionEffect;c.active=o;const i=this;if(o){const e="transitionEffect"+_num++;let t=0;s.on("update",(o=>{const r=o.deltaTime;t+=r,c.progress=t/a,t>=a&&(s.off("update",e),i._eventTag=null,i.syncRun("complete",n),setTimeout((()=>{c.progress=0}),0))}),e),this._eventTag=e}else i.syncRun("complete",n)}onStop(){const e=this.app,t=BPFullscreenAnimateTransition._transitionEffect;this._eventTag&&(e.off("update",this._eventTag),this._eventTag=null),t&&(e.camera.removeEffect("TransitionEffect"),BPFullscreenAnimateTransition._transitionEffect=null)}}class BPUnBindAppEvent extends BaseNode3D{static config={name:"BPUnBindAppEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"global",type:"boolean",value:!0},{name:"name",type:"string"},{name:"condition",type:"string",enabled:!1},{name:"tag",type:"string",enabled:!1}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.name,o=t.condition||null,s=t.tag,c=!(!1===t.global);this._object=t.object||this.app,c?this._object.off(a,o,s):this._object.off(a+this._blueprint.uuid,o,s)}}class BPAddComponent extends BaseNode3D{static config={name:"BPAddComponent",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"component",title:"组件",type:"select",data:()=>Object.keys(THING.Utils.getRegisteredComponents()).sort(),visiblePin:!1},{name:"name",type:"string",value:"",enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]},{name:"name",type:"string"}]};onExecute(e,t,n){let a=t.object,o=t.component,s=t.name;n.object=a;let c=THING.Utils.getRegisteredComponents(),i=c&&c[o];s=s||i?.className,i&&s?(n.name=s,this.traverseObject(a,(e=>{if(e.getComponentByName(s))console.error("Component name already exist.");else{var t=new i;e.addComponent(t,s)}}))):console.error("BPAddComponent param error")}onExecute(e,t,n){let a=t.object,o=t.component,s=t.name;n.object=a;let c=THING.Utils.getRegisteredComponents(),i=c&&c[o];s=s||(i&&i.className?i.className+"_"+THING.Math.generateUUID():THING.Math.generateUUID()),i?(n.name=s,this.traverseObject(a,(e=>{var t=new i;e.addComponent(t,s)}))):console.error("BPAddComponent: component not found in registered components")}}class BPRemoveComponent extends BaseNode3D{static config={name:"BPRemoveComponent",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"name",type:"string",value:""}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object,o=t.name;n.object=a,o?this.traverseObject(a,(e=>{e.removeComponent(o)})):console.error("BPRemoveComponent param error")}}class BPObjectSetUv extends BaseNode3D{static config={name:"BPObjectSetUv",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"repeat",type:"vector2",value:[1,1]},{name:"offset",type:"vector2",value:[0,0]},{name:"center",type:"vector2",value:[0,0]},{name:"rotation",type:"number",value:0},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object,o=null==t.recursive||t.recursive;if(!a)return;let s={};t.offset&&(s.offset=t.offset),t.repeat&&(s.repeat=t.repeat),t.center&&(s.center=t.center),THING.Utils.isValid(t.rotation)&&(s.rotation=t.rotation),this.setStyleProp(a,"uv",s,o),n.object=a}}class BPDynamicLoad extends BaseNode3D{static config={name:"BPDynamicLoad",inputs:[{name:"exec",type:"exec"},{name:"enable",type:"boolean"}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.enable;this.app.root.dynamicLoad.enable=a}onStop(){this.app.root.dynamicLoad.enable=!1}}class BPWaitDynamicLoadComplete extends BaseNode3D{static config={name:"BPWaitDynamicLoadComplete",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"complete",type:"callback"}]};constructor(){super()}async onExecute(e,t,n){await this.app.root.dynamicLoad.waitForComplete(),this.run("complete",n)}}class BPIsLevelChangeComplete extends BaseNode3D{static config={name:"BPIsLevelChangeComplete",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"true",type:"callback"},{name:"false",type:"callback"}]};onExecute(e,t,n){const a=this.app.level.isChanging;!0===a&&this.syncRun("false",n),!1===a&&this.syncRun("true",n)}}class BPIsReachedTargetLevel extends BaseNode3D{static config={name:"BPIsReachedTargetLevel",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"true",type:"callback"},{name:"false",type:"callback"}]};onExecute(e,t,n){const a=this.app.level.current,o=this.app.level.changingOptions,s=o?.path;if(!s||0===s.length)return void this.syncRun("false",n);a===s[s.length-1]?this.syncRun("true",n):this.syncRun("false",n)}}class BPObjectLoadResource extends BaseNode3D{static config={name:"BPObjectLoadResource",desc:"obj.add",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"recursive",type:"boolean",value:!0,enabled:!1}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object,o=null==t.recursive||t.recursive;a&&(n.object=a,this.traverseObject(a,(e=>{e.loadResource(o)})),a.waitForComplete().then((()=>{this.run("complete",n)})))}}class BPObjectSetActive extends BaseNode3D{static config={name:"BPObjectSetActive",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"active",type:"boolean"}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};onExecute(e,t,n){let a=t.object,o=t.active;this.traverseObject(a,(e=>{e.active=o})),n.object=a}}class BPActiveObject extends BPObjectSetActive{static config={name:"BPActiveObject",advanced:!0,inputs:[...BPObjectSetActive.config.inputs.filter((e=>"active"!==e.name))],outputs:[...BPObjectSetActive.config.outputs]};constructor(){super()}onExecute(e,t,n){t.active=!0,super.onExecute(e,t,n)}}class BPDeactiveObject extends BPObjectSetActive{static config={name:"BPDeactiveObject",advanced:!0,inputs:[...BPObjectSetActive.config.inputs.filter((e=>"active"!==e.name))],outputs:[...BPObjectSetActive.config.outputs]};constructor(){super()}onExecute(e,t,n){t.active=!1,super.onExecute(e,t,n)}}class BPObjectGetSubNodes extends BaseNode3D{static config={name:"BPObjectGetSubNodes",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}],outputs:[{name:"next",type:"exec"},{name:"subObjects",type:"selector"}]};onExecute(e,t,n){let a=t.object;const o=new THING.Selector;this.traverseObject(a,(e=>{e.body.nodeNames.forEach((t=>{const n=e.promoteNode(t);o.push(n)}))})),n.subObjects=o}}class BPObjectPromoteNode extends BaseNode3D{static config={name:"BPObjectPromoteNode",title:"节点提升",inputs:[{name:"exec",type:"exec"},{name:"object",title:"对象",type:["object","selector"]},{name:"nodeName",title:"节点名称",type:"string"}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};getObjectsByIndex(e,t){return e.length<=t?null:e[t]}onExecute(e,t,n){let a=t.nodeName,o=[];this.traverseObject(t.object,(e=>{let t=e.promoteNode(a);o.push(t)})),0==o.length?n.object=null:1==o.length?n.object=o[0]:n.object=o}}class BPIsChildOfObject extends BaseNode3D{static config={name:"BPIsChildOfObject",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["selector","object"]},{name:"child",type:["selector","object"]}],outputs:[{name:"exec",type:"callback",title:"是"},{name:"false",type:"callback",title:"否"}]};constructor(){super()}onExecute(e,t,n){const a=t.object;a?.isSelector&&a.length>0&&(a=a[0]);const o=t.child;if(o?.isSelector&&o.length>0&&(o=a[0]),a&&o){o.isChildOf(a)?this.syncRun("exec",n):this.syncRun("false",n)}else this.syncRun("false",n)}onStop(){}}class BPPauseMouseEnterEvent extends BaseNode3D{static config={name:"BPPauseMouseEnterEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",value:"*"},{name:"tag",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.tag,o=t.object||this.app,s="mouseenter",c=t.condition;!(!1===t.pause)?o.pauseEvent(s,c,a):o.resumeEvent(s,c,a)}}class BPPauseMouseLeaveEvent extends BaseNode3D{static config={name:"BPPauseMouseLeaveEvent",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"condition",type:"string",value:"*"},{name:"tag",type:"string",enabled:!1},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.tag,o=t.object||this.app,s="mouseleave",c=t.condition;!(!1===t.pause)?o.pauseEvent(s,c,a):o.resumeEvent(s,c,a)}}class BPGetActivedStatesByGroupName extends BaseNode3D{static config={name:"BPGetActivedStatesByGroupName",title:"获取激活状态",inputs:[{name:"exec",type:"exec"},{name:"groupName",title:"组名",type:"string"}],outputs:[{name:"exec",type:"exec"},{name:"states",title:"状态",type:"any"}]};constructor(){super()}onExecute(e,t,n){let{groupName:a}=t;if(a){let e=this.app.stateGroupManager.getActiveStates().get(a);e?.length>0&&(n.states=e)}}onStop(){}}class BPMarkerAutoTransparentIfObstructed extends BaseNode3D{static config={name:"BPMarkerAutoTransparentIfObstructed",title:"标记被遮挡后样式",inputs:[{name:"exec",type:"exec"},{name:"opacity",title:"透明度",type:"number",visiblePin:!1},{name:"delay",type:"number",title:"延时",value:1,enabled:!1},{name:"open",title:"启用",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"}]};static totalTime=0;constructor(){super()}async onExecute(e,t,n){this._opacity=t.opacity||.3;let a=THING.Utils.isNull(t.delay)?1:t.delay,o=t.open,s=this.app;if(!o)return void s.query(".Marker").forEach((e=>{e.style.opacity=1}));let c=s.camera;if(BPMarkerAutoTransparentIfObstructed.totalTime<a)return void(BPMarkerAutoTransparentIfObstructed.totalTime+=s.deltaTime);await c.waitForGPUUpdate();const i=s.query(".Marker");c.pickType=THING.PickType.GPUFast,BPMarkerAutoTransparentIfObstructed.totalTime=0;for(let e=0,t=i.length;e<t;e++){const t=i[e];if(!t.visible||!c)continue;const n=c.target,a=c.position,o=THING.MathUtils.scaleVector(THING.MathUtils.normalizeVector(THING.MathUtils.subVector(n,a)),-1),s=t.position,r=THING.MathUtils.addVector(s,o),l=c.worldToScreen(r),p=c.pick(l[0],l[1]);t.alwaysOnTop=!0,p?l[2]+1>c.worldToScreen(p.position)[2]+1?t.style.opacity=this._opacity:t.style.opacity=1:t.style.opacity=1}}onStop(){}}class BPSelection extends BaseNode3D{static config={name:"BPSelection",title:"选择对象",inputs:[{name:"select",title:"选择",type:"exec"},{name:"deselect",title:"取消选择",type:"exec"},{name:"object",title:"对象",type:["object","selector"]}],outputs:[{name:"select",title:"选择后",type:"callback"},{name:"deselect",title:"取消选择后",type:"callback"},{name:"object",title:"当前对象",type:["object","selector"]},{name:"prevObject",title:"上个对象",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=this.app;this.selection=a.getComponentByName("selection");let o=t.object;this[this._execName](o)}select(e){this.selection.clear(),this.selection.select(e),this.syncRun("select",{object:this.selection.objects,prevObject:this.selection.prevObjects})}deselect(e){this.selection.deselect(e),this.syncRun("deselect",{object:this.selection.objects,prevObject:this.selection.prevObjects})}onStop(){}}THING.BLUEPRINT.BPObject=BPObject,THING.BLUEPRINT.BPGetObject=BPGetObject,THING.BLUEPRINT.BPObjects=BPObjects,THING.BLUEPRINT.BPState=BPState,THING.BLUEPRINT.BPStateEvent=BPStateEvent,THING.BLUEPRINT.BPStateComplete=BPStateComplete,THING.BLUEPRINT.BPStartSimulationDataMonitor=BPStartSimulationDataMonitor,THING.BLUEPRINT.BPAttachment=BPAttachment;let{BPBegin:BPBegin,BPSequence:BPSequence,BPCreateArray:BPCreateArray,BPAnyVarSetter:BPAnyVarSetter,BPAnyVarGetter:BPAnyVarGetter,BPPreExecute:BPPreExecute}=THING.BLUEPRINT;var BPNodes={CommonNodes:{BPBegin:BPBegin,BPPreExecute:BPPreExecute,BPPrint:BPPrint,WorkflowNodes:[BPBranch,BPSequence,BPSwitchCase,BPAnyTrigger,BPDelay,BPClearDelay,BPTimer,BPClearTimer,BPFlipFlop,BPForLoop,BPForEachLoop,CountDownLatch,BPChangeState,BPGetActivedStatesByGroupName,BPOneTimeExecution],UtilsNodes:[BPCode,BPExecuteCode,BPJSON,BPRandomInt,BPRandomFloat,BPRandomVector3Array,BPRandomVector3,BPRandomElementFromArray,BPRandomColor,BPVector3Add,BPGetLastNumberStr,BPGetStrByNumberAndLength,BPGetElementFromArray,BPArrayAddElement,BPConvertAnyToVector3,BPConvertAnyToString,BPCreateCircleVector3Array,BPStringAdd,BPNumberMultiply,BPNumberDivision,BPNumberAdd,BPInvertBoolean,BPNumberSubtract,BPColorPicker,BPGetJSONPropertyByPath,BPStringToJSON,BPJSONToString,BPAddFontMSDFWasmFike,BPGetCurrentTimestamp],LogicNodes:[BPIsObjectValid,BPIsContains,BPIsCollectionEmpty,BPIsEqual,BPIsTrue,BPRegExpTest,BPRegExpTestCase,BPNumberCompare,BPCheckNumberRange,BPCheckObjectTag]},ObjectNodes:{BasicNodes:[BPCreateEntity,BPBatchCreateEntity,BPCreateEntityFromJSON,BPCreateParticleSystem,BPCreateWater,BPCreateGrid,BPObjectGetBasicAttribute,BPObjectSetBasicAttribute,BPQueryObject,BPGetValidObject,BPObjectSet,BPConcatSelector,BPCloneObject,BPObjectGetParent,BPObjectGetChildren,BPObjectGetBrothers,BPObjectGetVerticesInfo,BPObjectAddChild,BPObjectRemoveChild,BPObjectGetSubNodes,BPCreateAttachedPoint,BPObjectAlwaysOnTop,BPObjectSetPickable,BPCreateObject,BPCreate3DObject,BPDestroyObject,BPQueryObjectByDistance,BPGetCurrentObject,BPObjectTraverseChild,BPObjectTraverseChildByCondition,BPObjectLoadResource,BPObjectSetActive,BPActiveObject,BPDeactiveObject,BPObjectPromoteNode,BPIsChildOfObject,BPObjectSetOcclusion,BPSelection,BPGetSelectionObjects],RelationshipNodes:[BPCreateRelationShip,BPDestroyRelationShip,BPQueryObjectByRelationShip,BPQueryRelationShip],StyleNodes:[BPObjectSetColor,BPObjectSetMetalness,BPObjectSetRoughness,BPObjectSetEmissive,BPObjectSetOpacity,BPObjectSetTransparent,BPObjectSetOutline,BPObjectSetEdge,BPObjectSetVisible,BPShowObject,BPHideObject,BPShowBoundingBox,BPObjectSetGlow,BPObjectSetWireframe,BPObjectSetTexture,BPObjectSetUv,BPObjectFadeIn,BPObjectFadeOut,BPObjectStopFading,BPObjectResetStyle,BPMarkerAutoTransparentIfObstructed],AttributeNodes:[BPObjectGetName,BPObjectSetName,BPObjectGetAttribute,BPObjectSetAttribute,BPObjectSetUserData,BPObjectGetUserData,BPObjectSetLevelViewpoint,BPObjectGetLevelViewpoint,BPObjectSetCastShadow,BPEnableObjectCastShadow,BPDisableObjectCastShadow,BPObjectGetMetalness,BPObjectGetRoughness],AnimationNodes:[BPObjectPlayAnimation,BPObjectStopAnimation,BPObjectPauseAnimation,BPObjectGetAnimationNames,BPFullscreenAnimateTransition],TransformNodes:[BPCreateSpace3D,BPSpace3DShowBounding,BPSpace3DIsContains,BPSpace3DIsIntersects,BPSpace3DIsDisjoint,BPObjectGetPosition,BPObjectSetPosition,BPObjectGetPivot,BPObjectSetPivot,BPObjectGetRotation,BPObjectSetRotation,BPObjectGetScale,BPObjectSetScale,BPObjectMoveTo,BPObjectMovePath,BPObjectStopMoving,BPObjectRotateTo,BPObjectStopRotating,BPObjectScaleTo,BPObjectStopScaling,BPObjectLookAt,BPObjectFlyTo,BPObjectStopFlying,BPObjectShowAxes,BPObjectSetTransformControl,BPObjectSetTransform,BPVolumeMesh,BPGetDistance,BPGetFullPath],GeometryNodes:[BPCreateBox,BPCreateSphere,BPCreateCylinder,BPCreateCapsule,BPCreateTorus,BPCreatePoints,BPCreateLine,BPCreatePlane,BPCreateCircle,BPCreatePlaneRegion,BPCreateExtrudeShape],LightNodes:[BPSetAmbientLight,BPSetMainLight,BPCreateSpotLight,BPCreateDirectionalLight,BPLightSetIntensity,BPLightSetAngle,BPLightSetPenumbra,BPLightSetDistance,BPLightSetShadow],MarkerNodes:[BPCreateMarker,BPCreateHTMLMarker,BPCreateTextLabel,BPAttachmentV2],ViewProbeNodes:[BPViewProbeStart,BPViewProbeStop,BPViewProbePause,BPViewProbeIntersectObject,BPViewProbeIntersectObjects],ComponentNodes:[BPAddComponent,BPRemoveComponent]},CameraNodes:[BPCameraFlyTo,BPCameraStopFlying,BPCameraStopMoving,BPCameraFit,BPCameraSetPosition,BPCameraGetPosition,BPCameraFollow,BPCameraLookAt,BPCameraStopFollowing,BPCameraSetProjection,BPCameraSetFov,BPCameraSetViewMode,BPCreateCamera,BPCameraRotateAround,BPCameraStopRotating,BPCameraPan,BPCameraZoom,BPCameraEnablePan,BPCameraEnableRotate,BPCameraEnableZoom,BPCameraSetAngleLimit,BPCameraSetDistanceLimit,BPSetCameraControl],LevelNodes:[BPChangeLevel,BPGetCurrentLevel,BPGetPrevLevel,BPLevelBack,BPLevelChangeEvent,BPBuildingExpandFloors,BPTriggerLevelComplete,BPGetLevelChangeOptions,BPCheckLevelEnterChild,BPCheckLevelEnterBrother,BPDynamicLoad,BPWaitDynamicLoadComplete,BPIsLevelChangeComplete,BPIsReachedTargetLevel],CampusNodes:[BPLoad,BPLoadTheme,BPLoadSceneTheme,BPCurrentCampus,BPCreateSceneHierarchyUI],EventNodes:[BPObjectLevelEvent,BPBindMouseClickEvent,BPUnbindMouseClickEvent,BPPauseMouseClickEvent,BPBindMouseDoubleClickEvent,BPUnbindMouseDoubleClickEvent,BPPauseMouseDoubleClickEvent,BPBindMouseEnterEvent,BPUnbindMouseEnterEvent,BPPauseMouseEnterEvent,BPBindMouseLeaveEvent,BPUnbindMouseLeaveEvent,BPPauseMouseLeaveEvent,BPBindMouseMoveEvent,BPUnbindMouseMoveEvent,BPPauseMouseMoveEvent,BPBindMouseDragEvent,BPUnBindMouseDragEvent,BPBindAppEvent,BPUnBindAppEvent,BPTriggerAppEvent,BPBindObjectUpdateEvent,BPUnbindObjectUpdateEvent,BPPauseObjectUpdateEvent,BPBindUpdateEvent,BPUnbindUpdateEvent,BPPauseUpdateEvent,BPBindKeyboardEvent,BPUnbindKeyboardEvent,BPPauseKeyboardEvent,BPObjectCallFunction,BPSetTimeOfDay,BPPostMessage,BPReceiveMessage],VariableNodes:[BPNumber,BPString,BPVector3,BPVector2,BPArray,BPCreateArray,BPAnyVarSetter,BPAnyVarGetter],InterfaceNodes:{BPCreateButton:BPCreateButton,BPCreateSlider:BPCreateSlider,BPCreateRadioMultipleButtons:BPCreateRadioMultipleButtons,BPCreateRadioMultipleButtonsBottom:BPCreateRadioMultipleButtonsBottom,BPCreateTopMenu:BPCreateTopMenu,ChartNodes:[BPChartSetting,BPGetChartById]},EnvironmentNodes:[BPSetBackgroundColor,BPSetBackgroundImage,BPSetSkyBox,BPCameraSetFog,BPSetDynamicSky],PrefabNodes:[],MonitorNodes:[BPObjectGetMonitorData,BPObjectSetMonitorData,BPObjectMonitorDataSubscribe,BPDataProcessor,BPObjectUpdateData,BPStartAjaxDataMonitor,BPStartWebsocketDataMonitor,BPProcessData,BPLoadJSONFile],CustomNodes:[]};class BPBindGlobalMouseEvent extends BaseNode3D{static config={name:"BPBindGlobalMouseEvent",inputs:[{name:"exec",type:"exec"},{name:"event",type:"select",value:["click","dblclick","mousedown","mousemove","mouseup","mouseenter","mouseleave"]},{name:"tag",type:"string",advanced:!0}],outputs:[{name:"callback",type:"callback"},{name:"object",type:"selector"},{name:"pickedPosition",type:"vector3"}]};constructor(){super(),this._object=null}onExecute(e,t,n){this._event=t.event||"click",this._tag=t.tag||"defaultTag",this._app=THING.App.current;let a=new THING.Selector;this._app.on(this._event,(e=>{a.clear(),a.push(e.object),n.object=a,n.pickedPosition=e.pickedPosition,this.run("callback",n)}),this._tag)}onStop(){this._app.off(this._event,this._tag)}}class BPUnbindGlobalMouseEvent extends BaseNode3D{static config={name:"BPUnbindGlobalMouseEvent",inputs:[{name:"exec",type:"exec"},{name:"event",type:"select",value:["click","dblclick","mousedown","mousemove","mouseup","mouseenter","mouseleave"]},{name:"tag",type:"string",advanced:!0}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this._event=t.event||"click",this._tag=t.tag||"defaultTag",this._app=this.app,this._app.off(this._event,this._tag)}onStop(){}}class BPUpdateEvent extends BaseNode3D{static config={name:"BPUpdateEvent",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"tag",type:"string",advanced:!0}],outputs:[{name:"next",type:"exec"},{name:"callback",type:"callback"},{name:"object",type:"selector"}]};constructor(){super(),this._object=null}onExecute(e,t,n){if(this._tag=t.tag||"defaultTag",this._object=t.object,!this._object)return void console.error("没有找到绑定事件的对象");let a=this,o=new THING.Selector;this._object.on("update",(function(e){o.clear(),o.push(e.object),n.object=o,a.run("callback",n)}),a._tag)}onStop(){this._object&&this._object.off("update",this._tag)}}class BPKeyboardEvent extends BaseNode3D{static config={name:"BPKeyboardEvent",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"event",type:"select",value:["keydown","keypress","keyup"]},{name:"keyCode",type:"number",visiblePin:!1},{name:"tag",type:"string",advanced:!0}],outputs:[{name:"next",type:"exec"},{name:"callback",type:"callback"},{name:"object",type:"selector"},{name:"keyCode",type:"number"}]};constructor(){super(),this._object=null}onExecute(e,t,n){if(this._event=t.event||"keydown",this._tag=t.tag||"defaultTag",this._keyCode=t.keyCode||"allKeyCode",this._object=t.object,!this._object)return void console.error("没有找到绑定事件的对象");let a=this,o=new THING.Selector;this._object.on(a._event,(function(e){!function(e){a._keyCode!=e.keyCode&&"allKeyCode"!=a._keyCode||(o.clear(),o.push(e.object),n.keyCode=e.keyCode,n.object=o,a.run("callback",n))}(e)}),a._tag)}onStop(){const e=this;this._object&&this._object.off(e._event,e._tag)}}class BPFlyTo extends BaseNode3D{static config={name:"BPFlyTo",inputs:[{name:"exec",type:"exec"},{name:"target",type:"selector"},{name:"position",type:"vector3",value:[0,0,0]},{name:"time",type:"number",value:1,unit:"秒"},{name:"delayTime",type:"number",value:0}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback"}]};constructor(){super()}onExecute(e,t,n){let a=t.target||[0,0,0],o=t.position||[0,0,0],s=function(e){return/^\d+(\.\d+)?$/.test(e)?1e3*e:0}(t.time),c=1e3*t.delayTime||0,i=THING.App.current,r=this;a.isSelector&&a.length>0&&(a=a[0]),i.camera.flyToAsync({target:a,position:o,time:s,delayTime:c,complete:()=>{r.run("complete",n)}})}}class BPStopFlying extends BaseNode3D{static config={name:"BPStopFlying",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this.app.camera.stopFlying()}}class BPUnbindMouseEvent extends BaseNode3D{static config={name:"BPUnbindMouseEvent",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"event",type:"select",value:["click","dblclick","mousedown","mousemove","mouseup","mouseenter","mouseleave"]},{name:"tag",type:"string",advanced:!0}],outputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}]};onExecute(e,t,n){let a=t.event||"click",o=t.tag||"defaultTag",s=t.object;s?(s.off(a,o),n.object=s):console.error("没有找到绑定事件的对象")}}class BPBindMouseEvent extends BaseNode3D{static config={name:"BPBindMouseEvent",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"event",type:"select",value:["click","dblclick","mousedown","mousemove","mouseup","mouseenter","mouseleave"]},{name:"tag",type:"string",advanced:!0}],outputs:[{name:"callback",type:"callback"},{name:"object",type:"selector"},{name:"pickedPosition",type:"vector3"}]};constructor(){super(),this._object=new THING.Selector}onExecute(e,t,n){if(this.getDefaultTag(),this._event=t.event||"click",this._tag=t.tag,this._object=t.object,!this._object)return void console.error("没有找到绑定事件的对象");let a=this,o=new THING.Selector;this._object.on(a._event,(function(e){o.clear(),o.push(e.object),n.object=o,n.pickedPosition=e.pickedPosition,a.run("callback",n)}),a._tag)}onStop(){this._object&&this._object.off(this._event,this._tag)}}class BPPauseMouseEvent extends BaseNode3D{static config={name:"BPPauseMouseEvent",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"event",type:"select",value:["click","dblclick","mousedown","mousemove","mouseup","mouseenter","mouseleave"]},{name:"tag",type:"string"},{name:"pause",type:"boolean",value:!0}],outputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.event||"click",o=t.tag||"defaultTag",s=t.pause,c=t.object;c?(s?c.pauseEvent(a,o):c.resumeEvent(a,o),n.object=c):console.error("没有找到绑定事件的对象")}}class BPBindClickEvent extends BaseNode3D{static config={name:"BPBindClickEvent",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}],outputs:[{name:"click",type:"callback"},{name:"object",type:"selector"}]};constructor(){super(),this._object=new THING.Selector,this._event="click",this._clickObject=new THING.Selector}onExecute(e,t,n){if(this._object=t.object,!this._object)return void console.error("没有找到绑定事件的对象");let a=this;a._object.on(a._event,(function(e){a._clickObject.clear(),a._clickObject.push(e.object),n.object=a._clickObject,a.run("click",n)}),"defaultTag")}onStop(){this._object&&(this._object.off(this._event,"defaultTag"),this._clickObject.clear())}}class BPPlayAudio extends BaseNode3D{static config={name:"BPPlayAudio",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"url",type:"string"},{name:"id",type:"string",advanced:!0},{name:"x",type:"number",advanced:!0},{name:"y",type:"number",advanced:!0},{name:"control",type:"boolean",value:!0,advanced:!0},{name:"loop",type:"boolean",value:!1,advanced:!0},{name:"autoplay",type:"boolean",value:!0,advanced:!0}],outputs:[{name:"next",type:"exec"},{name:"interface",type:"object",advanced:!0}]};constructor(){super()}onExecute(e,t,n){let a=t.x||10,o=t.y||10,{url:s,id:c,control:i,loop:r,autoplay:l}=t,p="left",u="top";if(a<0&&(p="right",a=-a),o<0&&(u="bottom",o=-o),s){super.validNodeUserInterface();const e=document.getElementById("uino-container-ui");let t=`<audio class = "thingAudio"\n                style="position:absolute;${p}:${a};${u}:${o};pointer-events:all;" >\n                <source src=${s}>\n                </audio>`;if(this._audio&&this._audio.remove(),this._audio=(m=t,d="thingAudio",(new DOMParser).parseFromString(m,"text/html").querySelector(`.${d}`)),c){let e=document.getElementById(c);e&&e.remove(),this._audio.id=c}i&&(this._audio.controls="controls"),r&&(this._audio.loop="loop"),l&&(this._audio.autoplay="autoplay"),e.appendChild(this._audio),n.interface=this._audio}var m,d}onStop(){this._audio&&this._audio.remove(),super.recycleNodeUserInterface()}}class BPLoadScene extends BaseNode3D{static config={name:"BPLoadScene",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"url",type:"string",value:"./resource/bluePrint/models/factory"},{name:"enterLevel",type:"boolean"},{name:"ignoreTheme",type:"boolean",advanced:!0}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:"selector"}]};constructor(){super(),this.bundle=null,this._selector=new THING.Selector}onExecute(e,t,n){const a=t.url,o=t.enterLevel;var s=this.app.loadBundle(a,{ignoreTheme:!1});this.bundle=s;let c=this;s.waitForComplete().then((()=>{this.root=s.campuses[0],o?this.app.level.change(this.root,{onComplete:()=>{c._selector.push(s.campuses[0]),c.run("complete",{object:c._selector})}}):(c._selector.push(s.campuses[0]),c.run("complete",{object:c._selector}))}))}onStop(){let e=this.app;this.root?(this.root.destroy(),this.root=null):e.query(".Campus")[0].destroy(),e.root.hasComponent("renderSetting")&&e.root.removeComponent("renderSetting"),this._selector.clear()}}class BPLoadGltf extends BaseNode3D{static config={name:"BPLoadGltf",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"url",type:"string",value:"./resource/scene/gltfScene/Thing.gltf"},{name:"enterLevel",type:"boolean"},{name:"ignoreTheme",type:"boolean",advanced:!0}],outputs:[{name:"next",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:"selector"}]};constructor(){super(),this._selector=new THING.Selector}onExecute(e,t,n){const a=t.url,o=t.enterLevel,s=new THING.Campus({url:a});s.waitForComplete().then((()=>{o?this.app.level.change(s,{onComplete:()=>{this._selector.push(s),n.object=this._selector,this.run("complete",n)}}):(this._selector.push(s),n.object=this._selector,this.run("complete",n))}))}onStop(){this._selector.destroy(),this._selector.clear()}}class BPGetCameraPosition extends BaseNode3D{static config={name:"BPGetCameraPosition",inputs:[{name:"exec",type:"exec"}],outputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3"},{name:"target",type:"vector3"}]};constructor(){super()}onExecute(e,t,n){let a=this.app;n.position=a.camera.position,n.target=a.camera.target}}class BPSetCameraPosition extends BaseNode3D{static config={name:"BPSetCameraPosition",inputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3",value:[0,0,0]},{name:"target",type:"vector3",value:[0,0,0]}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.position||[0,0,0],o=t.target||[0,0,0],s=this.app;this.position=s.camera.position,this.target=s.camera.target,s.camera.position=a,s.camera.target=o}onStop(){this.app.camera.position=this.position,this.app.camera.target=this.target}}class BPFuzzyQueryObject extends BaseNode3D{static config={name:"BPFuzzyQueryObject",inputs:[{name:"exec",type:"exec"},{name:"name",type:"string"},{name:"object",type:"selector",advanced:!0},{name:"containsChild",type:"boolean",value:!0,advanced:!0}],outputs:[{name:"next",type:"exec"},{name:"allResult",type:"selector"}]};onExecute(e,t,n){let a=t.name,o=t.containsChild,s=t.object,c=[];s&&s.length>0&&(s=s[0]);let i=s||this.app;if(a){let e=new RegExp(a);c=i.query(e,{recursive:o})}n.allResult=c}onStop(){}}class BPSetCameraFov extends BaseNode3D{static config={name:"BPSetCameraFov",inputs:[{name:"exec",type:"exec"},{name:"fov",type:"number",value:50}],outputs:[{name:"next",type:"exec"}]};constructor(){super()}onExecute(e,t,n){this.oldFov=this.app.camera.fov;let a=t.fov;this.app.camera.fov=a}onStop(){this.oldFov&&(this.app.camera.fov=this.oldFov)}}class BPCameraSetVertAngleLimit extends BaseNode3D{static config={name:"BPCameraSetVertAngleLimit",inputs:[{name:"exec",type:"exec"},{name:"angleLimit",type:"vector2"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.angleLimit||[0,0];this.app.camera.vertAngleLimit=a}onStop(){this.app.camera.vertAngleLimit=[0,180]}}class BPCameraSetHorzAngleLimit extends BaseNode3D{static config={name:"BPCameraSetHorzAngleLimit",inputs:[{name:"exec",type:"exec"},{name:"angleLimit",type:"vector2"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.angleLimit||[0,0];this.app.camera.horzAngleLimit=a}onStop(){this.app.camera.horzAngleLimit=[-360,360]}}class BPObjectRotateOnAxis extends BaseNode3D{static config={name:"BPObjectRotateOnAxis",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"axis",type:"select",value:["X","Y","Z"]},{name:"angles",type:"number",value:0}],outputs:[{name:"next",type:"exec"},{name:"object",type:"selector"}]};onExecute(e,t,n){let a=t.object||new THING.Selector,o=t.axis||"X",s=t.angles||0;if(a.isSelector){const e=a.length;if(e>0)for(let t=0;t<e;t++)if(a[t]){let e;switch(o){case"X":default:e=[1,0,0];break;case"Y":e=[0,1,0];break;case"Z":e=[0,0,1]}a[t].rotateOnAxis(e,s)}}n.object=a}}class BPObjectTranslateOnAxis extends BaseNode3D{static config={name:"BPObjectTranslateOnAxis",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"axis",type:"select",value:["X","Y","Z"]},{name:"distance",type:"number",value:0}],outputs:[{name:"next",type:"exec"},{name:"object",type:"selector"}]};onExecute(e,t,n){let a=t.object||new THING.Selector,o=t.axis||"X",s=t.distance||0;if(a.isSelector){const e=a.length;for(let t=0;t<e;t++)if(a[t]){let e;switch(o){case"X":default:e=[1,0,0];break;case"Y":e=[0,1,0];break;case"Z":e=[0,0,1]}a[t].translateOnAxis(e,s)}}n.object=a}}class BPObjectMoveToOnAxis extends BaseNode3D{static config={name:"BPObjectMoveToOnAxis",group:"Basic",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"axis",type:"select",value:["X","Y","Z"]},{name:"distance",type:"number",value:0},{name:"time",type:"number",value:1,unit:"秒"},{name:"loopType",type:"select",value:["Once","Repeat","PingPong"],advanced:!0},{name:"orientToPath",type:"boolean",value:!0,advanced:!0}],outputs:[{name:"exec",type:"exec"},{name:"complete",type:"callback"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){const a=t.object||new THING.Selector,o=t.orientToPath,s=t.distance||0,c=t.axis||"X",i=(r=t.time,/^\d+(\.\d+)?$/.test(r)?1e3*r:0);var r;let l=t.loopType||"Once";if(l=THING.LoopType[l],a.isSelector){const e=a.length;if(e>0){for(let t=0;t<e;t++)if(a[t]){const e=a[t].position;let r;switch(c){case"X":r=[e[0]+s,e[1],e[2]];break;case"Y":r=[e[0],e[1]+s,e[2]];break;case"Z":r=[e[0],e[1],e[2]+s];break;default:r=[0,0,0]}a[t].moveTo(r,{time:i,loopType:l,orientToPath:o,complete:()=>{this.run("complete",n)}})}n.object=a}}}}class BPEnterCampusLevelEvent extends BaseNode3D{static config={name:"BPEnterCampusLevelEvent",outputs:[{name:"enter",type:"callback"},{name:"quit",type:"callback"},{name:"campus",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=this,o="Campus",s=this.app,c=new THING.Selector,i=new THING.Selector;s.on(THING.EventType.AfterEnterLevel,(e=>{o==e.current.type&&(c.clear(),c.push(e.current),a.run("enter",{campus:c}))}),"EnterCampusLevel_BP"),s.on(THING.EventType.AfterLeaveLevel,(e=>{o==e.current.type&&(i.clear(),i.push(e.current),a.run("quit",{campus:i}))}),"LeaveCampusLevel_BP")}}class BPEnterBuildingLevelEvent extends BaseNode3D{static config={name:"BPEnterBuildingLevelEvent",outputs:[{name:"enter",type:"callback"},{name:"quit",type:"callback"},{name:"building",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=this,o="Building",s=this.app,c=new THING.Selector,i=new THING.Selector;s.on(THING.EventType.AfterEnterLevel,(e=>{o==e.current.type&&(c.clear(),c.push(e.current),a.run("enter",{building:c}))}),"EnterBuildingLevel_BP"),s.on(THING.EventType.AfterLeaveLevel,(e=>{o==e.current.type&&(i.clear(),i.push(e.current),a.run("quit",{building:i}))}),"LeaveBuildingLevel_BP")}}class BPEnterFloorLevelEvent extends BaseNode3D{static config={name:"BPEnterFloorLevelEvent",outputs:[{name:"enter",type:"callback"},{name:"quit",type:"callback"},{name:"floor",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=this,o="Floor",s=this.app,c=new THING.Selector,i=new THING.Selector;s.on(THING.EventType.AfterEnterLevel,(e=>{o==e.current.type&&(c.clear(),c.push(e.current),a.run("enter",{floor:c}))}),"EnterFloorLevel_BP"),s.on(THING.EventType.AfterLeaveLevel,(e=>{o==e.current.type&&(i.clear(),i.push(e.current),a.run("quit",{floor:i}))}),"LeaveFloorLevel_BP")}}class BPEnterRoomLevelEvent extends BaseNode3D{static config={name:"BPEnterRoomLevelEvent",outputs:[{name:"enter",type:"callback"},{name:"quit",type:"callback"},{name:"room",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=this,o="Room",s=this.app,c=new THING.Selector,i=new THING.Selector;s.on(THING.EventType.AfterEnterLevel,(e=>{o==e.current.type&&(c.clear(),c.push(e.current),a.run("enter",{room:c}))}),"EnterRoomLevel_BP"),s.on(THING.EventType.AfterLeaveLevel,(e=>{o==e.current.type&&(i.clear(),i.push(e.current),a.run("quit",{room:i}))}),"LeaveRoomLevel_BP")}}class BPArrayPushItem extends BaseNode3D{static config={name:"BPArrayPushItem",inputs:[{name:"exec",type:"exec"},{name:"array",type:"array"},{name:"item",type:"any"}],outputs:[{name:"exec",type:"exec"},{name:"array",type:"array"}]};constructor(){super()}onExecute(e,t,n){let a=t.array,o=t.item;a&&a instanceof Array&&o&&a.push(o),n.array=a}}class BPRandomInteger extends BaseNode3D{static config={name:"BPRandomInteger",inputs:[{name:"min",type:"number",value:0},{name:"max",type:"number",value:100}],outputs:[{name:"result",type:"number"}]};onExecute(e,t,n){let a=t.min,o=t.max,s=a+Math.random()*(o-a);s=parseInt(s),n.result=s}}class BPLayerButton extends BaseNode3D{static config={name:"BPLayerButton",inputs:[{name:"exec",type:"exec"},{name:"option1",type:"string"},{name:"option2",type:"string"},{name:"option3",type:"string"},{name:"option4",type:"string"}],outputs:[{name:"next",type:"exec"},{name:"press1",type:"callback"},{name:"press2",type:"callback"},{name:"press3",type:"callback"},{name:"press4",type:"callback"}]};onExecute(e,t,n){let a=document.querySelector(".layerButtonRoot");a&&a.remove();let o=document.querySelector("#div3d").parentNode;function s(e,t){return(new DOMParser).parseFromString(e,"text/html").querySelector(`.${t}`)}!function(){let e=s('<style class="layerButtonStyle">\n          .layerButtonRoot,layerButtonRoot div{\n            box-sizing:border-box;\n          }\n          .layerButtonRoot{\n            position:absolute;top:10;left:10px;z-index:10000;\n            height:56px;background: rgba(255,255,255,0.80);\n            border-radius: 10px;\n            filter: blur(0);\n            padding:8px;\n            left:50%;\n            transform:translateX(-50%);\n          }\n          .layerButton{\n            cursor:pointer;\n            border-radius: 8px;\n            display:inline-block;\n            height: 16px;\n            padding:12px 20px;\n            font-size: 16px;\n            color: #333333;\n            letter-spacing: 0;\n            text-align: center;\n            line-height: 16px;\n          }\n          .layerButton:hover{\n            background: rgba(30,54,102,0.06);\n          }\n          .layerButton.active{\n            background: #48C672;\n            color: #FFFFFF;\n          }\n          </style>',"layerButtonStyle");o.appendChild(e)}();function c(e,t){return`<div class="layerButton" id='${t}'>${e}</div>`}let i="";if(t.option1&&(i+=c(t.option1,"1")),t.option2&&(i+=c(t.option2,"2")),t.option3&&(i+=c(t.option3,"3")),t.option4&&(i+=c(t.option4,"4")),!i)return;let r='<div class="layerButtonRoot" style="top:10px;">'+i+"</div>";this.oLayerButtonRoot=s(r,"layerButtonRoot"),o.appendChild(this.oLayerButtonRoot),this.oLayerButtonRoot.onclick=e=>{this.oLayerButtonRoot.querySelectorAll(".layerButton").forEach((e=>{e.classList.remove("active")})),e.target.classList.add("active"),this.run(`press${e.target.id}`,n)}}onStop(){this.oLayerButtonRoot&&this.oLayerButtonRoot.remove()}}class BPPickupColor extends BaseNode3D{static config={name:"BPPickupColor",inputs:[{name:"exec",type:"exec"},{name:"color",type:"color",value:"#ffffff"}],outputs:[{name:"next",type:"exec"},{name:"color",type:"color"}]};onExecute(e,t,n){n.color=t.color}}class BPRandomFromArray extends BaseNode3D{static config={name:"BPRandomFromArray",inputs:[{name:"exec",type:"exec"},{name:"array",type:"array"}],outputs:[{name:"next",type:"exec"},{name:"result",type:"vector3"}]};onExecute(e,t,n){let a=THING.Math.randomFromArray(t.array);n.result=a}}class BPAddCamera extends BaseNode3D{static config={name:"BPAddCamera",inputs:[{name:"exec",type:"exec"},{name:"position",type:"vector3",value:[0,0,0]},{name:"target",type:"vector3",value:[0,0,0]},{name:"object",type:"selector"},{name:"viewport",type:"any",value:[10,10,200,200],advanced:!0}],outputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.position||[0,0,0],o=t.target||[0,0,0],s=t.viewport||[10,10,200,200],c=this.app;if(this._camera||(this._camera=new THING.Camera),"string"==typeof s&&(s=s.split(",").map(Number)),!(s instanceof Array&&4===s.length))return void console.error("视口参数格式不正确");this._camera.name="ffff",this._camera.enableViewport=!0,this._camera.viewport=[c.size[0]-s[2]-s[1],s[0],s[2],s[3]],this._camera.enable=!1,this._camera.position=a,this._camera.target=o;let i=new THING.Selector;i.push(this._camera),n.object=i}onStop(){this._camera&&this._camera.destroy()}}class BPObjectSetFlash extends BaseNode3D{static config={name:"BPObjectSetFlash",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"flash",type:"boolean",value:!0}],outputs:[{name:"next",type:"exec"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.object||new THING.Selector,o=t.flash;var s=this.app;if(a.length&&o){const e=a.length;if(e>0)for(let t=0;t<e;t++)a[t].isPrefabObject?a[t].traverse((e=>{e.on("update",(function(){e.style.opacity=.5+.5*Math.sin(10*s.elapsedTime)}),"每帧改变透明度")})):a[t].on("update",(function(){a[t].style.opacity=.5+.5*Math.sin(10*s.elapsedTime)}),"每帧改变透明度")}else{const e=a.length;if(e>0)for(let t=0;t<e;t++)a[t].isPrefabObject?a[t].traverse((e=>{e.off("update","每帧改变透明度")})):a[t].off("update","每帧改变透明度")}n.object=a}}class BPCameraPanControl extends BaseNode3D{static config={name:"BPCameraPanControl",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:"selector",advanced:!0},{name:"x",type:"number",value:0},{name:"y",type:"number",value:0},{name:"time",type:"number",value:.5,advanced:!0,unit:"秒"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.x||0,o=t.y||0,s=(c=t.time,/^\d+(\.\d+)?$/.test(c)?1e3*c:0);var c;let i=this.app,r=t.camera;r=r&&r.isSelector&&r.length>0?r[0]:i.camera,r.pan(a,o,s)}}class BPCameraZoomControl extends BaseNode3D{static config={name:"BPCameraZoomControl",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"camera",type:"selector",advanced:!0},{name:"distance",type:"number",value:0},{name:"time",type:"number",value:.5,advanced:!0,unit:"秒"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=t.distance||0,o=(s=t.time,/^\d+(\.\d+)?$/.test(s)?1e3*s:0);var s;let c=this.app,i=t.camera;i=i&&i.isSelector&&i.length>0?i[0]:c.camera,i.zoom(a,{time:o})}}class BPObjectCancelTransformControl extends BaseNode3D{static config={name:"BPObjectCancelTransformControl",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}],outputs:[{name:"next",type:"exec"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.object||new THING.Selector;this._tag="TransformControlTag",a.controlObject&&a.controlObject.removeComponent(this._tag),n.object=a}onStop(){}}class BPObjectTranslate extends BaseNode3D{static config={name:"BPObjectTranslate",advanced:!0,desc:"obj.translate",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"},{name:"offset",type:"vector3",value:[0,0,0]},{name:"distance",type:"number",advanced:!0}],outputs:[{name:"next",type:"exec"},{name:"object",type:"selector"}]};onExecute(e,t,n){let a=t.object||new THING.Selector,o=t.offset||[0,0,0],s=t.distance;if(a.isSelector){const e=a.length;for(let t=0;t<e;t++)if(a[t])if(s){let e=o;a[t].translateOnAxis(e,s)}else a[t].translate(o)}n.object=a}}class BPSpaceIsContains extends BaseNode3D{static config={name:"BPSpaceIsContains",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"space",type:"selector"},{name:"object",type:"selector"}],outputs:[{name:"contains",type:"callback"},{name:"noContains",type:"callback"},{name:"space",type:"selector",advanced:!0},{name:"object",type:"selector",advanced:!0}]};constructor(){super()}onExecute(e,t,n){let a=t.space||new Selector,o=t.object||new Selector;if(n.space=a,n.object=o,a.length&&o.length){let e=a[0],t=o[0];e.contains(t,!0)?this.run("contains",n):this.run("noContains",n)}}onStop(){}}class BPSpaceShowBounding extends BaseNode3D{static config={name:"BPSpaceShowBounding",inputs:[{name:"exec",type:"exec"},{name:"space",type:"selector"},{name:"show",type:"boolean",value:!0}],outputs:[{name:"next",type:"exec"},{name:"space",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.space||new THING.Selector;if(a.isSelector){const e=a.length;for(let t=0;t<e;t++)a[t].showBounding()}n.space=a}}class BPSpaceIsIntersects extends BaseNode3D{static config={name:"BPSpaceIsIntersects",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"space",type:"selector"},{name:"object",type:"selector"}],outputs:[{name:"intersects",type:"callback"},{name:"noIntersects",type:"callback"},{name:"space",type:"selector",advanced:!0},{name:"object",type:"selector",advanced:!0}]};constructor(){super()}onExecute(e,t,n){let a=t.space,o=t.object;if(n.space=a,n.object=o,a.length&&o.length){let e=a[0],t=o[0];e.intersects(t,!0)?this.run("intersects",n):this.run("noIntersects",n)}}onStop(){}}class BPSpaceIsDisjoint extends BaseNode3D{static config={name:"BPSpaceIsDisjoint",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"space",type:"selector"},{name:"object",type:"selector"}],outputs:[{name:"disjoint",type:"callback"},{name:"noDisjoint",type:"callback"},{name:"space",type:"selector",advanced:!0},{name:"object",type:"selector",advanced:!0}]};constructor(){super()}onExecute(e,t,n){let a=t.space,o=t.object;if(n.space=a,n.object=o,a.length&&o.length){let e=a[0],t=o[0];e.disjoint(t,!0)?this.run("disjoint",n):this.run("noDisjoint",n)}}onStop(){}}class BPObjectSetSpaceAttribute extends BaseNode3D{static config={name:"BPObjectSetSpaceAttribute",group:"Basic",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]},{name:"position",type:"vector3",value:[0,0,0]},{name:"rotation",type:"vector3",value:[0,0,0]},{name:"scale",type:"vector3",value:[1,1,1]},{name:"spaceType",type:"select",value:["Local","World"],advanced:!0}],outputs:[{name:"next",type:"exec"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){const a=t.object,o=t.rotation,s=t.position,c=t.scale;let i=t.spaceType||"Local";a?(this.traverseObject(a,(e=>{"Local"===i?(o&&(e.localRotation=o),s&&(e.localPosition=s),c&&(e.localScale=c)):(o&&(e.rotation=o),s&&(e.position=s),c&&(e.scale=c))})),n.object=a):console.error("Please provide the object input data")}}class BPObjectGetChildrenNodes extends BaseNode3D{static config={name:"BPObjectGetChildrenNodes",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}],outputs:[{name:"next",type:"exec"},{name:"childObject",type:"selector"}]};onExecute(e,t,n){let a=t.object||new THING.Selector,o=new THING.Selector;if(a.isSelector&&a._objects[0]){const e=a._objects[0].children.objects,t=e.length;if(t>0)for(let n=0;n<t;n++)e[n]&&o.push(e[n])}n.childObject=o}}class BPObjectCancelTexture extends BaseNode3D{static config={name:"BPObjectCancelTexture",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}],outputs:[{name:"next",type:"exec"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.object||new THING.Selector;this.setStyleProp(a,"image",null),n.object=a}}class BPObjectCancelOutline extends BaseNode3D{static config={name:"BPObjectCancelOutline",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}],outputs:[{name:"next",type:"exec"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.object||new THING.Selector;this.setStyleProp(a,"outlineColor",null),n.object=a}}class BPObjectCancelColor extends BaseNode3D{static config={name:"BPObjectCancelColor",group:"Custom",inputs:[{name:"exec",type:"exec"},{name:"object",type:"selector"}],outputs:[{name:"next",type:"exec"},{name:"object",type:"selector"}]};constructor(){super()}onExecute(e,t,n){let a=t.object||new THING.Selector;if(a&&a.length>0&&a.isSelector)for(let e=0;e<a.length;e++){a[e].lerp._getTweenByName("colorGradient")&&a[e].lerp.stop("colorGradient")}this.setStyleProp(a,"color",null),n.object=a}}class BPIsEmpty extends BaseNode3D{static config={name:"BPIsEmpty",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"param",type:"any",input:!0}],outputs:[{name:"empty",type:"callback"},{name:"notEmpty",type:"callback"},{name:"param",type:"unknown",advanced:!0}]};constructor(){super()}isObject(e){return"object"==typeof e&&null!==e}isEmpty(e){let t=!0;if(e instanceof Array)e.length&&(t=!1);else if(e&&e.isSelector){e.objects.length&&(t=!1)}else e&&(t=!1);return t}onExecute(e,t,n){let a=t.param;n.param=a,this.isEmpty(a)?this.run("empty",n):this.run("notEmpty",n)}onStop(){}}class BPIsExist extends BaseNode3D{static config={name:"BPIsExist",advanced:!0,inputs:[{name:"exec",type:"exec"},{name:"param",type:"any",input:!0}],outputs:[{name:"exist",type:"callback"},{name:"notExist",type:"callback"},{name:"param",type:"unknown",advanced:!0}]};constructor(){super(),this.index=0}onExecute(e,t,n){let a=t.param;n.param=a,a?this.run("exist",n):this.run("notExist",n)}onStop(){}}class BPObjectGetAnimations extends BaseNode3D{static config={name:"BPObjectGetAnimations",inputs:[{name:"exec",type:"exec"},{name:"object",type:["object","selector"]}],outputs:[{name:"exec",type:"exec"},{name:"names",type:"any"},{name:"object",type:["object","selector"]}]};constructor(){super()}onExecute(e,t,n){let a=t.object;if(n.object=a,!a)return void console.error("Please provide the object input data");a.isSelector&&(a=a[0]);let o=a.animationNames;n.names=o}onStop(){}}class BPBasicLevelEvent extends BaseNode3D{constructor(){super(),this.type=""}onExecute(e){let t=this,n=this.type;this.enterName="Enter"+n+"Level_BP",this.leaveName="Leave"+n+"Level_BP";const a={};this.app.on(THING.EventType.AfterEnterLevel,(o=>{n===o.current.type&&(a[e]=o.current,a.prev=o.prev,t.syncRun("enter",a))}),this.enterName),this.app.on(THING.EventType.BeforeEnterLevel,(o=>{n===o.current.type&&(a[e]=o.current,a.prev=o.prev,t.syncRun("beforeEnter",a))}),this.enterName),this.app.on(THING.EventType.AfterLeaveLevel,(o=>{n===o.current.type&&(a[e]=o.current,a.prev=o.prev,t.syncRun("leave",a))}),this.leaveName),this.app.on(THING.EventType.BeforeLeaveLevel,(o=>{n===o.current.type&&(a[e]=o.current,a.prev=o.prev,t.syncRun("beforeLeave",a))}),this.leaveName)}onStop(){this.app.off(THING.EventType.AfterEnterLevel,this.enterName),this.app.off(THING.EventType.BeforeEnterLevel,this.enterName),this.app.off(THING.EventType.AfterLeaveLevel,this.leaveName),this.app.off(THING.EventType.BeforeLeaveLevel,this.leaveName)}}class BPCampusLevelEvent extends BPBasicLevelEvent{static config={name:"BPCampusLevelEvent",advanced:!0,outputs:[{name:"enter",type:"callback",title:"进入后"},{name:"beforeEnter",type:"callback",enabled:!1},{name:"leave",type:"callback",title:"退出后"},{name:"beforeLeave",type:"callback",enabled:!1},{name:"campus",type:["object","selector"]},{name:"prev",type:["object","selector"]}]};constructor(){super(),this.type="Campus"}onExecute(e,t,n){super.onExecute("campus")}}class BPBuildingLevelEvent extends BPBasicLevelEvent{static config={name:"BPBuildingLevelEvent",advanced:!0,outputs:[{name:"enter",type:"callback",title:"进入后"},{name:"beforeEnter",type:"callback",enabled:!1},{name:"leave",type:"callback",title:"退出后"},{name:"beforeLeave",type:"callback",enabled:!1},{name:"building",type:["object","selector"]},{name:"prev",type:["object","selector"]}]};constructor(){super(),this.type="Building"}onExecute(e,t,n){super.onExecute("building")}}class BPFloorLevelEvent extends BPBasicLevelEvent{static config={name:"BPFloorLevelEvent",advanced:!0,outputs:[{name:"enter",type:"callback",title:"进入后"},{name:"beforeEnter",type:"callback",enabled:!1},{name:"leave",type:"callback",title:"退出后"},{name:"beforeLeave",type:"callback",enabled:!1},{name:"floor",type:["object","selector"]},{name:"prev",type:["object","selector"]}]};constructor(){super(),this.type="Floor"}onExecute(e,t,n){super.onExecute("floor")}}class BPRoomLevelEvent extends BPBasicLevelEvent{static config={name:"BPRoomLevelEvent",advanced:!0,outputs:[{name:"enter",type:"callback",title:"进入后"},{name:"beforeEnter",type:"callback",enabled:!1},{name:"leave",type:"callback",title:"退出后"},{name:"beforeLeave",type:"callback",enabled:!1},{name:"room",type:["object","selector"]},{name:"prev",type:["object","selector"]}]};constructor(){super(),this.type="Room"}onExecute(e,t,n){super.onExecute("room")}}class BPSwitch extends BaseNode3D{static config={name:"BPSwitch",inputs:[{name:"exec",type:"exec"},{name:"condition",type:["any"]},{name:"caseArray",type:"array"}],outputs:[{name:"default",type:"callback"}],dynamic:{inputOrOutput:"output",type:"callback",label:"then [index]",length:1}};constructor(){super()}onExecute(data,inputs,outputs){let value=inputs.condition;"string"==typeof value&&(value="'"+value+"'");let caseArray=inputs.caseArray;for(var str="switch("+value+"){",j=0;j<caseArray.length;j++)"number"==typeof caseArray[j]||"string"==typeof caseArray[j]?("string"==typeof caseArray[j]&&(caseArray[j]="'"+caseArray[j]+"'"),str=str+"case "+caseArray[j]+":this.syncRun('BPSwitch--"+j+"', outputs);break;"):console.warn("case value can only be number or string!");str+="default :this.syncRun('default', outputs);break;",str+="}",eval(str)}}class BPSetVariablesFromJson extends BaseNode3D{static config={name:"BPSetVariablesFromJson",title:"设置变量（JSON）",inputs:[{name:"enter",type:"exec"},{name:"json",title:"变量",type:"any"}],outputs:[{name:"exec",type:"exec"}]};constructor(){super()}onExecute(e,t,n){let a=this._blueprint.getVars(),o=t.json;"string"==typeof o&&(o=JSON.parse(o)),this._blueprint.setVars({...a,...o})}onStop(){}}class BPVector3Node extends BaseNode3D{static config={name:"BPVector3Node",inputs:[{name:"x",type:"number",value:0},{name:"y",type:"number",value:0},{name:"z",type:"number",value:0}],outputs:[{name:"result",type:"vector3"}]};constructor(){super()}onExecute(e,t,n){let a=t.x||0,o=t.y||0,s=t.z||0;n.result=[a,o,s]}}class BPBaseLevelChanging extends BaseNode3D{static config={advanced:!0,inputs:[],outputs:[{name:"enter",type:"callback"},{name:"leave",type:"callback"},{name:"event",type:"object",enabled:!1}]};constructor(){super()}onExecute(e,t,n){this.app.on(THING.EventType.EnterObjectLevel,(e=>{let t=e.current;this.checkObject(t)&&(n.event=e,this.syncRun("enter",n))}),this.tags+"enter"),this.app.on(THING.EventType.LeaveObjectLevel,(e=>{let t=e.current;this.checkObject(t)&&(n.event=e,this.syncRun("leave",n))}),this.tags+"leave")}onStop(){this.app.off(THING.EventType.EnterObjectLevel,null,this.tags+"enter"),this.app.off(THING.EventType.LeaveObjectLevel,null,this.tags+"leave")}}class BPFloorLevelChanging extends BPBaseLevelChanging{static config=THING.BLUEPRINT.Utils.mergeNodeConfig({name:"BPFloorLevelChanging"},BPBaseLevelChanging.config);constructor(){super(),this.tags="bp_floor_level"}checkObject(e){return!(!e||!e.tags.has("Floor"))}}class BPRoomLevelChanging extends BPBaseLevelChanging{static config=THING.BLUEPRINT.Utils.mergeNodeConfig({name:"BPRoomLevelChanging"},BPBaseLevelChanging.config);constructor(){super(),this.tags="bp_room_level"}checkObject(e){return!(!e||!e.tags.has("Room"))}}class BPPlacementLevelChanging extends BPBaseLevelChanging{static config=THING.BLUEPRINT.Utils.mergeNodeConfig({name:"BPPlacementLevelChanging"},BPBaseLevelChanging.config);constructor(){super(),this.tags="bp_placement_level"}checkObject(e){return!(!e||!(e.tags.has("Placement")||e.tags.has("Entity")||e.tags.has("Line")||e.tags.has("Geometry")||e.tags.has("Region")||e.tags.has("Window")||e.tags.has("Door")))}}let BPCustomLevelChanging_tagsID=0;class BPCustomLevelChanging extends BPBaseLevelChanging{static config=THING.BLUEPRINT.Utils.mergeNodeConfig({name:"BPCustomLevelChanging",inputs:[{name:"condition",type:"string",visiblePin:!1}]},BPBaseLevelChanging.config);isEntrance(){return!0}constructor(){super(),this.tags="bp_custom_level"+BPCustomLevelChanging_tagsID,BPCustomLevelChanging_tagsID++}checkObject(e){return!(!e||!e.test(this.condition))}onExecute(e,t,n){this.condition=t.condition,super.onExecute(e,t,n)}}class BPCampusLevelChanging extends BPBaseLevelChanging{static config=THING.BLUEPRINT.Utils.mergeNodeConfig({name:"BPCampusLevelChanging"},BPBaseLevelChanging.config);constructor(){super(),this.tags="bp_campus_level"}checkObject(e){return!(!e||!e.tags.has("Campus"))}}class BPBuildingLevelChanging extends BPBaseLevelChanging{static config=THING.BLUEPRINT.Utils.mergeNodeConfig({name:"BPBuildingLevelChanging"},BPBaseLevelChanging.config);constructor(){super(),this.tags="bp_building_level"}checkObject(e){return!(!e||!e.tags.has("Building"))}}class BPRootLevelChanging extends BPBaseLevelChanging{static config=THING.BLUEPRINT.Utils.mergeNodeConfig({name:"BPRootLevelChanging"},BPBaseLevelChanging.config);constructor(){super(),this.tags="bp_root_level"}checkObject(e){return!(!e||!e.isRootObject)}}const{BeginNode:BeginNode,TickNode:TickNode,ArrayNode:ArrayNode,SequenceNode:SequenceNode}=THING.BLUEPRINT;var BPLegacyNodes={legacy:[BPUpdateEvent,BPKeyboardEvent,BPFlyTo,BPStopFlying,BPBindGlobalMouseEvent,BPUnbindGlobalMouseEvent,BPUnbindMouseEvent,BPBindMouseEvent,BPPauseMouseEvent,BPBindClickEvent,BPPlayAudio,BPLoadScene,BPLoadGltf,BPGetCameraPosition,BPSetCameraPosition,BPFuzzyQueryObject,BPSetCameraFov,BeginNode,TickNode,ArrayNode,SequenceNode,BPCameraSetVertAngleLimit,BPCameraSetHorzAngleLimit,BPObjectRotateOnAxis,BPObjectTranslateOnAxis,BPObjectMoveToOnAxis,BPEnterCampusLevelEvent,BPEnterBuildingLevelEvent,BPEnterFloorLevelEvent,BPEnterRoomLevelEvent,BPRandomInteger,BPRandomFromArray,BPArrayPushItem,BPPickupColor,BPLayerButton,BPAddCamera,BPObjectSetFlash,BPCameraPanControl,BPCameraZoomControl,BPObjectCancelTransformControl,BPObjectTranslate,BPSpaceIsContains,BPSpaceShowBounding,BPSpaceIsIntersects,BPSpaceIsDisjoint,BPObjectSetSpaceAttribute,BPObjectGetChildrenNodes,BPObjectCancelTexture,BPObjectCancelOutline,BPObjectCancelColor,BPIsEmpty,BPIsExist,BPObjectGetAnimations,BPCampusLevelEvent,BPBuildingLevelEvent,BPFloorLevelEvent,BPRoomLevelEvent,BPSwitch,BPSetVariablesFromJson,BPVector3Node,BPRootLevelChanging,BPCampusLevelChanging,BPBuildingLevelChanging,BPFloorLevelChanging,BPRoomLevelChanging,BPPlacementLevelChanging,BPCustomLevelChanging]};class BPBaseLevelControl extends BaseNode3D{static levelControlTag="";constructor(){super()}static config={inputs:[{name:"enable",title:"开启",type:"exec"},{name:"disable",title:"关闭",type:"exec"}],outputs:[{name:"enableCallback",title:"开启后",type:"callback"},{name:"disableCallback",title:"关闭后",type:"callback"}]};onExecute(e,t,n){let a=this.curExecName;"enable"==a?(this.onEnable(),this.syncRun("enableCallback",n)):"disable"==a&&(this.onDisable(),this.syncRun("disableCallback",n))}onEnable(){this.app.level.enableControls(this.constructor.levelControlTag)}onDisable(){this.app.level.disableControls(this.constructor.levelControlTag)}}const allNodes=Object.assign({},BPNodes,BPLegacyNodes);function registerNodes(){traversalNodes(allNodes,(function(e){e.forEach((e=>{THING.BLUEPRINT.Utils.registerBlueprintNode(e)}))}));[THING.BLUEPRINT.BPObject,THING.BLUEPRINT.BPGetObject,THING.BLUEPRINT.BPObjects,THING.BLUEPRINT.BPState,THING.BLUEPRINT.BPStateEvent,THING.BLUEPRINT.BPStateComplete,THING.BLUEPRINT.BPAttachment,THING.BLUEPRINT.BPStartSimulationDataMonitor].forEach((e=>{THING.BLUEPRINT.Utils.registerBlueprintNode(e)})),THING.BLUEPRINT.otherNodes=[THING.BLUEPRINT.BPState,THING.BLUEPRINT.BPStateEvent,THING.BLUEPRINT.BPStateComplete,THING.BLUEPRINT.BPAttachment]}function traversalNodes(e,t){Object.keys(e).forEach((n=>{e[n]instanceof Array?"function"==typeof t&&t(e[n]):e[n]instanceof Function?THING.BLUEPRINT.Utils.registerBlueprintNode(e[n]):traversalNodes(e[n],t)}))}registerNodes(),THING.BLUEPRINT.NODES={},THING.BLUEPRINT.NODES.VERSION="0.2.0",THING.BLUEPRINT.NODES.BPNodes=BPNodes,THING.BLUEPRINT.NODES.BPLegacyNodes=BPLegacyNodes,THING.BLUEPRINT.NODES.BaseNode3D=BaseNode3D,THING.BLUEPRINT.BaseNode3D=BaseNode3D,THING.BLUEPRINT.NODES.BPBaseLevelControl=BPBaseLevelControl,THING.BLUEPRINT.BPBaseLevelControl=BPBaseLevelControl}));
